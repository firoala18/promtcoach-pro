@model (IEnumerable<PortalCard> Cards, PortalVideo Video)
@{
    ViewData["Title"] = "Startseite";
}
<div class="mt-5">
    <!-- Video Upload Section -->
    <div class="card mb-5">
        <div class="card-header text-white" style="background:#393939">
            <h3 class="mb-0">
                <i class="fas fa-video me-2"></i>Prompt Coach Video Verwaltung
            </h3>
        </div>
        <div class="card-body">
            <form id="videoUploadForm" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="row">
                    <div class="col-md-9">
                        <div class="form-group">
                            <label class="form-label">Neues Prompt Coach Video hochladen</label>
                            <input type="file" class="form-control" id="videoFile" name="videoFile" accept="video/mp4" required>
                            <small class="form-text text-muted">
                                Maximale Dateigröße: 500MB, Unterstütztes Format: MP4
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn w-100" style="background:black;color:white;">
                            <i class="fas fa-upload me-2"></i>Video hochladen
                        </button>
                    </div>
                </div>
            </form>
            <div id="uploadStatus" class="mt-3"></div>

            <!-- Toggle Switch -->
            <div class="form-check form-switch mt-4">
                <input class="form-check-input bubble-toggle" type="checkbox" role="switch"
                       id="showImageCheckbox" @(Model.Video?.ShowImageInsteadOfVideo == true ? "checked" : "")>
                <label class="form-check-label fw-bold" for="showImageCheckbox">
                    Bild anstelle von Video verwenden
                </label>
            </div>
        </div>
    </div>

    <!-- Image Upload Section (Initially Hidden) -->
    <div class="card mb-5" id="imageManagementSection" style="display: none;">
        <div class="card-header text-white" style="background:#393939">
            <h3 class="mb-0">
                <i class="fas fa-image me-2"></i>Prompt Coach Bildverwaltung
            </h3>
        </div>
        <div class="card-body">
            <form id="imageUploadForm" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="row">
                    <div class="col-md-9">
                        <div class="form-group">
                            <label class="form-label">Prompt Coach Bild hochladen</label>
                            <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*" required />
                            <small class="form-text text-muted">Unterstützte Formate: JPG, PNG, SVG, WEBP</small>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn  w-100" style="background:black;color:white;">
                            <i class="fas fa-upload me-2"></i>Bild hochladen
                        </button>
                    </div>
                </div>
            </form>
            <div id="imageUploadStatus" class="mt-3"></div>
        </div>
    </div>

    <div class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Startseite-Text Felder</h2>
            <a href="@Url.Action("Upsert", "PortalCard", new { area = "Admin" })" class="btn  addBtn" style="background:black;color:white;">
                <i class="fas fa-plus"></i> Felder hinzufügen
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 8%;">#</th>
                        <th style="width: 20%;">Titel</th>
                        <th>Inhalt</th>
                        <th style="width: 15%;">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="sortable">
                    @foreach (var card in Model.Cards.OrderBy(c => c.DisplayOrder).Select((card, index) => new { Card = card, Index = index }))
                    {
                        <tr class="sortable-row" data-id="@card.Card.Id" draggable="true">
                            <td class="text-center">
                                <span class="badge bg-info">@((card.Index + 1))</span>
                                <i class="bi bi-grip-vertical handle ms-2" style="cursor: move;"></i>
                            </td>
                            <td>@card.Card.Title</td>
                            <td>@Html.Raw(card.Card.Content)</td>
                            <td class="text-center">
                                <a href="@Url.Action("Upsert", "PortalCard", new { area = "Admin", id = card.Card.Id })"
                                   class="btn btn-warning  mx-1" title="Bearbeiten">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <button class="btn btn-danger  delete-card" data-id="@card.Card.Id" title="Löschen">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3 mt-1">
            <h2></h2>
            <a href="@Url.Action("Upsert", "PortalCard", new { area = "Admin" })" class="btn  addBtn" style="background:black;color:white;">
                <i class="fas fa-plus"></i> Felder hinzufügen
            </a>
        </div>
    </div>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggle = document.getElementById('showImageCheckbox');
                const imageSection = document.getElementById('imageManagementSection');

                if (toggle && imageSection) {
                    imageSection.style.display = toggle.checked ? 'block' : 'none';
                }

                toggle?.addEventListener('change', function () {
                    imageSection.style.display = this.checked ? 'block' : 'none';

                    fetch('@Url.Action("TogglePortalDisplay", "PortalCard", new { area = "Admin" })', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ useImage: this.checked })
                    }).then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                alert("Aktualisierung fehlgeschlagen");
                                this.checked = !this.checked;
                                imageSection.style.display = this.checked ? 'block' : 'none';
                            }
                        });
                });
            });

            $('#imageUploadForm').submit(function (e) {
                e.preventDefault();
                const input = document.getElementById('imageFile');
                const status = document.getElementById('imageUploadStatus');
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                if (!input.files || input.files.length === 0) {
                    status.innerHTML = `<div class="alert alert-danger">Bitte wählen Sie ein Bild aus</div>`;
                    return;
                }

                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                formData.append('imageFile', input.files[0]);

                fetch('@Url.Action("UpdatePortalImage", "PortalCard", new { area = "Admin" })', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        status.innerHTML = data.success
                            ? `<div class="alert alert-success">${data.message}</div>`
                            : `<div class="alert alert-danger">${data.message}</div>`;
                        input.value = "";
                    })
                    .catch(err => {
                        status.innerHTML = `<div class="alert alert-danger">${err}</div>`;
                    });
            });

            document.getElementById('showImageCheckbox').addEventListener('change', function () {
                const checked = this.checked;
                fetch('@Url.Action("TogglePortalDisplay", "PortalCard", new { area = "Admin" })', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ useImage: checked })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert("Aktualisierung fehlgeschlagen");
                        }
                    });
            });

            document.getElementById('videoUploadForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const fileInput = document.getElementById('videoFile');
                const statusDiv = document.getElementById('uploadStatus');
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                if (!fileInput.files || fileInput.files.length === 0) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Bitte wählen Sie eine Videodatei aus</div>`;
                    return;
                }

                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                formData.append('videoFile', fileInput.files[0]);

                statusDiv.innerHTML = `<div class="alert alert-info">Hochladen... <i class="fas fa-spinner fa-spin"></i></div>`;

                fetch('@Url.Action("UpdatePortalVideo", "PortalCard", new { area = "Admin" })', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                })
                    .then(async response => {
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || 'Unbekannter Fehler');
                        }
                        return contentType && contentType.includes('application/json')
                            ? response.json()
                            : { success: false, message: 'Ungültiges Antwortformat' };
                    })
                    .then(data => {
                        if (data.success) {
                            statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                            fileInput.value = '';
                            if (data.newPath) {
                                const videoContainer = document.querySelector('.video-container video source');
                                if (videoContainer) {
                                    videoContainer.src = data.newPath;
                                    document.querySelector('.video-container video').load();
                                }
                            }
                        } else {
                            statusDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Upload-Fehler:', error);
                        statusDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                    });
            });

            $(function () {
                const tbody = document.getElementById('sortable');

                if (tbody) {
                    const rows = tbody.querySelectorAll('.sortable-row');

                    rows.forEach(row => {
                        row.addEventListener('dragstart', function (e) {
                            this.classList.add('dragging');
                        });

                        row.addEventListener('dragend', function () {
                            this.classList.remove('dragging');
                            saveOrder();
                        });
                    });

                    tbody.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        const dragging = tbody.querySelector('.sortable-row.dragging');
                        if (!dragging) return;

                        const afterElement = getDragAfterElement(tbody, e.clientY);
                        if (afterElement == null) {
                            tbody.appendChild(dragging);
                        } else {
                            tbody.insertBefore(dragging, afterElement);
                        }
                    });

                    function getDragAfterElement(container, y) {
                        const elements = [...container.querySelectorAll('.sortable-row:not(.dragging)')];
                        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

                        elements.forEach(element => {
                            const box = element.getBoundingClientRect();
                            const offset = y - box.top - box.height / 2;
                            if (offset < 0 && offset > closest.offset) {
                                closest = { offset: offset, element: element };
                            }
                        });

                        return closest.element;
                    }

                    function saveOrder() {
                        const ids = [];
                        $("#sortable .sortable-row").each(function (index) {
                            ids.push(parseInt($(this).data("id")));
                            $(this).find(".badge").text(index + 1);
                        });

                        $.post("@Url.Action("UpdateOrder", "PortalCard", new { area = "Admin" })", { ids: ids })
                            .done(function () {
                                Swal.fire({
                                    title: "Erfolg",
                                    text: "Anzeigereihenfolge erfolgreich aktualisiert!",
                                    icon: "success",
                                    timer: 1000,
                                    showConfirmButton: false
                                });
                            })
                            .fail(function () {
                                Swal.fire({
                                    title: "Fehler",
                                    text: "Beim Aktualisieren der Reihenfolge ist ein Fehler aufgetreten.",
                                    icon: "error"
                                });
                            });
                    }
                }
                $(document).on('click', '.delete-card', function () {
                    const cardId = $(this).data("id");
                    const $row = $(this).closest('tr');

                    Swal.fire({
                        title: 'Sind Sie sicher?',
                        text: "Diese Aktion kann nicht rückgängig gemacht werden!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Ja, löschen!',
                        cancelButtonText: 'Abbrechen'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post('@Url.Action("Delete", "PortalCard", new { area = "Admin" })', { id: cardId })
                                .done(function (response) {
                                    if (response.success) {
                                        $row.fadeOut(300, function () {
                                            $(this).remove();
                                        });
                                        Swal.fire('Gelöscht!', response.message, 'success');
                                    } else {
                                        Swal.fire('Fehler!', response.message, 'error');
                                    }
                                })
                                .fail(function () {
                                    Swal.fire('Fehler!', 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.', 'error');
                                });
                        }
                    });
                });
            });
        </script>
    }
