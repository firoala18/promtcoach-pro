@model IEnumerable<SliderItem>

@{
    var mainSlides = Model.Where(s => !s.IsForVirtuellesKlassenzimmer).OrderBy(s => s.DisplayOrder).ToList();
    var vkSlides = Model.Where(s => s.IsForVirtuellesKlassenzimmer).OrderBy(s => s.DisplayOrder).ToList();
    bool isVK = ViewBag.IsVK ?? false;
}

<style>
    .slider-toggle.active {
        color: white !important;
    }

    #showMainSlider.active {
        background-color: #198754 !important;
        border-color: #198754 !important;
    }

    #showVKSlider.active {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
    }

</style>

<div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        @if (!isVK)
        {
            <h2>Projekte Slider bearbeiten</h2>
        }
        else
        {
            <h2>XR Lab Slider bearbeiten</h2>
        }
        <a href="@Url.Action("Upsert", "Slider", new { isVK = ViewBag.IsVK })" class="btn btn-primary addBtn">
            <i class="fas fa-plus"></i> Neue Slide
        </a>

    </div>



    <!-- Main Slider Table -->
    <div id="mainSliderTable" class="table-responsive" style="display: @(isVK ? "none" : "block");">

        @* <h2>Projekte Slider bearbeiten</h2> *@
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Image</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sortable-main">
                @for (int i = 0; i < mainSlides.Count; i++)
                {
                    var item = mainSlides[i];
                    <tr class="sortable-row" data-id="@item.Id">
                        <td class="text-center">
                            <span class="badge bg-info">@(i + 1)</span>
                            <i class="bi bi-grip-vertical handle ms-2" style="cursor: move;"></i>
                        </td>
                        <td class="text-center">
                            <img src="@item.ImageUrl" class="img-thumbnail" style="width: 100px; height: 80px; object-fit: cover;">
                        </td>
                        <td class="fw-bold">@item.Title</td>
                        <td>@Html.Raw(item.Description)</td>
                        <td class="text-center">
                            <a href="@Url.Action("Upsert", "Slider", new { id = item.Id })" class="btn btn-warning mx-1"><i class="bi bi-pencil-square"></i></a>
                            <button class="btn btn-danger delete-slide" data-id="@item.Id"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Virtuelles Klassenzimmer Slider Table -->
    <div id="vkSliderTable" class="table-responsive" style="display: @(isVK ? "block" : "none");">

        @* <h2>Virtuelles Klassenzimmer Slider bearbeiten</h2> *@
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Image</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sortable-vk">
                @for (int i = 0; i < vkSlides.Count; i++)
                {
                    var item = vkSlides[i];
                    <tr class="sortable-row" data-id="@item.Id">
                        <td class="text-center">
                            <span class="badge bg-info">@(i + 1)</span>
                            <i class="bi bi-grip-vertical handle ms-2" style="cursor: move;"></i>
                        </td>
                        <td class="text-center">
                            <img src="@item.ImageUrl" class="img-thumbnail" style="width: 100px; height: 80px; object-fit: cover;">
                        </td>
                        <td class="fw-bold">@item.Title</td>
                        <td>@Html.Raw(item.Description)</td>
                        <td class="text-center">
                            <a href="@Url.Action("Upsert", "Slider", new { id = item.Id })" class="btn btn-warning mx-1"><i class="bi bi-pencil-square"></i></a>
                            <button class="btn btn-danger delete-slide" data-id="@item.Id"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // Drag-and-drop sorting
            function enableSorting(selector, actionUrl) {
                $(selector).sortable({
                    handle: ".handle",
                    update: function () {
                        const ids = [];
                        $(selector + " .sortable-row").each(function (index) {
                            ids.push(parseInt($(this).data("id")));
                            $(this).find(".badge").text(index + 1);
                        });

                        $.post(actionUrl, { ids: ids })
                            .done(() => Swal.fire("Updated", "Display order updated!", "success"))
                            .fail(() => Swal.fire("Error", "Failed to update order!", "error"));
                    }
                }).disableSelection();
            }

            enableSorting("#sortable-main", "@Url.Action("UpdateOrder", "Slider")");
            enableSorting("#sortable-vk", "@Url.Action("UpdateOrder", "Slider")");

            // Delete slide with confirmation
            $(document).on('click', '.delete-slide', function () {
                const slideId = $(this).data("id");
                const $row = $(this).closest('tr');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "This action cannot be undone!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('@Url.Action("Delete", "Slider")', { id: slideId })
                            .done(function (response) {
                                if (response.success) {
                                    $row.fadeOut(300, function () {
                                        $(this).remove();
                                    });
                                    Swal.fire('Deleted!', response.message, 'success');
                                } else {
                                    Swal.fire('Error!', response.message, 'error');
                                }
                            })
                            .fail(() => Swal.fire('Error!', 'An error occurred. Please try again.', 'error'));
                    }
                });
            });
        });
    </script>
}
