@model IEnumerable<ProjectsWebApp.Models.FilterCategory>
@using ProjectsWebApp.Models
@using ProjectsWebApp.DataAccsess.Data
@inject ApplicationDbContext _modesDb
@{
    ViewData["Title"] = "Kategorien ein-/ausblenden";
    var isAjax = string.Equals(Context?.Request?.Headers["X-Requested-With"].ToString(), "XMLHttpRequest", StringComparison.OrdinalIgnoreCase);
    if (isAjax)
    {
        Layout = null;
    }
    var currentType = (PromptType)ViewBag.Type;
    var currentTypeStr = currentType.ToString();

    // Get Mode titles from database
    var allModes = _modesDb.Modes.Where(m => !m.IsHidden).ToList();
    var modeTitleMap = allModes
        .Where(m => !string.IsNullOrEmpty(m.RouteType) && !string.IsNullOrEmpty(m.Title))
        .ToDictionary(m => m.RouteType, m => m.Title, StringComparer.OrdinalIgnoreCase);

    // Default titles for types not in database
    var defaultTitles = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        { "Text", "Text" },
        { "Bild", "Bild" },
        { "Video", "Video" },
        { "Sound", "Sound" },
        { "Beruf", "KI-Agent" },
        { "Bildung", "Domäne" },
        { "Eigenfilter", "Szenarien" },
        { "Framework", "Framework" },
        { "Meta", "Meta" }
    };

    var orderedPromptTypes = new[]
    {
        PromptType.Text,
        PromptType.Bild,
        PromptType.Video,
        PromptType.Sound,
        PromptType.Beruf,
        PromptType.Bildung,
        PromptType.Eigenfilter,
        PromptType.Framework,
        PromptType.Meta
    };

    var allTypes = Enum.GetValues(typeof(PromptType)).Cast<PromptType>().ToHashSet();
    var types = orderedPromptTypes.Where(pt => allTypes.Contains(pt)).ToList();

    // Dynamic typeLabel function using Mode titles from database
    Func<PromptType, string> typeLabel = pt =>
    {
        var routeType = pt.ToString();
        if (modeTitleMap.TryGetValue(routeType, out var title) && !string.IsNullOrEmpty(title))
        {
            return title;
        }
        return defaultTitles.TryGetValue(routeType, out var defaultTitle) ? defaultTitle : routeType;
    };

    var hiddenIds = ViewBag.HiddenCategoryIds as HashSet<int> ?? new HashSet<int>();
}

<style>
    .filtercat-visibility .card {
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e4e4e4;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        transition: box-shadow .25s ease, transform .25s;
    }

        .filtercat-visibility .card:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

    .filtercat-visibility .card-header {
        background: #f1f1f1;
        border-bottom: 1px solid #e4e4e4;
        padding: 1rem;
        font-weight: 600;
        font-size: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #333;
    }

    .filtercat-visibility #promptTypeTabs.custom-pills {
        border-bottom: none;
        display: flex;
        flex-wrap: wrap;
        gap: .4rem;
        justify-content: center;
        width: 100%;
    }

        .filtercat-visibility #promptTypeTabs.custom-pills .nav-link {
            background: #f1f3f5;
            color: #333;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            padding: .45rem 1rem;
            font-weight: 600;
            transition: background .2s,color .2s, box-shadow .2s;
        }

            .filtercat-visibility #promptTypeTabs.custom-pills .nav-link:hover {
                background: #e9ecef;
                color: #111;
            }

            .filtercat-visibility #promptTypeTabs.custom-pills .nav-link.active {
                background: #89ba17;
                color: #fff;
                border-color: #89ba17;
                box-shadow: 0 6px 14px rgba(58,204,89,.25);
            }

    .filtercat-visibility .table {
        background: #fff;
    }

        .filtercat-visibility .table thead th {
            border-bottom: 2px solid #e4e4e4;
            color: #333;
        }

        .filtercat-visibility .table tbody tr:hover {
            background: #fafafa;
        }

        .filtercat-visibility .table td, .filtercat-visibility .table th {
            vertical-align: middle;
            color: #333;
        }

    .filtercat-visibility .badge {
        border-radius: 6px;
        font-weight: 500;
    }

        .filtercat-visibility .badge.bg-info {
            background-color: #89ba17 !important;
            color: #fff;
        }

    .filtercat-visibility .btn {
        border-radius: 6px;
        padding: .5rem 1.25rem;
        font-weight: 500;
        transition: transform .2s, box-shadow .2s;
    }

        .filtercat-visibility .btn:hover {
            transform: translateY(-1px);
        }

    .filtercat-visibility .btn-toggle-visible {
        background: #111827;
        color: #fff;
        border: none;
    }

        .filtercat-visibility .btn-toggle-visible:hover {
            background: #374151;
        }

        .filtercat-visibility .btn-toggle-visible i,
        .filtercat-visibility .btn-toggle-visible:hover i {
            color: #fff;
        }

    .filtercat-visibility .btn-toggle-hidden {
        background: #f9fafb;
        color: #4b5563;
        border: 1px solid #d1d5db;
    }

        .filtercat-visibility .btn-toggle-hidden:hover {
            background: #e5e7eb;
        }
</style>

<div class="filtercat-visibility">
    @if (!isAjax)
    {
        <h2 class="mb-4"><i class="bi bi-funnel me-2"></i>Kategorien ein-/ausblenden</h2>
    }

    <div class="d-flex align-items-center mb-3">
        <ul id="promptTypeTabs" class="nav nav-pills custom-pills">
            @foreach (var pt in types)
            {
                <li class="nav-item">
                    <a class="nav-link @(pt == currentType ? "active" : "")"
                       asp-action="Visibility"
                       asp-route-type="@pt">
                        @typeLabel(pt)
                    </a>
                </li>
            }
        </ul>
    </div>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">@typeLabel(currentType)-Filter</h4>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width:10%">Reihenfolge</th>
                        <th style="width:60%">Name</th>
                        <th style="width:30%" class="text-end">Sichtbarkeit</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cat in Model)
                    {
                        var isHidden = hiddenIds.Contains(cat.Id);
                        <tr>
                            <td>
                                <span class="badge bg-info">@cat.DisplayOrder</span>
                            </td>
                            <td class="fw-semibold">@cat.Name</td>
                            <td class="text-end">
                                <form asp-action="ToggleUserVisibility"
                                      method="post"
                                      class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@cat.Id" />
                                    <input type="hidden" name="type" value="@currentTypeStr" />
                                    <button type="submit"
                                            class="btn btn-sm @(isHidden ? "btn-toggle-hidden" : "btn-toggle-visible")"
                                            title="@(isHidden ? "Kategorie für mich einblenden" : "Kategorie für mich ausblenden")">
                                        @if (isHidden)
                                        {
                                            <i class="bi bi-eye-slash"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-eye"></i>
                                        }
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
