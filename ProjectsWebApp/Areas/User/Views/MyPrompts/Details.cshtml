@model ProjectsWebApp.Models.SavedPrompt
@using System.Text.Json
@using System.Linq
@using System.Text.RegularExpressions
@using System.Net
@{
    // deserialize the saved prompt's own filters
    var mainFilters = JsonSerializer.Deserialize<List<JsonElement>>(Model.FilterJson ?? "[]")!;

    // same gradient / icon logic
    string gradient = Model.PromptType.ToLower() switch
    {
        "bild"  => "#5c5c5c",
        "video" => "#828282",
        "sound" => "#aaaaaa",
        "lehr"  => "#393939",
        "meta"  => "#191919",
        _       => "#5c5c5c"
    };
    string iconClass = Model.PromptType.ToLower() switch
    {
        "bild"  => "bi-image",
        "video" => "bi-play-btn",
        "sound" => "bi-volume-up",
        "lehr"  => "bi-journal-bookmark",
        "meta"  => "bi-gear",
        _       => "bi-text-paragraph"
    };

    /* liefert z. B.  /promptcoach   oder  "" bei localhost */
    var basePath = Context.Request.PathBase.Value ?? "";

    /* Modell‐Pfad bereinigen */
    var relPath = (Model.GeneratedImagePath ?? "")
                   .TrimStart('~')   // "~/uploads/…"  →  "/uploads/…"
                   .TrimStart('/'); //  "uploads/…"    →  "uploads/…"

    var imgSrc = $"{basePath}/{relPath}";

    // URL for deleting a variation in MyPromptsController (User area)
    var deleteVariationUrl = Url.Action("Delete", "MyPrompts", new { area = "User" })!;

    var variations = Model.PromptVariations?.ToList() ?? new List<ProjectsWebApp.Models.SavedPromptVariation>();
    
    // payload for JSON export / inline-models
    var payload = JsonSerializer.Serialize(new
    {
        type               = Model.PromptType.ToLower(),
        akronym            = Model.Akronym,
        title              = Model.Title,
        thema              = Model.Thema,
        ziele              = Model.Ziele,
        beschreibung       = Model.Beschreibung,
        schluesselbegriffe = Model.Schluesselbegriffe,
        temperatur         = Model.Temperatur,
        maxZeichen         = Model.MaxZeichen,
        promptHtml         = Model.PromptHtml,
        checkedItems       = mainFilters.Select(f => new
        {
            value       = f.GetProperty("value").GetString(),
            instruction = f.GetProperty("instruction").GetString() ?? f.GetProperty("value").GetString()
        }).ToList()
    });
    string CleanTag(string raw)
    {
        if (string.IsNullOrEmpty(raw)) return string.Empty;
        // Remove HTML tags
        var noTags = Regex.Replace(raw, "<.*?>", string.Empty);
        // Decode HTML entities like &nbsp; &amp; etc.
        var decoded = WebUtility.HtmlDecode(noTags);
        return decoded.Trim();
    }
    var readOnly = (bool?)ViewBag.ReadOnly ?? false;
}



    @if (readOnly)
    {
        <style>
            .edit-btn, .delete-btn, .delete-image-form,
            .publish-btn, .delete-variation, .edit-variation,
            .header-actions-mobile, .header-actions-desktop {
                display: none !important;
            }

            form[action*="UpdateUsedModels"] {
                display: none !important;
            }
        </style>
    }
    <style>
        :root {
            --clr-main: #191919;
            --clr-accent: #89ba17;
            --radius: 1rem;
            --shadow: 0 .5rem 1.5rem rgba(0,0,0,.06);
            --btn-copy-bg: #000;
            --btn-pdf-bg: #304c3c;
            --btn-json-bg: #8c5164;
            --btn-tokens-bg: #89ba17;
            --btn-models-bg: #89ba17;
            --btn-bib-bg: #ec5c44;
        }

        body {
            background: #ffffff;
            font-family: Segoe UI, sans-serif;
            color: #191919;
        }

        .card-detail {
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: visible;
            background: #ffffff;
            border: 1px solid #d4d4d4;
        }

        .icon-lg {
            font-size: 2rem;
            color: #fff;
        }

        .badge-tag {
            background: #004f72;
            color: white;
            cursor: pointer;
            margin: .25rem .25rem 0 0;
            padding: .3rem .7rem;
            border-radius: .5rem;
            display: inline-block;
            transition: all 0.2s;
        }

            .badge-tag:hover {
                background: #89ba17;
                color: #fff;
            }

            .badge-tag.active {
                background: #89ba17;
                color: #fff;
            }

        .prompt-box {
            background: white;
            border-radius: .5rem;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
            resize: vertical;
            color: #191919;
            border: 1px solid #191919;
        }

        .highlight {
            background: rgba(27, 187, 57, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Buttons at bottom, PromptEngineering style */
        .prompt-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

            .prompt-actions .btn {
                border-radius: .5rem;
                font-size: .95rem;
                color: #fff;
                transition: filter .15s, background .15s;
                padding: .5rem 1rem;
                min-width: 140px;
            }

        .btn-copy {
            background: #89ba17;
        }

        .btn-pdf {
            background: #89ba17;
        }

        .btn-json {
            background: var(--btn-json-bg);
        }

        .btn-tokens {
            background: var(--btn-tokens-bg);
        }

        .btn-models {
            background: var(--btn-models-bg);
        }

        .btn-Bib1 {
            background:black;
            color:white;
        }

        .btn-bib {
            background: #000;
            color: #fff;
            border: 1px solid #393939;
            border-radius: .5rem;
            padding: .6rem 1.25rem;
            font-size: .95rem;
            font-weight: 500;
            transition: all .25s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .4rem;
        }

            .btn-bib:hover {
                border: 1px solid #7d8791;
                color: #000;
                background: #f8f9fa;
                text-decoration: none;
            }

        .btn-neuPrompt {
            background: #004f72;
            color: #fff;
            border: 1px solid #004f72;
            border-radius: .5rem;
            padding: .6rem 1.25rem;
            font-size: .95rem;
            font-weight: 500;
            transition: all .25s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .4rem;
        }

            .btn-neuPrompt:hover {
                border: 1px solid #7d8791;
                color: #000;
                background: #f8f9fa;
                text-decoration: none;
            }

        .btn-Bib1:hover {
            background: black;
            color: white;
        }

        .btn-Bib:hover {
            background: black;
        }


        .btn-export {
            background: #ed5d41;
        }

        .prompt-actions .btn:hover {
            filter: brightness(1.1);
            text-decoration: none;
        }

        /* Inline models panel */
        #inlineModelsContainer {
            display: none;
            margin-top: 1rem;
        }

        .generated-thumb {
            max-width: 200px; /* gewünschte Breite */
            max-height: 200px; /* gewünschte Höhe */
            object-fit: cover; /* beschneidet, nicht verzerrt */
            cursor: pointer; /* Hand-Cursor für “klickbar” */
        }


  

        .accordion-button {
            background-color: #5c5c5c;
            color:white;
            /* border-radius:50px; */
            font-weight:bold;
        }

        #variationsAccordion .accordion-button {
            position: relative;
        }

        #variationsAccordion .accordion-header {
            position: relative;
        }

        /* Variation actions inside accordion body */
        .variation-actions-inside {
            margin-bottom: .5rem;
        }

        /* Variation circular icon buttons */
        .variation-actions-inside .edit-variation,
        .variation-actions-inside .delete-variation,
        .variation-actions-inside .btn-share {
            width: 38px;
            height: 38px;
            min-width: 38px;
            min-height: 38px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            border: none;
            padding: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            color: #fff;
            transition: transform 0.18s, box-shadow 0.18s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
        }

        .variation-actions-inside .edit-variation {
            background: #89ba17;
        }

        .variation-actions-inside .delete-variation {
            background: #dc3545;
        }

        .variation-actions-inside .btn-share {
            background: #004f72;
        }

        .variation-actions-inside .edit-variation:hover,
        .variation-actions-inside .delete-variation:hover,
        .variation-actions-inside .btn-share:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.22);
        }

        .variation-actions-inside .edit-variation:active,
        .variation-actions-inside .delete-variation:active,
        .variation-actions-inside .btn-share:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,0,0,0.18) inset;
        }
            /* ----------------- Pfeil weiss (zu) ----------------- */
            .accordion-button.collapsed::after {
                filter: brightness(0) invert(1); /* macht das Bootstrap‑SVG weiss */
            }

            /* ----------------- Pfeil schwarz (offen) ------------- */
            .accordion-button:not(.collapsed)::after {
                filter: none; /* Original‑SVG bleibt schwarz */
            }

        .accordion-item {
            border: 1px solid #d4d4d4;
        }

        .card-body {
            margin-top: -15px;
        }

        .card-body {
            margin-bottom: -15px;
        }

        .prompt-actions > button:hover {
            border: 1px solid #7d8791;
            color: black;
        }

        /*  #exportDropdown:hover{
                    border: 1px solid #7d8791;
                    color: black;
                } */

        /* Grundlegendes Styling für den Export-Button */
        .btn-export {
            background: #ed5d41; /* z.B. #054d74 */
            color: #fff;
            border: 1px solid transparent;
            transition: background .15s, color .15s, border .15s;
        }

            /* Hover-Zustand */
            .btn-export:hover {
                border: 1px solid #7d8791;
                color: #000;
            }

            /* Wenn das Dropdown geöffnet ist bzw. der Button aktiv/fokussiert ist */
            .btn-export:focus,
            .btn-export:active,
            .btn-export.show {
                background: var(--btn-export-bg);
                color: #000;
                border: 1px solid #7d8791;
                box-shadow: none; /* falls Bootstrap hier einen Shadow reinpackt */
            }

       

            /* Damit die Pfeil-Raute auch korrekt gefärbt bleibt */
            .btn-export.dropdown-toggle::after {
                border-top-color: currentColor;
            }
        /* Variation buttons responsive - now handled in .variation-actions-inside */


        /* ========== RESPONSIVE DESIGN ========== */

        /* Large Desktop (1200px+) - Default styles above */

        /* Desktop / Laptop (992px - 1199px) */
        @@media (max-width: 1199px) {
            h2, .h4 {
                font-size: 1.5rem;
            }
            .card-detail {
                margin-bottom: 1.5rem;
            }
            .prompt-actions {
                gap: 0.75rem;
            }
            .prompt-actions .btn {
                min-width: 120px;
                font-size: 0.9rem;
            }
        }

        /* iPad Pro Landscape / Small Desktop (1024px) */
        @@media (max-width: 1024px) {
            .py-5 {
                padding-top: 2rem !important;
                padding-bottom: 2rem !important;
            }
            .card-detail {
                border-radius: 0.75rem;
            }
            .prompt-box {
                font-size: 0.9rem;
                padding: 0.9rem;
            }
            .badge-tag {
                padding: 0.25rem 0.6rem;
                font-size: 0.85rem;
            }
            .rail-actions .btn-dots-menu {
                padding: 0.45rem 0.75rem;
            }
        }

        /* iPad Portrait / Tablet Landscape (768px - 991px) */
        @@media (max-width: 991px) {
            h2 {
                font-size: 1.3rem;
            }
            .icon-lg {
                font-size: 1.75rem;
            }
            .prompt-actions {
                gap: 0.5rem;
            }
            .prompt-actions .btn {
                min-width: 100px;
                font-size: 0.85rem;
                padding: 0.45rem 0.85rem;
            }
            /* Make inline models grid 2 columns on tablets */
            #inlineModelCards.row,
            .inlineModelCards.row {
                --bs-gutter-x: 1rem;
            }
            .generated-thumb {
                max-width: 180px;
                max-height: 180px;
            }
            /* Accordion adjustments */
            .accordion-button {
                font-size: 0.95rem;
                padding: 0.75rem 1rem;
            }
            .accordion-body {
                padding: 1rem;
            }
        }

        /* iPad Mini / Small Tablets (768px - 820px) */
        @@media (max-width: 820px) {
            .rail-actions {
                margin-bottom: 0.75rem;
            }
            .card-detail {
                margin-bottom: 1.25rem;
            }
            h6 {
                font-size: 1rem;
            }
            /* Stack action buttons on smaller tablets */
            .d-flex.align-items-center.justify-content-between {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 1rem;
            }
            .d-flex.align-items-center.justify-content-between > div {
                width: 100%;
            }
            .d-flex.align-items-center.justify-content-between > div:last-child {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
            }
        }

        /* Mobile / Small Tablet Portrait (576px - 767px) */
        @@media (max-width: 767px) {
            h2 {
                font-size: 1.2rem;
            }
            .icon-lg {
                font-size: 1.5rem;
            }
            .prompt-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .prompt-actions .btn,
            .prompt-actions .btn-group {
                width: 100%;
                min-width: unset;
            }
            .prompt-actions .btn-group .btn {
                flex: 1;
            }
            .prompt-box {
                font-size: 0.85rem;
                padding: 0.75rem;
                max-height: 400px;
            }
            .badge-tag {
                font-size: 0.75rem;
                padding: 0.25rem 0.55rem;
                margin: 0.2rem 0.2rem 0 0;
            }
            .edit-btn, .delete-btn, .publish-btn {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
                font-size: 0.95rem;
            }
            .variation-actions-inside .edit-variation,
            .variation-actions-inside .delete-variation,
            .variation-actions-inside .btn-share {
                width: 34px;
                height: 34px;
                min-width: 34px;
                min-height: 34px;
                font-size: 0.9rem;
            }
            .generated-thumb {
                max-width: 120px;
                max-height: 120px;
            }
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.35rem 0.6rem;
            }
            /* Accordion */
            .accordion-button {
                font-size: 0.9rem;
                padding: 0.6rem 0.75rem;
            }
            .accordion-body {
                padding: 0.75rem;
            }
            .accordion-header {
                flex-wrap: wrap;
            }
            .accordion-button {
                flex: 1 1 100%;
            }
            /* Rail actions */
            .rail-actions .dots-dropdown-menu {
                min-width: 200px;
            }
            .rail-actions .dots-dropdown-menu .dropdown-item {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* Small Mobile (less than 576px) */
        @@media (max-width: 575px) {
            .py-5 {
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }
            h2 {
                font-size: 1.1rem;
            }
            h2 i {
                font-size: 1rem;
            }
            h6 {
                font-size: 0.95rem;
            }
            .card-detail {
                border-radius: 0.5rem;
                margin-bottom: 1rem;
            }
            .card-detail > div[style*="padding:2rem"] {
                padding: 1rem !important;
            }
            .card-body {
                padding: 0.75rem;
            }
            .icon-lg {
                font-size: 1.25rem;
                margin-right: 0.5rem !important;
            }
            .h4 {
                font-size: 1.1rem;
            }
            .prompt-box {
                font-size: 0.8rem;
                padding: 0.65rem;
                max-height: 350px;
            }
            .prompt-actions .btn {
                font-size: 0.85rem;
                padding: 0.5rem;
                min-height: 44px;
            }
            .badge-tag {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
            }
            .edit-btn, .delete-btn, .publish-btn {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                font-size: 0.9rem;
            }
            .variation-actions-inside .edit-variation,
            .variation-actions-inside .delete-variation,
            .variation-actions-inside .btn-share {
                width: 34px;
                height: 34px;
                min-width: 34px;
                min-height: 34px;
                font-size: 0.9rem;
            }
            .generated-thumb {
                max-width: 120px;
                max-height: 120px;
            }
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.35rem 0.6rem;
            }
            /* Accordion */
            .accordion-button {
                font-size: 0.85rem;
                padding: 0.5rem 0.6rem;
            }
            .accordion-body {
                padding: 0.6rem;
            }
            /* Model cards - single column on small mobile */
            #inlineModelCards .col,
            .inlineModelCards .col {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .card-title {
                font-size: 0.95rem;
            }
            /* Dropdown menu adjustments */
            .rail-actions .dots-dropdown-menu {
                min-width: 180px;
                font-size: 0.85rem;
            }
            .rail-actions .dots-dropdown-menu .dropdown-item {
                padding: 0.45rem 0.65rem;
                gap: 0.5rem;
            }
            .rail-actions .dots-dropdown-menu .dropdown-item i {
                font-size: 0.9rem;
            }
        }

        /* Extra Small Mobile (less than 400px) */
        @@media (max-width: 400px) {
            h2 {
                font-size: 1rem;
            }
            h2 i {
                display: none;
            }
            .card-detail > div[style*="padding"] {
                padding: 0.75rem !important;
            }
            .prompt-box {
                font-size: 0.75rem;
                padding: 0.5rem;
                max-height: 300px;
            }
            .prompt-actions .btn {
                font-size: 0.8rem;
                padding: 0.45rem;
            }
            .edit-btn, .delete-btn, .publish-btn {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
                font-size: 0.85rem;
            }
            .variation-actions-inside .edit-variation,
            .variation-actions-inside .delete-variation,
            .variation-actions-inside .btn-share {
                width: 30px;
                height: 30px;
                min-width: 30px;
                min-height: 30px;
                font-size: 0.8rem;
            }
            .accordion-button {
                font-size: 0.8rem;
            }
        }

        /* iPad Specific Media Queries */
        @@media only screen
        and (min-device-width: 768px)
        and (max-device-width: 1024px)
        and (-webkit-min-device-pixel-ratio: 2) {
            /* iPad Pro / Air / Mini specific optimizations */
            button, a.btn, .badge-tag {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0, 79, 114, 0.1);
            }
            /* Ensure touch targets are at least 44x44px */
            button:not(.badge-tag),
            a.btn,
            .edit-btn,
            .delete-btn,
            .publish-btn,
            .edit-variation,
            .delete-variation,
            .btn-share {
                min-height: 44px;
                min-width: 44px;
            }
            /* Smooth scrolling for prompt boxes */
            .prompt-box {
                -webkit-overflow-scrolling: touch;
            }
            /* Better accordion interaction */
            .accordion-button {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.05);
            }
        }

        /* Touch Device Optimizations */
        @@media (hover: none) and (pointer: coarse) {
            /* Remove hover effects on touch devices */
            .edit-btn:hover,
            .delete-btn:hover,
            .publish-btn:hover,
            .edit-variation:hover,
            .delete-variation:hover,
            .btn-share:hover {
                transform: none;
                filter: none;
            }
            /* Use active states instead */
            .edit-btn:active,
            .delete-btn:active,
            .publish-btn:active,
            .edit-variation:active,
            .delete-variation:active,
            .btn-share:active {
                transform: scale(0.95);
                opacity: 0.8;
            }
            .badge-tag:hover {
                background: #004f72;
                color: white;
            }
            .badge-tag:active {
                background: #89ba17;
                transform: scale(0.95);
            }
            /* Better prompt box interaction */
            .prompt-box {
                -webkit-user-select: text;
                user-select: text;
            }
        }

        /* Landscape orientation specific */
        @@media (max-width: 991px) and (orientation: landscape) {
            .py-5 {
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }
            .card-detail {
                margin-bottom: 1rem;
            }
            .prompt-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .prompt-actions .btn {
                flex: 1 1 calc(33.333% - 0.5rem);
                min-width: 100px;
            }
            .accordion-body {
                padding: 0.75rem;
            }
        }

        /* Print styles */
        @@media print {
            .rail-actions,
            .edit-btn,
            .delete-btn,
            .publish-btn,
            .edit-variation,
            .delete-variation,
            .btn-share,
            .prompt-actions,
            form {
                display: none !important;
            }
            .card-detail {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .prompt-box {
                border: 1px solid #ddd;
                background: white;
                color: black;
            }
        }

          
        /* Upper prompt circular icon buttons - white bg, black icons, color on hover */
        .edit-btn,
        .delete-btn,
        .publish-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            border: 1px solid transparent;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            background: #fff;
            color: #333;
            transition: transform 0.18s, box-shadow 0.18s, background 0.18s, color 0.18s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.22);
            background: #89ba17;
            color: #fff;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.22);
            background: #dc3545;
            color: #fff;
        }

        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.22);
            background: #004f72;
            color: #fff;
        }

        .edit-btn:active,
        .delete-btn:active,
        .publish-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,0,0,0.18) inset;
        }


        /* Three-dots menu container */
        .rail-actions {
            padding: 0;
            padding-left: var(--rail-pad);
            margin: 0 0 1rem 0;
            display: flex;
            justify-content: flex-end;
            gap: .75rem;
        }

        /* Three-dots menu button - scoped to .rail-actions */
        .rail-actions .btn-dots-menu {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            color: #333;
            padding: 0.5rem 0.85rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .rail-actions .btn-dots-menu:hover {
            background: #f8f9fa;
            border-color: #ccc;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .rail-actions .btn-dots-menu:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .rail-actions .btn-dots-menu.show {
            background: #f0f0f0;
            border-color: #bbb;
        }

        /* Dropdown menu styling - scoped to .rail-actions */
        .rail-actions .dots-dropdown-menu {
            min-width: 240px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            margin-top: 0.5rem !important;
            position: absolute !important;
            right: 0 !important;
            left: auto !important;
            top: 100% !important;
            transform: none !important;
            background: #fff;
        }

        .rail-actions .dots-dropdown-menu .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 1rem;
            border-radius: 8px;
            color: #333;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .rail-actions .dots-dropdown-menu .dropdown-item:hover {
            background-color: #f0f2f5;
            color: #000;
            transform: translateX(3px);
        }

        .rail-actions .dots-dropdown-menu .dropdown-item i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            color: #555;
        }

        .rail-actions .dots-dropdown-menu .dropdown-item:hover i {
            color: #004f72;
        }

        .rail-actions .dots-dropdown-menu .dropdown-divider {
            margin: 0.5rem 0;
        }

        /* Header action buttons - desktop vs mobile */
        .header-actions-desktop {
            display: flex !important;
            align-items: center;
        }

        .header-actions-mobile {
            display: none !important;
        }

        .header-actions-mobile .btn-dots-menu {
            background: #ffffff;
            border: none;
            border-radius: 50%;
            color: #333;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .header-actions-mobile .btn-dots-menu:hover {
            background: #f8f9fa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .header-actions-mobile .dots-dropdown-menu {
            min-width: 200px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            background: #fff;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 1rem;
            border-radius: 8px;
            color: #333;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item:hover {
            background-color: #f0f2f5;
            color: #000;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item.edit-action i {
            color: #89ba17;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item.delete-action i {
            color: #dc3545;
        }

        .header-actions-mobile .dots-dropdown-menu .dropdown-item.publish-action i {
            color: #004f72;
        }

        @@media (max-width: 1200px) {
            .header-actions-desktop {
                display: none !important;
            }

            .header-actions-mobile {
                display: block !important;
            }
        }

    </style>

<div class="d-flex justify-content-end mb-4 container flex-wrap gap-2">
    <div class="d-flex gap-2 flex-wrap">
        <a asp-area="User"
           asp-controller="Home"
           asp-action="Bibliothek"
           class="btn btn-bib">
            <i class="fa fa-university me-1" aria-hidden="true"></i> Zur Bibliothek
        </a>
        <a asp-area="User"
           asp-controller="MyPrompts"
           asp-action="Index"
           class="btn btn-neuPrompt">
            <i class="bi bi-archive-fill me-1"></i> Zur Sammlung
        </a>
        <a asp-area="User"
           asp-controller="Home"
           asp-action="PromptAssistent"
           asp-route-type="text"
           class="btn btn-neuPrompt">
            <i class="bi bi-plus-circle me-1"></i> Prompt
        </a>
    </div>
</div>

    <h2 class="mb-0"><i class="bi bi-bookmarks me-2"></i>Prompt analysieren</h2>
  <div class="py-5">
    <!-- main card -->
    <div class="card card-detail mb-4">
      <div style="background:@gradient; padding:2rem;">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="bi @iconClass icon-lg me-3"></i>
                        <h2 class="h4 text-white mb-0">@Model.Akronym</h2>
                    </div>

                 

                    <!-- Desktop action buttons -->
                    <div class="header-actions-desktop">
                        <button class="edit-btn ms-2" title="Bearbeiten">
                            <i class="bi bi-pencil-fill"></i>
                        </button>

                        <button class="delete-btn ms-2" title="Löschen">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                        <button type="button"
                                class="publish-btn ms-2"
                                data-akronym="@Model.Akronym"
                                title="In Bibliothek veröffentlichen">
                            <i class="bi bi-upload"></i>
                        </button>
                    </div>

                    <!-- Mobile three-dots menu -->
                    <div class="header-actions-mobile dropdown">
                        <button class="btn-dots-menu" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dots-dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item edit-action mobile-edit-btn" href="#">
                                    <i class="bi bi-pencil-fill"></i>
                                    Bearbeiten
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item publish-action mobile-publish-btn" href="#" data-akronym="@Model.Akronym">
                                    <i class="bi bi-upload"></i>
                                    Veröffentlichen
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item delete-action mobile-delete-btn" href="#">
                                    <i class="bi bi-trash-fill"></i>
                                    Löschen
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

      </div>
      <div class="card-body">
                @* Bild hochladen/anzeigen wie in Admin *@
                @if (Model.PromptType.Equals("Bild", StringComparison.OrdinalIgnoreCase))
                {
                    <div class="mb-4 text-center">
                        <div class="generated-container">
                            @if (!string.IsNullOrEmpty(Model.GeneratedImagePath))
                            {
                                <img src="@imgSrc"
                                     class="generated-thumb mb-3"
                                     alt="Generiertes Bild"
                                     onclick="window.open('@imgSrc','_blank','width=800,height=600')" />

                                <form asp-area="User"
                                      asp-controller="MyPrompts"
                                      asp-action="DeleteImage"
                                      asp-route-id="@Model.Id"
                                      method="post"
                                      class="delete-image-form d-inline-block">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-danger" title="Bild löschen">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </form>
                            }
                            <form asp-area="User"
                                  asp-controller="MyPrompts"
                                  asp-action="UploadImage"
                                  asp-route-id="@Model.Id"
                                  method="post"
                                  enctype="multipart/form-data"
                                  class="mt-2 d-flex justify-content-center align-items-center">
                                @Html.AntiForgeryToken()
                                <input type="file"
                                       name="imageFile"
                                       class="form-control form-control-sm me-2"
                                       accept="image/*" />
                                <button type="submit" class="btn btn-sm btn-dark">
                                    <i class="bi bi-upload me-1"></i> Speichern
                                </button>
                            </form>

                          

                        </div>
                        @if (!string.IsNullOrEmpty(Model.GeneratedImagePath))
                        {
                            <hr />
                        }
                    </div>
                }

                

                    <!-- Title on its own line -->
                <p class="fw-semibold mb-3 mt-3" style="font-size:20px;">Title: @Model.Title</p>
                    <div class="ps-3 border-start border-secondary mb-4">
                    @* if there are already entries, show them *@
                    @if (!string.IsNullOrWhiteSpace(Model.UsedModels))
                    {
                        <p class="mb-2">
                            <strong>Verwendete Modelle:</strong> @Model.UsedModels
                        </p>
                    }

                    @* always allow the user to edit their own prompt’s UsedModels *@
                    <form asp-area="User"
                          asp-controller="MyPrompts"
                          asp-action="UpdateUsedModels"
                          method="post"
                          class="mb-0">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />

                        <div class="input-group input-group-sm" style="max-width:360px;">
                            <input type="text"
                                   name="usedModels"
                                   class="form-control"
                                   placeholder="z. B. GPT-4, DALL·E 3"
                                   value="@Model.UsedModels" />
                            <button type="submit"
                                    class="btn btn-sm btn-dark">
                                Speichern
                            </button>
                        </div>
                    </form>
                
                </div>
        <hr />
                <h6 style="font-size:18px;">Filter-Kriterien analysieren: </h6>
        <div id="filters-main" class="mb-3">
          @foreach (var f in mainFilters)
          {
              var v = f.GetProperty("value").GetString();
              var i = f.GetProperty("instruction").GetString() ?? v;
              <span class="badge-tag filter-badge"
                    data-prompt="main"
                              data-instr="@CleanTag(i)">@CleanTag(v)</span>
          }
        </div>
        <hr />
                <h6 style="font-size:18px;">Prompt-Inhalt:</h6>
        <pre id="prompt-main" class="prompt-box">@Html.Raw(Model.PromptHtml)</pre>
      </div>

      <div class="prompt-actions">
            <button id="copy-prompt" class="btn btn-copy"> <i class="fa fa-clone me-1 "></i> Kopieren</button>
        <button id="calculate-tokens" class="btn btn-tokens"><i class="bi bi-calculator me-1"></i> Tokens</button>
        <button id="show-inline-models" class="btn btn-models">
          
                <i id="models-icon" class="fa fa-cubes me-1"></i>
          <span id="models-button-text">Modelle</span>
        </button>
        <div class="btn-group">
          <button id="exportDropdown" class="btn btn-export dropdown-toggle"
                  data-bs-toggle="dropdown"><i class="bi bi-file-earmark me-1"></i> Export</button>
          <ul class="dropdown-menu">
            <li><button class="dropdown-item" id="export-pdf"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button></li>
            <li><button class="dropdown-item" id="export-json"><i class="bi bi-download me-1"></i> JSON</button></li>
          </ul>
        </div>
      </div>
    </div>

        <!-- Inline Models Container -->
        <div id="inlineModelsContainer" class="row g-4" style="display: none; margin-top: 1rem;">
            <div class="col-12">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="inlineModelSearch"
                           type="text"
                           class="form-control"
                           placeholder="Modelle durchsuchen …" />
                </div>
            </div>
            <div id="inlineModelCards"
                 class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4"></div>
            <nav class="col-12">
                <ul id="inlineModelPagination"
                    class="pagination justify-content-center mb-0"></ul>
            </nav>
        </div>

    @* ── Variationen ── *@
    @if (Model.PromptVariations?.Any() == true)
    {
      <h5 class="mb-3"><i class="bi bi-card-list me-1"></i>Variationen</h5>
      <div class="accordion" id="variationsAccordion">
        @for (int idx = 0; idx < Model.PromptVariations.Count; idx++)
        {
          var v = variations[idx];
          var root       = JsonDocument.Parse(v.VariationJson ?? "{}").RootElement;
          var data       = root.TryGetProperty("data", out var d) ? d : root;
          var html       = data.GetProperty("promptHtml").GetString() ?? "";
          var filtersVar = new List<JsonElement>();
          if (data.TryGetProperty("checkedItems", out var ci) && ci.ValueKind == JsonValueKind.Array)
          {
            filtersVar = ci.EnumerateArray().ToList();
          }
          else if (data.TryGetProperty("filterJson", out var fj) && fj.ValueKind == JsonValueKind.String)
          {
            try
            {
              using var docF = JsonDocument.Parse(fj.GetString() ?? "[]");
              if (docF.RootElement.ValueKind == JsonValueKind.Array)
                filtersVar = docF.RootElement.EnumerateArray().ToList();
            }
            catch { }
          }
          var collapseId = $"collapse-{v.Id}";
          var headingId  = $"heading-{v.Id}";
          var promptId   = $"prompt-var-{v.Id}";

          <div class="accordion-item mb-3" data-var-id="@v.Id" data-payload='@Html.Raw(data.GetRawText())'>
            <h2 class="accordion-header" id="@headingId">
              <button class="accordion-button collapsed"
                      data-bs-toggle="collapse"
                      data-bs-target="#@collapseId"
                      aria-controls="@collapseId">
                Variation @(idx + 1)
              </button>
            </h2>
            <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="@headingId">
              <div class="accordion-body">
                <!-- Variation Actions (Edit/Delete/Share) -->
                <div class="variation-actions-inside d-flex justify-content-end gap-2 mb-3">
                    <button type="button"
                            class="edit-variation"
                            data-target="@promptId"
                            data-prompt-type="@Model.PromptType.ToLower()"
                            title="Bearbeiten">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                    <button type="button"
                            class="delete-variation"
                            title="Variation löschen">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                    <button type="button"
                            class="btn-share act-share"
                            data-var-id="@v.Id"
                            title="In Bibliothek veröffentlichen">
                        <i class="bi bi-upload"></i>
                    </button>
                </div>
                <h6>Filter-Kriterien</h6>
                <div id="filters-var-@v.Id">
                  @{
                    var hadAny = false;
                    if (filtersVar != null && filtersVar.Count > 0)
                    {
                      hadAny = true;
                      foreach (var item in filtersVar)
                      {
                        var val2 = item.GetProperty("value").GetString();
                        var ins2 = item.GetProperty("instruction").GetString() ?? val2;
                        <span class="badge-tag filter-badge"
                              data-prompt="var-@v.Id"
                              data-instr="@CleanTag(ins2)">@CleanTag(val2)</span>
                      }
                    }
                    if (!hadAny)
                    {
                      var parsed = new List<string>();
                      try
                      {
                        var plain = Regex.Replace(html ?? string.Empty, "<.*?>", string.Empty);
                        var ms = Regex.Matches(plain, "\\(([^)]+)\\)\\s*:");
                        var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                        foreach (Match m in ms)
                        {
                          var s = (m.Groups[1].Value ?? string.Empty).Trim();
                          if (!string.IsNullOrWhiteSpace(s) && seen.Add(s)) parsed.Add(s);
                        }
                      }
                      catch { }
                      foreach (var val2 in parsed)
                      {
                        var ins2 = val2;
                        <span class="badge-tag filter-badge"
                              data-prompt="var-@v.Id"
                              data-instr="@CleanTag(ins2)">@CleanTag(val2)</span>
                      }
                    }
                  }
                </div>
                <hr />
                <h6>Prompt-Inhalt</h6>
                <pre id="@promptId" class="prompt-box">@Html.Raw(html)</pre>
                            

                                <!-- Prompt‑Actions für diese Variation -->
                                <div class="prompt-actions mt-3" data-owner="var-@v.Id">
                                    <button class="btn btn-copy shadow-sm act-copy" data-target="@promptId">
                                    <i class="fa fa-clone me-1"></i> Kopieren
                                    </button>
                                    <button class="btn btn-tokens shadow-sm act-tokens" data-target="@promptId">
                                        <i class="bi bi-calculator me-1"></i> Tokens
                                    </button>

                                    <button class="btn btn-models shadow-sm act-models"
                                            data-var-id="@v.Id">
                                    <i  class="fa fa-cubes me-1"></i>Modelle
                                    </button>

                                    <button class="btn btn-export shadow-sm dropdown-toggle act-export"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-file-earmark me-1"></i> Export
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item act-pdf" href="#" data-target="@promptId">
                                                <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item act-json" href="#" data-target="@promptId">
                                                <i class="bi bi-download me-1"></i> JSON
                                            </a>
                                        </li>
                                    </ul>
                                </div>

              </div>
            </div>
          </div>

                    <div id="inlineModelsContainer-var-@v.Id" class="row g-4 mt-3 mb-3" style="display:none">
                        <div class="col-12">
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control inlineModelSearch"
                                       placeholder="Modelle durchsuchen …" />
                            </div>
                        </div>
                        <div class="inlineModelCards row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4"></div>
                        <nav class="col-12">
                            <ul class="inlineModelPagination pagination justify-content-center mb-0"></ul>
                        </nav>
                    </div>
        }
      </div>
    }

 

  </div>
  <div class="d-flex justify-content-end mb-4 flex-wrap gap-2">
    <div class="d-flex gap-2 flex-wrap">
        <a asp-area="User"
           asp-controller="Home"
           asp-action="Bibliothek"
           class="btn btn-bib">
            <i class="fa fa-university me-1" aria-hidden="true"></i> Zur Bibliothek
        </a>
        <a asp-area="User"
           asp-controller="MyPrompts"
           asp-action="Index"
           class="btn btn-neuPrompt">
            <i class="bi bi-archive-fill me-1"></i> Zur Sammlung
        </a>
        <a asp-area="User"
           asp-controller="Home"
           asp-action="PromptAssistent"
           asp-route-type="text"
           class="btn btn-neuPrompt">
            <i class="bi bi-plus-circle me-1"></i> Prompt
        </a>
    </div>
</div>

    <!-- Kopier-Toast ------------------------------------------------------->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11000;">
        <div id="copy-toast"
             class="toast align-items-center text-bg-success border-0"
             role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Prompt wurde kopiert&nbsp;✔
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>


    <script>
             /*----------------------------------------------------------
          Meine‑Prompt‑Details  –  kompletter JavaScript‑Block
          (identisch zu den Funktionen der Bibliothek‑Ansicht)
        ----------------------------------------------------------*/

       

        document.addEventListener('DOMContentLoaded', () => {

                    function showCopyToast () {
          const el = document.getElementById('copy-toast');
          if (el) bootstrap.Toast.getOrCreateInstance(el, { delay: 2500 }).show();
        }

                const existsUrl  = '@Url.Action("Exists", "PromptTemplateApi", new { area = "Api" })';
        const publishUrl = '@Url.Action("Publish", "PromptTemplateApi", new { area = "Api" })';

        async function akronymExists(akronym) {
          const res = await fetch(`${existsUrl}?akronym=${encodeURIComponent(akronym)}`,
                                  { credentials:'same-origin' });
          if (res.status === 404) return false;
          const { exists } = await res.json();
          return !!exists;
        }


          /* ─────────────────────────────────────────────────────
             0)  Konstanten & Razor‑Daten
          ────────────────────────────────────────────────────── */
          const state              = /**/ @Html.Raw(payload) /**/;   // Razor‑Inject
          window.promptState = state;
          const secretKey          = 'uni-wuppertal2025';
          const deleteVariationUrl = '@deleteVariationUrl';

          /* ─────────────────────────────────────────────────────
             1)  Universelle Helfer
          ────────────────────────────────────────────────────── */
          async function sha256(str){
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
          }


          /* Kopieren – liefert HTML + Plain‑Text */
          async function copyPrompt(preId){
            const pre  = document.getElementById(preId); if(!pre) return;
            const html = pre.innerHTML.trim();

            /* Plain‑Text mit sauberen Zeilenumbrüchen */
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            tmp.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
            tmp.querySelectorAll('p,div').forEach(el => el.append('\n'));
            const plain = (tmp.textContent||'').replace(/\n{3,}/g,'\n\n').trim();

            if(navigator.clipboard && window.ClipboardItem){
              await navigator.clipboard.write([
                new ClipboardItem({
                  'text/html' : new Blob([html] ,{type:'text/html'}),
                  'text/plain': new Blob([plain],{type:'text/plain'})
                })
              ]);
            }else{                       /* uralter Fallback */
              const ta = Object.assign(document.createElement('textarea'),
                        {value:html,style:'position:absolute;left:-9999px'});
              document.body.append(ta); ta.select(); document.execCommand('copy'); ta.remove();
            }
          }

          /* PDF‑Export – Layout wie in der Bibliothek */
          function exportPromptPdf(html,fileName='prompt.pdf'){
            const { jsPDF } = window.jspdf;
            const pdf  = new jsPDF('p','mm','a4');
            const L    = 15, maxW = pdf.internal.pageSize.getWidth()-2*L;
            let   y    = L;

            pdf.setFontSize(16).setFont('helvetica','bold')
               .text('Prompt‑Inhalt',L,y); y+=10;

            const tmp=document.createElement('div'); tmp.innerHTML=html;
            tmp.querySelectorAll('br').forEach(br=>br.replaceWith('\n'));

            const sections=[];
            tmp.childNodes.forEach(n=>{
              const t=(n.textContent||'').replace(/\s+/g,' ').trim();
              if(!t) return;
              const m=t.match(/^(Thema|Ziele|Beschreibung|Schlüsselbegriffe):/i);
              sections.push(m ? {title:m[0],content:t.replace(m[0],'').trim()}
                              : {title:null ,content:t});
            });

            sections.forEach(s=>{
              if(s.title){
                pdf.setFontSize(12).setFont('helvetica','bold').text(s.title,L,y); y+=7;
                pdf.setFont('helvetica','normal');
              }
              pdf.splitTextToSize(s.content,maxW).forEach(line=>{
                if(y>280){ pdf.addPage(); y=L; }
                pdf.text(line,L,y); y+=6;
              });
              y+=4;
            });

            const pages=pdf.getNumberOfPages();
            for(let p=1;p<=pages;p++){
              pdf.setPage(p).setFontSize(8)
                 .text(`Seite ${p} von ${pages}`,L+maxW,290,{align:'right'});
            }
            pdf.save(fileName);
          }

          /* ─────────────────────────────────────────────────────
             2)  Haupt‑Prompt Aktionen
          ────────────────────────────────────────────────────── */
          /* Kopieren */
          // document.getElementById('copy-prompt')
          //         ?.addEventListener('click',async()=>{
          //           await copyPrompt('prompt-main');
          //           Swal.fire({icon:'success',title:'Kopiert!',timer:1500,showConfirmButton:false});
          //         });

                   document.getElementById('copy-prompt')
                ?.addEventListener('click', async () => {
                  await copyPrompt('prompt-main');
                  showCopyToast();              // ✅ nur Toast
        });

          /* Tokens */
          document.getElementById('calculate-tokens')
                  ?.addEventListener('click',()=>{
                    const txt=document.getElementById('prompt-main').innerText.trim();
                    const tokens=Math.ceil(txt.length/4);
                    Swal.fire({icon:'info',
                      html:`<p><strong>Zeichen (Characters):</strong> ${txt.length}</p>
                            <p><strong>Tokens (geschätzt):</strong> ${tokens}</p>`});
                  });

          /* JSON‑Export */
          document.getElementById('export-json')
                  ?.addEventListener('click',async()=>{
                    const hash=await sha256(secretKey+JSON.stringify(state));
                    const blob=new Blob([JSON.stringify({data:state,hash},null,2)],
                                        {type:'application/json'});
                    const url =URL.createObjectURL(blob);
                    Object.assign(document.createElement('a'),
                       {href:url,download:'prompt-export.json'}).click();
                    URL.revokeObjectURL(url);
                  });

          /* PDF‑Export */
          document.getElementById('export-pdf')
                  ?.addEventListener('click',()=>exportPromptPdf(state.promptHtml,'prompt.pdf'));



          /* ─────────────────────────────────────────────────────
             3)  Delegierter Listener für Variations‑Buttons
          ────────────────────────────────────────────────────── */
          // document.addEventListener('click',async ev=>{
          //   /* COPY */
          //   const c=ev.target.closest('.act-copy');
          //   if(c){
          //     await copyPrompt(c.dataset.target);
          //     return Swal.fire({icon:'success',title:'Kopiert!',timer:1500,showConfirmButton:false});
          //   }

                document.addEventListener('click', async ev => {

        /* SHARE  ⇢  Variation in Bibliothek posten -------------------------- */
        const share = ev.target.closest('.act-share');
        if (share) {
          const varId = share.dataset.varId;
          const item  = document.querySelector(`.accordion-item[data-var-id="${varId}"]`);
          if (!item) return;

          /* komplette Payload der Variation holen */
          let varData = JSON.parse(item.dataset.payload || '{}');

          /* Fallback für ältere Datensätze ohne promptHtml */
          if (!varData.promptHtml) {
            const pre = item.querySelector('pre.prompt-box');
            varData.promptHtml = pre ? pre.innerHTML : '';
          }

          /* endgültiges Payload bauen */
          const s = { ...window.promptState, ...varData };
          const akronym = (s.akronym || '').trim();
          if (!akronym)
            return Swal.fire({ icon:'error', title:'Akronym fehlt' });

          /* Existenz-Check + Bestätigung */
          let alreadyThere = false;
          try { alreadyThere = await akronymExists(akronym); }
          catch(e){ return Swal.fire({ icon:'error', title:'Fehler', text:String(e) }); }

          const go = await Swal.fire({
              title : alreadyThere
                      ? `Akronym „${akronym}“ existiert bereits.`
                      : 'In Bibliothek speichern?',
              text  : alreadyThere
                      ? 'Möchtest du den bestehenden Prompt überschreiben?'
                      : 'Bist du sicher, dass du diesen Prompt speichern möchtest?',
              icon  : alreadyThere ? 'warning' : 'question',
              showCancelButton : true,
              confirmButtonText: alreadyThere ? 'Überschreiben' : 'Speichern',
              cancelButtonText : 'Abbrechen'
          }).then(r => r.isConfirmed);

          if (!go) return;

          /* Body vorbereiten (wie bei Haupt-Prompt) */
          const bodyPayload = {
            Akronym           : s.akronym,
            Title             : s.title,
            Beschreibung      : s.beschreibung       ?? '',
            Schluesselbegriffe: s.schluesselbegriffe ?? '',
            Thema             : s.thema              ?? '',
            Ziele             : s.ziele              ?? '',
            PromptHtml        : s.promptHtml,
            PromptType        : s.type,
            FilterJson        : JSON.stringify(s.checkedItems ?? []),
            Temperatur        : s.temperatur         ?? 0,
            MaxZeichen        : s.maxZeichen         ?? null,
            UsedModels        : s.usedModels         ?? '',
            GeneratedImagePath: s.generatedImagePath ?? ''
          };
          const metaHash = await sha256(JSON.stringify(bodyPayload));
          const body     = { ...bodyPayload, MetaHash: metaHash };

          /* POST an /Publish */
          try {
            const res = await fetch(publishUrl, {
              method :'POST',
              headers:{ 'Content-Type':'application/json' },
              body   : JSON.stringify(body)
            });
            if (!res.ok) throw await res.text();

            Swal.fire({
              icon : 'success',
              title: alreadyThere ? 'Überschrieben!' : 'Gespeichert!',
              timer: 1500,
              showConfirmButton: false
            });

          } catch(err){
            Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
          }
          return;                      // nichts weiteres mehr für dieses Event
        }


        /* COPY */
        const c = ev.target.closest('.act-copy');
        if (c) {
          await copyPrompt(c.dataset.target);
          showCopyToast();                    // ✅ Toast statt SweetAlert
          return;                             // nichts weiter ausführen
        }

            /* TOKENS */
            const t=ev.target.closest('.act-tokens');
            if(t){
              const txt=document.getElementById(t.dataset.target).innerText.trim();
              const tokens=Math.ceil(txt.length/4);
              return Swal.fire({icon:'info',
                       html:`<p><strong>Zeichen:</strong> ${txt.length}</p>
                             <p><strong>Tokens:</strong> ${tokens}</p>`});
            }

            /* JSON */
            const j=ev.target.closest('.act-json');
            if(j){
              ev.preventDefault();
              const html=document.getElementById(j.dataset.target).innerHTML;
              const payload={html,exportedAt:new Date().toISOString()};
              const hash=await sha256(secretKey+JSON.stringify(payload));
              const blob=new Blob([JSON.stringify({data:payload,hash},null,2)],
                                  {type:'application/json'});
              const url=URL.createObjectURL(blob);
              Object.assign(document.createElement('a'),
                {href:url,download:`${j.dataset.target}.json`}).click();
              URL.revokeObjectURL(url);
              return;
            }

            /* PDF */
            const p=ev.target.closest('.act-pdf');
            if(p){
              ev.preventDefault();
              exportPromptPdf(document.getElementById(p.dataset.target).innerHTML,
                              `${p.dataset.target}.pdf`);
            }
          });

                  /* ─────────────────────────────────────────────────────
           INLINE‑MODEL‑PANEL  (Light‑Bulb Button)
        ───────────────────────────────────────────────────── */
        (() => {
          const btnModels  = document.getElementById('show-inline-models'),
                panel      = document.getElementById('inlineModelsContainer'),
                cards      = document.getElementById('inlineModelCards'),
                pag        = document.getElementById('inlineModelPagination'),
                searchIn   = document.getElementById('inlineModelSearch'),
                icon       = document.getElementById('models-icon'),
                txt        = document.getElementById('models-button-text');

          if (!btnModels || !panel || !cards || !pag || !searchIn) return;

          let visible = false, all = [], filtered = [];

          /* fetch once, then cache */
          async function loadModels() {
            if (all.length) return;
            const res = await fetch('@Url.Content("~/api/PromptModel")');
            if (!res.ok) throw new Error(await res.text());
            all = await res.json();
            filtered = [...all];
          }

          /* tiny paginator */
          function render(page = 1, per = 6) {
            const slice = filtered.slice((page - 1) * per, page * per);
            cards.innerHTML =
              slice.map(m => `
                <div class="col">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                      <h5 class="card-title">${m.titel}</h5>
                      <a href="${m.redirectUrl}" target="_blank"
                         class="btn mt-auto w-100" style="background:#89ba17;color:#fff">
                        Öffnen <i class="bi bi-box-arrow-up-right ms-1"></i>
                      </a>
                    </div>
                  </div>
                </div>`).join('') ||
              `<p class="text-center text-muted w-100">Keine Modelle gefunden.</p>`;

            /* pagination pills */
            const pages = Math.max(1, Math.ceil(filtered.length / per));
            pag.innerHTML = '';
            for (let p = 1; p <= pages; p++) {
              pag.insertAdjacentHTML('beforeend', `
                <li class="page-item ${p === page ? 'active' : ''}">
                  <a class="page-link" href="#" data-p="${p}">${p}</a>
                </li>`);
            }
          }

          /* UI handlers -------------------------------------------------- */
          btnModels.addEventListener('click', async () => {
            visible = !visible;
            panel.style.display = visible ? 'block' : 'none';
            icon.className      = visible ? 'bi bi-eye-slash me-1'
                                          : 'bi bi-lightbulb me-1';
            txt.textContent     = visible ? 'Modelle ausblenden' : 'Modelle';

            if (!visible) return;

            try { await loadModels(); } catch (e) {
              cards.innerHTML = `<p class="text-danger w-100">Fehler: ${e.message}</p>`;
              return;
            }
            render(1);
          });

          /* pagination click */
          pag.addEventListener('click', e => {
            const a = e.target.closest('a[data-p]');
            if (!a) return;
            e.preventDefault();
            render(+a.dataset.p);
          });

          /* live‑filter */
          searchIn.addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            filtered = all.filter(m => m.titel.toLowerCase().includes(term));
            render(1);
          });
        })();

          /* ==================================================
           VARIATION MODELS PANELS
        ================================================== */
        document.addEventListener('click', async e => {
            const btn = e.target.closest('.act-models');
            if (!btn) return;

            const varId = btn.dataset.varId;
            if (!varId) return;

            const panelId = `inlineModelsContainer-var-${varId}`;
            const panel = document.getElementById(panelId);
            if (!panel) return;

            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';

            // Load models if not already loaded
            if (!window.allModels) {
                try {
                    window.allModels = await (await fetch('@Url.Content("~/api/PromptModel")')).json();
                } catch(e) {
                    console.error('Fehler beim Laden der Modelle:', e);
                    return;
                }
            }

            // Initialize panel if first time
            if (!panel.dataset.initialized) {
                panel.dataset.initialized = true;
                renderModelsForPanel(panel);
            }
        });

        function renderModelsForPanel(panel, page = 1, perPage = 6) {
            const searchInput = panel.querySelector('.inlineModelSearch');
            const term = (searchInput?.value || '').toLowerCase();

            const filtered = term
                ? window.allModels.filter(m => m.titel.toLowerCase().includes(term))
                : [...window.allModels];

            const start = (page - 1) * perPage;
            const slice = filtered.slice(start, start + perPage);

            const cards = panel.querySelector('.inlineModelCards');
            cards.innerHTML = slice.map(m => `
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${m.titel}</h5>
                            <a href="${m.redirectUrl}" target="_blank"
                               class="btn mt-auto w-100" style="background:#89ba17;color:#fff">
                                Öffnen <i class="bi bi-box-arrow-up-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('') || `<p class="text-center text-muted">Keine Modelle gefunden.</p>`;

            const pagination = panel.querySelector('.inlineModelPagination');
            const totalPages = Math.ceil(filtered.length / perPage);

            pagination.innerHTML = '';
            if (totalPages > 0) {
                const prevLi = createPageItem('&laquo;', page - 1, page === 1);
                pagination.appendChild(prevLi);

                for (let p = 1; p <= totalPages; p++) {
                    const li = createPageItem(p, p, false, p === page);
                    pagination.appendChild(li);
                }

                const nextLi = createPageItem('&raquo;', page + 1, page === totalPages);
                pagination.appendChild(nextLi);
            }

            function createPageItem(label, targetPage, disabled, active = false) {
                const li = document.createElement('li');
                li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;

                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.innerHTML = label;

                if (!disabled) {
                    a.onclick = (e) => {
                        e.preventDefault();
                        renderModelsForPanel(panel, targetPage, perPage);
                    };
                }

                li.appendChild(a);
                return li;
            }
        }

        // Handle search in variation panels
        document.addEventListener('input', e => {
            if (!e.target.classList.contains('inlineModelSearch')) return;

            const panel = e.target.closest('[id^="inlineModelsContainer-var-"]');
            if (panel && panel.dataset.initialized) {
                renderModelsForPanel(panel, 1);
            }
        });



          /* ─────────────────────────────────────────────────────
             4)  Highlight‑Logik  (Filter‑Badges)
          ────────────────────────────────────────────────────── */
          const escRe = s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

          document.querySelectorAll('.prompt-box')
                  .forEach(pre=>pre.dataset.orig=pre.innerHTML);

          document.querySelectorAll('.filter-badge').forEach(b=>{
            b.addEventListener('click',()=>{
              document.querySelectorAll('.filter-badge.active')
                      .forEach(x=>x.classList.remove('active'));
              document.querySelectorAll('.prompt-box')
                      .forEach(pre=>pre.innerHTML=pre.dataset.orig);

              const box=document.getElementById('prompt-'+b.dataset.prompt);
              if(!box) return;
              const rx=new RegExp(`\\b${escRe(b.textContent.trim())}\\b`,'gi');
              box.innerHTML=box.innerHTML.replace(rx,
                '<span class="highlight">$&</span>');
              b.classList.add('active');
            });
          });

          /* ─────────────────────────────────────────────────────
             5)  Delete‑Variation
          ────────────────────────────────────────────────────── */
          document.querySelectorAll('.delete-variation').forEach(btn=>{
            btn.addEventListener('click',async()=>{
              const item = btn.closest('.accordion-item');
              const id   = item?.dataset.varId;
              if(!id) return;

              const ok = await Swal.fire({
                title:'Variation löschen?',
                text :'Dieser Schritt kann nicht rückgängig gemacht werden.',
                icon :'warning',showCancelButton:true,
                confirmButtonText:'Löschen',cancelButtonText:'Abbrechen',
                confirmButtonColor:'#d33'
              }).then(r=>r.isConfirmed);
              if(!ok) return;

              try{
                const res=await fetch(`${deleteVariationUrl}?id=${encodeURIComponent(id)}`,
                                      {method:'POST',body:''});
                if(!res.ok) throw await res.text();
                item.remove();
                Swal.fire({icon:'success',title:'Gelöscht',timer:1500,showConfirmButton:false});
              }catch(err){
                Swal.fire({icon:'error',title:'Fehler',text:String(err)});
              }
            });
          });

          /* ─────────────────────────────────────────────────────
             6)  Edit Haupt‑Prompt  &  Edit Variation
          ────────────────────────────────────────────────────── */
          function exportAndGo(payload){
            sha256(secretKey+JSON.stringify(payload)).then(hash=>{
              localStorage.setItem('import_payload',JSON.stringify({data:payload,hash}));
              const editUrlBase = '@Url.Action("PromptAssistent", "Home", new { area = "User" })';
              location.href = `${editUrlBase}?type=${encodeURIComponent(payload.type)}`;
            });
          }

          /* Edit Main */
          document.querySelector('.edit-btn')
                  ?.addEventListener('click',()=>exportAndGo(state));

                 /* ───────────── EDIT – Variation ───────────── */
        document.querySelectorAll('.edit-variation').forEach(btn => {

          btn.addEventListener('click', () => {
            const item    = btn.closest('.accordion-item');
            if (!item) return;

            /* 1) Daten der Variation aus dem data‑payload holen  */
            const varData = JSON.parse(item.dataset.payload || '{}');

            /* 2) Falls das JSON kein HTML trägt (ältere Datensätze) –
                  nimm das aktuelle <pre>‑Element als Fallback          */
            if (!varData.promptHtml) {
              const preId = btn.dataset.target;
              varData.promptHtml = document.getElementById(preId)?.innerHTML ?? '';
            }

            /* 3) Endgültiges Payload zusammenbauen:
                  – alles vom Haupt‑State,
                  – dann die Variation drüber‑kopieren,
                  – Akronym & Titel ergänzen                          */
            const payload = {
              ...state,          // Basis = Haupt‑Prompt
              ...varData,        // überschreibt PromptHtml + checkedItems + …
              akronym : @Html.Raw(Json.Serialize(Model.Akronym)),
              title   : @Html.Raw(Json.Serialize(Model.Title))          // (oder varData.title, falls vorhanden)
            };

            /* 4) Hash berechnen & rüber in den Assistenten          */
            exportAndGo(payload);
          });

        });


        });


           /* ─────────────────────────────────────────────────────
           7)  Haupt‑Prompt LÖSCHEN
        ───────────────────────────────────────────────────── */
        (() => {
          const btn = document.querySelector('.delete-btn');
          if (!btn) return;

          const deleteUrl = '@Url.Action("DeletePrompt",
                                                                                  "MyPrompts",
                                                                                  new { area = "User" })';

          btn.addEventListener('click', async () => {
            const ok = await Swal.fire({
              title: 'Prompt löschen?',
              text : 'Diese Aktion kann nicht rückgängig gemacht werden.',
              icon : 'warning',
              showCancelButton: true,
              confirmButtonText: 'Löschen',
              cancelButtonText : 'Abbrechen',
              confirmButtonColor:'#d33'
            }).then(r => r.isConfirmed);

            if (!ok) return;

            const res = await fetch(`${deleteUrl}?id=@Model.Id`, { method:'POST' });
            if (res.ok) {
              Swal.fire({icon:'success',title:'Gelöscht',timer:1500,showConfirmButton:false});
              /* zurück zur Liste */
              setTimeout(()=>location.href =
                  '@Url.Action("Index", "MyPrompts", new { area = "User" })', 1200);
            } else {
              Swal.fire({icon:'error',title:'Fehler',text:await res.text()});
            }
          });
        })();

        /* ─────────────────────────────────────────────────────
           8)  In Bibliothek veröffentlichen  (mit Overwrite-Check)
        ───────────────────────────────────────────────────── */
        (() => {

            const btn = document.querySelector('.publish-btn');
            if (!btn) return;

            /* ---- Helper: SHA-256 & Exists-Endpoint ------------------- */
            async function sha256(str) {
                const buf = await crypto.subtle.digest('SHA-256',
                               new TextEncoder().encode(str));
                return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
            }

            const existsUrl = '@Url.Action("Exists",
                                                                                      "PromptTemplateApi",
                                                                                      new { area = "Api" })';

            async function akronymExists(akronym) {
                const res = await fetch(`${existsUrl}?akronym=${encodeURIComponent(akronym)}`,
                                        { credentials:'same-origin' });
                if (res.status === 404) return false;          // Fallback bei älteren Deploys
                const { exists } = await res.json();           // { exists : true|false }
                return !!exists;
            }

            /* ---- Main-Click-Handler ---------------------------------- */
            btn.addEventListener('click', async () => {

                const s        = window.promptState;           // Razor-Payload (oben injiziert)
                const akronym  = (s.akronym || btn.dataset.akronym || '').trim();
                if (!akronym)
                    return Swal.fire({ icon:'error', title:'Akronym fehlt' });

                /* 1)  Vorhanden? -------------------------------------- */
                let alreadyThere = false;
                try { alreadyThere = await akronymExists(akronym); }
                catch(e){ return Swal.fire({ icon:'error', title:'Fehler', text:String(e) }); }

                /* 2)  Bestätigungs-Dialog ------------------------------ */
                const proceed = await Swal.fire({
                    title : alreadyThere
                            ? `Akronym „${akronym}“ existiert bereits.`
                            : 'In Bibliothek speichern?',
                    text  : alreadyThere
                            ? 'Möchtest du den bestehenden Prompt überschreiben?'
                            : 'Bist du sicher, dass du diesen Prompt speichern möchtest?',
                    icon  : alreadyThere ? 'warning' : 'question',
                    showCancelButton : true,
                    confirmButtonText: alreadyThere ? 'Überschreiben' : 'Speichern',
                    cancelButtonText : 'Abbrechen'
                }).then(r => r.isConfirmed);

                if (!proceed) return;

                /* 3)  Payload bauen ----------------------------------- */
                const bodyPayload = {
                    Akronym           : s.akronym,
                    Title             : s.title,
                    Beschreibung      : s.beschreibung       ?? '',
                    Schluesselbegriffe: s.schluesselbegriffe ?? '',
                    Thema             : s.thema              ?? '',
                    Ziele             : s.ziele              ?? '',
                    PromptHtml        : s.promptHtml,
                    PromptType        : s.type,
                    FilterJson        : JSON.stringify(s.checkedItems ?? []),
                    Temperatur        : s.temperatur         ?? 0,
                    MaxZeichen        : s.maxZeichen         ?? null,
                    UsedModels        : s.usedModels         ?? '',
                    GeneratedImagePath: s.generatedImagePath ?? ''
                };
                const metaHash = await sha256(JSON.stringify(bodyPayload));
                const body     = { ...bodyPayload, MetaHash: metaHash };

                /* 4)  POST an /Publish -------------------------------- */
                try {
                    const res = await fetch(
                        '@Url.Action("Publish", "PromptTemplateApi", new { area = "Api" })',
                        { method :'POST',
                          headers:{ 'Content-Type':'application/json' },
                          body   : JSON.stringify(body) });

                    if (!res.ok) throw await res.text();

                    Swal.fire({
                        icon : 'success',
                        title: alreadyThere ? 'Überschrieben!' : 'Gespeichert!',
                        timer: 1500,
                        showConfirmButton: false
                    });

                } catch(err){
                    Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
                }

            });
        })();

                 /* ==================================================
               EXTRA VALIDATION – “Used Models” form
          ================================================== */
          const usedModelsForm = document.querySelector('form[action*="UpdateUsedModels"]');
          if (usedModelsForm) {
            usedModelsForm.addEventListener('submit', e => {
              const input = usedModelsForm.querySelector('input[name="usedModels"]');
              if (!input || !input.value.trim()) {
                e.preventDefault();                            // 🆕 stop empty submits
                Swal.fire({                                    // 🆕 nice error modal
                  icon: 'error',
                  title: 'Eingabe fehlt',
                  text: 'Bitte geben Sie mindestens ein verwendetes Modell an!'
                });
              }
            });
          }

                 document.querySelectorAll('form[action*="UploadImage"]').forEach(form => {

          form.addEventListener('submit', e => {
            const fileChosen = !!form.querySelector('input[name="imageFile"]')?.files[0];

            if (!fileChosen) {
              e.preventDefault();          // ⛔️ nichts an den Server schicken
              Swal.fire({
                icon:  'error',
                title: 'Fehler',
                text:  'Bitte zuerst eine Bild-Datei auswählen!',
                confirmButtonColor: '#d33'
              });
            }
          });

        });

        /* ─────────────────────────────────────────────────────
           Mobile menu button handlers
        ───────────────────────────────────────────────────── */
        // Mobile Edit button - trigger same action as desktop edit button
        document.querySelector('.mobile-edit-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.edit-btn')?.click();
        });

        // Mobile Delete button - trigger same action as desktop delete button
        document.querySelector('.mobile-delete-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.delete-btn')?.click();
        });

        // Mobile Publish button - trigger same action as desktop publish button
        document.querySelector('.mobile-publish-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.publish-btn')?.click();
        });

    </script>


