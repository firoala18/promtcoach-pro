@using Microsoft.AspNetCore.Identity
@using ProjectsWebApp.DataAccsess.Repository.IRepository
@using System.Linq
@using System.Collections.Generic
@model IEnumerable<FilterCategory>
@inject UserManager<IdentityUser> UserManager
@{

    ViewData["Title"] = "Prompt Assistent";
    var currentType = (PromptType)ViewBag.Type;
    var currentUser = await UserManager.GetUserAsync(User);
    var currentUserId = currentUser?.Id;
    var isAdminUser = User.IsInRole("Admin") || User.IsInRole("SuperAdmin") || User.IsInRole("Coach");
    var isDozentUser = User.IsInRole("Dozent");
    // Only admins and dozents can enter new keywords; normal users can only select from suggestions
    var canAddNewKeywords = isAdminUser || isDozentUser;

    var userGroups = ViewBag.UserGroups as List<string> ?? new List<string>();
    var activeGroup = ViewBag.ActiveGroup as string ?? "Ohne Gruppe";
    var aiGroups   = ViewBag.AiGroups as List<string> ?? userGroups;

    // Für Domäne (Eigenfilter), Framework & Meta: nur eigene Kategorien
    // Sonst: alle sichtbaren Kategorien dieses Typs
    var categories = (currentType == PromptType.Eigenfilter
                      || currentType == PromptType.Framework
                      || currentType == PromptType.Meta)
        ? Model
            .Where(cat => cat.Type == currentType
                       && cat.UserId == currentUserId)
            .OrderBy(cat => cat.DisplayOrder)
            .ToList()
        : Model
            .Where(cat => cat.Type == currentType && (!cat.IsHidden || isAdminUser))
            .OrderBy(cat => cat.DisplayOrder)
            .ToList();

    var addVariationUrl = Url.Action(
    "AddVariation",          // action
    "PromptTemplate",        // controller
    new { area = "Admin" }); // area

    /// Replaces CR/LF by the HTML entity &#10;  (works with dataset)
    string AttrEscape(string s) =>
        (s ?? "").Replace("\r", "").Replace("\n", "&#10;")
                 .Replace("\"", "&quot;");

    /* ── Überschrift grammatikalisch anpassen ─────────────── */
    string headline = currentType switch
    {
        PromptType.Beruf       => "KI-Agenten ",
        PromptType.Bildung     => "Domäne",
        PromptType.Eigenfilter => "Szenarien",
        _                      => $"{currentType}"
    };

    // Feste Anzeige-Reihenfolge für Prompt-Typ-Tabs
    // Soll mit Prompt-Engineering-Kacheln übereinstimmen:
    // Text, Bild, Video, Sound, Domäne, KI-Agent, Szenarien, Framework, Meta
    var orderedTypes = new[]
    {
        PromptType.Text,
        PromptType.Bild,
        PromptType.Video,
        PromptType.Sound,
        PromptType.Bildung,     // Szenarien
        PromptType.Beruf,       // KI-Agent
        PromptType.Eigenfilter, // Domäne
        PromptType.Framework,
        PromptType.Meta
    };

    Func<PromptType, string> typeLabel = pt => pt switch
    {
        PromptType.Eigenfilter => "Szenarien",
        PromptType.Beruf       => "KI-Agent",
        PromptType.Bildung     => "Domäne",
        _                       => pt.ToString()
    };
  
}

<style>
    :root {
        --c-bg: #f6f7f9;
        --c-tab: #646c77;
        --c-tab-active: #587a0f;
        --c-item-bg: #ffffff;
        --c-border: #ccd1d9;
        --c-check: #89ba17;
    }

    /* Save Assistant Modal - wider and responsive */
    #saveAssistantModal .modal-dialog {
        max-width: 900px;
        width: 95%;
        margin: 1.75rem auto;
    }
    @@media (min-width: 1200px) {
        #saveAssistantModal .modal-dialog {
            max-width: 1000px;
        }
    }
    @@media (max-width: 768px) {
        #saveAssistantModal .modal-dialog {
            max-width: 100%;
            width: 100%;
            margin: 0.5rem;
        }
    }
    @@media (max-width: 576px) {
        #saveAssistantModal .modal-dialog {
            margin: 0;
            width: 100%;
            max-width: 100%;
            min-height: 100vh;
        }
        #saveAssistantModal .modal-content {
            border-radius: 0;
            min-height: 100vh;
        }
    }

    .btn-active {
        background: #89ba17;
        color: white;
    }

        .btn-active:hover {
            background: #89ba17;
            color: white;
        }

    /* site accent utility */
    .accent-green { color:#89ba17 !important; }

    .scalable-textarea {
        min-height: 3.5rem;
        resize: vertical; /* desktop can drag; mobile gets auto-grow */
        overflow-y: hidden; /* prevent inner scrollbar while auto-growing */
        font-size: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }

    /* On small screens, disable manual resize (auto-grow takes over) */
    @@media (max-width: 576px){
        .scalable-textarea { resize: none; }
    }


    .accordion .accordion-button {
        background-color: #404040;
        color: #fff;
        font-weight: bold;
        border-radius: 0.5rem;
    }

        .accordion .accordion-button:not(.collapsed) {
            color: #fff;
            background-color: #404040;
            box-shadow: none;
        }

    .accordion .accordion-body {
        /* background: linear-gradient(135deg, #9A9A9A, #6B6B6B); */
        border-radius: 0.5rem;
        padding: 2rem;
    }

    .accordion-item {
        border: solid 1px #191919;
        border-radius: 10px;
    }

    /* 1) Make the nav-tabs dark gray (#393939) */
    #promptTypeTabs:not(.custom-pills) .nav-link {
        background: #393939 !important;
        color: #ccc !important;
    }

        #promptTypeTabs:not(.custom-pills) .nav-link.active {
            background: #89ba17 !important; /* keep your active accent */
            color: #fff !important;
        }

    /* 2) Keep the accordion chevron white */
    .accordion-button {
        color: #fff !important; /* text */
    }

        .accordion-button::after {
            /* bootstrap inlines a dark SVG; this inverts it to white */
            filter: brightness(0) invert(1);
        }




    .card-prompt {
        /* background: linear-gradient(135deg, #e0f7f1, #f9f9f9); */
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .filter-toolbar {
        position: relative;
        display: flex;
        overflow-x: auto;
        padding: 0.6rem 1rem; /* ⬅️ Increase padding for vertical space */
        gap: .25rem; /* ⬅️ Slightly more spacing between tabs */
        scrollbar-width: none;
        min-height: 3.5rem; /* ⬅️ Ensures enough vertical space for indicator */
    }


        .filter-toolbar::-webkit-scrollbar {
            display: none;
        }

    .filter-tab {
        position: relative;
        background: #89ba17;
        color: #fff;
        border: none;
        border-radius: .5rem;
        padding: .4rem 1.1rem;
        /* font-weight: 600; */
        white-space: nowrap;
        transition: background .25s;
        padding: 0.55rem 1.2rem; /* ⬅️ Slightly taller tab buttons */
        font-size: 0.95rem;
    }

        /* Admin-only: highlight AI-generated categories */
        .filter-tab.ai-generated {
            --accent: #89ba17;
            --accent2: #00b36c;
            background: linear-gradient(135deg,var(--accent),var(--accent2)); /* deep green */
            color: #fff;         /* white text */
            /* border: 2px dashed #89ba17; */
            box-shadow: 0 0 0 2px rgba(58, 204, 89, .15);
        }
        .filter-tab.ai-generated.active {
            background: #1a6b3a; /* darker when active */
            border-color: #2db049;
        }

        .filter-tab.ai-generated .ai-icon {
            margin-left: .35rem;
            color: #fff;
        }

        .filter-tab.active {
            background: #2db049;
        }

        /* Lesezeichen, Eye, and Pin buttons - same green color scheme and consistent size */
        .filter-tab[data-category="__bm__"],
        .js-category-visibility,
        #toggle-helper-float {
            background: #89ba17 !important;
            color: #fff !important;
            border: none !important;
            border-radius: .5rem !important;
            padding: .45rem .65rem !important;
            min-width: 36px;
            min-height: 36px;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, transform 0.15s ease;
        }
        .filter-tab[data-category="__bm__"]:hover,
        .js-category-visibility:hover,
        #toggle-helper-float:hover {
            background: #7aa614 !important;
            transform: translateY(-1px);
        }
        .filter-tab[data-category="__bm__"].active,
        .js-category-visibility.active,
        #toggle-helper-float[aria-pressed="true"] {
            background: #2db049 !important;
        }
        .filter-tab[data-category="__bm__"] i,
        .js-category-visibility i,
        #toggle-helper-float i {
            font-size: 1rem;
        }

        .filter-tab:focus-visible {
            outline: 2px solid #fff3;
        }

    /* make all tabs dark gray */


    .tab-indicator {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        background: #2db049;
        transition: transform .25s,width .25s;
        height: 4px; /* ⬅️ Make the indicator more prominent */
        bottom: 2px; /* ⬅️ Slightly raise it */
        border-radius: 2px;
        transition: transform .3s ease, width .3s ease;
    }

    .filter-content {
        background: var(--c-bg);
        max-height: 45vh;
        overflow: auto;
        padding: 1.25rem;
    }

    .filter-checkbox {
        display: flex;
        align-items: center;
        position: relative;
        gap: .75rem;
        padding: 1rem 0; /* rely on flex, no artificial right padding */
        border-bottom: 1px solid var(--c-border);
    }

        .filter-checkbox:last-child {
            border-bottom: none;
        }

        .filter-checkbox input,
        .filter-checkbox .filter-label {
            cursor: pointer;
        }

        .filter-checkbox input {
            position: absolute;
            top: 30%; /* centre it …  */
            left: 0;
            transform: translateY(-50%); /* … vertically */
            width: 1.1rem;
            height: 1.1rem;
            margin: 0;
            opacity: 0; /* keep it invisible */
            cursor: pointer;
        }

    /* Checkmark (Haken) sichtbar machen */
    .checkmark {
        width: 1.1rem;
        height: 1.1rem;
        border: 2px solid var(--c-border);
        border-radius: .25rem;
        flex-shrink: 0;
        transition: background .2s, border-color .2s;
        pointer-events: none;
    }

    /* Force-hide filtered items regardless of other layout rules */
    .filter-checkbox.is-hidden { display: none !important; }

    .filter-checkbox input:checked + .checkmark {
        background: var(--c-check);
        border-color: var(--c-check);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14 10'%3E%3Cpath fill='white' d='M1 5.5l3.5 3.5 8-8'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
    }

    .filter-label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem; /* Abstand zwischen Text und Badge */
        /* optional: white-space: nowrap;  verhindert, dass Text und Badge getrennt werden */
        flex: 1 1 auto; /* occupy remaining space so bookmark button can sit on the right */
        min-width: 0;   /* allow text to truncate instead of overlapping */
    }


    .info-badge {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-size: .85rem;
        line-height: 1;
        text-align: center;
        width: 1.25rem;
        height: 1.25rem;
        border: 1px solid var(--c-border);
        border-radius: 50%;
        margin-left: .45rem;
        cursor: pointer;
        color: #000;
        background: #fff;
        vertical-align: middle;
    }

        .info-badge:hover {
            background: var(--c-tab-active);
            color: #fff;
            border-color: var(--c-tab-active);
        }


    /* crystal-glass popup */
    /* Überschreibe das transparente Glas-Popup */
    .glass-popup {
        background: #fff !important; /* weißer Hintergrund */
        color: #222 !important; /* dunkle Schrift */
        font-size: 1.2rem !important; /* etwas größere Textgröße */
        backdrop-filter: none !important; /* entferne Unschärfe dahinter */
        box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
    }

        /* Styling für die Close-Schaltfläche */
        .glass-popup .swal2-close {
            color: #000 !important; /* schwarzes × */
            font-size: 1.5rem !important; /* größere × */
            width: 2rem;
            height: 2rem;
            line-height: 1.5rem;
            opacity: 1 !important; /* immer sichtbar */
        }

        /* Optional: Padding und Abstand justieren */
        .glass-popup .swal2-html-container {
            padding: 1.5rem 1.25rem !important;
            line-height: 1.5 !important;
        }

    /* SweetAlert2 “OK”-Button grün einfärben */
    .swal2-styled.swal2-confirm {
        background-color: #89ba17 !important;
        border-color: #89ba17 !important;
        color: #fff !important;
    }

        /* Optional: leichten Hover-Effekt */
        .swal2-styled.swal2-confirm:hover {
            background-color: #32b14e !important;
            border-color: #32b14e !important;
        }


    /* badge highlight when active */
    .info-badge.active {
        background: var(--c-tab-active);
        color: #fff;
        border-color: var(--c-tab-active);
    }

    .filter-panel {
        overflow-y: auto; /* allow panel to scroll if needed */
        overflow-x: visible; /* ensure badges at the edge are not clipped */
        transition: opacity 0.3s ease;
        max-height: 0; /* keep it hidden when not active */
        padding: 0;
        opacity: 0;
        pointer-events: none;
    }

        .filter-panel.active {
            max-height: none; /* remove the hard cap */
            padding: 1rem 1rem 1rem 0; /* base right padding so the KI pill has room */
            opacity: 1;
            pointer-events: all;
        }
        /* Keep list padding compact (no extra whitespace) */
        .filter-panel.active .filter-items { padding-right: .75rem; }
        /* Admin-only: AI panel highlight (left border removed per UX request) */
        .filter-panel.panel-ai {
            border-left: 0;
            border-radius: .25rem;
            position: relative;
        }

        .filter-panel .ai-badge {
            position: absolute;
            top: .45rem;
            right: 1rem;
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            background: #89ba17;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: .15rem .6rem;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,.08);
            z-index: 5; /* ensure it sits above the card edges */
            pointer-events: none; /* do not block clicks on row controls beneath */
        }

    /* Inline tags added by AI (for items) */
    .filter-label .ai-tag,
    .filter-label .sugg-tag {
        display: inline-flex;
        align-items: center;
        padding: .1rem .45rem;
        border-radius: 999px;
        font-size: .75rem;
        line-height: 1;
        margin-left: .35rem;
        white-space: nowrap;
    }
    .filter-label .ai-tag { background: #e6f7ef; color: #198754; }
    .filter-label .sugg-tag { background: #e7f1ff; color: #0d6efd; }

    /* Keep the bookmark button in a fixed right column */
    .filter-checkbox .btn-bookmark {
        position: static;           /* keep inside flex flow */
        margin-left: auto;          /* push to the right */
        align-self: center;         /* vertical centering */
        transform: none;            /* no translate needed */
        z-index: auto;
        flex: 0 0 auto;             /* do not grow/shrink */
        width: 1.5rem;
        height: 1.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: color 0.2s ease, background 0.2s ease;
    }
    /* Green color when bookmark is active (filled) */
    .filter-checkbox .btn-bookmark:has(.bi-bookmark-fill),
    .filter-checkbox .btn-bookmark .bi-bookmark-fill {
        color: #2db049 !important;
    }
    .filter-checkbox .btn-bookmark:has(.bi-bookmark-fill):hover {
                color: #89ba17 !important;
    }

    /* In AI panels, push the entire list slightly down so the top-right badge clears the first row,
       keeping all bookmark buttons aligned vertically at the same X position. */
    .filter-panel.panel-ai .filter-items { padding-top: 1.1rem; }

    /* Empty-state for bookmarks panel */
    .bm-empty { color: #6c757d; }

    /* Summary box clear button placement */
    #filter-summary { position: relative; }
    #filter-summary #clear-filters {
        position: absolute;
        top: .5rem;
        right: .5rem;
        margin: 0;
        z-index: 2;
    }

    /* KI‑Assistent‑Studio header in gray tone */
    /* Studio header as full gray capsule */
    .group-card .group-title.studio {
        display: flex;
        align-items: center;
        gap: .5rem;
        width: 100%;
        background: #f2f4f7 !important; /* light gray */
        color: #111827;                  /* slate-900 */
        border: 1px solid #e5e7eb;
        border-radius: .75rem;
        padding: .6rem .9rem;            /* give it height */
        box-shadow: 0 4px 10px rgba(16,24,40,.04);
    }
    .group-card .group-title.studio .chev { color: #6b7280; } /* slate-500 chevron */
    .group-card .group-title.studio i.bi-robot { color: #89ba17; } /* keep robot icon green */
    .group-card .group-title.studio:not(.collapsed) {
        background: #e9ecef;
        border-color: #dfe3e8;
    }
     .accent-green { color:#89ba17 !important; }
    /* Modern accordion for KI‑Auswahl */
    .modern-accordion .accordion-item { border:1px solid #e7f6ed; border-radius:.65rem; overflow:hidden; }
    .modern-accordion .accordion-button { background:#f6fffa; color:#1f7d56; color:black}
    .modern-accordion .accordion-button:not(.collapsed) { background:#eefaf3; color:#1f7d56; box-shadow:none; }
    /* Ensure chevron is black on light background (override global white) */
    .modern-accordion .accordion-button::after {
        filter: none !important; /* cancel global white invert */
        /* force black chevron icon */
        --bs-accordion-btn-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='black'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
        --bs-accordion-btn-active-icon: var(--bs-accordion-btn-icon);
    }
    .ki-acc-btn .badge.bg-success {
        background: #89ba17 !important;
        color: black!important;
    }
    .ai-list .ai-group { margin-bottom:.75rem; }
    .ai-list .ai-group-title { font-weight:600; color:#208a43; margin-bottom:.25rem; }
    .ai-list .ai-chip { display:inline-block; margin:.2rem .3rem .2rem 0; background:#eefaf3; color:#1f7d56; border:1px solid #bdebd0; padding:.25rem .5rem; border-radius:999px; font-size:.9rem; }
    /* Mark AI-selected items in panels (remove vertical left border) */
    .filter-checkbox.ai-selected { background:#f6fffa; border-left:0; }
    .filter-checkbox.ai-selected .ai-tag { margin-left:.5rem; background:#89ba17; color:#fff; border-radius:999px; font-size:.7rem; padding:.05rem .4rem; }
    .filter-checkbox.ai-suggested { background:#f0f7ff; border-left:0; }
    .filter-checkbox.ai-suggested .sugg-tag { margin-left:.5rem; background:#3b82f6; color:#fff; border-radius:999px; font-size:.7rem; padding:.05rem .4rem; }
    /* ← Add this at the end: */
    .tooltip-inner {
        max-width: 400px !important;
        white-space: normal;
    }

    .selected-filters {
        padding: .5rem .75rem;
        background: rgba(0,0,0,0.03);
        border-radius: .5rem;
        font-size: .875rem;
    }

        .selected-filters .badge {
            background-color: var(--c-tab-active);
            color: white;
            padding: .4rem .6rem;
            border-radius: 2rem;
            font-weight: 500;
        }

            .selected-filters .badge .remove-tag {
                background: none;
                border: none;
                color: #fff;
                margin-left: .5rem;
                /* cursor: pointer; */
            }

    .form-section {
        background: #f9f9f9;
        padding: 1rem;
        border-radius: .5rem;
        margin-bottom: 1.5rem;
    }

    .form-control {
        background-color: #fff;
    }

    .form-inline-group {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

        .form-inline-group label {
            font-weight: 600;
            margin-bottom: 0;
        }

    #editor {
        resize: vertical;
        min-height: 300px;
        height: 400px;
        max-height: 90vh;
    }

    #editor-container {
        margin-bottom: 2rem;
        position: relative;
    }

    .ck-editor__editable div {
        margin-bottom: 0.25rem !important;
        line-height: 1.4;
    }

    .ck-editor__editable_inline {
        min-height: 300px;
        resize: vertical;
        overflow: auto;
    }

    .fullscreen-editor {
        position: fixed !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999;
        background: #fefefe linear-gradient(to bottom right, #eafcf7, #ffffff);
        padding: 3rem 5%;
        overflow: auto;
        box-shadow: inset 0 0 80px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        border-radius: 0;
    }


        .fullscreen-editor .ck-editor__editable[role="textbox"] {
            flex-grow: 1;
            min-height: 400px;
            resize: vertical;
            overflow: auto;
        }

    .prompt-actions .btn {
        border-radius: 0.5rem;
        font-size: 0.95rem;
        min-width: 180px;
        transition: all 0.2s ease-in-out;
    }

        .prompt-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 0.3rem 0.6rem rgba(0, 0, 0, 0.1);
        }

    #filter-summary {
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .filter-summary-group {
        margin-bottom: 1rem;
    }

    .filter-summary-group-title {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .filter-summary-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 1rem;
        margin: 1rem;
    }

        .filter-summary-item span,
        .criteria-item span {
            line-height: 1.7rem; /*  = height of the round buttons  */
            /* or, if you prefer to keep the default line-height: */
            align-self: center;
        }

        .filter-summary-item .plus-btn {
            width: 1.7rem;
            height: 1.7rem;
            padding: 0; /* remove bootstrap btn-sm padding */
            display: grid; /* pixel-perfect centering */
            place-items: center;
            border: 1px solid #89ba17;
            border-radius: 50%;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1; /* avoid vertical drift */
        }
        .filter-summary-item .plus-btn i { line-height: 1; font-size: 0.95rem; display: block; transform: translateY(-0.5px); }

    .divider {
        height: 2px;
        border: none;
        margin: 2rem 0;
        background: linear-gradient(to right, transparent, #587a0f, transparent);
        opacity: 0.8;
    }

    /* Toggle container */
    #inlineModelsContainer {
        display: none;
        padding: 1rem;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 1rem;
        animation: fadeInSlide 0.5s ease;
    }

    @@keyframes fadeInSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }



    /* Model cards layout */
    .model-card-grid .card {
        border: 1px solid #89ba17;
        border-radius: 1rem;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
        height: 100%;
    }

        .model-card-grid .card:hover {
            transform: translateY(-4px);
        }

    .model-card-grid .card-title {
        font-size: 1.1rem;
        color: #00a86b;
        font-weight: bold;
        text-align: center;
    }


    .btn-copy {
        background-color: #89ba17;
        color: white;
        border: none;
    }

    .btn-reset {
        background-color: #991d30;
        color: white;
        border: none;
        border: 1px solid #ed5d41;
    }

        .btn-reset:hover {
            background-color: #991d30;
            color: white;
        }

    .btn-pdf {
        background-color: #304c3c;
        color: white;
        border: none;
    }

    .btn-json {
        background-color: #ed5d41;
        color: white;
        border: none;
    }

    .btn-import {
        background-color: #ed5d41;
        color: white;
        border: none;
    }

    .btn-tokens {
        background-color: #89ba17;
        color: white;
        border: none;
    }

    .btn-models {
        background-color: #89ba17;
        color: white;
        border: none;
    }

    .btn-Bib {
        background-color: #191919;
        color: white;
        border: none;
    }

    .save-to-lib {
        background: #004f72;
        color: white;
        border-right: 1px solid white;
    }

    .save-to-lib-var {
        background: #004f72;
        color: white;
    }

    .btn-export {
        background: #ed5d41;
        color: white;
    }

    .btn-aufeheben {
        border: 1px solid red;
    }

        .btn-aufeheben:hover {
            border: 1px solid red;
        }

    .btn-export:hover, .save-to-lib-var:hover, .save-to-lib:hover, .btn-Bib:hover, .btn-models:hover, .btn-tokens:hover, .btn-import:hover, .btn-json:hover, .btn-pdf:hover, .btn:hover {
        border: 1px solid #7d8791;
    }
    /*    .prompt-actions .btn:hover {
                filter: brightness(1.05);
                transform: translateY(-1px);
                box-shadow: 0 0.3rem 0.6rem rgba(0, 0, 0, 0.15);
            } */


    #colorPalette .color-swatch {
        width: 2.5rem;
        height: 2.5rem;
        padding: 0;
        border: 4px solid #ccc; /* <-- Add this line */
        border-radius: 0.5rem;
        cursor: pointer;
        background-clip: content-box; /* optional for better appearance */
    }

    #applyColors {
        padding: .45rem 1.2rem;
        font-weight: 600;
    }

    /* Keyword suggestions (Schlüsselbegriffe) */
    .kw-accord-toggle {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        color: #1f7d56;
    }

    .kw-accord {
        border: 1px solid #e7ebf2;
        border-radius: .75rem;
        padding: .75rem;
        background: #fff;
    }

    .kw-chip {
        display: inline-block;
        background: #f6f7f9;
        border: 1px solid #e5e7eb;
        color: #333;
        padding: .35rem .7rem;
        border-radius: .5rem;
        margin: .35rem .35rem 0 0;
        cursor: pointer;
        transition: background .15s ease, transform .05s ease;
        white-space: nowrap;
    }
        .kw-chip:hover { background: #eef1f4; }
        .kw-chip:active { transform: scale(.98); }
        .kw-chip.active { background:#587a0f; color:#fff; border-color:#587a0f; }

    /* Integrated input look: wrapper becomes the visual control */
    .kw-input-wrap {
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        background: #fff;
        border: solid 1px #A1A1A1;
        overflow: hidden; /* keep inner button fully inside rounded frame */
    }

    .kw-input-wrap:focus-within { border-color:#80d9b0; box-shadow:0 0 0 .25rem rgba(58,204,89,.15); }
    .kw-input-wrap .kw-input { border:0; box-shadow:none; outline:0; }
    .kw-input { padding-right: 8.25rem; }
    .kw-in-input {
        position: absolute;
        right: .4rem;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        display: inline-flex;
        align-items: center;
        gap: .3rem;
        border: 1px solid #e5e7eb;
        background: linear-gradient(180deg,#ffffff,#f7fafc);
        color: #0f172a;
        border-radius: .45rem;
        padding: .22rem .6rem;
        line-height: 1;
        white-space: nowrap;
    }
        .kw-in-input:hover {
            background: #f3f6fb;
            border-color: #d7ddea;
            color: #4F4F4F;
        }
    .kw-in-input:focus { outline: none; box-shadow: 0 0 0 .1rem rgba(58,204,89,.25); border-color:#80d9b0; }
    /* Open state: neutral/gray */
    .kw-in-input.open { background:#f3f6fb; border-color:#d7ddea; color:#4F4F4F; }
    .kw-in-input .btn-text { display: inline; }

    /* Readonly keyword input for normal users */
    .kw-input.kw-readonly {
        background: #f8fafc;
        cursor: pointer;
        color: #475569;
    }
    .kw-input.kw-readonly:focus {
        background: #f8fafc;
    }
    .kw-input-wrap:has(.kw-readonly):focus-within {
        border-color: #cbd5e1;
        box-shadow: none;
    }
    @@media (max-width: 576px){
        .kw-input { padding-right: 3rem; }
        .kw-in-input { padding: .2rem .45rem; font-size: .95rem; }
        .kw-in-input .btn-text { display: none; }
    }
      .kw-in-input.btn-accent { background:#89ba17; color:#fff; border-color:#32b14e; }
  .kw-in-input.btn-accent:hover { filter:brightness(.98); }
    /* Suggestions accordion container animation */
    #kwAccordion {
        overflow: hidden;
        height: 0;
        opacity: 0;
        transition: height .28s ease, opacity .28s ease;
    }
        #kwAccordion.open {
            opacity: 1;
        }

    /* Limit suggestions to ~3 rows with scroll */
    #kwChips {
        max-height: 7.5rem; /* ≈ 3 rows */
        overflow-y: auto;
        padding-right: .25rem;
    }

    /* ――― prompt-type nav ――― */
    #promptTypeTabs {
        border-bottom: 2px solid #89ba17;
    }

        #promptTypeTabs:not(.custom-pills) .nav-link {
            color: #ccc;
            background: #1e1e2d;
            border: 1px solid transparent;
            border-radius: .4rem .4rem 0 0;
            padding: .45rem 1.25rem;
            transition: .25s;
        }

            #promptTypeTabs:not(.custom-pills) .nav-link:hover {
                color: #fff;
                background: #2a2a3a;
            }

            #promptTypeTabs:not(.custom-pills) .nav-link.active {
                color: #fff;
                background: #89ba17;
                border-color: #587a0f #587a0f var(--c-bg);
                font-weight: 600;
            }

    .type-card {
        border: 1px solid #6B6B6B;
        margin-top: 0px;
    }

    .form-inline-group {
        margin-bottom: 0 !important;
    }

    #promptTypeTabs {
        margin-bottom: 0 !important;
    }

    /* Wrapper als Flex, damit alles zentriert wird */
    .filter-toolbar-wrapper {
        display: flex;
        align-items: center;
        position: relative;
    }

    /* Prompt-Editor generation overlay */
    #editor-wrapper { position: relative; }
    #editor-wrapper.blurring .form-control { filter: blur(3px); pointer-events: none; }
    .editor-overlay {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.75));
        backdrop-filter: blur(2px);
        z-index: 5;
    }
    .editor-overlay .overlay-box {
        border: 1px solid #e8ecf3;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 10px 24px rgba(16,24,40,.08);
    }

    /* AI Prompt generate button – align with existing green CTA */
    .btn-ai-generate {
        --accent: #89ba17;
        --accent2: #00b36c;
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        color: #fff;
        border: 0;
        border-radius: .5rem;
        font-weight: 600;
        letter-spacing: .2px;
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        box-shadow: 0 10px 24px rgba(58,204,89,.35), inset 0 0 0 1px rgba(255,255,255,.15);
        transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn-ai-generate i { font-size: 1rem; }
    .btn-ai-generate:hover {  filter: brightness(1.04); box-shadow: 0 14px 28px rgba(58,204,89,.45);color:white; }
    /* .btn-ai-generate:active { transform: translateY(0); } */

    /* Vertical divider between header buttons */
    .btn-v-divider {
        width: 1px;
        height: 24px;
        background: rgba(0,0,0,.12);
        display: inline-block;
        align-self: center;
    }
    /* Filter search styling */
    .filter-search-wrap .input-group-text {
        border-color: #32b14e;
        background: #fff;
        color: #0f172a;
        border-right: 0;
    }
    .filter-search-wrap .form-control {
        border-color: #32b14e;
        border-left: 0;
        box-shadow: none;
    }
    .filter-search-wrap .form-control:focus {
        border-color: #80d9b0;
        box-shadow: 0 0 0 .2rem rgba(58,204,89,.15);
    }
    .filter-search-wrap .btn-clear {
        border-color: #32b14e;
        color: #0f172a;
        background: #fff;
    }
    .filter-search-wrap .btn-clear:hover {
        background: #f3fff6;
        border-color: #2db049;
    }

    /* Loading overlay over filter tabs while generating */
    .filter-toolbar-wrapper .filter-gen-overlay {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.92));
        backdrop-filter: blur(2px);
        z-index: 10;
        border-radius: .5rem;
    }
    .filter-toolbar-wrapper.is-loading .filter-gen-overlay { display: flex; }
    .filter-toolbar-wrapper.is-loading .filter-toolbar,
    .filter-toolbar-wrapper.is-loading .scroll-arrow {
        filter: blur(2px);
        pointer-events: none;
        user-select: none;
    }

    /* Pfeile quadratisch, weißer Hintergrund, kein overhang */
    .scroll-arrow {
        flex: 0 0 2.5rem;
        height: 2.5rem;
        border: 1px solid #32b14e;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Abstand zwischen Pfeilen und Tabs */
    .filter-toolbar {
        flex: 1;
        overflow-x: auto;
        margin: 0 0.5rem;
    }

    /* Icon etwas größer */
    .scroll-arrow .bi {
        font-size: 1.25rem;
        color: #333;
    }

    /* dezenter Hover‐Effekt */
    .scroll-arrow:hover {
        background-color: #e9ecef;
    }


    .custom-swal-popup .custom-wide-input {
        width: 100% !important;
        box-sizing: border-box;
        font-size: 1rem;
    }

    /* Bubble pills for prompt types (top navigation) */
    #promptTypeTabs.custom-pills {
        border-bottom: none;
        display: flex;
        flex-wrap: wrap !important;
        gap: .4rem;
        justify-content: center;
        margin-bottom: .9rem !important; /* etwas mehr Abstand nach unten für alle Pills, überschreibt frühere 0-Margin */
        max-width: 100%;
        width: 100%;
    }

    #promptTypeTabs.custom-pills .nav-item {
        flex: 0 0 auto;
    }

    #promptTypeTabs.custom-pills .nav-link {
        background: #f1f3f5 !important;
        color: #333 !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 999px !important;
        padding: .45rem 1rem;
        font-weight: 600;
        margin-bottom: .4rem;
        transition: background .2s,color .2s, box-shadow .2s;
        white-space: nowrap;
    }

    #promptTypeTabs.custom-pills .nav-link:hover {
        background: #e9ecef !important;
        color: #111 !important;
    }

    #promptTypeTabs.custom-pills .nav-link.active {
        background: #89ba17 !important;
        color: #fff !important;
        border-color: #89ba17 !important;
        box-shadow: 0 6px 14px rgba(58,204,89,.25);
    }

    /* Domäne / Framework / Meta – blaue Pills (idle) */
    #promptTypeTabs.custom-pills .nav-link.domain-pill {
        background: linear-gradient(135deg, #1f3470 0%, #3a4f8b 60%, #182b63 100%) !important;
        color: #fff !important;
        border-color: #182b63 !important;
        border-width: 2px;
        box-shadow: 0 6px 14px rgba(24,43,99,.35);
    }

    /* Wenn aktiv, gleiche grüne Optik wie die übrigen Typen */
    #promptTypeTabs.custom-pills .nav-link.domain-pill.active {
        background: #89ba17 !important;
        color: #fff !important;
        border-color: #89ba17 !important;
        box-shadow: 0 6px 14px rgba(58,204,89,.25);
    }

    /* Optische Trennung nach Bildung */
    #promptTypeTabs.custom-pills .type-divider {
        display: flex;
        align-items: center;
        padding: 0 .35rem;
        pointer-events: none;
    }

        #promptTypeTabs.custom-pills .type-divider span {
            display: inline-block;
            width: 1px;
            height: 18px;
            background: #d0d4da;
        }

    /* iPad tweaks only: fit pills on one row without scrolling (no desktop changes) */
    @@media (min-width: 768px) and (max-width: 1199.98px) {
        #promptTypeTabs.custom-pills {
            gap: .25rem;
            justify-content: center;
        }

        #promptTypeTabs.custom-pills .nav-link {
            display: inline-flex;               /* ensure consistent interior spacing */
            align-items: center;
            justify-content: center;
            width: auto;                        /* natural width, keeps center */
            padding: .42rem .75rem !important;  /* compact for tablet widths */
            min-height: 1.95rem;                /* comfortable height */
            min-width: unset;                   /* allow compact labels */
            font-size: .9rem;                   /* slightly smaller to fit */
            white-space: nowrap;                /* prevent wrapping inside pill */
            border-radius: 999px !important;    /* ensure pills, not tabs */
        }
    }

    /* hide toolbar initially */
    #markdown-toolbar {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height .3s ease,opacity .3s ease;
    }

        #markdown-toolbar.show {
            max-height: none !important;
            opacity: 1;
            overflow: visible
        }

    /* ---------- word buttons  -------------------------------- */
    #word-toolbar {
        gap: .25rem;
        display: flex;
        flex-wrap: wrap;
    }
        /* little breathing space           */
        #word-toolbar .btn-word {
            flex: 0 1 auto; /* natural width, may shrink a bit        */
            width: max-content;
            max-width: 100%;
            word-break: break-word; /* break *inside* very long single words  */
            white-space: nowrap;
            padding: .35rem .65rem;
        }

    @@media (max-width:768px) {
        #word-toolbar {
            flex-wrap: nowrap; /* stay in one row … */
            overflow-x: auto; /* … and scroll if needed                 */
            padding-bottom: .25rem;
        }

            #word-toolbar .btn-word {
                flex: 0 0 auto; /* never shrink, just scroll              */
            }
    }

    /* very wide viewports – disable tiny gaps */
    @@media (min-width:1200px) {
        #word-toolbar .btn-word {
            flex: 0 0 auto;
        }

        .btn-mdcode {
            font-size: 0.7rem;
        }
    }

    /* ---------- responsive helpers --------------------------- */
    @@media(max - width:576px) { /* phones ≈ two columns              */
        #word-toolbar .btn-word {
            flex: 1 1 calc(50% - .3rem); /* two buttons per row               */
            white-space: normal; /* allow wrapping inside cell        */
        }

        .btn-mdcode {
            font-size: 0.6rem;
            padding: .4rem .45rem;
            transition: .15s;
            margin: 3px;
            min-width: 40px;
            min-height: 40px;
        }

        .btn-mdcode {
            font-size: 0.7rem;
        }
    }

    @@media(min - width:1200px) { /* huge screens – prevent giant gaps */
        #word-toolbar .btn-word {
            flex: 0 0 auto;
        }

        .btn-mdcode {
            font-size: 0.7rem;
        }
    }

    /* ---------- example style for the toggle button ---------- */
    .btn-markdown-shortcut {
        background: #5c5c5c;
        color: #fff;
    }

        .btn-markdown-shortcut:hover {
            filter: brightness(1.1);
        }

    /* ======== Button‐Labels umbrechen und zentrieren ======== */


    /* Tablet: zwei Buttons pro Zeile */
    @@media (max-width: 768px) {
        .prompt-actions .d-flex > .btn, .prompt-actions .d-flex > .btn-group {
            max-width: 45%;
        }
    }

    /* Smartphone: ein Button pro Zeile */
    @@media (max-width: 576px) {
        .prompt-actions .d-flex > .btn, .prompt-actions .d-flex > .btn-group {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }

    /* ───────── Sidebar & Burger ───────── */
    .criteria-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        max-height: 35vh; /* gleich wie mobil            */
        transform: translateY(-100%);
        background: #fff;
        border: 0;
        border-bottom: 2px solid #89ba17;
        border-radius: 0 0 1rem 1rem;
        box-shadow: 0 10px 24px rgba(0,0,0,.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 1040;
        transition: transform .35s ease;
    }

        .criteria-sidebar.open {
            transform: translateY(0);
        }

    /* Header / Body */
    .sidebar-header {
        flex: 0 0 auto;
        padding: .9rem 1rem;
        border-bottom: 1px solid #eee;
    }

    .sidebar-body {
        flex: 1 1 auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 1rem 1rem 1.5rem;
    }

    /* Burger */
    .sidebar-toggle {
        position: fixed; /* stay in the viewport      */
        top: 50%; /* vertical centre           */
        right: 1rem; /* 1 rem from the right edge */
        transform: translateY(-50%);
        /* unchanged look */
        background: #89ba17;
        color: #fff;
        border: none;
        border-radius: .55rem;
        padding: .65rem .85rem;
        box-shadow: 0 2px 8px rgba(0,0,0,.25);
        z-index: 1050;
    }

        .sidebar-toggle.d-none {
            display: none;
        }

    /* Backdrop */
    .mobile-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        opacity: 0;
        pointer-events: none;
        z-index: 1035;
        transition: opacity .25s ease;
        display: none !important;
    }

        .mobile-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

    /* ───────── Kriterium‑Grid ───────── */
    .section-grid {
        display: grid;
        /* ▸ 190 px Basis – füllt den ganzen Platz, wird aber nicht zu schmal  */
        grid-template-columns: repeat(auto-fill,minmax(190px,1fr));
        gap: .9rem;
    }

    /* Item‑Karte */
    .criteria-item {
        display: flex;
        flex-direction: column; /* Icons oben & unten, Text mittig */
        align-items: center;
        gap: .65rem;
        padding: 1.1rem .85rem; /* etwas mehr “Luft”               */
        background: #fafafa;
        border: 1px solid #e5e5e5;
        border-radius: .65rem;
        text-align: center;
    }

        /* Text darf umbrechen */
        .criteria-item span {
            white-space: normal;
            line-height: 1.3;
            font-size: .93rem;
        }

    /* runde Buttons – mit aspect‑ratio immer exakt rund  */
    .insert-btn,
    .trash-btn {
        width: 2.3rem;
        aspect-ratio: 1; /* macht den Kreis perfekt       */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        line-height: 1;
    }

    .insert-btn {
        color: #89ba17;
        border: 1px solid #89ba17;
    }

    .trash-btn {
        color: #d9534f;
        border: 1px solid #d9534f;
    }

    /* Eigenfilter‑Button (unverändert) */
    .eigenfilter-btn {
        background: #89ba17;
        border: none;
    }

        .eigenfilter-btn:hover {
            background: #fff;
            border: 1px solid #000;
            color: #000;
        }
    /* prettier markdown buttons */
    .btn-mdcode {
        --bs-btn-bg: #f8f9fa;
        --bs-btn-border-color: #ced4da;
        --bs-btn-hover-bg: #e9f7f0;
        --bs-btn-hover-border-color: #80d9b0;
        --bs-btn-active-bg: #d3f0e2;
        --bs-btn-active-border-color: #5fcf97;
        font-size: 0.95rem;
        padding: .7rem .75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: .15s;
        margin: 3px;
        min-width: 60px;
        min-height: 50px;
    }

    .mark-btn {
        background: #d3d3d3;
        font-size: 20px;
        font-weight: bold;
    }

    .btn-mdcode i {
        font-size: 1.7rem;
    }

    /* subtle separator between groups if you add more later */
    .btn-toolbar .btn-group + .btn-group {
        border-left: 1px solid #dee2e6;
    }

    /* animate collapse (Bootstrap’s .collapse only toggles height) */
    #markdown-toolbar.collapsing,
    #markdown-toolbar.collapse.show {
        transition: height .25s ease;
    }

    .btn-markdown-shortcut {
        background: #89ba17;
        color: white
    }

    /* ====== MOBILE TOP-SHEET FOR FILTER-KRITERIEN ====== */
    /* ===== Top sheet for phones & tablets ===== */
    /* ===== Mobile / Tablet sheet (≤1024px) ===== */
    @@media (max-width:1024px) {
        .criteria-sidebar {
            left: 0;
            top: 0;
            width: 100%;
            transform: translateY(-100%);
            background: #fff;
            border: 0;
            border-bottom: 2px solid #89ba17;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 10px 24px rgba(0,0,0,.25);
            z-index: 1040;
            transition: transform .35s ease;
            /* fixed height below viewport */
            max-height: 25vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

            .criteria-sidebar.open {
                transform: translateY(0);
            }
        /* header stays visible, body scrolls */
        .sidebar-header {
            flex: 0 0 auto;
            padding: .9rem 1rem;
            border-bottom: 1px solid #eee;
            background: #fff;
        }

        .sidebar-body {
            flex: 1 1 auto;
            overflow-y: auto; /* scrollable area */
            -webkit-overflow-scrolling: touch;
            padding: 1rem 1rem 1.5rem;
        }
        /* dim background */
        .mobile-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            opacity: 0;
            pointer-events: none;
            z-index: 1035;
            transition: opacity .25s ease;
        }

            .mobile-backdrop.show {
                opacity: 1;
                pointer-events: auto;
            }
        /* toggle button */
        .sidebar-toggle {
            position: fixed; /* stay in the viewport      */
            top: 50%; /* vertical centre           */
            right: 1rem; /* 1 rem from the right edge */
            transform: translateY(-50%);
            /* unchanged look */
            background: #89ba17;
            color: #fff;
            border: none;
            border-radius: .55rem;
            padding: .65rem .85rem;
            box-shadow: 0 2px 8px rgba(0,0,0,.25);
            z-index: 1050;
        }
        /* grouped layout */
        .sidebar-section {
            margin-bottom: 1.25rem;
        }

        .section-title {
            font-weight: 700;
            margin: 0 0 .6rem;
            color: #222;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
            gap: .65rem .75rem;
        }

        .criteria-item {
            margin: 0;
            padding: .65rem .55rem;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: .55rem;
            display: flex;
            align-items: center;
            gap: .45rem;
        }

            .criteria-item span {
                flex: 1 1 auto;
                font-size: .9rem;
                line-height: 1.25;
                white-space: normal;
            }

        .insert-btn, .trash-btn {
            width: 30px;
            height: 30px;
            font-size: .8rem;
            line-height: 1;
        }
        /* nicer thin scrollbar (optional) */
        .sidebar-body::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-body::-webkit-scrollbar-thumb {
            background: #89ba17;
            border-radius: 3px;
        }

        .sidebar-body::-webkit-scrollbar-track {
            background: transparent;
        }
    }

    /* AI Filter generator button styling */
    /* ===== Fancy CTA + loading panel for Filter generieren ===== */

    /* keep the button row single-line and vertically aligned */
    #basic-btn-row .btn {
        margin-bottom: 0;
    }

    /* ensure the row never breaks because of spacing tweaks */
    #basic-btn-row {
        min-height: 48px;
    }
    /* matches default .btn height */

    .cta-generate {
        --accent: #89ba17;
        --accent2: #00b36c;
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        color: #fff;
        border: 0;
        border-radius: .75rem;
        padding: .8rem 1.1rem;
        font-weight: 700;
        letter-spacing: .2px;
        box-shadow: 0 10px 24px rgba(58,204,89,.35), inset 0 0 0 1px rgba(255,255,255,.15);
        transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }

        .cta-generate:hover {
            transform: translateY(-1px);
            filter: brightness(1.04);
            box-shadow: 0 14px 28px rgba(58,204,89,.45);
        }

        .cta-generate .sparkle {
            font-size: 1.1rem;
            filter: drop-shadow(0 0 6px rgba(255,255,255,.65));
        }

    .cta-generate::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg,transparent 0%,rgba(255,255,255,.35) 50%,transparent 100%);
        transform: translateX(-120%);
    }

    .cta-generate:hover::after {
        animation: shine 1s forwards;
    }

    @@keyframes shine {
        to {
            transform: translateX(120%)
        }
    }

    .cta-generate.is-loading {
        cursor: progress;
        opacity: .85;
        filter: saturate(.9);
    }

        .cta-generate.is-loading .btn-text {
            opacity: .7;
        }

    /* Panel shown during generation */
    .ai-loading {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: .85rem 1rem;
        margin-top: .75rem;
        background: #fff;
        border: 1px dashed #89ba17;
        border-radius: .75rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        animation: fadeInLoad .25s ease both;
    }

    .neue-prompt-btn{
        background-color:#89ba17;
        color:white;
    }

    @@keyframes fadeInLoad {
        from {
            opacity: 0;
            transform: translateY(-4px)
        }

        to {
            opacity: 1;
            transform: none
        }
    }

    .ai-loading img {
        width: 56px;
        height: 56px;
        object-fit: contain;
    }

    .ai-typing {
        font-weight: 800;
        letter-spacing: .2px;
        background: linear-gradient(90deg,#0d0d0d 0%, #89ba17 60%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

        .ai-typing small {
            font-weight: 600;
            opacity: .7;
            display: block;
            margin-top: 2px;
        }


    /* Sticky dock for AI actions – within the filter card */
    .action-dock {
        position: sticky;
        bottom: -1px; /* visually hugs the card edge */
        inset-inline: -1rem; /* stretch to card padding */
        padding: .75rem 1rem;
        background: linear-gradient(180deg, rgba(255,255,255,0), #fff 55%);
        border-top: 1px solid #eef1f4;
        backdrop-filter: blur(2px);
        z-index: 5;
    }

    /* Elevate primary/secondary */
    .btn-smart {
       
        --accent: #89ba17;
        --accent2: #00b36c;
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        color: #fff;
        border: 0;
        border-radius: .75rem;
        padding: .8rem 1.1rem;
        font-weight: 500;
        letter-spacing: .2px;
        box-shadow: 0 10px 24px rgba(58,204,89,.35), inset 0 0 0 1px rgba(255,255,255,.15);
        transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }

        .btn-smart:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(58,204,89,.18);
        }

        /* Subtle pulse for Smart Selection when nothing selected */
        .btn-smart.attention {
            box-shadow: 0 0 0 0 rgba(58,204,89,.35);
            animation: smartPulse 1.6s ease-out infinite;
        }
    @@keyframes smartPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(58,204,89,.35);
        }

        70% {
            box-shadow: 0 0 0 12px rgba(58,204,89,0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(58,204,89,0);
        }
    }

    /* Harmonize primary CTA sizing inside dock */
    .action-dock .cta-generate {
        padding: .75rem 1.05rem;
        border-radius: .7rem;
    }

    /* Mobile: keep it compact and single line scrollable */
    @@media (max-width: 576px) {
        .action-dock {
            inset-inline: -.5rem;
            padding: .6rem .75rem;
        }

            .action-dock .d-flex {
                overflow-x: auto;
                gap: .5rem;
            }
    }

    .filter-tab-smart{
  background:#fff;
  color:#208a43;
  border:1px solid #89ba17;
}
.filter-tab-smart:hover{ background:#f7fff9; }

    .filter-tab-generate{
      background:#fff;
        color: #89ba17;
        border: 1px solid #89ba17;
    }
    .filter-tab-generate:hover{ background:#f0f7ff; }

/* Smart attention + busy states (toolbar chip + dock button) */
.filter-tab-smart.attention { box-shadow: 0 0 0 0 rgba(58,204,89,.35); animation: smartPulse 1.6s ease-out infinite; }
.btn-smart.is-busy, .filter-tab-smart.is-busy { opacity:.7; pointer-events:none; }
.btn-smart.is-busy .bi-magic { animation: spin .9s linear infinite; }
@@keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }

    /* Local Smart Selection overlay within the filter type-card */
    .type-card { position: relative; }
  #smart-loading.smart-overlay {
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.9));
      backdrop-filter: blur(2px);
      display: flex; align-items: center; justify-content: center;
      z-index: 20;
    }
    #smart-loading.d-none { display: none; }
    #smart-loading .box {
      background:#fff; border:1px solid #eef1f4; border-radius:.75rem;
      padding:.9rem 1.1rem; box-shadow:0 8px 24px rgba(0,0,0,.08);
      display:flex; align-items:center; gap:.65rem;
    }
    #smart-loading .spinner-border { width:1.5rem; height:1.5rem; }
    #smart-loading .loader-visual img { width:56px; height:56px; object-fit:contain; }
  }

  /* Divider and helper card polish */
  .section-divider { height:1px; border:0; background:linear-gradient(90deg,transparent,#e7ebf2,transparent); margin:1rem 0 1.25rem; }
  #promptHelperWrap .card { border:1px solid #eef1f4; border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.06);  }
  #promptHelperWrap .filter-title { font-size:1.1rem; letter-spacing:.2px; }
  #promptHelperWrap .filter-toolbar { background:#fafbfc; border:1px solid #eef1f4; border-radius:999px; }
  #promptHelperWrap .filter-content { background:#fff; }
  #promptHelperWrap.helper-shell { background:#f3f5f8; border:1px solid #d8dde5; border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.08); padding:1rem 1rem 1.25rem; margin:1rem 0 1.25rem; }
  #promptHelperWrap.helper-shell.is-floating { position:fixed; top:84px; right:24px; bottom:24px; width:min(620px, 56vw); max-height:calc(100vh - 108px); overflow:auto; z-index:1065; box-shadow:0 18px 40px rgba(16,24,40,.18); }
  #promptHelperWrap:not(.is-floating) .helper-header .left-actions .btn { white-space:nowrap; }
  #promptHelperWrap.helper-shell .helper-header { display:flex; gap:.5rem; flex-wrap:wrap; }
  #promptHelperWrap.helper-shell .helper-header .left-actions { display:flex; gap:.5rem; flex-wrap:wrap; flex:1 1 auto; min-width:0; }
  #promptHelperWrap.helper-shell .helper-header .right-actions { display:flex; gap:.5rem; flex-shrink:0; }
  #promptHelperWrap.helper-shell.is-floating .helper-header .left-actions .btn { white-space:normal; padding:.4rem .6rem; font-size:.9rem; }
  #promptHelperWrap.helper-shell.is-floating .helper-header { cursor: move; user-select: none; }
  #promptHelperWrap .drag-indicator { display:none; color:#667085; align-items:center; gap:.35rem; font-size:.9rem; }
  #promptHelperWrap.helper-shell.is-floating .drag-indicator { display:flex !important; opacity:1; background:#eef2f6; border:1px dashed #98a2b3; padding:.25rem .6rem; border-radius:999px; flex:0 0 auto; }
  @@media (max-width: 768px) {
    #promptHelperWrap.helper-shell.is-floating { width:92vw; left:4vw !important; right:auto; }
  }

  /* CKEditor modern look (applies to both Beschreibung and Prompt-Editor) */
  .ck.ck-editor { border:1px solid #e8ecf3 !important; border-radius:14px !important; box-shadow:0 10px 24px rgba(16,24,40,.06) !important; overflow:hidden; }
  .ck.ck-editor__top .ck-toolbar { border:0 !important; background:linear-gradient(180deg,#ffffff,#f8fafc) !important; padding:6px 8px !important; }
  .ck.ck-toolbar .ck-toolbar__items { gap:4px; }
  .ck.ck-button { border-radius:10px !important; }
  .ck.ck-editor__main { background:#fff; }
  .ck.ck-content { min-height:140px; padding:14px !important; font-size:0.98rem; line-height:1.55; }

  /* Prompt Editor card polish */
  /* .card-prompt { background:#fff; border-radius:16px;  rgba(0,0,0,.06); padding:1.25rem; } */
   .card-prompt { background:#fff; border:1px solid #e0e0e0; border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.06); padding:1.25rem; }
  /* Page shell card */
  .page-shell { background:#fff; border:1px solid #eef1f4; border-radius:18px; box-shadow:0 16px 36px rgba(16,24,40,.08); padding:1rem 1.25rem 1.25rem; margin:1rem 0 1.25rem; }
  .page-shell .page-title { margin-bottom:.5rem; }
  /* Integrated accordion look */
  .modern-accordion .accordion-item { border:0; background:transparent; margin-bottom:.75rem; }
  .modern-accordion .accordion-button { background:linear-gradient(180deg,#ffffff,#f7fafc); border:1px solid #e7ebf2; border-radius:12px !important; box-shadow:0 2px 6px rgba(16,24,40,.04); font-weight:600; color:#0f172a !important; }
  .modern-accordion .accordion-button:not(.collapsed) { background:#f7fafc; box-shadow:0 3px 10px rgba(16,24,40,.06); color:#0f172a !important; }
  .modern-accordion .accordion-body { background:#fff; border:1px solid #e0e0e0; border-top:0; border-radius:0 0 12px 12px; padding:1rem; box-shadow:0 8px 18px rgba(16,24,40,.06); }
  /* Compact CKEditor variant for short fields */
  .ck.ck-editor.ck-compact .ck-content { min-height:64px; }
  /* Helper chip toggle */
    .helper-chip {
        display: inline-flex;
        align-items: center;
        gap: .55rem;
        border: 2px solid #86efac;
        background: linear-gradient(180deg,#dcfce7,#e8f7ee);
        color: #065f46;
        text-decoration: none;
        border-radius: 10px;
        padding: .5rem 1rem;
        font-weight: 600;
        box-shadow: 0 6px 16px rgba(16,24,40,.08);
        transition: background .2s ease, box-shadow .2s ease, border-color .2s ease, transform .08s ease;
    }

        .helper-chip:hover {
            background: #d3f7e1;
            border-color: #6ee7b7;
            box-shadow: 0 10px 24px rgba(16,24,40,.12);
            transform: translateY(-1px);
        }

  .helper-chip .chev { transition: transform .2s ease; }
  .helper-chip[aria-expanded="true"] .chev { transform: rotate(180deg); }

    #btn-manage-filters i,
    #toggle-helper-float i {
        font-size: 1.4em;


    }
      #btn-manage-filters ,
    #toggle-helper-float  {
    
        border: 1px solid black;

    }
</style>
<style>
  .mode-chip {
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.32rem .85rem;
      border-radius:9999px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#111827;
      font-weight:500;
      font-size:.8rem;
      line-height:1.1;
      box-shadow:0 1px 2px rgba(15,23,42,.04);
      cursor:pointer;
      transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease, transform .1s ease;
  }

  .mode-chip:hover {
      background:#f9fafb;
      border-color:#cbd5e1;
      box-shadow:0 2px 4px rgba(15,23,42,.08);
      transform: translateY(-1px);
  }

  .mode-chip:focus-visible {
      outline:2px solid #3b82f6;
      outline-offset:2px;
  }

  .mode-chip.active {
      background:linear-gradient(180deg,#f9ffed,#eef9d6);
      color:#111827;
      border-color:#89ba17;
      box-shadow:0 3px 8px rgba(137,186,23,.25);
  }

  .mode-chip .bi { font-size:1rem; color:#64748b; }
  .mode-chip.active .bi { color:#89ba17; }

  .mode-chip .label {
      font-size:.7rem;
      opacity:.7;
  }

  .chip-help {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:1.25rem;
      height:1.25rem;
      border-radius:9999px;
      margin-left:.25rem;
      color:#6b7280;
  }

  .mode-chip.active .chip-help {
      color:#166534;
      opacity:1;
  }

  .mode-chip .status {
      font-weight:600;
      font-size:.75rem;
  }

  .mode-chip .status.on { color:#166534; }
  .mode-chip .status.off { color:#b91c1c; }

  .reset-round-btn { --btn-w:30px; --btn-h:30px; --ring-inner:65%; --ring-thickness:12%; --ring-edge:calc(var(--ring-inner) + var(--ring-thickness)); --arrow-rotate:-70deg; --arrow-scale:.66; --arrow-size:calc(min(var(--btn-w), var(--btn-h)) * var(--arrow-scale)); width:var(--btn-w); height:var(--btn-h); min-width:var(--btn-w); min-height:var(--btn-h); border-radius:999px; padding:0; border:0; background:
      radial-gradient(circle at center, #ffffff var(--ring-inner), transparent var(--ring-edge)),
      #7c7c7cff; color:black; display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 2px 8px rgba(0, 0, 0, 0.25); }
  .reset-round-btn .bi { font-size:var(--arrow-size); line-height:1; transform: rotate(var(--arrow-rotate)); }
  .reset-round-btn:hover { box-shadow:0 4px 12px rgba(0, 0, 0, 0.25); transform:translateY(-1px); }
  .reset-round-btn:focus { outline:none; }

  /* Editor toolbar action buttons */
  .editor-toolbar-actions {
      display: flex;
      align-items: center;
      gap: 1.25rem;
  }
  .btn-editor-action {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      padding: 0;
      border: none;
      background: #89ba17;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.30);
      transition: all 0.2s ease;
  }
  .btn-editor-action:hover {
      background: #7aa614;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      color: #fff;
  }
  .btn-editor-action:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(137,186,23,0.3);
  }
  .btn-editor-action .bi {
      font-size: 0.95rem;
      line-height: 1;
  }

  /* Responsive adjustments for editor toolbar */
  @@media (max-width: 576px) {
      .editor-toolbar-actions {
          gap: 1rem;
      }
      .btn-editor-action {
          width: 28px;
          height: 28px;
          min-width: 28px;
          min-height: 28px;
      }
      .btn-editor-action .bi {
          font-size: 0.85rem;
      }
      .reset-round-btn {
          --btn-w: 26px;
          --btn-h: 26px;
      }
  }

  /* Restructured accordions - centered horizontal layout */
  .prompt-actions {
      margin-top: 1.5rem;
  }
  .action-groups {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      align-items: flex-start;
  }
  .group-card {
      background: #fff;
      border: 1px solid #e2e5e9;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      overflow: hidden;
      transition: all 0.25s ease;
      flex: 0 1 auto;
      min-width: 180px;
      max-width: 280px;
  }
  .group-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border-color: #d0d4d9;
  }
  .group-title {
      font-weight: 600;
      color: #344054;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: #fff;
      border: 0;
      width: 100%;
      text-align: left;
      cursor: pointer;
      margin: 0;
      transition: all 0.2s ease;
      font-size: 0.9rem;
  }
  .group-title:hover {
      background: #f8f9fa;
  }
  .group-title:not(.collapsed) {
      background: #f8f9fa;
      border-bottom: 1px solid #e8ebee;
  }
  .group-title .bi, .group-title .fa {
      color: #89ba17;
      font-size: 1rem;
      flex-shrink: 0;
  }
  .group-title span {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }
  .group-title .chev {
      margin-left: auto;
      color: #9ca3af;
      transition: transform 0.25s ease;
      transform: rotate(0deg);
      font-size: 0.85rem;
      flex-shrink: 0;
  }
  .group-title[aria-expanded="true"] .chev,
  .group-title:not(.collapsed) .chev {
      transform: rotate(180deg);
  }
  .group-card .collapse,
  .group-card .collapsing {
      background: #fafbfc;
  }
  .group-card .collapse.show {
      overflow: visible;
  }
  .group-card:has(.collapse.show) {
      overflow: visible;
  }
  .group-card .btn-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.75rem;
  }
  .group-card .btn-row .btn {
      width: 100%;
      text-align: center;
      justify-content: center;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      border-radius: 8px;
  }
  .group-card .btn-row .btn-group {
      width: 100%;
  }
  .group-card .btn-row .btn-group .btn {
      flex: 1;
  }
  /* Allow dropdown menu to overflow outside the card */
  .group-card .btn-row .btn-group .dropdown-menu {
      position: fixed;
  }

  /* KI-Assistent-Studio special styling */
  .group-title.studio {
      background: #f9fbf6 !important;
  }
  .group-title.studio:hover {
      background: #f3f7ed !important;
  }
  .group-title.studio:not(.collapsed) {
      background: #f3f7ed !important;
  }
  .group-title.studio .bi-robot {
      color: #89ba17 !important;
  }

  /* Responsive accordion */
  @@media (max-width: 991px) {
      .action-groups {
          gap: 0.6rem;
      }
      .group-card {
          min-width: 160px;
          max-width: 240px;
      }
  }
  @@media (max-width: 767px) {
      .action-groups {
          justify-content: center;
      }
      .group-card {
          flex: 1 1 calc(50% - 0.5rem);
          min-width: 140px;
          max-width: none;
      }
  }
  @@media (max-width: 480px) {
      .group-card {
          flex: 1 1 100%;
          max-width: 100%;
      }
      .group-title {
          padding: 0.65rem 0.85rem;
          font-size: 0.85rem;
      }
      .group-card .btn-row {
          padding: 0.6rem;
          gap: 0.4rem;
      }
      .group-card .btn-row .btn {
          padding: 0.45rem 0.6rem;
          font-size: 0.8rem;
      }
  }
</style>



<div class="page-shell">
<!-- Page header: headline left, action button right -->
<div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-2 mb-4">
    <h2 class="page-title mb-0">@headline</h2>

    <div class="d-flex align-items-center gap-2 ms-sm-auto">
        <button type="button" id="new-prompt"
                class="btn neue-prompt-btn px-4 py-2 fw-semibold shadow-sm">
            <i class="bi bi-plus-circle me-1"></i> Prompt
        </button>
    </div>
</div>



<!-- ───── Prompt-Kriterien Sidebar ───── -->
<button id="sidebarToggle" class="sidebar-toggle d-none"
        aria-label="Prompt-Kriterien anzeigen">
    <i class="fa fa-list" aria-hidden="true"></i>
</button>

<aside id="criteriaSidebar" class="criteria-sidebar" aria-label="Prompt‑Kriterien">
    <div class="sidebar-header d-flex align-items-center">
        <!-- left X -->
        <button id="sidebarCloseLeft" class="btn-close me-2" aria-label="Schließen"></button>

        <h5 class="mb-0 flex-grow-1 text-center">Prompt‑Kriterien</h5>

        <!-- right X -->
        <button id="sidebarClose" class="btn-close ms-2" aria-label="Schließen"></button>
    </div>

    <div id="sidebarBody" class="sidebar-body"></div>
</aside>



<div class="accordion modern-accordion" id="accordionPromptBuilder">
    <!-- ── Accordion Item #1: Thema & Ziele ── -->
    <div class="accordion-item">
        <h2 class="accordion-header text-dark" id="headingOne">
                <button class="accordion-button text-dark" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseOne"
                    aria-expanded="true"
                    aria-controls="collapseOne">
                Prompt-Eigenschaften
            </button>
        </h2>
        <div id="collapseOne"
             class="accordion-collapse collapse show"
             aria-labelledby="headingOne">
            <div class="accordion-body">
                <div class="form-section shadow-sm">

                    <div class="mb-3">
                        <label for="akronym" class="form-label fw-semibold">Akronym:</label>
                        <input id="akronym"
                               type="text"
                               class="form-control"
                               @* placeholder="z. B. SMM" *@ />
                    </div>
                </div>

                    <div class="mb-3">
                        <label for="promptTitle" class="form-label fw-semibold">Titel:</label>
                        <div id="promptTitle-wrapper" class="position-relative">
                            <button type="button" id="reset-title-top" class="reset-round-btn position-absolute top-0 end-0 mt-2 me-3 z-3" aria-label="Zurücksetzen" title="Zurücksetzen">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <textarea id="promptTitle"
                                      class="form-control scalable-textarea"
                                      rows="2"
                                      @* placeholder="Geben Sie einen kurzen, prägnanten Titel ein…" *@></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="thema" class="form-label fw-semibold">Thema:</label>
                        <div id="thema-wrapper" class="position-relative">
                            <button type="button" id="reset-thema-top" class="reset-round-btn position-absolute top-0 end-0 mt-2 me-3 z-3" aria-label="Zurücksetzen" title="Zurücksetzen">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <textarea id="thema"
                                      class="form-control scalable-textarea"
                                      rows="2"
                                      @* placeholder="Beschreiben Sie das Thema Ihres Prompts…" *@></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ziele" class="form-label fw-semibold">Ziele:</label>
                        <div id="ziele-wrapper" class="position-relative">
                            <button type="button" id="reset-ziele-top" class="reset-round-btn position-absolute top-0 end-0 mt-2 me-3 z-3" aria-label="Zurücksetzen" title="Zurücksetzen">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <textarea id="ziele"
                                      class="form-control scalable-textarea"
                                      rows="2"
                                      @* placeholder="Welche Ziele sollen mit dem Prompt erreicht werden?" *@></textarea>
                        </div>
                    </div>

                    <div class="mb-3 mt-4">
                        <label for="schluesselbegriffe" class="form-label fw-semibold">Schlüsselbegriffe:</label>
                        @if (!canAddNewKeywords)
                        {
                            <small class="text-muted d-block mb-1">Bitte aus der Vorauswahl wählen</small>
                        }
                        <div class="kw-input-wrap">
                            <input id="schluesselbegriffe"
                                   type="text"
                                   class="form-control kw-input @(!canAddNewKeywords ? "kw-readonly" : "")"
                                   placeholder="@(canAddNewKeywords ? "z. B. KI, Visualisierung" : "Aus Vorauswahl wählen...")"
                                   @(!canAddNewKeywords ? "readonly" : "")
                                   data-can-add="@(canAddNewKeywords ? "true" : "false")" />
                            @if ((ViewBag.KeywordSuggestions as IEnumerable<string>)?.Any() ?? false)
                            {
                                <button type="button" id="kwToggleBtn" class="btn btn-sm kw-in-input btn-accent" aria-expanded="false" aria-controls="kwAccordion">
                                    <span class="btn-text">Vorauswahl</span> <i class="bi bi-caret-down-fill"></i>
                                </button>
                            }
                        </div>
                        <!-- Suggestions accordion (from DB) -->
                        @{
                            var kws = ViewBag.KeywordSuggestions as IEnumerable<string>;
                            var popular = ViewBag.PopularKeywords as IEnumerable<string> ?? Enumerable.Empty<string>();
                            var counts = ViewBag.KeywordCounts as IDictionary<string, int> ?? new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
                            bool hasKws = kws != null && kws.Any();
                        }
                        @if (hasKws)
                        {
                            <div id="kwAccordion" class="kw-accord mt-2">
                                <div id="kwChips" class="d-flex flex-wrap justify-content-center gap-2">

                                    @foreach (var kw in kws!)
                                    {
                                        var isPop = popular.Any(p => string.Equals(p, kw, StringComparison.OrdinalIgnoreCase));
                                        var count = counts.TryGetValue(kw, out var c) ? c : 0;
                                        <span class="kw-chip @(isPop ? "kw-pop" : "")" data-kw="@kw" title="@(count > 0 ? $"Verwendet {count}× in Bibliothek" : "Schlüsselbegriff")">
                                            @kw
                                            @if (isPop)
                                            {
                                                <i class="bi bi-fire text-danger ms-1" style="font-size:.9em;"></i>
                                            }
                                        </span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                     @* <hr class="section-divider mt-5 mb-5" /> *@
                        
                    
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Beschreibung/Fragestellung (eigener Bereich) -->
<div class="card-prompt mb-4">
        <div class="card-body">

           @* ---- PROMPT-Technicken HIER BIGENN --- *@
        <div class="d-flex justify-content-end mb-4">
            <a id="helper-chip" class="helper-chip" data-bs-toggle="collapse" href="#promptHelperWrap"
               role="button" aria-expanded="false" aria-controls="promptHelperWrap"
               title="Prompt Techniken öffnen/schließen">
                @* <i class="bi bi-magic"></i> *@
                <span>Prompt-Vorlagen</span>
                <i class="bi bi-chevron-down chev"></i>
            </a>
        </div>



        <!-- Prompt Techniken Content (moved from Accordion Item #2) -->
        <div id="promptHelperWrap" class="collapse mt-0 helper-shell" style="border:1px solid #c8c8c8;">

            <div class="helper-header d-flex align-items-center justify-content-between mb-0">
                <div class="drag-indicator">
                    <i class="bi bi-grip-vertical"></i>
                    <span>Ziehen zum Bewegen</span>
                </div>
                <div class="right-actions d-flex align-items-center gap-2 ms-auto">
                    <button type="button" id="generate-filters"
                            class="btn btn-smart btn-sm js-generate-filters">
                        <i class="bi bi-stars sparkle"></i>
                        <span class="btn-text">Filter generieren</span>
                    </button>
                    @*   <button type="button" class="btn btn-smart btn-sm js-smart-select">
                                    <i class="bi bi-stars sparkle"></i>
                                    Smart select
                                </button>
                                *@
                    <button type="button" class="btn btn-smart btn-sm js-deep-select">
                        <i class="bi bi-stars sparkle"></i>
                        Deep select 
                    </button>
                    <!-- @if (isAdminUser)
                    {
                            <a id="btn-manage-filters"
                               class="btn btn-secondary btn-sm fs-7"

                               href="@Url.Action("Index", "FilterCategory", new { area = "Admin", type = currentType })">
                                <i class="bi bi-funnel-fill"></i> Zur Filterverwaltung
                            </a>
                    }
                                        else
                    {
                            <a id="btn-manage-filters"
                               class="btn btn-secondary btn-sm ms-1"
                               href="@Url.Action("Index", "FilterCategory", new { area = "User", type = PromptType.Eigenfilter })">
                                <i class="bi bi-funnel-fill"></i> Eigenfilter verwalten
                            </a>
                    }
 -->
                    <button type="button" id="toggle-helper-float"
                            class="btn" aria-pressed="false"
                            aria-label="Panel andocken/abdocken" title="Panel andocken/abdocken">
                        <i class="bi bi-pin-angle"></i>
                    </button>

                </div>
            </div>

            <!-- Prompt-Typ Navigation (bubble pills) - below action buttons -->
            <div class="mt-5 mb-3">
                <ul id="promptTypeTabs" class="nav nav-pills custom-pills">
                    @for (int i = 0; i < orderedTypes.Length; i++)
                    {
                        var pt = orderedTypes[i];
                        bool isDomainType = pt == PromptType.Eigenfilter || pt == PromptType.Framework || pt == PromptType.Meta;
                        var linkClasses = $"nav-link{(pt == currentType ? " active" : string.Empty)}" + (isDomainType ? " domain-pill" : string.Empty);

                        <li class="nav-item">
                            <a class="@linkClasses"
                               asp-area="User"
                               asp-controller="Home"
                               asp-action="PromptAssistent"
                               asp-route-type="@pt">
                                @typeLabel(pt)
                            </a>
                        </li>

                        @* Optischer Divider nach Agent (Beruf) *@
                        if (pt == PromptType.Beruf && i < orderedTypes.Length - 1)
                        {
                         @*    <li class="nav-item type-divider" aria-hidden="true">
                                <span></span>
                            </li> *@
                        }
                    }
                </ul>
            </div>



            @* <h3 class="filter-title text-center mt-3 mb-3 fw-bold">
                Prompt-Filter @currentType
            </h3> *@

            <!-- “Filter” Card Container -->
            <div class="card-prompt bg-white mb-4 type-card">
                <!-- Local overlay for Smart Selection loading -->
                <div id="smart-loading" class="smart-overlay d-none">
                    <div class="box">
                        <div class="loader-visual me-2">
                            <img src="@Url.Content("~/images/eigenfilter-thinking.gif")" alt="Wird geladen …" />
                        </div>
                        <div class="d-flex flex-column">
                            <strong id="smart-stage-title">Denken</strong>
                            <small id="smart-stage-hint" class="text-muted"></small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
                    <button type="button" id="clear-filters"
                            class="reset-round-btn d-none" aria-label="Filter Zurücksetzen" title="Filter Zurücksetzen">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>

                <!-- Filter-Tabs (horiz. scroll) -->
                <div class="filter-toolbar-wrapper position-relative mb-3">
                    <!-- Overlay shown during Filter generieren -->
                    <div class="filter-gen-overlay">
                        <div class="d-flex align-items-center gap-2 p-2">
                            <picture>
                                <source srcset="~/images/eigenfilter-thinking.gif" type="image/gif">
                                <img src="~/images/eigenfilter-thinking.png" alt="KI denkt …" style="width:38px;height:38px;object-fit:contain;" />
                            </picture>
                            <div class="small text-muted">
                                <div><strong>Denken</strong><span class="ms-1">…</span></div>
                                <div>Filter werden generiert</div>
                            </div>
                        </div>
                    </div>
                    <button class="scroll-arrow left" aria-label="Scroll left">‹</button>
                    <div class="filter-toolbar shadow-sm">
                        @foreach (var cat in categories)
                        {
                            <button class="filter-tab @(isAdminUser && cat.IsAiGenerated ? "ai-generated" : "")"
                                    type="button"
                                    data-category="@cat.Id"
                                    data-name="@cat.Name"
                                    data-ai="@(cat.IsAiGenerated ? "true" : "false")"
                                    data-created="@(cat.CreatedAt is DateTime dt ? dt.ToString("o") : "")">
                                @if (isAdminUser && cat.IsAiGenerated)
                                {
                                    <i class="bi bi-stars ai-icon me-1" title="KI‑generierte Kategorie"></i>
                                }
                                @cat.Name
                                @if (isAdminUser && cat.IsHidden)
                                {
                                    <i class="bi bi-eye-slash ms-1" title="Für Nutzer/Dozenten verborgen"></i>
                                }
                            </button>
                        }
                        <span class="tab-indicator"></span>
                    </div>
                    <button class="scroll-arrow right" aria-label="Scroll right">›</button>
                    <button class="filter-tab"
                            type="button"
                            data-category="__bm__"
                            data-name="Meine Lesezeichen"
                            data-ai="false"
                            data-created=""
                            title="Meine Lesezeichen"
                            aria-label="Meine Lesezeichen"
                            style="margin-left:.35rem;">
                        <i class="bi bi-bookmark-star"></i>
                    </button>
                    <a asp-area="User"
                       asp-controller="FilterCategory"
                       asp-action="Visibility"
                       asp-route-type="@currentType"
                       class="btn js-category-visibility"
                       data-bs-toggle="modal"
                       data-bs-target="#filterCategoryVisibilityModal"
                       title="Kategorien ein-/ausblenden"
                       aria-label="Kategorien ein-/ausblenden"
                       style="margin-left:.35rem;">
                        <i class="bi bi-eye"></i>
                    </a>
                </div>

                <!-- Filter search (below category slider) -->
                <div class="mb-3">
                    <label for="filter-search" class="form-label fw-semibold">Filter durchsuchen</label>
                    <div class="input-group filter-search-wrap">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="filter-search" class="form-control" type="search" placeholder="Nach Prompt‑Techniken suchen …">
                        <button id="filter-search-clear" class="btn btn-clear" type="button">Löschen</button>
                    </div>
                </div>

                <!-- Filter Items Panels -->
                <div id="filter-items-container" class="filter-content rounded-3 shadow">
                    @if (currentType == PromptType.Eigenfilter && !categories.Any())
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center py-5 w-100">
                            <p class="text-muted mb-3">
                                Du hast noch keine eigenen Filter angelegt.
                            </p>

                            <a asp-area="User"
                               asp-controller="FilterCategory"
                               asp-action="Index"
                               asp-route-type="Eigenfilter"
                               class="btn eigenfilter-btn btn-success">
                                <i class="bi bi-plus-circle me-1"></i>
                                Domäne entwickeln
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="filter-panel" data-category="__bm__" data-name="Meine Lesezeichen" data-bookmarks="true" data-ai="false">
                            <div class="filter-items"></div>
                        </div>
                        @foreach (var cat in categories)
                        {
                            <div class="filter-panel @(isAdminUser && cat.IsAiGenerated ? "panel-ai" : "")" data-category="@cat.Id" data-name="@cat.Name" data-ai="@(cat.IsAiGenerated ? "true" : "false")" data-created="@(cat.CreatedAt is DateTime dt2 ? dt2.ToString("o") : "")">
                                @if (isAdminUser && cat.IsAiGenerated)
                                {
                                    <span class="ai-badge"><i class="bi bi-stars"></i> KI</span>
                                }
                                @if (isAdminUser && cat.IsHidden)
                                {
                                    <span class="ai-badge"><i class="bi bi-eye-slash"></i> Versteckt</span>
                                }
                                <div class="filter-items">
                                    @{
                                        var items = (cat.ItemSortMode == ItemSortMode.Alphabetic
                                        ? cat.FilterItems.OrderBy(i => i.Title, StringComparer.OrdinalIgnoreCase)
                                        : cat.FilterItems.OrderBy(i => i.SortOrder));
                                    }
                                    @foreach (var item in items)
                                    {
                                        <div class="filter-checkbox d-flex align-items-start" data-instruction="@AttrEscape(@item.Instruction)">
                                            <input id="filter_@item.Id"
                                                   type="checkbox"
                                                   name="filters"
                                                   value="@item.Title"
                                                   data-title="@item.Title" />
                                            <span class="checkmark"></span>
                                            <label for="filter_@item.Id" class="filter-label mb-0">
                                                @Html.Raw(item.Title)
                                                <span class="info-badge mb-3" data-info="@Html.Raw(item.Info)">?</span>
                                            </label>
                                            <button type="button" class="btn btn-light btn-sm btn-bookmark ms-auto" title="Lesezeichen">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                        </div>

                                        <div class="filter-summary-item mb-3 d-none">
                                            <button class="btn btn-sm btn-outline-danger trash-btn" data-val="@item.Title" title="Löschen">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success plus-btn" data-instruction="@AttrEscape(item.Instruction)" title="Einfügen">
                                                <i class="fa fa-level-down" aria-hidden="true"></i>
                                            </button>
                                            <span>@item.Title</span>
                                        </div>
                                    }
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button type="button" class="reset-round-btn clear-category" data-category="@cat.Id" aria-label="Auswahl aufheben" title="Auswahl aufheben">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Sticky action dock inside the filter card -->
                <div class="action-dock">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <button type="button" class="btn btn-smart js-smart-select d-none">
                            <i class="bi bi-magic"></i>
                            <span>Smart Selection</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Zusammenfassung der ausgewählten Filter -->
            <div id="filter-summary" class="mt-4 p-3 rounded border bg-white shadow-sm">
                <label class="form-label fw-semibold">Prompt-Kriterien:</label>
            </div>

            <!-- KI‑Auswahl Accordion -->
            <div id="ai-selected-accordion" class="accordion modern-accordion d-none mt-3">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="ai-acc-head">
                        <button class="accordion-button collapsed ki-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#ai-acc-body" aria-expanded="false" aria-controls="ai-acc-body">
                            <i class="bi bi-magic text-dark me-2"></i>
                            <span class=" text-dark">KI-ausgewählte Filter</span>
                            <span class="badge bg-success ms-2" id="ai-selected-count">0</span>
                            <small class="text-muted ms-3 d-none d-md-inline">Diese Filter wurden automatisch per Deep Analyse gesetzt.</small>
                        </button>
                    </h2>
                    <div id="ai-acc-body" class="accordion-collapse collapse" aria-labelledby="ai-acc-head">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" id="reset-ai-selected" class="btn btn-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> KI Auswahl zurücksetzen
                                </button>
                            </div>
                            <div id="ai-selected-list" class="ai-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="ai-suggested-accordion" class="accordion modern-accordion d-none mt-3">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="ais-acc-head">
                        <button class="accordion-button collapsed ki-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#ais-acc-body" aria-expanded="false" aria-controls="ais-acc-body">
                            <i class="bi bi-lightbulb text-dark me-2"></i>
                            <span class=" text-dark">KI‑Vorschläge</span>
                            <span class="badge bg-primary ms-2" id="ai-suggested-count">0</span>
                            @* <small class="text-muted ms-3 d-none d-md-inline">Nicht gesetzt – als Vorschlag aus der Deep Analyse.</small> *@
                        </button>
                    </h2>
                    <div id="ais-acc-body" class="accordion-collapse collapse" aria-labelledby="ais-acc-head">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" id="reset-ai-suggested" class="btn btn-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> KI Vorschläge zurücksetzen
                                </button>
                            </div>
                            <div id="ai-suggested-list" class="ai-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farb-Palette (Bild/Video only) -->
           
        </div>


        <div class="d-flex justify-content-end mb-2">
            <a id="helper-chip" class="helper-chip" data-bs-toggle="collapse" href="#promptHelperWrap"
               role="button" aria-expanded="false" aria-controls="promptHelperWrap"
               title="Prompt Techniken öffnen/schließen">
                @* <i class="bi bi-magic"></i> *@
                <span>Prompt Techniken</span>
                <i class="bi bi-chevron-down chev"></i>
            </a>
        </div>
        @* <hr class="section-divider mt-5 mb-3" /> *@
        <!-- Prompt Techniken Content (moved from Accordion Item #2) -->
        <div id="promptHelperWrap" class="collapse mt-2 helper-shell">
            <div class="helper-header d-flex align-items-center justify-content-between mb-2">
                <div class="drag-indicator">
                    <i class="bi bi-grip-vertical"></i>
                    <span>Ziehen zum Bewegen</span>
                </div>
                <div class="right-actions d-flex align-items-center gap-2 ms-auto">
                    <button type="button" id="generate-filters"
                            class="btn btn-smart btn-sm js-generate-filters">
                        <i class="bi bi-stars sparkle"></i>
                        <span class="btn-text">Filter generieren</span>
                    </button>
                    <button type="button" class="btn btn-smart btn-sm js-smart-select">
                        <i class="bi bi-stars sparkle"></i>
                        Smart select
                    </button>
                    <button type="button" class="btn btn-smart btn-sm js-deep-select">
                        <i class="bi bi-stars sparkle"></i>
                        Deep select
                    </button>
                    <!-- @if (isAdminUser)
                    {
                            <a id="btn-manage-filters"
                               class="btn btn-secondary btn-sm fs-7"

                               href="@Url.Action("Index", "FilterCategory", new { area = "Admin", type = currentType })">
                                <i class="bi bi-funnel-fill"></i> Zur Filterverwaltung
                            </a>
                    }
                                        else
                    {
                            <a id="btn-manage-filters"
                               class="btn btn-secondary btn-sm ms-1"
                               href="@Url.Action("Index", "FilterCategory", new { area = "User", type = PromptType.Eigenfilter })">
                                <i class="bi bi-funnel-fill"></i> Eigenfilter verwalten
                            </a>
                    }
 -->
                    <button type="button" id="toggle-helper-float"
                            class="btn" aria-pressed="false"
                            aria-label="Panel andocken/abdocken" title="Panel andocken/abdocken">
                        <i class="bi bi-pin-angle"></i>
                    </button>

                </div>
            </div>
            <h3 class="filter-title text-center mt-3 mb-3 fw-bold">
                Prompt-Filter @currentType
            </h3>

            <!-- “Filter” Card Container -->
            <div class="card-prompt bg-white mb-4 type-card">
                <!-- Local overlay for Smart Selection loading -->
                <div id="smart-loading" class="smart-overlay d-none">
                    <div class="box">
                        <div class="loader-visual me-2">
                            <img src="@Url.Content("~/images/magic-wand.gif")" alt="Wird geladen …" />
                        </div>
                        <div class="d-flex flex-column">
                            <strong id="smart-stage-title">Denken</strong>
                            <small id="smart-stage-hint" class="text-muted"></small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end align-items-center mb-3">
                    <button type="button" id="clear-filters"
                            class="reset-round-btn d-none" aria-label="Filter Zurücksetzen" title="Filter Zurücksetzen">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>

                <!-- Filter-Tabs (horiz. scroll) -->
                <div class="filter-toolbar-wrapper position-relative mb-3">
                    <!-- Overlay shown during Filter generieren -->
                    <div class="filter-gen-overlay">
                        <div class="d-flex align-items-center gap-2 p-2">
                            <picture>
                                <source srcset="~/images/eigenfilter-thinking.gif" type="image/gif">
                                <img src="~/images/eigenfilter-thinking.png" alt="KI denkt …" style="width:38px;height:38px;object-fit:contain;" />
                            </picture>
                            <div class="small text-muted">
                                <div><strong>Denken</strong><span class="ms-1">…</span></div>
                                <div>Filter werden generiert</div>
                            </div>
                        </div>
                    </div>
                    <button class="scroll-arrow left" aria-label="Scroll left">‹</button>
                    <div class="filter-toolbar shadow-sm">
                        @foreach (var cat in categories)
                        {
                            <button class="filter-tab @(isAdminUser && cat.IsAiGenerated ? "ai-generated" : "")"
                                    type="button"
                                    data-category="@cat.Id"
                                    data-name="@cat.Name"
                                    data-ai="@(cat.IsAiGenerated ? "true" : "false")"
                                    data-created="@(cat.CreatedAt is DateTime dt ? dt.ToString("o") : "")">
                                @if (isAdminUser && cat.IsAiGenerated)
                                {
                                    <i class="bi bi-stars ai-icon me-1" title="KI‑generierte Kategorie"></i>
                                }
                                @cat.Name
                                @if (isAdminUser && cat.IsHidden)
                                {
                                    <i class="bi bi-eye-slash ms-1" title="Für Nutzer/Dozenten verborgen"></i>
                                }
                            </button>
                        }
                        <span class="tab-indicator"></span>
                    </div>
                    <button class="scroll-arrow right" aria-label="Scroll right">›</button>
                    <button class="filter-tab"
                            type="button"
                            data-category="__bm__"
                            data-name="Meine Lesezeichen"
                            data-ai="false"
                            data-created=""
                            title="Meine Lesezeichen"
                            aria-label="Meine Lesezeichen"
                            style="margin-left:.35rem;">
                        <i class="bi bi-bookmark-star"></i>
                    </button>
                    <a asp-area="User"
                       asp-controller="FilterCategory"
                       asp-action="Visibility"
                       asp-route-type="@currentType"
                       class="btn js-category-visibility"
                       data-bs-toggle="modal"
                       data-bs-target="#filterCategoryVisibilityModal"
                       title="Kategorien ein-/ausblenden"
                       aria-label="Kategorien ein-/ausblenden"
                       style="margin-left:.35rem;">
                        <i class="bi bi-eye"></i>
                    </a>
                </div>

                <!-- Filter search (below category slider) -->
                <div class="mb-3">
                    <label for="filter-search" class="form-label fw-semibold">Filter durchsuchen</label>
                    <div class="input-group filter-search-wrap">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="filter-search" class="form-control" type="search" placeholder="Nach Prompt‑Techniken suchen …">
                        <button id="filter-search-clear" class="btn btn-clear" type="button">Löschen</button>
                    </div>
                </div>

                <!-- Filter Items Panels -->
                <div id="filter-items-container" class="filter-content rounded-3 shadow">
                    @if (currentType == PromptType.Eigenfilter && !categories.Any())
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center py-5 w-100">
                            <p class="text-muted mb-3">
                                Du hast noch keine eigenen Filter angelegt.
                            </p>

                            <a asp-area="User"
                               asp-controller="FilterCategory"
                               asp-action="Index"
                               asp-route-type="Eigenfilter"
                               class="btn eigenfilter-btn btn-success">
                                <i class="bi bi-plus-circle me-1"></i>
                                Eigenfilter entwickeln
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="filter-panel" data-category="__bm__" data-name="Meine Lesezeichen" data-bookmarks="true" data-ai="false">
                            <div class="filter-items"></div>
                        </div>
                        @foreach (var cat in categories)
                        {
                            <div class="filter-panel @(isAdminUser && cat.IsAiGenerated ? "panel-ai" : "")" data-category="@cat.Id" data-name="@cat.Name" data-ai="@(cat.IsAiGenerated ? "true" : "false")" data-created="@(cat.CreatedAt is DateTime dt2 ? dt2.ToString("o") : "")">
                                @if (isAdminUser && cat.IsAiGenerated)
                                {
                                    <span class="ai-badge"><i class="bi bi-stars"></i> KI</span>
                                }
                                @if (isAdminUser && cat.IsHidden)
                                {
                                    <span class="ai-badge"><i class="bi bi-eye-slash"></i> Versteckt</span>
                                }
                                <div class="filter-items">
                                    @{
                                        var items = (cat.ItemSortMode == ItemSortMode.Alphabetic
                                        ? cat.FilterItems.OrderBy(i => i.Title, StringComparer.OrdinalIgnoreCase)
                                        : cat.FilterItems.OrderBy(i => i.SortOrder));
                                    }
                                    @foreach (var item in items)
                                    {
                                        <div class="filter-checkbox d-flex align-items-start" data-instruction="@AttrEscape(@item.Instruction)">
                                            <input id="filter_@item.Id"
                                                   type="checkbox"
                                                   name="filters"
                                                   value="@item.Title"
                                                   data-title="@item.Title" />
                                            <span class="checkmark"></span>
                                            <label for="filter_@item.Id" class="filter-label mb-0">
                                                @Html.Raw(item.Title)
                                                <span class="info-badge mb-3" data-info="@Html.Raw(item.Info)">?</span>
                                            </label>
                                            <button type="button" class="btn btn-light btn-sm btn-bookmark ms-auto" title="Lesezeichen">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                        </div>

                                        <div class="filter-summary-item mb-3 d-none">
                                            <button class="btn btn-sm btn-outline-danger trash-btn" data-val="@item.Title" title="Löschen">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success plus-btn" data-instruction="@AttrEscape(item.Instruction)" title="Einfügen">
                                                <i class="fa fa-level-down" aria-hidden="true"></i>
                                            </button>
                                            <span>@item.Title</span>
                                        </div>
                                    }
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button type="button" class="reset-round-btn clear-category" data-category="@cat.Id" aria-label="Auswahl aufheben" title="Auswahl aufheben">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Sticky action dock inside the filter card -->
                <div class="action-dock">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <button type="button" class="btn btn-smart js-smart-select d-none">
                            <i class="bi bi-magic"></i>
                            <span>Smart Selection</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Zusammenfassung der ausgewählten Filter -->
            <div id="filter-summary" class="mt-4 p-3 rounded border bg-white shadow-sm">
                <label class="form-label fw-semibold">Prompt-Kriterien:</label>
            </div>

            <!-- KI‑Auswahl Accordion -->
            <div id="ai-selected-accordion" class="accordion modern-accordion d-none mt-3">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="ai-acc-head">
                        <button class="accordion-button collapsed ki-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#ai-acc-body" aria-expanded="false" aria-controls="ai-acc-body">
                            <i class="bi bi-magic text-dark me-2"></i>
                            <span class=" text-dark">KI-ausgewählte Filter</span>
                            <span class="badge bg-success ms-2" id="ai-selected-count">0</span>
                            <small class="text-muted ms-3 d-none d-md-inline">Diese Filter wurden automatisch per Deep Analyse gesetzt.</small>
                        </button>
                    </h2>
                    <div id="ai-acc-body" class="accordion-collapse collapse" aria-labelledby="ai-acc-head">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" id="reset-ai-selected-2" class="btn btn-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> KI Auswahl zurücksetzen
                                </button>
                            </div>
                            <div id="ai-selected-list" class="ai-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="ai-suggested-accordion" class="accordion modern-accordion d-none mt-3">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="ais-acc-head">
                        <button class="accordion-button collapsed ki-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#ais-acc-body" aria-expanded="false" aria-controls="ais-acc-body">
                            <i class="bi bi-lightbulb text-dark me-2"></i>
                            <span class=" text-dark">KI‑Vorschläge</span>
                            <span class="badge bg-primary ms-2" id="ai-suggested-count">0</span>
                            <small class="text-muted ms-3 d-none d-md-inline">Nicht gesetzt – als Vorschlag aus der Deep Analyse.</small>
                        </button>
                    </h2>
                    <div id="ais-acc-body" class="accordion-collapse collapse" aria-labelledby="ais-acc-head">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" id="reset-ai-suggested-2" class="btn btn-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> KI Vorschläge zurücksetzen
                                </button>
                            </div>
                            <div id="ai-suggested-list" class="ai-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farb-Palette (Bild/Video only) -->
            <div id="colorPalette" class="form-inline-group mt-3" style="display:none">
                <label class="fw-semibold me-2">Farben:</label>
                @for (int i = 0; i < 6; i++)
                {
                    <input type="color" class="form-control form-control-color color-swatch" value="#ffffff" title="Farbe wählen" />
                }
                <button type="button" id="applyColors" class="btn btn-active btn-sm ms-2">Anwenden</button>
            </div>

            <!-- Smart Selection + Max Zeichen + Temperatur -->
            <div class="row g-3 align-items-center mt-3 flex-wrap">
                <div class="col-12 col-md-auto">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label for="maxZeichen" class="col-form-label fw-semibold mb-0">Max.&nbsp;Zeichen:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" id="maxZeichen" class="form-control" value="500" min="10" max="5000" style="width:8rem;">
                        </div>
                        <div class="col-auto">
                            <button type="button" id="apply-max" class="btn btn-active">Anwenden</button>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-auto">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label for="temperature" class="col-form-label fw-semibold mb-0">Temperatur:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" step="0.1" id="temperature" class="form-control" value="0.7" min="0" max="1" style="width:6rem;">
                        </div>
                        <div class="col-auto">
                            <button type="button" id="apply-temp" class="btn btn-active">Anwenden</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Loading panel lives on its own row, so it never pushes buttons around -->
        <div id="ai-loading" class="ai-loading d-none mt-2" aria-live="polite">
            <picture>
                <source srcset="~/images/eigenfilter-thinking.gif" type="image/gif">
                <img src="~/images/eigenfilter-thinking.png" alt="KI denkt …" />
            </picture>
            <div>
                <div class="ai-typing">
                    <span id="ai-typing-word">Denken</span><span id="ai-typing-dots">…</span>
                    <small>Deine Angaben werden analysiert.</small>
                </div>
            </div>
        </div>


            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <label for="beschreibung" class="form-label fw-semibold mb-0">Beschreibung/Fragestellung:</label>
                    <div class="d-flex align-items-center gap-3 me-1">
                        <button id="toggle-besch-markdown" class="btn btn-markdown-shortcut btn-sm d-flex align-items-center gap-1 mb-2 mt-3">
                            <i class="bi bi-lightning-charge-fill"></i>
                            <span>Prompt-Keys</span>
                        </button>
                    </div>
                </div>
                <div id="besch-markdown-toolbar" class="btn-toolbar mb-2 collapse" role="toolbar" aria-label="Markdown-Shortcuts">
                    <div class="btn-group me-2" role="group">
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="#" title="Überschrift">#</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="**" title="Fett">B</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="{}" title="Platzhalter">{}</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="()" title="Prompt-Technik">( )</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="[]" title="Rollen/Kontext">[ ]</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="-" title="Bullet">-</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="+" title="Check-Item">+</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="*" title="Kursiv">*</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="`" title="Inline-Code">`</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="&lt" title="Zitat, Hinweis">&lt;</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="&gt;" title="Zitat, Hinweis">&gt;</button>
                        <button type="button" class="btn btn-mdcode besch-mark-btn" data-md="&lt;&gt;" title="Zitat, Hinweis">&lt;&gt;</button>
                    </div>
                    <div class="btn-group flex-wrap w-100 overflow-x-auto" id="besch-word-toolbar" role="group">
                        @inject IUnitOfWork Uow2
                        @{ var words2 = Uow2.PromptWord.GetAll().OrderBy(w => w.Text).ToList(); }
                        @foreach (var w in words2)
                        {
                            <button type="button" class="btn btn-mdcode btn-word my-1 me-1" data-word="@w.Text">@w.Text</button>
                        }
                    </div>
                </div>

                <div id="beschreibung-wrapper" class="position-relative">
                    <button type="button" id="reset-beschreibung-top" class="reset-round-btn position-absolute top-0 end-0 mt-2 me-3 z-3" aria-label="Zurücksetzen" title="Zurücksetzen">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <textarea id="beschreibung"
                              class="form-control scalable-textarea"
                              rows="3"
                              @* placeholder="Geben Sie hier eine Beschreibung oder Fragestellung ein…" *@></textarea>
                </div>
            </div>
        <div id="colorPalette" class="form-inline-group mt-3" style="display:none">
            <label class="fw-semibold me-2">Farben:</label>
            @for (int i = 0; i < 6; i++)
            {
                <input type="color" class="form-control form-control-color color-swatch" value="#ffffff" title="Farbe wählen" />
            }
            <button type="button" id="applyColors" class="btn btn-active btn-sm ms-2">Anwenden</button>
        </div>

        <!-- Smart Selection + Max Zeichen + Temperatur -->
        <div class="row g-3 align-items-center mt-3 flex-wrap">
            <div class="col-12 col-md-auto">
                <div class="row g-2 align-items-center">
                    <div class="col-auto">
                        <label for="maxZeichen" class="col-form-label fw-semibold mb-0">Max.&nbsp;Zeichen:</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="maxZeichen" class="form-control" value="500" min="10" max="5000" style="width:8rem;">
                    </div>
                    <div class="col-auto">
                        <button type="button" id="apply-max" class="btn btn-active">Anwenden</button>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-auto">
                <div class="row g-2 align-items-center">
                    <div class="col-auto">
                        <label for="temperature" class="col-form-label fw-semibold mb-0">Temperatur:</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" step="0.1" id="temperature" class="form-control" value="0.7" min="0" max="1" style="width:6rem;">
                    </div>
                    <div class="col-auto">
                        <button type="button" id="apply-temp" class="btn btn-active">Anwenden</button>
                    </div>
                </div>
            </div>

        </div>
        </div>
    </div>

   

<div class="card-prompt mb-4 mt-4">

 <div id="editor-container">
    <!-- one shared header row -->
    <div class="d-flex justify-content-between align-items-center mb-1">
      <label class="form-label fw-semibold mb-0">@* Prompt-Editor: *@</label>

      <div class="d-flex align-items-center gap-2 mb-5">
      

        <!-- moved button group (was the separate card) -->
        <div class="d-flex align-items-center gap-1 p-1 ">
          <input type="checkbox" id="toggle-ki-assist" hidden />
          <button type="button" id="chip-ki-assist"
                  class="mode-chip" aria-pressed="false"
                  title="KI-Assistent umschalten">
            <div class="d-flex align-items-center gap-2"">
              <i class="bi bi-robot fs-5"></i>
              <div class="d-flex flex-column align-items-start" style="line-height:1; ">
                <span class="label" style="font-size:.7rem;opacity:1; ">KI-Modus</span>
                <span class="status off fw-bold" style="font-size:.8rem;">Inaktiv</span>
              </div>
              <span id="chip-ki-help" class="chip-help ms-1 text-muted" tabindex="0" role="button" style="font-size:.8rem;">
                <i class="bi bi-question-circle"></i>
              </span>
            </div>
          </button>

          <div class="vr my-1 mx-1 text-muted"></div>

          <button type="button" id="generate-techniques"
                  class="btn btn-ai-generate btn-sm d-flex align-items-center gap-2 px-3 py-2 border-0">
            <i class="bi bi-stars sparkle"></i>
            <span class="fw-semibold">Prompt generieren</span>
          </button>

          <div class="vr my-1 mx-1 text-muted"></div>

          <button type="button" id="apply-basic"
                  class="btn btn-active d-flex align-items-center gap-2 px-3">
            <i class="bi bi-check-lg"></i>
            <span>Anwenden</span>
          </button>
        </div>
      </div>
    </div>

    <div id="editor-container">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label fw-semibold mb-0">Prompt-Editor:</label>
            <div class="d-flex align-items-center gap-2 me-1">
                <button id="toggle-markdown"
                        class="btn btn-markdown-shortcut mb-1 btn-sm d-flex align-items-center gap-1">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <span>Prompt-Keys</span>
                </button>
            </div>
        </div>

        <!-- ───── INLINE MARKDOWN TOOLBAR ───── -->
        <div id="markdown-toolbar"
             class="btn-toolbar mb-3 collapse"
             role="toolbar" aria-label="Markdown-Shortcuts">

            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-mdcode mark-btn" data-md="#" title="Überschrift">#</button>
                <button type="button" class="btn btn-mdcode mark-btn" data-md="**" title="Fett">B</button>
                <button type="button" class="btn btn-mdcode mark-btn" data-md="{}" title="Platzhalter">{}</button>

                <button class="btn btn-mdcode mark-btn" data-md="()" title="Prompt-Technik">( )</button>
                <button class="btn btn-mdcode mark-btn" data-md="[]" title="Rollen/Kontext">[ ]</button>
                <button class="btn btn-mdcode mark-btn" data-md="-" title="Bullet">-</button>
                <button class="btn btn-mdcode mark-btn" data-md="+" title="Check-Item">+</button>
                <button class="btn btn-mdcode mark-btn" data-md="*" title="Kursiv">*</button>
                <button class="btn btn-mdcode mark-btn" data-md="`" title="Inline-Code">`</button>
                <button class="btn btn-mdcode mark-btn" data-md="&lt" title="Zitat, Hinweis">&lt;</button>
                <button class="btn btn-mdcode mark-btn" data-md="&gt;" title="Zitat, Hinweis">&gt;</button>
                <button class="btn btn-mdcode mark-btn" data-md="&lt;&gt;" title="Zitat, Hinweis">&lt;&gt;</button>
            </div>

            <!-- ───── word keyboard – now scrollable & auto-wrapping ───── -->
            <div class="btn-group flex-wrap w-100 overflow-x-auto" id="word-toolbar" role="group">
                @inject IUnitOfWork Uow
                @{
                    var words = Uow.PromptWord.GetAll().OrderBy(w => w.Text).ToList();
                }
                @foreach (var w in words)
                {
                    <button type="button"
                            class="btn btn-mdcode btn-word my-1 me-1"
                            data-word="@w.Text">
                        @w.Text
                    </button>
                }
            </div>
        </div>

        <div id="editor-wrapper" class="position-relative">
            <!-- Editor toolbar buttons - moved from Aktionen accordion -->
            <div class="editor-toolbar-actions position-absolute top-0 end-0 mt-2 me-3 z-3 d-flex align-items-center gap-2">
              
                <button type="button" id="calculate-tokens" class="btn btn-editor-action" aria-label="Tokens" title="Tokens berechnen">
                    <i class="bi bi-calculator"></i>
                </button>
                <button type="button" id="show-inline-models" class="btn btn-editor-action" aria-label="Modelle" title="Modelle anzeigen">
                        <i id="models-icon" class="fa fa-cubes"></i>
                    <span id="models-button-text" class="d-none">Modelle</span>
                </button>
                    <button type="button" id="copy-prompt" class="btn btn-editor-action" aria-label="Prompt Kopieren" title="Prompt Kopieren">
                        <i class="fa fa-clone"></i>
                    </button>
                <button type="button" id="reset-prompt-top" class="reset-round-btn" aria-label="Zurücksetzen" title="Zurücksetzen">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </div>
            <textarea name="PromptContent"
                      id="editor"
                      rows="8"
                      class="form-control"></textarea>
            <div id="prompt-gen-overlay" class="editor-overlay" style="display:none;">
                <div class="overlay-box d-flex align-items-center gap-3 p-3">
                    <picture>
                        <source srcset="~/images/eigenfilter-thinking.gif" type="image/gif">
                        <img src="~/images/eigenfilter-thinking.png" alt="KI denkt …" style="width:38px;height:38px;object-fit:contain;" />
                    </picture>
                    <div class="small text-muted">
                        <div><strong>Denken</strong><span class="ms-1">…</span></div>
                        <div>Prompt wird generiert</div>
                    </div>
                </div>
            </div>
        </div>

    </div>




    <div class="prompt-actions mt-4">
        <div id="actionsAccordion" class="d-flex flex-wrap action-groups">

            <div class="group-card">
                <button class="group-title collapsed" data-bs-toggle="collapse" data-bs-target="#grpImportExport" aria-expanded="false" aria-controls="grpImportExport">
                    <i class="bi bi-arrow-left-right"></i><span>Import & Export</span>
                    <i class="bi bi-chevron-down chev"></i>
                </button>
                <div id="grpImportExport" class="collapse">
                <div class="btn-row">
                    <div class="btn-group">
                        <button id="exportDropdown" type="button"
                                class="btn btn-export px-4 py-2 fw-semibold shadow-sm dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                            <li>
                                <button class="dropdown-item" id="export-pdf">
                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" id="export-json">
                                    <i class="bi bi-download me-1"></i>JSON
                                </button>
                            </li>
                        </ul>
                    </div>
                    <button type="button" id="import-json-btn" class="btn btn-import px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-upload me-1"></i>Import JSON
                    </button>
                </div>
            </div>

            </div>

            <div class="group-card">
                <button class="group-title collapsed" data-bs-toggle="collapse" data-bs-target="#grpMyPrompts" aria-expanded="false" aria-controls="grpMyPrompts">
                    <i class="bi bi-bookmark-heart"></i><span>Sammlung</span>
                    <i class="bi bi-chevron-down chev"></i>
                </button>
                <div id="grpMyPrompts" class="collapse">
                <div class="btn-row">
                    <button type="button" id="save-to-my" class="btn save-to-lib px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-folder-plus me-1"></i> Sammlung speichern
                    </button>
                      <button type="button" id="save-variation-my"
                            class="btn save-to-lib-var px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-bookmark-plus me-1"></i> Reprompting
                    </button>
                    <a asp-area="User"
                       asp-controller="MyPrompts"
                       asp-action="Index"
                       class="btn save-to-lib-var px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-archive me-1"></i> Sammlung
                    </a>
                  
                </div>
            </div>

            </div>

            <div class="group-card">
                <button class="group-title collapsed" data-bs-toggle="collapse" data-bs-target="#grpLibrary" aria-expanded="false" aria-controls="grpLibrary">
                    <i class="fa fa-university accent-green" aria-hidden="true"></i><span>Bibliothek</span>
                    <i class="bi bi-chevron-down chev"></i>
                </button>
                <div id="grpLibrary" class="collapse">
                <div class="btn-row">
                    <button type="button" id="save-to-library" class="btn btn-Bib px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-folder-plus me-1"></i> Bibliothek speichern
                    </button>
                            <button type="button" id="save-variation"
                                    class="btn btn-Bib px-4 py-2 fw-semibold shadow-sm">
                                <i class="bi bi-bookmark-plus me-1"></i> Reprompting
                            </button>
                    <a asp-area="User"
                       asp-controller="Home"
                       asp-action="Bibliothek"
                       class="btn btn-Bib px-4 py-2 fw-semibold shadow-sm">
                        <i class="fa fa-university me-1" aria-hidden="true"></i> Bibliothek
                    </a>
                  
                </div>
            </div>

            </div>

            <div class="group-card">
                <button class="group-title collapsed studio" data-bs-toggle="collapse" data-bs-target="#grpAssistant" aria-expanded="false" aria-controls="grpAssistant">
                    <i class="bi bi-robot"></i><span>KI‑Assistent‑Studio</span>
                    <i class="bi bi-chevron-down chev"></i>
                </button>
                <div id="grpAssistant" class="collapse">
                <div class="btn-row">
                    <button type="button" id="save-assistant-btn" class="btn btn-Bib px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-robot me-1"></i> Ins Studio speichern
                    </button>
                    <a asp-area="User"
                       asp-controller="Home"
                       asp-action="Assistenten"
                       class="btn btn-Bib px-4 py-2 fw-semibold shadow-sm">
                        <i class="bi bi-collection me-1"></i> Zum Studio
                    </a>
                </div>
            </div>

            </div>

        </div>

        <input type="file" id="import-json-file" accept=".json" class="d-none" />
    </div>




</div>

</div>
@{ var editAsst = ViewBag.EditAssistant as ProjectsWebApp.Models.Assistant; }
<!-- KI‑Assistent speichern/aktualisieren Modal -->
<div class="modal fade" id="saveAssistantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@(editAsst != null ? "KI‑Assistent aktualisieren" : "KI‑Assistent speichern")</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="saveAssistantForm" asp-area="User" asp-controller="Home" asp-action="@(editAsst != null ? "UpdateAssistant" : "CreateAssistant")" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        @if (editAsst != null)
        {
            <input type="hidden" name="id" value="@editAsst.Id" />
        }
        <input type="hidden" name="systemPrompt" id="assistantSystemPrompt" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" name="name" class="form-control" required value="@(editAsst?.Name ?? "")" />
          </div>
          <div class="mb-3">
            <label class="form-label">Beschreibung</label>
            <textarea id="assistantDescription" name="description" class="form-control" rows="3" required>@(editAsst?.Description ?? "")</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Ziele</label>
            <textarea id="assistantGoals" name="goals" class="form-control" rows="4" placeholder="Wofür ist dieser Assistent gedacht?" required>@(editAsst?.Goals ?? "")</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Reflektion (optional)</label>
            <textarea id="assistantReflektion" name="reflektion" class="form-control" rows="4" placeholder="Reflektierende Hinweise, Einsatznotizen usw.">@(editAsst?.Reflektion ?? "")</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Autor/Owner</label>
            <input type="text" name="authorName" class="form-control" value="@(editAsst?.AuthorName ?? "")" placeholder="Name des Autors/Eigentümers" required/>
          </div>
          <div class="mb-3">
            <label class="form-label">Lizenzen</label>
            @{ var lic = editAsst?.Licenses ?? string.Empty; }
            <select name="licenses" class="form-select">
              @if (string.IsNullOrEmpty(lic)) { <option value="" selected>Bitte wählen …</option>; } else { <option value="">Bitte wählen …</option>; }
              @{
                  var licenseOptions = new[] {
                      "Attribution_CC_BY",
                      "Attribution_ShareAlike_CC_BY_SA",
                      "Public_Domain_Dedication_CC0",
                      "Copyright",
                      "MIT"
                  };
                  foreach (var opt in licenseOptions)
                  {
                      if (string.Equals(lic, opt, StringComparison.Ordinal))
                      {
                          <option value="@opt" selected>@opt</option>;
                      }
                      else
                      {
                          <option value="@opt">@opt</option>;
                      }
                  }
              }
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Bild‑URL (optional)</label>
            <input type="url" name="avatarUrl" class="form-control" placeholder="https://…" value="@(editAsst?.AvatarUrl ?? "")" />
          </div>
          <div class="mb-3">
            <label class="form-label">Bild hochladen (optional)</label>
            <input type="file" name="avatarFile" class="form-control" accept="image/*" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="submit" id="confirmSaveAssistant" class="btn btn-success">@(editAsst != null ? "Aktualisieren" : "Speichern")</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal für gespeicherte Prompt-Modelle -->
<div id="inlineModelsContainer" class="collapse-models mt-4">
    <div class="search-bar mb-3">
        <div class="input-group shadow-sm">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" id="inlineModelSearch" class="form-control border-start-0"
                   placeholder="Modelle durchsuchen …">
        </div>
    </div>

    <div id="inlineModelCards" class="model-card-grid row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4"></div>

    <nav aria-label="Modell-Seiten" class="mt-4">
        <ul id="inlineModelPagination" class="pagination justify-content-center mb-0"></ul>
    </nav>
</div>



<div class="modal fade" id="filterCategoryVisibilityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kategorien ein-/ausblenden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="filterCategoryVisibilityModalBody">
                <div class="text-center text-muted py-5">Wird geladen …</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <button type="button" class="btn btn-dark" id="filterCategoryVisibilityApplyBtn" disabled>Speichern</button>
            </div>
        </div>
    </div>
</div>

<div id="copy-toast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-4" style="z-index:1000" role="alert">
    <div class="d-flex">
        <div class="toast-body">✅ Prompt erfolgreich kopiert!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<style>
  /* Premium searchable multi-select dropdown for rooms */
  .swal2-popup.group-select-popup { padding-top: 1.1rem; max-width: 500px; width: 95vw; }
  .group-select-popup .swal2-html-container { padding: 0 0.5rem; }

  .room-select-container { position: relative; width: 100%; }
  .room-select-box {
    min-height: 46px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 10px;
    background: #fff; cursor: pointer; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .room-select-box:hover { border-color: #d1d5db; }
  .room-select-box.focused { border-color: #89ba17; box-shadow: 0 0 0 3px rgba(137,186,23,0.15); }

  .room-tag {
    display: inline-flex; align-items: center; gap: 4px; background: #89ba17; color: #fff;
    padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; max-width: 150px;
  }
  .room-tag span:first-child { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .room-tag-remove {
    cursor: pointer; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; background: rgba(255,255,255,0.3); font-size: 12px; line-height: 1; flex-shrink: 0;
  }
  .room-tag-remove:hover { background: rgba(255,255,255,0.5); }

  .room-select-placeholder { color: #9ca3af; font-size: 0.95rem; }
  .room-select-arrow { margin-left: auto; color: #6b7280; transition: transform 0.2s; flex-shrink: 0; }
  .room-select-arrow.open { transform: rotate(180deg); }

  /* Dropdown that renders in body (outside popup) */
  .room-dropdown-portal {
    position: fixed; background: #fff; border: 2px solid #89ba17; border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 100000; display: none; min-width: 300px;
  }
  .room-dropdown-portal.open { display: block; }

  .room-search-input {
    width: 100%; padding: 12px 14px; border: none; border-bottom: 1px solid #e5e7eb;
    font-size: 0.95rem; outline: none; box-sizing: border-box; border-radius: 8px 8px 0 0;
  }
  .room-search-input::placeholder { color: #9ca3af; }

  .room-list { max-height: 250px; overflow-y: auto; }
  .room-list-item {
    padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: background 0.15s; font-size: 0.95rem; color: #374151;
  }
  .room-list-item:hover { background: #f3f4f6; }
  .room-list-item.selected { background: #f0fdf4; color: #166534; font-weight: 600; }
  .room-list-item.selected::before { content: '✓'; color: #89ba17; font-weight: 700; }
  .room-list-item.hidden { display: none; }

  .room-list-empty { padding: 20px 14px; text-align: center; color: #9ca3af; font-size: 0.9rem; }
  .room-select-info { margin-top: 8px; font-size: 0.85rem; color: #6b7280; text-align: center; }
</style>

@section Scripts {

    <script type="module">
        import { copyPromptHtml } from '@Url.Content("~/js/copyPrompt.js")';

        (function(){
            const modalEl = document.getElementById('filterCategoryVisibilityModal');
            const bodyEl = document.getElementById('filterCategoryVisibilityModalBody');
            const applyBtn = document.getElementById('filterCategoryVisibilityApplyBtn');
            if (!modalEl || !bodyEl) return;

            let lastUrl = null;
            let changed = false;

            const loadingHtml = '<div class="text-center text-muted py-5">Wird geladen …</div>';

            async function load(url, opts) {
                if (!url) return;
                const restoreScrollTop = (opts && typeof opts.restoreScrollTop === 'number') ? opts.restoreScrollTop : null;
                lastUrl = url;
                bodyEl.innerHTML = loadingHtml;
                try {
                    const res = await fetch(url, {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const html = await res.text();
                    bodyEl.innerHTML = html;
                    wire();
                    if (restoreScrollTop !== null) {
                        try { bodyEl.scrollTop = restoreScrollTop; } catch {}
                    }
                } catch (e) {
                    bodyEl.innerHTML = '<div class="text-danger">Fehler beim Laden.</div>';
                    try {
                        if (typeof Swal !== 'undefined') Swal.fire('Fehler', String(e), 'error');
                    } catch {}
                }
            }

            function wire() {
                try {
                    bodyEl.querySelectorAll('#promptTypeTabs a.nav-link').forEach(a => {
                        a.addEventListener('click', (ev) => {
                            ev.preventDefault();
                            load(a.href);
                        });
                    });
                } catch {}

                try {
                    bodyEl.querySelectorAll('form').forEach(form => {
                        form.addEventListener('submit', async (ev) => {
                            ev.preventDefault();
                            const prevScrollTop = (() => { try { return bodyEl.scrollTop || 0; } catch { return 0; } })();
                            try {
                                const res = await fetch(form.action, {
                                    method: 'POST',
                                    credentials: 'same-origin',
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                    body: new FormData(form)
                                });
                                if (!res.ok) throw new Error(await res.text());
                                changed = true;
                                if (applyBtn) applyBtn.disabled = false;
                                await load(lastUrl, { restoreScrollTop: prevScrollTop });
                            } catch (e) {
                                try {
                                    if (typeof Swal !== 'undefined') Swal.fire('Fehler', String(e), 'error');
                                } catch {}
                            }
                        });
                    });
                } catch {}
            }

            document.querySelectorAll('a.js-category-visibility').forEach(a => {
                a.addEventListener('click', (ev) => {
                    try { ev.preventDefault(); } catch {}
                    const url = a.href;
                    try {
                        const m = bootstrap.Modal.getOrCreateInstance(modalEl);
                        m.show();
                    } catch {}
                    load(url);
                });
            });

            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    if (!changed) return;
                    try { if (typeof storeFormSnapshot === 'function') storeFormSnapshot(); } catch {}
                    location.reload();
                });
            }

            modalEl.addEventListener('hidden.bs.modal', () => {
                bodyEl.innerHTML = loadingHtml;
                lastUrl = null;
                changed = false;
                if (applyBtn) applyBtn.disabled = true;
            });
        })();

        document.getElementById('copy-prompt')
                .addEventListener('click', () => {
                    const ed = getEd();                // your CKEditor getter
                    if (!ed) return;
                    copyPromptHtml(ed.getData());
                });

        const btnSaveAssistant = document.getElementById('save-assistant-btn');
        const hiddenSystem = document.getElementById('assistantSystemPrompt');
        if (btnSaveAssistant && hiddenSystem) {
            btnSaveAssistant.addEventListener('click', () => {
                const ed = getEd && getEd();
                hiddenSystem.value = ed ? ed.getData() : (document.getElementById('editor')?.value || '');
                const modal = new bootstrap.Modal(document.getElementById('saveAssistantModal'));
                modal.show();
            });
            const confirmBtn = document.getElementById('confirmSaveAssistant');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    const ed = getEd && getEd();
                    hiddenSystem.value = ed ? ed.getData() : (document.getElementById('editor')?.value || '');
                });
            }
        }

        // Init CKEditor for Beschreibung, Ziele & Reflektion inside modal when shown, and clean up on hide
        (function(){
            const modalEl = document.getElementById('saveAssistantModal');
            const formEl  = document.getElementById('saveAssistantForm');
            if (!modalEl) return;
            modalEl.addEventListener('shown.bs.modal', () => {
                try {
                    const descTa = document.getElementById('assistantDescription');
                    const goalsTa= document.getElementById('assistantGoals');
                    const reflTa = document.getElementById('assistantReflektion');
                    if (descTa && !window.__asstDescEd && window.ClassicEditor) {
                        window.ClassicEditor.create(descTa).then(ed => window.__asstDescEd = ed).catch(()=>{});
                    }
                    if (goalsTa && !window.__asstGoalsEd && window.ClassicEditor) {
                        window.ClassicEditor.create(goalsTa).then(ed => window.__asstGoalsEd = ed).catch(()=>{});
                    }
                    if (reflTa && !window.__asstReflEd && window.ClassicEditor) {
                        window.ClassicEditor.create(reflTa).then(ed => window.__asstReflEd = ed).catch(()=>{});
                    }
                    try { descTa?.removeAttribute('required'); } catch {}
                    try { goalsTa?.removeAttribute('required'); } catch {}
                } catch {}
            });

            if (formEl) {
                formEl.addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    try { if (window.__asstDescEd) document.getElementById('assistantDescription').value = window.__asstDescEd.getData(); } catch {}
                    try { if (window.__asstGoalsEd) document.getElementById('assistantGoals').value = window.__asstGoalsEd.getData(); } catch {}
                    try { if (window.__asstReflEd) document.getElementById('assistantReflektion').value = window.__asstReflEd.getData(); } catch {}
                    try {
                        const ed = (typeof getEd === 'function') ? getEd() : null;
                        const hiddenSystem = document.getElementById('assistantSystemPrompt');
                        if (hiddenSystem) hiddenSystem.value = ed ? ed.getData() : (document.getElementById('editor')?.value || '');
                    } catch {}
                    try {
                        const strip = (s) => String(s||'').replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').trim();
                        const dVal = window.__asstDescEd ? window.__asstDescEd.getData() : (document.getElementById('assistantDescription')?.value || '');
                        const gVal = window.__asstGoalsEd ? window.__asstGoalsEd.getData() : (document.getElementById('assistantGoals')?.value || '');
                        if (!strip(dVal)) {
                            try { window.__asstDescEd?.focus(); } catch {}
                            if (typeof Swal !== 'undefined') await Swal.fire({ icon:'error', title:'Beschreibung erforderlich', text:'Bitte die Beschreibung ausfüllen.' }); else alert('Bitte die Beschreibung ausfüllen.');
                            return;
                        }
                        if (!strip(gVal)) {
                            try { window.__asstGoalsEd?.focus(); } catch {}
                            if (typeof Swal !== 'undefined') await Swal.fire({ icon:'error', title:'Ziele erforderlich', text:'Bitte die Ziele ausfüllen.' }); else alert('Bitte die Ziele ausfüllen.');
                            return;
                        }
                    } catch {}

                    let selectedGroups = [];
                    try {
                        const groupsUrl = '@Url.Action("AllowedGroups", "PromptTemplateApi", new { area = "Api" })';
                        const grRes = await fetch(groupsUrl, { credentials: 'same-origin' });
                        const grJson = await grRes.json();
                        const groups = Array.isArray(grJson.groups) ? grJson.groups : [];
                        const html = groups.length === 0
                          ? '<div>Keine Räume verfügbar. Der Assistent wird ohne Raum gespeichert.</div>'
                          : `<div class="room-select-container" id="asstRoomContainer">
                               <div class="room-select-box" id="asstRoomSelectBox">
                                 <span class="room-select-placeholder">Räume auswählen…</span>
                                 <span class="room-select-arrow"><i class="bi bi-chevron-down"></i></span>
                               </div>
                             </div>
                             <div class="room-select-info">${groups.length} Räume verfügbar</div>`;

                        // Create portal dropdown in body
                        const asstPortalId = 'asstRoomDropdownPortal';
                        let asstPortal = document.getElementById(asstPortalId);
                        if (asstPortal) asstPortal.remove();
                        asstPortal = document.createElement('div');
                        asstPortal.id = asstPortalId;
                        asstPortal.className = 'room-dropdown-portal';
                        asstPortal.innerHTML = `
                          <input type="text" class="room-search-input" id="asstRoomSearch" placeholder="Räume durchsuchen…">
                          <div class="room-list" id="asstRoomList">
                            ${groups.map(g => { const esc = g.replace(/\"/g,'&quot;'); return `<div class="room-list-item" data-value="${esc}" data-search="${esc.toLowerCase()}">${esc}</div>`; }).join('')}
                          </div>`;
                        document.body.appendChild(asstPortal);

                        const go = await Swal.fire({
                            title: 'In welchen Räume speichern?',
                            html,
                            focusConfirm: false,
                            showCancelButton: true,
                            confirmButtonText: 'Weiter',
                            cancelButtonText: 'Abbrechen',
                            customClass: { popup: 'group-select-popup' },
                            didOpen: () => {
                                const container = document.getElementById('asstRoomContainer');
                                const selectBox = document.getElementById('asstRoomSelectBox');
                                const arrow = selectBox.querySelector('.room-select-arrow');
                                const portal = document.getElementById(asstPortalId);
                                const searchInput = document.getElementById('asstRoomSearch');
                                const list = document.getElementById('asstRoomList');
                                if (!container || !selectBox || !portal) return;

                                let selected = new Set();
                                let isOpen = false;

                                function positionPortal() {
                                    const rect = selectBox.getBoundingClientRect();
                                    portal.style.top = (rect.bottom + 4) + 'px';
                                    portal.style.left = rect.left + 'px';
                                    portal.style.width = rect.width + 'px';
                                }

                                function openDropdown() {
                                    if (isOpen) return;
                                    isOpen = true;
                                    positionPortal();
                                    portal.classList.add('open');
                                    selectBox.classList.add('focused');
                                    arrow.classList.add('open');
                                    searchInput.focus();
                                }

                                function closeDropdown() {
                                    if (!isOpen) return;
                                    isOpen = false;
                                    portal.classList.remove('open');
                                    selectBox.classList.remove('focused');
                                    arrow.classList.remove('open');
                                }

                                function renderTags() {
                                    const placeholder = selectBox.querySelector('.room-select-placeholder');
                                    selectBox.querySelectorAll('.room-tag').forEach(t => t.remove());
                                    if (selected.size === 0) {
                                        if (placeholder) placeholder.style.display = '';
                                    } else {
                                        if (placeholder) placeholder.style.display = 'none';
                                        selected.forEach(val => {
                                            const tag = document.createElement('span');
                                            tag.className = 'room-tag';
                                            tag.innerHTML = `<span>${val}</span><span class="room-tag-remove" data-val="${val}">&times;</span>`;
                                            selectBox.insertBefore(tag, arrow);
                                        });
                                    }
                                    list.querySelectorAll('.room-list-item').forEach(item => {
                                        item.classList.toggle('selected', selected.has(item.dataset.value));
                                    });
                                }

                                selectBox.addEventListener('click', (e) => {
                                    if (e.target.closest('.room-tag-remove')) {
                                        const val = e.target.closest('.room-tag-remove').dataset.val;
                                        selected.delete(val);
                                        renderTags();
                                        e.stopPropagation();
                                        return;
                                    }
                                    isOpen ? closeDropdown() : openDropdown();
                                });

                                searchInput.addEventListener('input', () => {
                                    const term = searchInput.value.toLowerCase().trim();
                                    list.querySelectorAll('.room-list-item').forEach(item => {
                                        const matches = !term || item.dataset.search.includes(term);
                                        item.classList.toggle('hidden', !matches);
                                    });
                                });

                                list.addEventListener('click', (e) => {
                                    const item = e.target.closest('.room-list-item');
                                    if (!item) return;
                                    const val = item.dataset.value;
                                    if (selected.has(val)) selected.delete(val);
                                    else selected.add(val);
                                    renderTags();
                                    closeDropdown();
                                });

                                // Close on outside click
                                document.addEventListener('click', function handler(e) {
                                    if (!selectBox.contains(e.target) && !portal.contains(e.target)) {
                                        closeDropdown();
                                    }
                                });

                                container._getSelected = () => Array.from(selected);
                            },
                            willClose: () => {
                                const portal = document.getElementById(asstPortalId);
                                if (portal) portal.remove();
                            },
                            preConfirm: () => {
                                if (groups.length === 0) return [];
                                const container = document.getElementById('asstRoomContainer');
                                const selected = container?._getSelected?.() || [];
                                if (selected.length === 0) {
                                    Swal.showValidationMessage('Bitte mindestens einen Raum auswählen.');
                                    return false;
                                }
                                return selected;
                            }
                        });
                        if (!go.isConfirmed) return;
                        selectedGroups = Array.isArray(go.value) ? go.value : [];
                    } catch { selectedGroups = []; }

                    try {
                        formEl.querySelectorAll('input[name=\"groups\"]').forEach(x => x.remove());
                        for (const g of selectedGroups) {
                            const inp = document.createElement('input');
                            inp.type = 'hidden';
                            inp.name = 'groups';
                            inp.value = g;
                            formEl.appendChild(inp);
                        }
                    } catch {}

                    formEl.submit();
                });
            }
        })();
    </script>

    <script>
        // Prefill when editing an existing assistant
        (function(){
            const editMeta = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ViewBag.EditAssistant == null ? null : new {
                    id = ((ProjectsWebApp.Models.Assistant)ViewBag.EditAssistant).Id,
                    name = ((ProjectsWebApp.Models.Assistant)ViewBag.EditAssistant).Name,
                    description = ((ProjectsWebApp.Models.Assistant)ViewBag.EditAssistant).Description,
                    avatarUrl = ((ProjectsWebApp.Models.Assistant)ViewBag.EditAssistant).AvatarUrl,
                    systemPrompt = ((ProjectsWebApp.Models.Assistant)ViewBag.EditAssistant).SystemPrompt
                }
            ));
            if (!editMeta) return;

            // Set editor content to the assistant's SystemPrompt once CKEditor is ready
            function trySet(){
                try {
                    if (typeof getEd === 'function'){
                        const ed = getEd();
                        if (ed) { ed.setData(editMeta.systemPrompt || ''); return true; }
                    }
                } catch {}
                return false;
            }
            if (!trySet()){
                const t = setInterval(() => { if (trySet()) clearInterval(t); }, 300);
                setTimeout(() => clearInterval(t), 8000);
            }

            // Adjust Assistant button label and expand the Assistant group
            const btn = document.getElementById('save-assistant-btn');
            if (btn) btn.innerHTML = '<i class="bi bi-robot me-1"></i> Assistent aktualisieren';
            const grp = document.getElementById('grpAssistant');
            if (grp && typeof bootstrap !== 'undefined') {
                try { new bootstrap.Collapse(grp, { toggle: true }); } catch {}
            }
        })();
    </script>

    <script>
        // Filter durchsuchen: scope to currently visible filter panels; supports '.filter-items' and '#filter-items-container'
        (function(){
          function getActiveContainers(){
            const active = document.querySelector('.filter-tab.active');
            if (active){
              const cid = active.getAttribute('data-category');
              if (cid){
                const scoped = Array.from(document.querySelectorAll(`.filter-panel[data-category="${cid}"] .filter-items, .filter-panel[data-category="${cid}"] #filter-items-container`));
                if (scoped.length) return scoped;
              }
            }
            return [];
          }

          function getVisibleContainers(){
            const list = Array.from(document.querySelectorAll('.filter-panel .filter-items, .filter-panel #filter-items-container'))
              .filter(el => !!(el.offsetParent));
            if (list.length > 0) return list;
            const fallback = Array.from(document.querySelectorAll('.filter-items, #filter-items-container'));
            return fallback.length ? fallback : [];
          }

          function applyFilterToContainer(cont, q){
            const norm = (s) => (s||'').toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]+/g,'');
            const qn = norm(q);
            cont.querySelectorAll('.filter-checkbox').forEach(box => {
              const label = box.querySelector('.filter-label');
              const cb    = box.querySelector('input[type="checkbox"]');
              const t1 = norm(label?.textContent || '');
              const t2 = norm(box.dataset?.instruction || '');
              const t3 = norm(cb?.value || '');
              const t4 = norm(cb?.dataset?.title || '');
              const show = !qn || t1.includes(qn) || t2.includes(qn) || t3.includes(qn) || t4.includes(qn);
              box.classList.toggle('is-hidden', !show);
            });
          }

          function applyFilter(input){
            const q = (input.value || '').trim().toLowerCase();
            const preferred = getActiveContainers();
            const containers = preferred.length ? preferred : getVisibleContainers();
            containers.forEach(c => applyFilterToContainer(c, q));
            try { console.debug('[FilterSearch]', q, { containers: containers.length }); } catch {}
          }

          function bindDelegated(){
            // delegate input on filter-search
            function handleInput(e){
              const inp = e.target && e.target.id === 'filter-search' ? e.target : null;
              if (!inp) return;
              applyFilter(inp);
            }
            document.addEventListener('input', handleInput);
            document.addEventListener('keyup', handleInput);
            document.addEventListener('search', handleInput, true);
            // delegate click on clear
            document.addEventListener('click', function(e){
              const btn = e.target.closest && e.target.closest('#filter-search-clear');
              if (!btn) return;
              const wrap = btn.closest('.filter-search-wrap') || document;
              const inp = wrap.querySelector('#filter-search');
              if(!inp) return;
              inp.value=''; inp.focus();
              applyFilter(inp);
            });
            // reapply when tab changes
            document.addEventListener('click', function(e){
              const tab = e.target.closest && e.target.closest('.filter-tab');
              if (!tab) return;
              // find any visible search input and reapply
              const visSearch = Array.from(document.querySelectorAll('#filter-search'))
                .find(el => !!el.offsetParent);
              if (visSearch) applyFilter(visSearch);
            });

            // apply once on load if any value present
            const initInp = Array.from(document.querySelectorAll('#filter-search'))
              .find(el => !!el.offsetParent) || document.querySelector('#filter-search');
            if (initInp && (initInp.value || '').trim().length) applyFilter(initInp);
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bindDelegated);
          } else {
            bindDelegated();
          }
        })();
    </script>

    <script>
        // KI‑Assistent chip wiring (mirror to hidden checkbox + persist)
        (function(){
          const cb   = document.getElementById('toggle-ki-assist');
          const chip = document.getElementById('chip-ki-assist');
          const help = document.getElementById('chip-ki-help');
          const status = chip?.querySelector('.status');
          if (!cb || !chip) return;

          const KEY = 'pa:ki_mode';              // assistant|techniques
          const apply = (on) => {
            cb.checked = !!on;
            chip.classList.toggle('active', !!on);
            chip.setAttribute('aria-pressed', on ? 'true' : 'false');
            if (status) {
              status.textContent = on ? 'Aktiv' : 'Inaktiv';
              status.classList.toggle('on', !!on);
              status.classList.toggle('off', !on);
            }
          };

          // restore
          try {
            const saved = localStorage.getItem(KEY);
            apply(saved === 'assistant');
          } catch {}

          chip.addEventListener('click', () => {
            const on = !cb.checked;
            apply(on);
            try { localStorage.setItem(KEY, on ? 'assistant' : 'techniques'); } catch {}
          });

          // Popover for mobile/desktop (click/focus)
          if (help && typeof bootstrap !== 'undefined') {
            const content = `Aktiviere den KI‑Assistenten, damit „Prompt generieren“ einen rollenbasierten Assistenten‑Prompt erzeugt (inkl. System-/Rollenanweisungen und Interaktionsregeln).`;
            try {
              const pop = new bootstrap.Popover(help, {
                trigger: 'focus',
                placement: 'bottom',
                html: false,
                content
              });
            } catch {}
            // prevent chip toggle when pressing info
            help.addEventListener('click', (e) => { e.stopPropagation(); });
          }
        })();
        /* ========== SIDEBAR (final pass) ========== */
        const sidebar     = document.getElementById('criteriaSidebar');
        const sidebarBody = document.getElementById('sidebarBody');
        const burger      = document.getElementById('sidebarToggle');
        // const closeBtn    = document.getElementById('sidebarClose');

        /* ---------- open / close ---------- */
               document.querySelectorAll('#sidebarClose, #sidebarCloseLeft')
                .forEach(btn => btn.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    updateBurgerVisibility();
                }));

        burger.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            updateBurgerVisibility();
        });

        /* ---------- burger hides only when sidebar is open OR empty ---------- */
        function updateBurgerVisibility () {
          const hide = sidebar.classList.contains('open') || !sidebarBody.children.length;
          burger.classList.toggle('d-none', hide);
        }

        /* ---------- build / refresh sidebar ---------- */
       function rebuildSidebar (map) {
  sidebarBody.innerHTML = '';

  // 0) Build AI-selected groups (categoryId -> items)
  const aiGroups = new Map();
  document.querySelectorAll('.filter-checkbox.ai-selected input:checked').forEach(cb => {
    const panel = cb.closest('.filter-panel');
    const cid = panel?.dataset?.category; if (!cid) return;
    const box = cb.closest('.filter-checkbox');
    const text = cb.dataset.title || box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
    const ins  = box?.dataset?.instruction || cb.value;
    const id   = String(cb.id || '').replace(/^filter_/, '');
    if (!aiGroups.has(cid)) aiGroups.set(cid, []);
    aiGroups.get(cid).push({ id, val: cb.value, text, ins });
  });

  // 1) Render MANUAL sections first
  Object.entries(map).forEach(([cid, items]) => {
    const section = document.createElement('div');
    section.className = 'sidebar-section';
    section.innerHTML = `
      <div class="section-title mb-2"><strong>${categoryMap[cid] ?? ''}</strong></div>
      <div class="section-grid"></div>
    `;

    const grid = section.querySelector('.section-grid');

    items.forEach(({ id, val, text, ins }) => {
      const instruction = (ins && ins !== 'undefined') ? ins : text;
      grid.insertAdjacentHTML('beforeend', `
        <div class="criteria-item">
          <button class="insert-btn" data-title="${text}" data-instruction="${instruction}" data-id="${id}" data-val="${val}">
            <i class="fa fa-level-down"></i>
          </button>
          <span>${text}</span>
          <button class="trash-btn" data-id="${id}" data-val="${val}">
            <i class="fa fa-trash"></i>
          </button>
          <span class="use-badge" style="display:none">×0</span>
        </div>
      `);
    });
    sidebarBody.appendChild(section);
  });

  // 2) Render AI-selected sections afterwards (clearly labeled)
  aiGroups.forEach((items, cid) => {
    const section = document.createElement('div');
    section.className = 'sidebar-section';
    section.innerHTML = `
      <div class="section-title mb-2">
        <strong>${categoryMap[cid] ?? ''}</strong>
        <span class="badge bg-success ms-2"><i class="bi bi-stars me-1"></i>KI</span>
      </div>
      <div class="section-grid"></div>
    `;

    const grid = section.querySelector('.section-grid');
    items.forEach(({ id, val, text, ins }) => {
      const instruction = (ins && ins !== 'undefined') ? ins : text;
      grid.insertAdjacentHTML('beforeend', `
        <div class="criteria-item ai-criteria">
          <button class="insert-btn" data-title="${text}" data-instruction="${instruction}" data-id="${id}" data-val="${val}">
            <i class="fa fa-level-down"></i>
          </button>
          <span>${text}</span>
          <i class="bi bi-stars text-warning" title="KI-ausgewählt"></i>
          <button class="trash-btn" data-id="${id}" data-val="${val}">
            <i class="fa fa-trash"></i>
          </button>
          <span class="use-badge" style="display:none">×0</span>
        </div>
      `);
    });
    sidebarBody.appendChild(section);
  });

  updateBurgerVisibility();
  updateUsedMarks();
}


        /* ---------- plus / trash handlers ---------- */
              /* ---------- plus / trash handlers in the sidebar ---------- */
        sidebarBody.addEventListener('click', e => {
          const trash = e.target.closest('.trash-btn');
          const plus  = e.target.closest('.insert-btn');

          // Trash: uncheck the corresponding filter
          if (trash) {
            const id  = trash.dataset.id;
            const val = trash.dataset.val;
            if (id) {
              const cb = document.getElementById('filter_' + id);
              if (cb) { cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: true })); }
            } else if (val) {
              document
                .querySelectorAll(`.filter-checkbox input[value="${val}"]`)
                .forEach(cb => { cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: true })); });
            }
            rebuildSummary();
            updateBurgerVisibility();
            return;
          }

          if (!plus) return;

          // Plus: insert instruction at caret into Beschreibung editor
          const title = oneLine(plus.dataset.title        ?? '');
          const instr = oneLine(plus.dataset.instruction  ?? '');
          const toInsert = `(${title}): ${instr}`;

          const bTa = document.getElementById('beschreibung');
          const ed = bTa && bTa.ckeditorInstance;
          if (!ed) return;
          try { ed.execute('enter'); } catch {}
          ed.model.change(writer => {
            const html = `<p>${toInsert.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
            const insertionRange = ed.model.insertContent(
              ed.data.toModel(ed.data.processor.toView(html)),
              ed.model.document.selection.getFirstPosition()
            );
            writer.setSelection(insertionRange.end);
          });

          ed.editing.view.focus();
          incrementCount(plus.dataset.val || title);
          try { saveAutosave(); } catch {}
        });





        /* --------------------------------------------------
        BASIC SETUP
        -------------------------------------------------- */
        const tabs = document.querySelectorAll('.filter-tab');
        const panels = document.querySelectorAll('.filter-panel');
        const line = document.querySelector('.tab-indicator');
        const summaryBox = document.getElementById('filter-summary');
        const clearBtn = document.getElementById('clear-filters');
        let clearBtnAnchor = null, clearBtnHome = null;
        if (clearBtn) {
          clearBtnHome = clearBtn.parentElement;
          try {
            clearBtnAnchor = document.createElement('span');
            clearBtnAnchor.id = 'clear-filters-anchor';
            clearBtnAnchor.style.display = 'none';
            clearBtnHome?.insertBefore(clearBtnAnchor, clearBtn.nextSibling);
          } catch {}
          try { clearBtn.removeAttribute('style'); } catch {}
          clearBtn.classList.add('d-none');
        }
        const applyBtn = document.getElementById('applyColors');
        const NEW_BTN = document.getElementById('new-prompt');

        /* === Bookmarks: Meine Lesezeichen category (first tab/panel) === */
        (function(){
          const BM_CAT = '__bm__';
          const bmPanel = document.querySelector(`.filter-panel[data-category="${BM_CAT}"]`);
          if (!bmPanel) return;
          const bmList = bmPanel.querySelector('.filter-items');
          const getStorageKey = () => {
            // Avoid touching block-scoped identifiers in TDZ (keyOf/CURRENT_TYPE)
            let t = 'text';
            try {
              const url = new URL(location.href);
              const q = (url.searchParams.get('type') || '').toLowerCase();
              if (q) t = q;
            } catch {}
            let uid = 'anon';
            try {
              uid = document.documentElement.getAttribute('data-user') || uid;
            } catch {}
            return `pa:${uid}:bookmarks_${t}`;
          };

          const load = () => {
            try { const a = JSON.parse(localStorage.getItem(getStorageKey()) || '[]'); return new Set(a.map(String)); }
            catch { return new Set(); }
          };
          const save = (set) => { try { localStorage.setItem(getStorageKey(), JSON.stringify(Array.from(set))); } catch {} };

          let bookmarks = load();

          const isMirror = (el) => !!el?.closest?.('.filter-panel[data-bookmarks="true"]');
          const origIdOf = (inputEl) => {
            const id = String(inputEl?.id || '');
            return id.startsWith('bm_filter_') ? id.replace(/^bm_/, '') : id;
          };

          const setBmIcon = (btn, on) => {
            if (!btn) return;
            const i = btn.querySelector('i');
            if (!i) return;
            i.className = on ? 'bi bi-bookmark-fill' : 'bi bi-bookmark';
            btn.setAttribute('aria-pressed', on ? 'true' : 'false');
            btn.classList.toggle('active', !!on);
          };

          const updateOriginalIcons = () => {
            document.querySelectorAll('.filter-panel:not([data-bookmarks="true"]) .filter-checkbox').forEach(box => {
              const input = box.querySelector('input');
              if (!input) return;
              const id = String(input.id || '').replace(/^filter_/, '');
              setBmIcon(box.querySelector('.btn-bookmark'), bookmarks.has(id));
            });
          };

          const makeMirror = (origBox) => {
            const clone = origBox.cloneNode(true);
            clone.classList.add('is-bookmark');
            clone.classList.remove('ai-selected','ai-suggested');
            const inp = clone.querySelector('input');
            const lbl = clone.querySelector('label');
            const btn = clone.querySelector('.btn-bookmark');
            if (inp) {
              const id = String(inp.id || '').replace(/^filter_/, '');
              inp.id = 'bm_filter_' + id;
              inp.dataset.mirror = '1';
              setTimeout(() => {
                const orig = document.getElementById('filter_' + id);
                if (orig) inp.checked = !!orig.checked;
              }, 0);
            }
            if (lbl && lbl.getAttribute('for')) {
              const id = lbl.getAttribute('for').replace(/^filter_/, '');
              lbl.setAttribute('for', 'bm_filter_' + id);
            }
            if (btn) setBmIcon(btn, true);
            return clone;
          };

          const rebuildBookmarks = () => {
            if (!bmList) return;
            bmList.innerHTML = '';
            if (!bookmarks || bookmarks.size === 0) {
              bmList.innerHTML = `
                <div class="text-center py-4 bm-empty">
                  @* <div class="mb-2">Noch keine Lesezeichen.</div>*@
                  <button type="button" class="btn btn-active btn-sm" id="bm-start-btn">Lesezeichen platzieren</button>
                </div>`;
              const startBtn = bmList.querySelector('#bm-start-btn');
              startBtn?.addEventListener('click', () => {
                const firstTab = document.querySelector('.filter-tab:not([data-category="__bm__"])');
                if (firstTab) firstTab.dispatchEvent(new Event('click', { bubbles: true }));
              });
              return;
            }
            Array.from(bookmarks).forEach(id => {
              const orig = document.getElementById('filter_' + id)?.closest('.filter-checkbox');
              if (orig) bmList.appendChild(makeMirror(orig));
            });
          };

          // Init
          rebuildBookmarks();
          updateOriginalIcons();

          // Sync check state both directions
          document.getElementById('filter-items-container')?.addEventListener('change', (e) => {
            const input = e.target?.closest?.('input[type="checkbox"]');
            if (!input) return;
            const id = String(input.id || '');
            if (id.startsWith('bm_filter_')) {
              const origId = id.replace(/^bm_/, '');
              const orig = document.getElementById(origId);
              if (orig && orig.checked !== input.checked) {
                orig.checked = input.checked;
                orig.dispatchEvent(new Event('change', { bubbles: true }));
              }
            } else if (id.startsWith('filter_')) {
              const mirror = document.getElementById('bm_' + id);
              if (mirror && mirror.checked !== input.checked) mirror.checked = input.checked;
            }
          });

          // Toggle bookmark via button
          document.getElementById('filter-items-container')?.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-bookmark');
            if (!btn) return;
            const box = btn.closest('.filter-checkbox');
            const input = box?.querySelector('input');
            if (!input) return;
            const id = String(origIdOf(input)).replace(/^filter_/, '').replace(/^bm_filter_/, '');
            if (bookmarks.has(id)) bookmarks.delete(id); else bookmarks.add(id);
            save(bookmarks);
            rebuildBookmarks();
            updateOriginalIcons();
          });
        })();

        function ensureImportFilterSelections(s){
            let tries = 0; const max = 60;
            const parseArr = () => {
                if (Array.isArray(s.checkedItems)) return s.checkedItems;
                try { const p = JSON.parse(s.filterJson || '[]'); return Array.isArray(p) ? p : []; } catch { return []; }
            };
            const arr = parseArr();
            const idSet = new Set(arr.map(x => String((x && (x.id || x.Id)) || '').trim()).filter(Boolean));
            const valSet = new Set(arr.map(x => String((x && (x.value || x.title || x.text)) || '').trim().toLowerCase()).filter(Boolean));
            if (!idSet.size && !valSet.size) return;
            const tick = () => {
                try {
                    const inputs = document.querySelectorAll('.filter-checkbox input');
                    if (!inputs.length) { if (++tries < max) return void setTimeout(tick, 100); else return; }
                    let matched = 0;
                    inputs.forEach(cb => {
                        let want = false;
                        if (!want && idSet.size) {
                            const id = String(cb.id || '').replace(/^filter_/, '').trim();
                            if (id && idSet.has(id)) want = true;
                        }
                        if (!want && valSet.size) {
                            const box = cb.closest('.filter-checkbox');
                            const labelTxt = (box?.querySelector('.filter-label')?.textContent || '').trim().toLowerCase();
                            const instr    = (box?.dataset?.instruction || '').trim().toLowerCase();
                            const candidates = [cb.value, cb.dataset?.title, labelTxt, instr]
                                .map(v => String(v || '').trim().toLowerCase())
                                .filter(Boolean);
                            for (const c of candidates) { if (valSet.has(c)) { want = true; break; } }
                        }
                        const changed = !!cb.checked !== !!want;
                        cb.checked = want;
                        if (changed) { matched++; cb.dispatchEvent(new Event('change', { bubbles: true })); }
                    });
                    if (!matched && ++tries < max) setTimeout(tick, 120); else { try { rebuildSummary(); } catch {} try { updateUsedMarks(); } catch {} }
                } catch {}
            };
            tick();
        }

        // Reset helpers for New Prompt and property-only reset
        (function setupResets(){
            function setCkOrVal(id, val){
                const el = document.getElementById(id);
                if (!el) return;
                const ed = el.ckeditorInstance;
                if (ed) ed.setData(val); else el.value = val;
            }

            function clearPropertiesFields(){
                try {
                    setCkOrVal('promptTitle','');
                    setCkOrVal('thema','');
                    setCkOrVal('ziele','');
                    setCkOrVal('beschreibung','');
                    const ak = document.getElementById('akronym'); if (ak) ak.value = '';
                    const sb = document.getElementById('schluesselbegriffe'); if (sb) sb.value = '';
                    const t = document.getElementById('temperature'); if (t) t.value = '0.7';
                    const m = document.getElementById('maxZeichen'); if (m) m.value = '500';
                    try {
                        ['prompt_thema','prompt_ziele','prompt_beschreibung','prompt_beschreibung_html','prompt_schluesselbegriffe','prompt_title','prompt_akronym']
                          .forEach(k => { try { localStorage.removeItem(keyOf(k)); } catch {} });
                    } catch {}
                } catch {}
            }

            function clearAllFields(){
                try { clearPropertiesFields(); } catch {}
                try { document.querySelectorAll('.filter-checkbox input').forEach(cb => { if (cb.checked) { cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles:true })); } }); } catch {}
                try { document.querySelectorAll('.color-swatch').forEach(sw => sw.value = '#FFFFFF'); } catch {}
                try { for (const k in chosenCounts) delete chosenCounts[k]; } catch {}
                try { rebuildAiAccordion(); } catch {}
                try { rebuildSummary(); } catch {}
                try { updateUsedMarks(); } catch {}
                try { const ed = getEd(); if (ed) ed.setData(''); } catch {}
                try { localStorage.removeItem(keyOf('import_payload')); } catch {}
            }

            document.getElementById('reset-basic')?.addEventListener('click', (e) => {
                try { e.preventDefault(); } catch {}
                let editorHtml = '';
                try { const ed = getEd(); if (ed) editorHtml = ed.getData() || ''; } catch {}
                clearPropertiesFields();
                // Restore Prompt‑Editor unchanged
                try { const ed = getEd(); if (ed) ed.setData(editorHtml); } catch {}
                try { rebuildSummary(); } catch {}
                try { updateUsedMarks(); } catch {}
            });

            document.getElementById('new-prompt')?.addEventListener('click', async (e) => {
                try { e.preventDefault(); } catch {}
                const ok = await Swal.fire({
                    title: 'Neuen Prompt entwickeln?',
                    text: 'Alle aktuellen Eingaben und der Prompt‑Editor werden gelöscht.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Löschen',
                    cancelButtonText: 'Abbrechen'
                }).then(r => r.isConfirmed);
                if (!ok) return;
                clearAllFields();
            });
        })();

        // Prompt Techniken toggling now handled via Bootstrap collapse using its button under Beschreibung

        /* category-id → label */
        const categoryMap = {};
        tabs.forEach(t => categoryMap[t.dataset.category] = t.textContent.trim());

        // Model picker (Kisski)
        const KISSKI_MODELS = [
          'meta-llama-3.1-8b-instruct',
          'openai-gpt-oss-120b',
          'llama-3.3-70b-instruct',
          'gemma-3-27b-it',
          'medgemma-27b-it',
          'teuken-7b-instruct-research',
          'mistral-large-instruct',
          'qwen3-32b',
          'qwen2.5-coder-32b-instruct',
          'codestral-22b',
          'internvl2.5-8b',
          'qwen2.5-vl-72b-instruct'
        ];
        const MODEL_STORAGE_KEY = 'pa_model_id';
        function getSelectedModelId(){ return ''; }
        function setSelectedModelId(id){ /* no-op: model managed server-side */ }
        async function pickModelDropdown(){ return ''; }

        // Attempt to read the current OpenAI model selection from the Manage Users form if rendered
        const getCurrentModel = () => {
          try {
            const select = document.getElementById('OpenAIModel');
            if (select) {
              const val = (select.value || '').trim();
              if (val) return val;
            }
            const stored = localStorage.getItem(MODEL_STORAGE_KEY);
            if (stored) return stored;
          } catch {}
          return '';
        };

        // ===== Prompt generieren (extract techniques and insert into Prompt-Editor) =====
        (function(){
          const btn = document.getElementById('generate-techniques');
          if (!btn) return;
          const textFromHtml = (html) => {
            try { return new DOMParser().parseFromString(html || '', 'text/html').body.textContent || ''; } catch { return html || ''; }
          };
          btn.addEventListener('click', async () => {
            const modelId = "";
            const wrap = document.getElementById('editor-wrapper');
            const overlay = document.getElementById('prompt-gen-overlay');
            const edDesc = document.getElementById('beschreibung')?.ckeditorInstance;
            const beschHtml = edDesc ? edDesc.getData() : (document.getElementById('beschreibung')?.value || '');
            const beschTxt  = textFromHtml(beschHtml).trim();

            const form = {
              Titel: (document.getElementById('promptTitle')?.value || '').trim(),
              Thema: (document.getElementById('thema')?.value || '').trim(),
              Ziele: (document.getElementById('ziele')?.value || '').trim(),
              Beschreibung: beschTxt || (document.getElementById('beschreibung')?.value || '').trim(),
              Schlüsselbegriffe: (document.getElementById('schluesselbegriffe')?.value || '')
                  .split(',').map(s => s.trim()).filter(Boolean)
            };

            if (!form.Beschreibung) {
              await Swal.fire({ icon: 'warning', title: 'Beschreibung fehlt', text: 'Bitte gib eine Beschreibung/Fragestellung ein.' });
              return;
            }

            const groupName = await getSelectedGroupName();
            if (groupName === undefined) return;

            btn.disabled = true;
            const spin = btn.querySelector('i');
            const oldIcon = spin?.className;
            if (spin) { spin.className = 'bi bi-stars'; }
            if (wrap) wrap.classList.add('blurring');
            if (overlay) overlay.style.display = 'flex';
            try {
              const useKi = !!document.getElementById('toggle-ki-assist')?.checked;
              const res = await fetch('@Url.Content("~/api/PromptTechnique")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ form, useKiAssistant: useKi, modelId, groupName })
              });
              if (!res.ok) throw new Error(await res.text());
              const data = await res.json();
              const html = (data && data.html) || '';
              if (!html) throw new Error('Leere Antwort');

              const ed = getEd();
              if (ed) {
                const cur = ed.getData() || '';
                const sep = cur.trim() ? '<hr><p></p>' : '';
                ed.setData(cur + sep + html);
                ed.editing.view.focus();
                try { saveAutosave(); } catch {}
                Swal.fire({ icon: 'success', title: 'Prompt generiert', timer: 1500, showConfirmButton: false });
              }
            } catch (err) {
              console.error(err);
              Swal.fire({ icon: 'error', title: 'Generierung fehlgeschlagen', text: String(err) });
            } finally {
              btn.disabled = false;
              if (spin && oldIcon) spin.className = oldIcon;
              if (overlay) overlay.style.display = 'none';
              if (wrap) wrap.classList.remove('blurring');
            }
          });
        })();

        // Safety: remove any duplicate Prompt Helper blocks that may have been injected
        (function dedupPromptHelper(){
          try {
            const wraps = document.querySelectorAll('#promptHelperWrap');
            if (wraps.length > 1) {
              for (let i = 1; i < wraps.length; i++) wraps[i].remove();
            }
            const chips = document.querySelectorAll('#helper-chip');
            if (chips.length > 1) {
              for (let i = 1; i < chips.length; i++) {
                const row = chips[i].closest('.d-flex');
                if (row) row.remove(); else chips[i].remove();
              }
            }
          } catch {}
        })();

        /* ---------------------- CONSTANTS ------------------ */
        const secretKey = 'uni-wuppertal2025';            // used once, never duplicate!
        const CURRENT_TYPE = '@currentType'.toLowerCase();   // "text" | "bild" | "video"
        const IS_VISUAL = CURRENT_TYPE === 'bild' || CURRENT_TYPE === 'video';
        const USER_ID = '@(currentUserId ?? "anon")';      // scope client storage to the signed-in user
        const keyOf = (name) => `pa:${USER_ID}:${name}`;

        const AI_GROUPS = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(aiGroups));
        const ACTIVE_GROUP = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(activeGroup));
        const GLOBAL_VALUE = 'Ohne Gruppe'; // internal sentinel, shown as "Global (System‑Prompt)"

        async function getSelectedGroupName() {
          try {
            const options = {};

            // Always offer the global option (maps to internal sentinel "Ohne Gruppe")
            options[GLOBAL_VALUE] = 'Global (System‑Prompt)';

            if (Array.isArray(AI_GROUPS)) {
              AI_GROUPS.forEach(g => {
                const v = (g ?? '').toString().trim();
                if (v && !options[v]) options[v] = v;
              });
            }

            const keys = Object.keys(options);
            if (!keys.length) return null;

            const initial = (ACTIVE_GROUP && options[ACTIVE_GROUP]) ? ACTIVE_GROUP : GLOBAL_VALUE;

            const result = await Swal.fire({
              title: 'Gruppe für KI‑System‑Prompts wählen',
              input: 'select',
              inputOptions: options,
              inputValue: initial,
              showCancelButton: true,
              confirmButtonText: 'Übernehmen',
              cancelButtonText: 'Abbrechen'
            });

            if (!result.isConfirmed) return undefined;
            const val = (result.value ?? '').toString().trim();
            return val || GLOBAL_VALUE;
          } catch { return GLOBAL_VALUE; }
        }

        // Preserve new lines when only plain text is available
        function textToHtmlParagraphs(t){
          try {
            const s = (t ?? '').toString();
            if (!s) return '';
            // Split on blank lines first, fallback to single newlines
            const parts = s.includes('\n\n') ? s.split(/\n\n+/) : s.split(/\n+/);
            return parts
              .map(p => p.trim())
              .filter(Boolean)
              .map(p => `<p>${p.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`)
              .join('');
          } catch { return (t || '').toString(); }
        }

        // ── AUTOSAVE: keys & helpers ─────────────────────────────────────────
        const AUTOSAVE_ENABLED = false;
        const AUTOSAVE_KEY = keyOf(`autosave_${CURRENT_TYPE}`);
        if (!AUTOSAVE_ENABLED) {
          const wipeAllAutosaves = () => {
            try {
              const prefix = `pa:${USER_ID}:autosave_`;
              for (let i = localStorage.length - 1; i >= 0; i--) {
                const k = localStorage.key(i) || '';
                if (k.startsWith(prefix)) localStorage.removeItem(k);
              }
            } catch {}
          };
          try { wipeAllAutosaves(); } catch {}
          try { window.addEventListener('visibilitychange', () => { if (document.hidden) wipeAllAutosaves(); }); } catch {}
          try { window.addEventListener('beforeunload', wipeAllAutosaves); } catch {}
          try { window.addEventListener('pagehide', wipeAllAutosaves); } catch {}
          try { window.addEventListener('unload', wipeAllAutosaves); } catch {}

          // Globally prevent writes to autosave keys on this page
          try {
            const origSetItem = Storage.prototype.setItem;
            Storage.prototype.setItem = function(key, val){
              try {
                const k = String(key || '');
                if (k.includes(`:autosave_`)) { try { this.removeItem(k); } catch {} ; return; }
              } catch {}
              return origSetItem.apply(this, arguments);
            };
          } catch {}

          // Periodic cleanup in case late listeners write during teardown
          try {
            const kill = setInterval(wipeAllAutosaves, 200);
            window.addEventListener('pagehide', () => { try { clearInterval(kill); } catch {} });
            window.addEventListener('unload',   () => { try { clearInterval(kill); } catch {} });
          } catch {}
        }

        // Migrate legacy keys (no user prefix) to user-scoped keys once
        (function migrateLegacyKeys(){
          try {
            const pairs = [
              ['prompt_thema', keyOf('prompt_thema')],
              ['prompt_ziele', keyOf('prompt_ziele')],
              ['prompt_beschreibung', keyOf('prompt_beschreibung')],
              ['prompt_schluesselbegriffe', keyOf('prompt_schluesselbegriffe')],
              ['prompt_title', keyOf('prompt_title')],
              ['prompt_akronym', keyOf('prompt_akronym')],
              [`pa_select_after_reload_${CURRENT_TYPE}`, keyOf(`select_after_reload_${CURRENT_TYPE}`)],
              [`pa_focus_category_${CURRENT_TYPE}`, keyOf(`focus_category_${CURRENT_TYPE}`)],
              ['import_payload', keyOf('import_payload')]
            ];
            for (const [oldK, newK] of pairs) {
              const v = localStorage.getItem(oldK);
              if (v && !localStorage.getItem(newK)) {
                localStorage.setItem(newK, v);
              }
            }
          } catch {}
        })();

        // Resume helper open + scroll to generated/selected filter after reload
        (function(){
          try {
            const openFlag = localStorage.getItem('pa_open_helper');
            if (!openFlag) return;

            // Clear early to avoid loops
            localStorage.removeItem('pa_open_helper');
            const catId = localStorage.getItem('pa_scroll_tab_category') || '';
            const itemId = localStorage.getItem('pa_scroll_item_id') || '';
            const catName = localStorage.getItem('pa_scroll_tab_name') || '';
            const itemTitle = localStorage.getItem('pa_scroll_item_title') || '';
            localStorage.removeItem('pa_scroll_tab_category');
            localStorage.removeItem('pa_scroll_item_id');
            localStorage.removeItem('pa_scroll_tab_name');
            localStorage.removeItem('pa_scroll_item_title');

            const openHelper = () => {
              const wrap = document.getElementById('promptHelperWrap');
              if (!wrap) return;
              // Bootstrap collapse: ensure open
              wrap.classList.add('show');
              const chip = document.getElementById('helper-chip');
              chip?.setAttribute('aria-expanded', 'true');
            };

            const focusTab = () => {
              let tab = null;
              if (catId) tab = document.querySelector(`.filter-tab[data-category="${CSS.escape(catId)}"]`);
              if (!tab && catName) tab = Array.from(document.querySelectorAll('.filter-tab'))
                .find(t => (t.dataset.name || '').trim().toLowerCase() === catName.trim().toLowerCase());
              if (tab) {
                tab.click();
                tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
              }
              return tab;
            };

            const scrollItem = () => {
              let target = null;
              if (itemId) target = document.getElementById('filter_' + itemId);
              if (!target && itemTitle) {
                // find by label text match
                const labels = Array.from(document.querySelectorAll('.filter-checkbox .filter-label'));
                const match = labels.find(l => (l.textContent || '').trim().toLowerCase() === itemTitle.trim().toLowerCase());
                if (match) target = match.closest('.filter-checkbox')?.querySelector('input[type="checkbox"], input[type="radio"]') || match.closest('.filter-checkbox');
              }
              if (!target) return;
              const panel = target.closest('.filter-panel');
              if (panel) {
                const cat = panel.dataset.category;
                if (cat) {
                  const t = document.querySelector(`.filter-tab[data-category="${CSS.escape(cat)}"]`);
                  t?.click();
                }
              }
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            // Slight delay to allow DOM/layout
            setTimeout(() => { openHelper(); focusTab(); scrollItem(); }, 60);
          } catch {}
        })();
        const debounced = (fn, wait=400) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } };
        const saveAutosave = () => {};
        const saveAutosaveDebounced = () => {};
        const restoreAutosaveIfAny = () => {};

        // ── Auto-grow textareas (Prompt‑Eigenschaften) ─────────────────────
        function autoGrow(el){
            if (!el) return;
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }
        function setupAutoGrow(){
            const list = document.querySelectorAll('.scalable-textarea');
            list.forEach(el => {
                if (!el.dataset.autogrowInit){
                    el.dataset.autogrowInit = '1';
                    el.addEventListener('input', ()=> autoGrow(el));
                }
                autoGrow(el);
            });
            if (!window.__autoGrowResize){
                window.__autoGrowResize = debounced(()=>{
                    document.querySelectorAll('.scalable-textarea').forEach(autoGrow);
                }, 200);
                window.addEventListener('resize', window.__autoGrowResize);
            }
        }

        // Track how often each criteria item was inserted into the editor
        const chosenCounts = Object.create(null); // { [value:string]: number }
        const getCount = v => chosenCounts[v] || 0;
        const incrementCount = v => { if (!v) return; chosenCounts[v] = getCount(v) + 1; updateUsedMarks(); };

        function updateUsedMarks() {
          // 1) Filter panels (checkbox list)
          document.querySelectorAll('.filter-checkbox').forEach(fc => {
            const val = fc.querySelector('input')?.value;
            if (!val) return;
            const cnt = getCount(val);
            fc.style.background = cnt > 0 ? '#f3fff6' : '';
            let badge = fc.querySelector('.use-badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'use-badge';
              badge.style.cssText = 'display:inline-block;background:#2db049;color:#fff;border-radius:999px;font-size:.75rem;padding:0 .4rem;line-height:1.2rem;margin-left:.4rem;';
              fc.querySelector('.filter-label')?.appendChild(badge);
            }
            badge.textContent = `×${cnt}`;
            badge.style.display = cnt > 0 ? '' : 'none';
          });

          // 2) Prompt‑Kriterien summary items
          document.querySelectorAll('#filter-summary .filter-summary-item').forEach(item => {
            const val = item.querySelector('.trash-btn')?.dataset?.val || item.querySelector('.plus-btn')?.dataset?.val;
            if (!val) return;
            const cnt = getCount(val);
            item.style.background = cnt > 0 ? '#f3fff6' : '';
            let badge = item.querySelector('.use-badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'use-badge';
              badge.style.cssText = 'display:inline-block;background:#2db049;color:#fff;border-radius:999px;font-size:.75rem;padding:0 .4rem;line-height:1.2rem;margin-left:.4rem;';
              item.appendChild(badge);
            }
            badge.textContent = `×${cnt}`;
            badge.style.display = cnt > 0 ? '' : 'none';
          });

          // 2b) KI‑Accordion items
          document.querySelectorAll('#ai-selected-accordion .filter-summary-item').forEach(item => {
            const val = item.querySelector('.trash-btn')?.dataset?.val || item.querySelector('.plus-btn')?.dataset?.val;
            if (!val) return;
            const cnt = getCount(val);
            item.style.background = cnt > 0 ? '#f3fff6' : '';
            let badge = item.querySelector('.use-badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'use-badge';
              badge.style.cssText = 'display:inline-block;background:#2db049;color:#fff;border-radius:999px;font-size:.75rem;padding:0 .4rem;line-height:1.2rem;margin-left:.4rem;';
              item.appendChild(badge);
            }
            badge.textContent = `×${cnt}`;
            badge.style.display = cnt > 0 ? '' : 'none';
          });

          // 3) Sidebar criteria items
          document.querySelectorAll('#sidebarBody .criteria-item').forEach(ci => {
            const val = ci.querySelector('.trash-btn')?.dataset?.val;
            if (!val) return;
            const cnt = getCount(val);
            ci.style.background = cnt > 0 ? '#f3fff6' : '';
            let badge = ci.querySelector('.use-badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'use-badge';
              badge.style.cssText = 'display:inline-block;background:#2db049;color:#fff;border-radius:999px;font-size:.75rem;padding:0 .4rem;line-height:1.2rem;margin-left:.4rem;';
              ci.insertBefore(badge, ci.querySelector('.trash-btn'));
            }
            badge.textContent = `×${cnt}`;
            badge.style.display = cnt > 0 ? '' : 'none';
          });
        }

        /* --------------------------------------------------
           INITIAL VISIBILITY (numbers vs colours)
        -------------------------------------------------- */
                /* ---------- Sichtbarkeit (für Bild/Video vs Text) ---------- */
        document.getElementById('maxZeichen')
                .parentElement.parentElement.style.display = IS_VISUAL ? 'none' : '';

        document.getElementById('temperature')
                .parentElement.parentElement.style.display = IS_VISUAL ? 'none' : '';

        //  ➜ Palette nur bei Bild / Video anzeigen
        document.getElementById('colorPalette').style.display = IS_VISUAL ? '' : 'none';

        // ── Autosave bindings (disabled) ───────────────────────────────────
        const bindAutosave = () => {};
        bindAutosave();
        setupAutoGrow();


        // Keyword Vorauswahl: animated accordion and chip interactions
        (function(){
            const input = document.getElementById('schluesselbegriffe');
            if (!input) return;
            const btn   = document.getElementById('kwToggleBtn');
            const acc   = document.getElementById('kwAccordion');
            const chips = document.getElementById('kwChips');

            const parse = () => input.value.split(',').map(s => s.trim()).filter(Boolean);
            const setVal = (arr) => {
                const unique = [];
                arr.forEach(k => {
                    if (!unique.some(u => u.toLowerCase() === k.toLowerCase())) unique.push(k);
                });
                input.value = unique.join(', ');
                input.dispatchEvent(new Event('input', { bubbles: true })); // autosave
            };

            const syncChipActive = () => {
                if (!chips) return;
                const arr = parse();
                chips.querySelectorAll('.kw-chip').forEach(ch => {
                    const kw = (ch.dataset.kw || ch.textContent || '').trim();
                    const on = arr.some(k => k.toLowerCase() === kw.toLowerCase());
                    ch.classList.toggle('active', on);
                });
            };

            chips?.addEventListener('click', e => {
                const chip = e.target.closest('.kw-chip');
                if (!chip) return;
                const kw = (chip.dataset.kw || chip.textContent || '').trim();
                if (!kw) return;
                const arr = parse();
                const idx = arr.findIndex(k => k.toLowerCase() === kw.toLowerCase());
                if (idx >= 0) {
                    arr.splice(idx, 1);
                    chip.classList.remove('active');
                } else {
                    arr.push(kw);
                    chip.classList.add('active');
                }
                setVal(arr);
                input.focus();
            });

            if (btn && acc) {
                const caret = btn.querySelector('i.bi');
                const setIcon = (open) => {
                    if (!caret) return;
                    caret.classList.toggle('bi-caret-up-fill', open);
                    caret.classList.toggle('bi-caret-down-fill', !open);
                };

                let isOpen = acc.classList.contains('open') || btn.getAttribute('aria-expanded') === 'true';
                let animating = false;
                let animTimer = null;
                const setBtnVisual = (open) => {
                    btn.classList.toggle('btn-accent', !open);   // green when closed
                    btn.classList.toggle('open', open);           // gray when open
                };

                function openAcc() {
                    if (animating || isOpen) return; // idempotent
                    animating = true;
                    acc.classList.add('open');
                    btn.setAttribute('aria-expanded', 'true');
                    isOpen = true;
                    setIcon(true);
                    setBtnVisual(true);
                    // Instant robust open: disable transition, set to auto height, then restore
                    const prev = acc.style.transition;
                    acc.style.transition = 'none';
                    acc.style.height = 'auto';
                    acc.offsetHeight; // reflow
                    acc.style.transition = prev || '';
                    if (animTimer) clearTimeout(animTimer);
                    animTimer = setTimeout(() => { animating = false; }, 50);
                }
                function closeAcc() {
                    if (animating || !isOpen) return; // idempotent
                    animating = true;
                    const current = acc.scrollHeight;
                    acc.style.height = current + 'px';
                    acc.offsetHeight; // force reflow
                    acc.style.height = '0px';
                    acc.classList.remove('open');
                    btn.setAttribute('aria-expanded', 'false');
                    isOpen = false;
                    setIcon(false);
                    setBtnVisual(false);
                    if (animTimer) clearTimeout(animTimer);
                    animTimer = setTimeout(() => { animating = false; }, 450);
                }

                // Toggle directly on button click to avoid focus edge cases
                btn.addEventListener('mousedown', (e) => e.preventDefault());
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (isOpen) {
                        closeAcc();
                        try { input.blur(); } catch {}
                    } else {
                        openAcc();
                        try { input.focus({ preventScroll: true }); } catch { input.focus(); }
                    }
                });

                // Focus in input should also open accordion (no suppression logic)
                input.addEventListener('focus', () => {
                    if (!isOpen) openAcc();
                });

                // For readonly input (normal users), also open on click
                if (input.hasAttribute('readonly') || input.dataset.canAdd === 'false') {
                    input.addEventListener('click', () => {
                        if (!isOpen) openAcc();
                    });
                    // Auto-open accordion for users who can only select (not type)
                    setTimeout(() => {
                        if (!isOpen) openAcc();
                    }, 100);
                }
            }

            // keep chip active states in sync with manual edits
            input.addEventListener('input', syncChipActive);
            syncChipActive();
        })();


        // ── SAVE VARIATION TO MY PROMPTS ─────────────────────────────
           document.getElementById('save-variation-my')?.addEventListener('click', async () => {
          const akronym = document.getElementById('akronym').value.trim();
          if (!akronym)
            return Swal.fire('Akronym fehlt', 'Bitte zuerst ein Akronym angeben.', 'error');

          /* existiert das Basisprompt?                                             */
          if (!(await akronymExistsForMe(akronym)))
            return Swal.fire('Nicht gefunden',
                             `Kein gespeicherter Prompt mit Akronym “${akronym}” vorhanden.`,
                             'error');

          const go = await Swal.fire({
            title: `Variation zu “${akronym}” speichern?`,
            icon:  'question',
            showCancelButton: true,
            confirmButtonText: 'Speichern',
            cancelButtonText : 'Abbrechen'
          }).then(r => r.isConfirmed);
          if (!go) return;               // user aborted

          try {
            const _st = collectState();
            _st.promptHtml = ensureColorsInHtml(_st.promptHtml, _st.colors);
            mergeFilterJsonWithTechniques(_st);
            const res = await fetch('@Url.Action("AddVariation", "MyPrompts", new { area = "User" })', {
              method : 'POST',
              headers: { 'Content-Type': 'application/json' },
              body   : JSON.stringify({ Akronym: akronym, Data: _st })
            });
            if (!res.ok) throw await res.text();
            Swal.fire({ icon:'success', title:'Variation gespeichert', timer:1500, showConfirmButton:false });
          } catch (err) {
            Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
          }
        });



                // ——— Markdown-Toolbar für Prompt-Editor ———


                      ;(function () {
            const toolbar = document.getElementById('markdown-toolbar');
            if (!toolbar) return;

            function wrapOrInsert(md) {
                const ed = getEd();                 // CKEditor‑Instanz besorgen
                if (!ed) return;

                ed.model.change(writer => {
                    const sel        = ed.model.document.selection;
                    const collapsed  = sel.isCollapsed;
                    const firstPos   = sel.getFirstPosition();


                           /* --- Mapping ------------------------------------------------ */
        let start = '', end = '', placeholder = '';
        switch (md) {
            case '#':    start = '#';  break;                       // H1
            case '**':   start = '**'; end = '**'; placeholder = 'fett';     break;
            case '*':    start = '*';  end = '*';  placeholder = 'kursiv';   break;
            case '`':    start = '`';  end = '`';  placeholder = 'code';     break;
            case '{}':   start = '{';  end = '}';  placeholder = 'variable'; break;
            case '()':   start = '(';  end = ')';  placeholder = 'text';     break;
            case '[]':   start = '[';  end = ']';  placeholder = 'text';     break;
            case '<>':   start = '<';  end = '>';  placeholder = 'tag';      break;
            case '<':    start = '<';  break;                       // Einzel­zeichen
            case '>':    start = '>';  break;
            case '-':    start = '- '; break;                       // Bullet
            case '+':    start = '+ '; break;                       // Checklist‑Bullet
            default:     start = md;   break;
        }


                    /* --- Selektion entfernen & merken --------------------------- */
                    let selected = '';
                    if (!collapsed) {
                        const range    = sel.getFirstRange();
                        const viewFrag = ed.data.toView(range);
                        selected       = viewFrag.getChild(0)?.data || '';
                        writer.remove(range);        // cut
                    }

                    /* --- Einfügen ---------------------------------------------- */
                    const insertText = start + (selected || placeholder) + end;
                    writer.insertText(insertText, firstPos);

                    /* --- Cursor / Auswahl setzen ------------------------------- */
                    const afterStart = firstPos.offset + start.length;

                    if (selected) {
                        // Cursor hinter den neu eingefügten Block setzen
                        const pos = writer.createPositionAt(firstPos.parent,
                                                            firstPos.offset + insertText.length);
                        writer.setSelection(writer.createRange(pos));
                    } else if (placeholder) {
                        // Platzhalter markieren
                        const anchor = writer.createPositionAt(firstPos.parent, afterStart);
                        const focus  = writer.createPositionAt(firstPos.parent,
                                                                afterStart + placeholder.length);
                        writer.setSelection(writer.createRange(anchor, focus));
                    } else {
                        // Einzelzeichen: Cursor ans Ende
                        const pos = writer.createPositionAt(firstPos.parent,
                                                            firstPos.offset + insertText.length);
                        writer.setSelection(writer.createRange(pos));
                    }
                });

                ed.editing.view.focus();
            }

            /* --- Klick‑Delegation --------------------------------------------- */
            toolbar.addEventListener('click', e => {
                const btn = e.target.closest('button[data-md]');
                if (btn) wrapOrInsert(btn.dataset.md);
            });
        })();

        // ——— Markdown-Toolbar for Beschreibung ———
        (function(){
          const toggle = document.getElementById('toggle-besch-markdown');
          const toolbar = document.getElementById('besch-markdown-toolbar');
          if (!toggle || !toolbar) return;
          toggle.addEventListener('click', () => toolbar.classList.toggle('show'));

          function getDescEd(){ return document.getElementById('beschreibung')?.ckeditorInstance; }

          function wrapOrInsert(md){
            const ed = getDescEd(); if (!ed) return;
            ed.model.change(writer => {
              const sel = ed.model.document.selection;
              const collapsed = sel.isCollapsed;
              const firstPos = sel.getFirstPosition();

              let start='', end='', placeholder='';
              switch(md){
                case '#': start='#'; break;
                case '**': start='**'; end='**'; placeholder='fett'; break;
                case '*': start='*'; end='*'; placeholder='kursiv'; break;
                case '`': start='`'; end='`'; placeholder='code'; break;
                case '{}': start='{'; end='}'; placeholder='variable'; break;
                case '()': start='('; end=')'; placeholder='text'; break;
                case '[]': start='['; end=']'; placeholder='text'; break;
                case '<>': start='<'; end='>'; placeholder='tag'; break;
                case '<': start='<'; break;
                case '>': start='>'; break;
                case '-': start='- '; break;
                case '+': start='+ '; break;
                default: start=md; break;
              }

              let selected='';
              if (!collapsed){
                const range = sel.getFirstRange();
                const viewFrag = ed.data.toView(range);
                selected = viewFrag.getChild(0)?.data || '';
                writer.remove(range);
              }

              const insertText = start + (selected || placeholder) + end;
              writer.insertText(insertText, firstPos);

              const afterStart = firstPos.offset + start.length;
              if (selected){
                const pos = writer.createPositionAt(firstPos.parent, firstPos.offset + insertText.length);
                writer.setSelection(writer.createRange(pos));
              } else if (placeholder){
                const anchor = writer.createPositionAt(firstPos.parent, afterStart);
                const focus  = writer.createPositionAt(firstPos.parent, afterStart + placeholder.length);
                writer.setSelection(writer.createRange(anchor, focus));
              } else {
                const pos = writer.createPositionAt(firstPos.parent, firstPos.offset + insertText.length);
                writer.setSelection(writer.createRange(pos));
              }
            });
            ed.editing.view.focus();
          }

          toolbar.addEventListener('click', e => {
            const btn = e.target.closest('button[data-md]');
            if (btn) wrapOrInsert(btn.dataset.md);
            const w = e.target.closest('button[data-word]');
            if (w){ wrapOrInsert(w.dataset.word + ' '); }
          });
        })();



                /**
         * Liefert alle angehakten Filter-Objekte, deren
         * Instruction-Text im aktuellen Editor *logisch* vorkommt.
         *  – Case-insensitiv
         *  – Mehrfach-Leerzeichen / Zeilenumbrüche werden ignoriert
         */

        function normalise(str = '') {
          // ① convert “&nbsp;” etc.                            ② strip all markup
          const txt = new DOMParser().parseFromString(str, 'text/html').body.textContent;
          return txt.replace(/\s+/g, ' ').toLowerCase().trim();   // ③ squash whitespace
        }

                function getUsedFilters(state = collectState()) {
          const editorText = normalise(state.promptHtml);
          const seen = new Set();
          const out = [];
          for (const it of state.checkedItems) {
            const full  = normalise((it.instruction || it.value).replace(/&#10;/g, '\n'));
            const title = normalise(it.value);
            const matches = (full && editorText.includes(full)) || (title && editorText.includes(title));
            if (!matches) continue;
            // build a stable dedupe key (prefer full instruction)
            const key = full || title;
            if (key && !seen.has(key)) { seen.add(key); out.push(it); }
          }
          return out;
        }


        document.getElementById('save-to-my')?.addEventListener('click', async () => {
          const ok = await Swal.fire({
            title: 'In Meine Prompts speichern?',
            text: 'Bist du sicher, dass du diesen Prompt speichern möchtest?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ja, speichern',
            cancelButtonText: 'Abbrechen'
          }).then(r => r.isConfirmed);
          if (!ok) return;

                  const akronym = document.getElementById('akronym').value.trim();
        if (!akronym) return Swal.fire('Fehler', 'Bitte Akronym eingeben.', 'error');

        if (await akronymExistsForMe(akronym)) {
          const ok = await Swal.fire({
            title: 'Akronym bereits vorhanden',
            text : `“${akronym}” existiert schon. Überschreiben?`,
            icon : 'warning',
            showCancelButton: true,
            confirmButtonText: 'Überschreiben',
            cancelButtonText : 'Abbrechen'
          }).then(r => r.isConfirmed);
          if (!ok) return;               // user aborted
        }


          const state = collectState();
          // embed colors into HTML so they persist even if “Anwenden” wasn’t clicked
          state.promptHtml = ensureColorsInHtml(state.promptHtml, state.colors);
          const used = getUsedFilters(state);

          const payload = {
            Akronym:            document.getElementById('akronym').value.trim(),
            Title:              document.getElementById('promptTitle').value.trim(),
            Beschreibung:       document.getElementById('beschreibung').value.trim(),
            Schluesselbegriffe: document.getElementById('schluesselbegriffe').value.trim(),
            Thema:              state.thema,
            Ziele:              state.ziele,
            PromptHtml:         state.promptHtml,
            PromptType:         state.type,
            FilterJson:         JSON.stringify(used),
            Temperatur:         state.temperatur,
            MaxZeichen:         state.maxZeichen
          };
          const hash = await sha256(JSON.stringify(payload));
          const body = { ...payload, MetaHash: hash };

          try {
            const res = await fetch('@Url.Action("Save", "MyPrompts", new { area = "User" })', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            if (!res.ok) throw await res.text();
            Swal.fire({ icon:'success', title:'Gespeichert!', timer:1500, showConfirmButton:false });
          } catch (err) {
            Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
          }
        });

                async function akronymExistsForMe(akronym) {
          const existsUrl = '@Url.Action("Exists", "MyPrompts", new { area = "User" })';
          const res = await fetch(`${existsUrl}?akronym=${encodeURIComponent(akronym)}`);
          const { exists } = await res.json();
          return exists;
        }



        /* -------------- SHA-256 helpers -------------------- */
        function buf2hex(buf) { return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join(''); }
        async function sha256(str) {
            const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            return buf2hex(hash);
        }

        /* -------------- CKEditor --------------------------- */
        // ClassicEditor.create(document.querySelector('#editor'), {
        //     toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'undo', 'redo'],
        //     language: 'de'
        // }).then(ed => {
        //     document.querySelector('#editor').ckeditorInstance = ed;

        //     /* 🟢 if we imported before the editor existed → apply now */
        //     if (window.__pendingState) { applyState(window.__pendingState); delete window.__pendingState; }
        // });

              ClassicEditor
        .create( document.querySelector('#editor'), {
            toolbar : ['heading','|','bold','italic','link','bulletedList','numberedList','undo','redo'],
            language: 'de'
        })
        .then( ed => {

            /* Editor-Instanz ablegen */
            document.querySelector('#editor').ckeditorInstance = ed;

            /* eventuell importierte Payload sofort anwenden */
            if (window.__pendingState) {
                applyState(window.__pendingState);
                delete window.__pendingState;
            }

            // autosave on editor content change
            try { ed.model.document.on('change:data', saveAutosaveDebounced); } catch {}

            /* ⬇︎––– SAFARI-WORKAROUND: Clipboard während „Copy“ säubern –––⬇︎ */
            const viewDoc = ed.editing.view.document;

                   viewDoc.on('copy', async (evt, data) => {
            const html  = data.dataTransfer.getData('text/html') || '';
            const plain = await window.copyPromptHtml(html, true);   // ✔︎ zweites Arg

            if (plain) {
                data.dataTransfer.clearData();
                data.dataTransfer.setData('text/plain', plain);
                        data.dataTransfer.setData(
             'text/html',
              `<pre style="white-space:pre-wrap">${plain
                   .replace(/&/g,'&amp;')
                   .replace(/</g,'&lt;')
                   .replace(/\n/g,'<br>')}</pre>`
          );                        // now the HTML branch is well-formed
           evt.stop();               // keep Safari from adding its own flavours
         }
        });

            /* ⬆︎–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––⬆︎ */
        })
        .catch( console.error );

        ClassicEditor
        .create( document.querySelector('#beschreibung'), {
            toolbar : ['bold','italic','link','bulletedList','numberedList','undo','redo'],
            language: 'de'
        })
        .then( ed => {
            const ta = document.querySelector('#beschreibung');
            ta.ckeditorInstance = ed;
            const syncPlain = () => {
                try {
                    const html = ed.getData();
                    const text = new DOMParser().parseFromString(html, 'text/html').body.textContent || '';
                    ta.value = text.trim();
                    try { saveAutosaveDebounced(); } catch {}
                } catch {}
            };
            try { ed.model.document.on('change:data', syncPlain); } catch {}
            try {
              const raw = localStorage.getItem(AUTOSAVE_KEY);
              const bHtml = raw ? (JSON.parse(raw)?.data?.beschreibungHtml) : null;
              if (bHtml) {
                ed.setData(bHtml);
              } else {
                ed.setData(ta.value || '');
              }
            } catch {}
            // Safety: re-apply autosaved HTML shortly after initialization to avoid late overwrites
            try {
              const raw = localStorage.getItem(AUTOSAVE_KEY);
              const bHtml = raw ? (JSON.parse(raw)?.data?.beschreibungHtml) : null;
              if (bHtml) setTimeout(() => { try { ed.setData(bHtml); } catch {} }, 150);
            } catch {}
        })
        .catch( console.error );

        ClassicEditor
        .create( document.querySelector('#promptTitle'), {
            toolbar : ['bold','italic','link','bulletedList','numberedList','undo','redo'],
            language: 'de'
        })
        .then( ed => {
            const ta = document.querySelector('#promptTitle');
            ta.ckeditorInstance = ed;
            try { ed.ui.view.element?.classList?.add('ck-compact'); } catch {}
            const syncPlain = () => {
                try {
                    const html = ed.getData();
                    const text = new DOMParser().parseFromString(html, 'text/html').body.textContent || '';
                    ta.value = text.trim();
                    try { saveAutosaveDebounced(); } catch {}
                } catch {}
            };
            try { ed.model.document.on('change:data', syncPlain); } catch {}
            try { ed.setData(ta.value || ''); } catch {}
        })
        .catch( console.error );

        ClassicEditor
        .create( document.querySelector('#thema'), {
            toolbar : ['bold','italic','link','bulletedList','numberedList','undo','redo'],
            language: 'de'
        })
        .then( ed => {
            const ta = document.querySelector('#thema');
            ta.ckeditorInstance = ed;
            try { ed.ui.view.element?.classList?.add('ck-compact'); } catch {}
            const syncPlain = () => {
                try {
                    const html = ed.getData();
                    const text = new DOMParser().parseFromString(html, 'text/html').body.textContent || '';
                    ta.value = text.trim();
                    try { saveAutosaveDebounced(); } catch {}
                } catch {}
            };
            try { ed.model.document.on('change:data', syncPlain); } catch {}
            try { ed.setData(ta.value || ''); } catch {}
        })
        .catch( console.error );

        ClassicEditor
        .create( document.querySelector('#ziele'), {
            toolbar : ['bold','italic','link','bulletedList','numberedList','undo','redo'],
            language: 'de'
        })
        .then( ed => {
            const ta = document.querySelector('#ziele');
            ta.ckeditorInstance = ed;
            try { ed.ui.view.element?.classList?.add('ck-compact'); } catch {}
            const syncPlain = () => {
                try {
                    const html = ed.getData();
                    const text = new DOMParser().parseFromString(html, 'text/html').body.textContent || '';
                    ta.value = text.trim();
                    try { saveAutosaveDebounced(); } catch {}
                } catch {}
            };
            try { ed.model.document.on('change:data', syncPlain); } catch {}
            try { ed.setData(ta.value || ''); } catch {}
        })
        .catch( console.error );

                    document.getElementById('toggle-markdown').addEventListener('click', () => {
              const tb = document.getElementById('markdown-toolbar');
              tb.classList.toggle('show');
            });

               /* ---------- WORD KEYBOARD ----------------------------------- */
        document.getElementById('word-toolbar').addEventListener('click', e => {
            const btn = e.target.closest('.btn-word');
            if (!btn) return;

            const word = btn.dataset.word + ' ';
            const ed   = getEd();                 // helper already defined
            if (!ed)  return;

            ed.model.change(writer => {
                const pos = ed.model.document.selection.getFirstPosition();

                /* Insert and capture the range that CKEditor returns … */
                const insertionRange = ed.model.insertContent(
                    ed.data.toModel(ed.data.processor.toView(word)),
                    pos
                );

                /* … then place the caret right after the inserted word */
                writer.setSelection(insertionRange.end);
            });

            ed.editing.view.focus();              // caret now blinks after the word
        });

        



        /* -------------- Fullscreen toggle ------------------ */
        const toggleBtn = document.getElementById('toggle-fullscreen');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const wrap = document.getElementById('editor-wrapper');
                wrap.classList.toggle('fullscreen-editor');
                toggleBtn.innerHTML = wrap.classList.contains('fullscreen-editor')
                    ? '<i class="bi bi-fullscreen-exit"></i> Minimieren'
                    : '<i class="bi bi-arrows-fullscreen"></i> Vollbild';
            });
        }

        /* --------------------------------------------------
           HELPERS
        -------------------------------------------------- */
        const getEd = () => document.querySelector('#editor').ckeditorInstance;

                /* ---------- 🆕  SPEC-REFRESH HELPER ----------------- */

               /* ---------- SPEC-REFRESH v3  (string-based, bullet-proof) ---------- */
            function refreshSpecifications () {
            const ed = getEd(); if (!ed) return;

            const titel = document.getElementById('promptTitle').value.trim();   // ← NEW
            const thema = document.getElementById('thema').value.trim();
            const ziele = document.getElementById('ziele').value.trim();
            const felder = [
                titel && `<p> <strong>Title:</strong> ${titel}</p>`,                                    // ← NEW
                thema && `<p><strong>Thema:</strong> ${thema}</p>`,
                ziele && `<p><strong>Ziele:</strong> ${ziele}</p>`,
               (() => {
                 const ta = document.getElementById('beschreibung');
                 const edInst = ta && ta.ckeditorInstance;
                 let rawText = ta?.value || '';
                 try {
                   const html = edInst ? (edInst.getData() || '') : '';
                   if (html) {
                     // Convert common block boundaries into newlines, keep bullets
                     const normalized = html
                       .replace(/<\s*br\s*\/?\s*>/gi, '\n')
                       .replace(/<\s*\/p\s*>/gi, '\n')
                       .replace(/<\s*li\s*>/gi, '• ')
                       .replace(/<\s*\/li\s*>/gi, '\n')
                       .replace(/<\s*div\s*>/gi, '')
                       .replace(/<\s*\/div\s*>/gi, '\n');
                     const text = new DOMParser().parseFromString(normalized, 'text/html').body.textContent || '';
                     rawText = text;
                   }
                 } catch {}
                 const trimmed = (rawText || '').trim();
                if (!trimmed) return '';
                const escaped = trimmed
                  .replace(/&/g,'&amp;')
                  .replace(/</g,'&lt;')
                  .replace(/>/g,'&gt;')
                  .replace(/\"/g,'&quot;')
                  .replace(/'/g,'&#39;');
                const withBr = escaped.replace(/(\r\n|\n|\r)/g, '<br>');
                return `<p data-pc-desc="1">${withBr}</p>`;
               })(),
                (() => {
                    const kw = document.getElementById('schluesselbegriffe')
                                       .value.split(',').map(s=>s.trim()).filter(Boolean).join(', ');
                    return kw && `<p><strong>Schlüsselbegriffe:</strong> ${kw}</p>`;
                })()
            ].filter(Boolean).join('');

            let html = ed.getData();

            /* drop the old block (curly‑braced title OR any spec line) */
                    html = html.replace(/<p>\{[^}]*\}<\/p>|<p><strong>(Title|Thema|Ziele|Beschreibung|Schlüsselbegriffe):<\/strong>[\s\S]*?<\/p>|<p[^>]*data-pc-desc=("|')1\1[^>]*>[\s\S]*?<\/p>/gi, '')
                       .trim();

            ed.setData(felder + html);
            ed.editing.view.focus();
        }






        function ensureBaseTemplate () {
            const ed = getEd(); if (!ed) return false;

            /* schon Inhalt? → nichts tun */
            if (ed.getData().trim()) return false;

            /* nur optionaler Titel‑Platzhalter */
            const titel = document.getElementById('promptTitle').value.trim();
            const firstLine = titel ? `<p>{${titel}}</p>` : '';

            ed.setData(firstLine);          // Editor füllen
            return true;                    // signalisiert „war leer“
        }




             /* ---------- Max‑Zeichen an Cursor ---------- */
               document.getElementById('apply-max').addEventListener('click', () => {
            const ed = getEd(); if (!ed) return;
            const maxZ = document.getElementById('maxZeichen').value.trim();
            ensureBaseTemplate();

            ed.model.change(writer => {
                /* ── alte Zeile löschen ─────────────────────────────── */
                for (const p of [...ed.model.document.getRoot().getChildren()]) {
                    if (!p.is('element', 'paragraph')) continue;
                    const txt = ed.data.toView(p).getChild(0)?.data || '';
                    if (/Max Zeichen:/i.test(txt)) writer.remove(p);
                }

                /* ── neue Zeile einfügen ────────────────────────────── */
                const html = `<div>Die gesamte Antwort darf <strong>Max Zeichen:</strong> ${maxZ} umfassen.</div>`;
                const frag = ed.data.toModel(ed.data.processor.toView(html));
                const pos  = ed.model.document.selection.getFirstPosition();

                /* Range zurückbekommen → Cursor dahinter setzen */
                const insertionRange = ed.model.insertContent(frag, pos);
                writer.setSelection(insertionRange.end);          // ← **neu**
            });

            ed.editing.view.focus();                              // Cursor blinkt hinter dem neuen Text
        });



               /* ---------- Temperatur an Cursor ---------- */
        document.getElementById('apply-temp').addEventListener('click', () => {
            const ed = getEd(); if (!ed) return;
            const temp = document.getElementById('temperature').value.trim();
            ensureBaseTemplate();

            ed.model.change(writer => {
                /* evtl. alte Temperatur‑Zeilen löschen */
                for (const ch of [...ed.model.document.getRoot().getChildren()]) {
                    if (ch.is('element','paragraph')) {
                        const txt = ed.data.toView(ch).getChild(0)?.data || '';
                        if (/Temperatur:/i.test(txt)) writer.remove(ch);
                    }
                }

                /* neue Zeile an Cursorposition einfügen */
                const html = `<div>Setze die <strong>Temperatur:</strong> ${temp}, um den Zufallsgrad bei der Antwort zu steuern.</div>`;
                const frag = ed.data.toModel(ed.data.processor.toView(html));
                const pos  = ed.model.document.selection.getFirstPosition();

                /* Range zurückbekommen → Cursor dahinter setzen */
                const insertionRange = ed.model.insertContent(frag, pos);
                writer.setSelection(insertionRange.end);  // ← **neu**
            });

            ed.editing.view.focus(); // Cursor blinkt hinter dem neuen Text
        });



        /* ---------- Sichtbarkeit (für Bild/Video vs Text) ---------- */
               // jeweils parentElement.parentElement (Input → col → row)
        document.getElementById('maxZeichen').parentElement.parentElement.style.display =
              (IS_VISUAL ? 'none' : '');

        document.getElementById('temperature').parentElement.parentElement.style.display =
              (IS_VISUAL ? 'none' : '');





        /* --------------------------------------------------
           PROMPT RESET
        -------------------------------------------------- */
            //   document.getElementById('reset-prompt').addEventListener('click', () => {
            // const ed = getEd(); if (!ed) return;
            // Swal.fire({
            //     title: 'Prompt zurücksetzen?',
            //     text: 'Der gesamte Inhalt im Editor wird gelöscht.',
            //     icon: 'warning',
            //     showCancelButton: true,
            //     confirmButtonText: 'Ja, löschen',
            //     cancelButtonText: 'Abbrechen',
            //     confirmButtonColor: '#d33',
            //     cancelButtonColor: '#3085d6'
            // }).then(r => {
            //     if (r.isConfirmed) {
            //         ed.setData('');
            //         Swal.fire({ icon: 'success', title: 'Prompt gelöscht', timer: 2000, showConfirmButton: false });
            //     }
            // });

                                  const attachReset = (id) => document.getElementById(id)?.addEventListener('click', () => {
          const ed = getEd();               // kann bestehen bleiben – wird ja evtl. gebraucht
          if (!ed) return;                  // Safety-Check wie zuvor

          Swal.fire({
            title: 'Prompt zurücksetzen?',
            text:  'Der gesamte Inhalt im Editor wird gelöscht.',
            icon:  'warning',
            showCancelButton: true,
            confirmButtonText: 'Ja, löschen',
            cancelButtonText : 'Abbrechen',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
          }).then(r => {
            if (r.isConfirmed) {
              /* statt ed.setData('') … einfach neu laden */
              ed.setData('');     // oder: location.href = location.href;
            }
          });
        });
         attachReset('reset-prompt');
        attachReset('reset-prompt-top');

        // Beschreibung/Fragestellung reset button
        const attachResetDesc = (id) => document.getElementById(id)?.addEventListener('click', () => {
          const descEl = document.getElementById('beschreibung');
          const descEd = descEl?.ckeditorInstance;

          Swal.fire({
            title: 'Beschreibung zurücksetzen?',
            text:  'Der gesamte Inhalt in Beschreibung/Fragestellung wird gelöscht.',
            icon:  'warning',
            showCancelButton: true,
            confirmButtonText: 'Ja, löschen',
            cancelButtonText : 'Abbrechen',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
          }).then(r => {
            if (r.isConfirmed) {
              if (descEd) descEd.setData(''); else if (descEl) descEl.value = '';
            }
          });
        });
        attachResetDesc('reset-beschreibung-top');

        // Generic textarea reset (Titel, Thema, Ziele) – robust, supports CKEditor and autosize listeners
        const handleFieldReset = (fieldId, titleTxt, bodyTxt) => {
          const el = document.getElementById(fieldId);
          if (!el) return;
          const ed = el.ckeditorInstance;
          Swal.fire({
            title: titleTxt,
            text:  bodyTxt,
            icon:  'warning',
            showCancelButton: true,
            confirmButtonText: 'Ja, löschen',
            cancelButtonText : 'Abbrechen',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
          }).then(r => {
            if (!r.isConfirmed) return;
            if (ed && typeof ed.setData === 'function') { ed.setData(''); }
            else {
              el.value = '';
              // notify any listeners (autosize, bindings)
              el.dispatchEvent(new Event('input', { bubbles: true }));
              el.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        };

        // Direct listeners (if elements are present now)
        const attachResetField = (btnId, fieldId, titleTxt, bodyTxt) => {
          const btn = document.getElementById(btnId);
          if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); handleFieldReset(fieldId, titleTxt, bodyTxt); });
        };
        attachResetField('reset-title-top', 'promptTitle', 'Titel zurücksetzen?', 'Der gesamte Inhalt im Titel wird gelöscht.');
        attachResetField('reset-thema-top', 'thema', 'Thema zurücksetzen?', 'Der gesamte Inhalt im Thema wird gelöscht.');
        attachResetField('reset-ziele-top', 'ziele', 'Ziele zurücksetzen?', 'Der gesamte Inhalt in Ziele wird gelöscht.');

        // Delegated listeners (work even if buttons are re-rendered later)
        document.addEventListener('click', (ev) => {
          const map = {
            'reset-title-top': { fieldId: 'promptTitle', t: 'Titel zurücksetzen?', m: 'Der gesamte Inhalt im Titel wird gelöscht.' },
            'reset-thema-top': { fieldId: 'thema', t: 'Thema zurücksetzen?', m: 'Der gesamte Inhalt im Thema wird gelöscht.' },
            'reset-ziele-top': { fieldId: 'ziele', t: 'Ziele zurücksetzen?', m: 'Der gesamte Inhalt in Ziele wird gelöscht.' }
          };
          const targetBtn = ev.target.closest('#reset-title-top, #reset-thema-top, #reset-ziele-top');
          if (!targetBtn) return;
          ev.preventDefault();
          const cfg = map[targetBtn.id];
          if (!cfg) return;
          handleFieldReset(cfg.fieldId, cfg.t, cfg.m);
        });

        /* --------------------------------------------------
           TABS & TOOL-TIPS
        -------------------------------------------------- */
        function activateTab(btn) {
            const id = btn.dataset.category;
            const inToolbar = !!btn.closest('.filter-toolbar');
            tabs.forEach(t => t.classList.toggle('active', t === btn));
            panels.forEach(p => p.classList.toggle('active', p.dataset.category === id));
            // Only show and position the indicator for tabs inside the scrollable toolbar
            if (inToolbar) {
                if (line) {
                    line.style.display = '';
                    line.style.transform = `translateX(${btn.offsetLeft}px)`;
                    line.style.width = `${btn.offsetWidth}px`;
                }
            } else {
                if (line) {
                    line.style.display = 'none';
                    line.style.transform = 'translateX(0)';
                    line.style.width = '0px';
                }
            }
        }

        tabs.forEach(b => b.addEventListener('click', () => activateTab(b)));
        // On initial load, prefer the first tab inside the scrollable toolbar
        (function(){
            const firstToolbarTab = document.querySelector('.filter-toolbar .filter-tab');
            if (firstToolbarTab) activateTab(firstToolbarTab); else if (tabs.length) activateTab(tabs[0]);
        })();
        // [...document.querySelectorAll('[data-bs-toggle=tooltip]')].forEach(el => new bootstrap.Tooltip(el));

        /* --------------------------------------------------
        TOOLTIP on the “info-badge” – auto-hide on click/scroll
        -------------------------------------------------- */
        // Utility to hide all tooltips and clear highlights
        function hideAllTooltips() {
            try {
                document.querySelectorAll('.info-badge.tooltip-visible').forEach(el => {
                    const tt = (window.bootstrap && window.bootstrap.Tooltip)
                        ? window.bootstrap.Tooltip.getOrCreateInstance(el)
                        : null;
                    try { tt?.hide?.(); } catch {}
                    el.classList.remove('tooltip-visible', 'active');
                });
            } catch {}
        }

        // Hide when clicking or scrolling outside
        document.addEventListener('click', hideAllTooltips);
        document.addEventListener('scroll', hideAllTooltips, true);

        // Initialize each badge to open SweetAlert (works for initially rendered badges)
        document.querySelectorAll('.info-badge').forEach(badge => {
            badge.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                const infoText = badge.dataset.info || '';
                Swal.fire({
                    html: `<div style="text-align:left; width:100%; line-height:1.4;">${infoText}</div>`,
                    showCloseButton: true,
                    focusConfirm: false,
                    customClass: { popup: 'glass-popup' }
                });
            });
        });

        // Robust binding for badges in the main Prompt-Filter panels
        function wireInfoBadges(root){
            const scope = root || document;
            scope.querySelectorAll('.filter-panel .info-badge:not([data-bound])').forEach(badge => {
                badge.setAttribute('data-bound','1');
                badge.addEventListener('click', e => {
                    e.preventDefault();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
                    else e.stopPropagation();
                    const infoText = badge.dataset.info || '';
                    Swal.fire({
                        html: `<div style="text-align:left; width:100%; line-height:1.4;">${infoText}</div>`,
                        showCloseButton: true,
                        focusConfirm: false,
                        customClass: { popup: 'glass-popup' }
                    });
                });
            });
        }
        // bind at load for initially rendered filter panels
        wireInfoBadges(document);


        /* --------------------------------------------------
           COLOUR PALETTE  –  Anwenden
        -------------------------------------------------- */
        applyBtn.addEventListener('click', () => {
            const colors = [...document.querySelectorAll('.color-swatch')]
                .map(c => c.value.toUpperCase()).filter(h => h !== '#FFFFFF');
            if (!colors.length) return;

            const ed = getEd(); if (!ed) return;
            // ensureBaseTemplate();

            // Mark the paragraph so we can reliably replace it later
            const html = `<p data-pc-colors="1"><strong>Farbe:</strong> ${colors.join(', ')}</p>`;
            ed.model.change(writer => {
                for (const ch of [...ed.model.document.getRoot().getChildren()]) {
                    if (ch.is('element', 'paragraph') &&
                        /Farbe:/i.test(ed.data.toView(ch).getChild(0)?.data ?? '')) {
                        writer.remove(ch);
                    }
                }
                const end = ed.model.createPositionAt(ed.model.document.getRoot(), 'end');
                ed.model.insertContent(ed.data.toModel(ed.data.processor.toView(html)), end);
            });
            ed.editing.view.focus();
            saveAutosave();
        });

        /* --------------------------------------------------
        COLLECT ↔ APPLY  (★ apply now handles “editor not ready”)
        -------------------------------------------------- */
        // ---------------------- COLLECT STATE ----------------------
        function collectState() {
            const ed = getEd();
            const checked = (() => {
                const seen = new Set();
                const arr = [];
                document.querySelectorAll('.filter-checkbox input:checked').forEach(cb => {
                    const panel = cb.closest('.filter-panel');
                    if (panel && panel.dataset && panel.dataset.bookmarks === 'true') return; // skip mirrored bookmarks
                    const normId = String(cb.id || '').replace(/^bm_/, '');
                    if (seen.has(normId)) return; // de-duplicate by logical id
                    seen.add(normId);
                    const raw = cb.closest('.filter-checkbox')?.dataset.instruction || cb.value;
                    arr.push({
                        value       : cb.value,
                        instruction : raw?.replace(/&#10;/g, '\n')
                    });
                });
                return arr;
            })();

            // capture AI-selected subset (by id and by value)
            const aiInputs = [...document.querySelectorAll('.filter-checkbox.ai-selected input:checked')];
            const aiSelectedIds = aiInputs.map(cb => String(cb.id || '').replace(/^filter_/, '')).filter(Boolean);
            const aiSelectedValues = aiInputs.map(cb => cb.value);

            // new fields (plain text fallbacks)
            const beschreibung = document.getElementById('beschreibung').value.trim();
            const schluesselbegriffe = document
                .getElementById('schluesselbegriffe')
                .value
                .split(',')
                .map(s => s.trim())
                .filter(Boolean)
                .join(', ');

            // collect chosen colors (uppercased hex, ignore default white)
            const colors = [...document.querySelectorAll('.color-swatch')]
                .map(c => String(c.value || '').toUpperCase())
                .filter(h => /^#[0-9A-F]{6}$/.test(h) && h !== '#FFFFFF');

            // capture HTML from CKEditors if present (to preserve formatting)
            let titleHtml = '';
            let themaHtml = '';
            let zieleHtml = '';
            let beschreibungHtml = '';
            try { const el = document.getElementById('promptTitle'); if (el?.ckeditorInstance) titleHtml = el.ckeditorInstance.getData(); } catch {}
            try { const el = document.getElementById('thema');       if (el?.ckeditorInstance) themaHtml = el.ckeditorInstance.getData(); } catch {}
            try { const el = document.getElementById('ziele');       if (el?.ckeditorInstance) zieleHtml = el.ckeditorInstance.getData(); } catch {}
            try { const el = document.getElementById('beschreibung');if (el?.ckeditorInstance) beschreibungHtml = el.ckeditorInstance.getData(); } catch {}

            return {
                akronym: document.getElementById('akronym').value.trim(),
                title:   document.getElementById('promptTitle').value.trim(),
                type: CURRENT_TYPE,
                thema: document.getElementById('thema').value.trim(),
                ziele: document.getElementById('ziele').value.trim(),
                beschreibung,
                titleHtml,
                themaHtml,
                zieleHtml,
                beschreibungHtml,
                schluesselbegriffe,
                temperatur: document.getElementById('temperature').value.trim(),
                maxZeichen: document.getElementById('maxZeichen').value.trim(),
                promptHtml: ed ? ed.getData() : '',
                checkedItems: checked,
                // persist AI subset to keep separation after refresh
                aiSelectedIds,
                aiSelectedValues,
                colors
            };
        }

        function mergeFilterJsonWithTechniques(st) {
            try {
                const items = [];
                const seen = new Set();

                const push = (val, ins) => {
                    const v = String(val || '').trim();
                    if (!v) return;
                    const key = v.toLowerCase();
                    if (seen.has(key)) return; // skip duplicates by value
                    seen.add(key);
                    const i = String(ins || v).trim();
                    items.push({ value: v, instruction: i });
                };

                if (Array.isArray(st?.checkedItems)) {
                    for (const it of st.checkedItems) push(it?.value, it?.instruction);
                }
                const text = String(st?.promptHtml || '').replace(/<.*?>/g, '');
                const re = /\(([^)]+)\)\s*:/g;
                let m;
                while ((m = re.exec(text)) !== null) {
                    const name = (m[1] || '').trim();
                    if (!name) continue;
                    push(name, name);
                }
                // keep both representations in sync
                st.checkedItems = items;
                st.filterJson = JSON.stringify(items);
            } catch {}
            return st;
        }

                /**
         * Make clicking anywhere in the .filter-checkbox container
         * (aside from the info badge or the checkbox itself) toggle the box.
         */
        // function activateFilterCheckboxToggles() {
        //   document.querySelectorAll('.filter-checkbox').forEach(container => {
        //     container.style.cursor = 'pointer';
        //     container.addEventListener('click', e => {
        //       // if they actually clicked the real <input> or the info-badge, let the default happen
        //                   if (
        //         e.target.tagName === 'INPUT' ||          // echtes Input
        //         e.target.tagName === 'LABEL' ||          // Label klick
        //         e.target.closest('.info-badge')          // “?”‑Badge
        //       ) return;

        //       // find the checkbox and flip it
        //       const cb = container.querySelector('input[type="checkbox"]');
        //       if (!cb) return;
        //       cb.checked = !cb.checked;

        //       // trigger any change handlers you may have
        //       cb.dispatchEvent(new Event('change', { bubbles: true }));
        //     });
        //   });
        // }

        // document.addEventListener('DOMContentLoaded', () => {
        //   activateFilterCheckboxToggles();
        // });


        // Helper: select generated filters stored in localStorage (runs idempotently)
        function selectAfterReloadIfAny(){
            try {
                const key = keyOf(`select_after_reload_${CURRENT_TYPE}`);
                const raw = localStorage.getItem(key);
                if (!raw) return;
                const list = JSON.parse(raw);
                if (!Array.isArray(list) || list.length === 0) { localStorage.removeItem(key); return; }

                const norm = s => {
                  try {
                    const txt = (s ?? '').toString();
                    const doc = new DOMParser().parseFromString(txt, 'text/html');
                    const dec = (doc.documentElement.textContent || '');
                    return dec.replace(/\s+/g,' ').toLowerCase().trim();
                  } catch { return (s || '').toString().replace(/\s+/g,' ').toLowerCase().trim(); }
                };

                const wantTitles = new Set();
                const wantInstrs = new Set();
                for (const el of list) {
                  if (typeof el === 'string') { wantTitles.add(norm(el)); continue; }
                  if (el && typeof el === 'object') {
                    if (el.t) wantTitles.add(norm(el.t));
                    if (el.i) wantInstrs.add(norm(el.i));
                  }
                }

                let matched = 0;
                let firstCatId = null;
                const catKey = keyOf(`focus_category_${CURRENT_TYPE}`);
                const focusName = localStorage.getItem(catKey);
                document.querySelectorAll('.filter-checkbox input').forEach(cb => {
                  const v1 = norm(cb.value);
                  const v2 = norm(cb.dataset.title || '');
                  const instr = norm(cb.closest('.filter-checkbox')?.dataset.instruction || '');
                  const labelTxt = norm(cb.closest('.filter-checkbox')?.querySelector('.filter-label')?.textContent || '');
                  const match = wantTitles.has(v1) || (v2 && wantTitles.has(v2)) || (labelTxt && wantTitles.has(labelTxt)) || (instr && wantInstrs.has(instr));
                  if (match && !cb.checked) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event('change', { bubbles: true }));
                    matched++;
                    if (!firstCatId) firstCatId = cb.closest('.filter-panel')?.dataset.category || null;
                  }
                });

                if (typeof rebuildSummary === 'function') rebuildSummary();
                if (typeof updateUsedMarks === 'function') updateUsedMarks();
                try { saveAutosave(); } catch {}
                localStorage.removeItem(key);
                // Activate the category tab that contains the first matched filter
                if (firstCatId) {
                  const targetBtn = Array.from(tabs).find(t => t.dataset.category === firstCatId);
                  if (targetBtn) activateTab(targetBtn);
                } else if (focusName) {
                  const targetBtn = Array.from(tabs).find(t => norm(t.textContent) === norm(focusName));
                  if (targetBtn) activateTab(targetBtn);
                } else {
                  // Fallback: focus the most recent AI-generated category, if any
                  const aiTabs = Array.from(tabs).filter(t => t.dataset.ai === 'true');
                  if (aiTabs.length) {
                    let latest = aiTabs[0], latestTs = Date.parse(latest.dataset.created || '') || 0;
                    for (const t of aiTabs) {
                      const ts = Date.parse(t.dataset.created || '') || 0;
                      if (ts > latestTs) { latest = t; latestTs = ts; }
                    }
                    if (latest) activateTab(latest);
                  }
                }
                if (matched === 0) {
                  // In case something re-rendered late, try once more shortly after
                  setTimeout(() => {
                    try { localStorage.setItem(key, raw); } catch {}
                    selectAfterReloadIfAny();
                  }, 100);
                }
                // Prefer focusing the user-chosen category name (if provided by generator)
                if (focusName) {
                  // Try match against tab text OR explicit data-name
                  const targetBtnByText = Array.from(tabs).find(t => norm(t.textContent) === norm(focusName));
                  const targetBtnByData = Array.from(tabs).find(t => norm(t.dataset?.name || '') === norm(focusName));
                  const target = targetBtnByText || targetBtnByData;
                  if (target) {
                    activateTab(target);
                  } else if (firstCatId) {
                    const fallback = Array.from(tabs).find(t => t.dataset.category === firstCatId);
                    if (fallback) activateTab(fallback);
                  } else {
                    // Fallback: focus the most recent AI-generated category, if any
                    const aiTabs = Array.from(tabs).filter(t => t.dataset.ai === 'true');
                    if (aiTabs.length) {
                      let latest = aiTabs[0], latestTs = Date.parse(latest.dataset.created || '') || 0;
                      for (const t of aiTabs) {
                        const ts = Date.parse(t.dataset.created || '') || 0;
                        if (ts > latestTs) { latest = t; latestTs = ts; }
                      }
                      if (latest) activateTab(latest);
                    }
                  }
                  try { localStorage.removeItem(catKey); } catch {}
                } else if (firstCatId) {
                  const targetBtn = Array.from(tabs).find(t => t.dataset.category === firstCatId);
                  if (targetBtn) activateTab(targetBtn);
                } else {
                  // Fallback: focus the most recent AI-generated category, if any
                  const aiTabs = Array.from(tabs).filter(t => t.dataset.ai === 'true');
                  if (aiTabs.length) {
                    let latest = aiTabs[0], latestTs = Date.parse(latest.dataset.created || '') || 0;
                    for (const t of aiTabs) {
                      const ts = Date.parse(t.dataset.created || '') || 0;
                      if (ts > latestTs) { latest = t; latestTs = ts; }
                    }
                    if (latest) activateTab(latest);
                  }
                }
            } catch {}
        }

        // ---------------------- APPLY STATE ----------------------
        function applyState(s) {
            const __ed = getEd();
            document.getElementById('akronym').value       = s.akronym || '';
            try {
                const ttlTa = document.getElementById('promptTitle');
                const ttlEd = ttlTa && ttlTa.ckeditorInstance;
                if (ttlEd) ttlEd.setData(s.titleHtml || s.title || '');
                else if (ttlTa) ttlTa.value = s.titleHtml || s.title || '';
            } catch {}
            try {
                const thTa = document.getElementById('thema');
                const thEd = thTa && thTa.ckeditorInstance;
                if (thEd) thEd.setData(s.themaHtml || s.thema || '');
                else if (thTa) thTa.value = s.themaHtml || s.thema || '';
            } catch {}
            try {
                const ziTa = document.getElementById('ziele');
                const ziEd = ziTa && ziTa.ckeditorInstance;
                if (ziEd) ziEd.setData(s.zieleHtml || s.ziele || '');
                else if (ziTa) ziTa.value = s.zieleHtml || s.ziele || '';
            } catch {}
            try {
                const bTa = document.getElementById('beschreibung');
                const bEd = bTa && bTa.ckeditorInstance;
                if (bEd) {
                  const html = s.beschreibungHtml || (s.beschreibung ? textToHtmlParagraphs(s.beschreibung) : '');
                  bEd.setData(html);
                } else if (bTa) {
                  bTa.value = s.beschreibungHtml || s.beschreibung || '';
                }
            } catch {}
            document.getElementById('schluesselbegriffe').value = s.schluesselbegriffe || '';

            document.getElementById('temperature').value = s.temperatur || '';
            document.getElementById('maxZeichen').value = s.maxZeichen || '';

            document.querySelectorAll('.filter-checkbox input')
                .forEach(cb => {
                    try {
                        const parseArr = () => {
                            let raw = Array.isArray(s.checkedItems) ? s.checkedItems : null;
                            if (!raw) {
                                try {
                                    const parsed = JSON.parse(s.filterJson || '[]');
                                    raw = Array.isArray(parsed) ? parsed : (parsed && typeof parsed === 'object' ? Object.values(parsed) : []);
                                } catch { raw = []; }
                            }
                            const norm = [];
                            for (const it of raw) {
                                if (it == null) continue;
                                if (typeof it === 'string') { norm.push({ id: '', val: it }); continue; }
                                try {
                                    const id = String((it.id ?? it.Id ?? it.itemId ?? it.ItemId ?? it.filterItemId ?? it.FilterItemId ?? '')).trim();
                                    const val = String((it.value ?? it.Value ?? it.title ?? it.Title ?? it.text ?? it.Text ?? it.name ?? it.Name ?? '')).trim();
                                    if (id || val) norm.push({ id, val });
                                } catch {}
                            }
                            return norm;
                        };
                        const arr = parseArr();

                        const idSet = new Set(arr.map(x => String(x.id || '').trim()).filter(Boolean));
                        const valSet = new Set(arr.map(x => String(x.val || '').trim().toLowerCase()).filter(Boolean));

                        let want = false;
                        // 1) Match by ID
                        if (!want && idSet.size) {
                            const id = String(cb.id || '').replace(/^filter_/, '').trim();
                            if (id && idSet.has(id)) want = true;
                        }
                        // 2) Match by value/title/label text/instruction (case-insensitive)
                        if (!want && valSet.size) {
                            const box = cb.closest('.filter-checkbox');
                            const labelTxt = (box?.querySelector('.filter-label')?.textContent || '').trim().toLowerCase();
                            const instr    = (box?.dataset?.instruction || '').trim().toLowerCase();
                            const candidates = [cb.value, cb.dataset?.title, labelTxt, instr]
                                .map(v => String(v || '').trim().toLowerCase())
                                .filter(Boolean);
                            for (const c of candidates) { if (valSet.has(c)) { want = true; break; } }
                        }

                        const changed = !!cb.checked !== !!want;
                        cb.checked = want;
                        if (changed) cb.dispatchEvent(new Event('change', { bubbles: true }));
                    } catch { cb.checked = false; }
                });

            // re-apply AI marks from saved state BEFORE building summary
            try {
              // clear any lingering AI marks first
              document.querySelectorAll('.filter-checkbox.ai-selected').forEach(fc => {
                fc.classList.remove('ai-selected');
                fc.querySelector('.ai-tag')?.remove();
              });
              const ids = new Set(Array.isArray(s.aiSelectedIds) ? s.aiSelectedIds.map(String) : []);
              const vals= new Set(Array.isArray(s.aiSelectedValues) ? s.aiSelectedValues : []);
              // Prefer IDs; fallback to values
              ids.forEach(id => {
                const cb = document.getElementById('filter_' + id);
                if (!cb || !cb.checked) return;
                const box = cb.closest('.filter-checkbox');
                if (!box) return;
                box.classList.add('ai-selected');
                const lbl = box.querySelector('.filter-label');
                if (lbl && !lbl.querySelector('.ai-tag')) {
                  const tag = document.createElement('span');
                  tag.className = 'ai-tag';
                  tag.textContent = 'KI';
                  lbl.appendChild(tag);
                }
              });
              if (!ids.size && vals.size) {
                vals.forEach(v => {
                  const cb = document.querySelector(`.filter-checkbox input[value="${CSS.escape(v)}"]`);
                  if (!cb || !cb.checked) return;
                  const box = cb.closest('.filter-checkbox');
                  if (!box) return;
                  box.classList.add('ai-selected');
                  const lbl = box.querySelector('.filter-label');
                  if (lbl && !lbl.querySelector('.ai-tag')) {
                    const tag = document.createElement('span');
                    tag.className = 'ai-tag';
                    tag.textContent = 'KI';
                    lbl.appendChild(tag);
                  }
                });
              }
            } catch {}

            // restore color swatches (Bild/Video): prefer s.colors; fallback to parse ONLY our color block from promptHtml
            try {
                const swatches = document.querySelectorAll('.color-swatch');
                if (swatches.length) {
                    let cols = Array.isArray(s.colors) ? s.colors : [];
                    if (!cols.length && typeof s.promptHtml === 'string') {
                        const html = s.promptHtml;
                        // Try marked block first
                        let block = (html.match(/<p[^>]*data-pc-colors=("|')1\1[^>]*>[\s\S]*?<\/p>/i) || [])[0];
                        if (!block) {
                            // Fallback to first Farbe: paragraph only
                            block = (html.match(/<p[^>]*>\s*<strong>\s*Farbe:\s*<\/strong>[\s\S]*?<\/p>/i) || [])[0];
                        }
                        const m = block ? (block.match(/#[0-9A-Fa-f]{6}\b/g) || []) : [];
                        cols = m.map(h => h.toUpperCase()).filter(h => h !== '#FFFFFF');
                    }
                    for (let i = 0; i < swatches.length; i++) {
                        swatches[i].value = cols[i] || '#FFFFFF';
                    }
                }
            } catch { /* ignore */ }

            // build accordions/summary now that AI marks are restored
            try { rebuildAiAccordion(); } catch {}
            rebuildSummary();
            try { updateUsedMarks(); } catch {}
            if (__ed) {
                __ed.setData(s.promptHtml);
            } else {
                try { window.__pendingPromptHtml = s.promptHtml || ''; } catch {}
            }
            try {
                const ttlEd = document.getElementById('promptTitle')?.ckeditorInstance;
                const thEd  = document.getElementById('thema')?.ckeditorInstance;
                const ziEd  = document.getElementById('ziele')?.ckeditorInstance;
                const bEd   = document.getElementById('beschreibung')?.ckeditorInstance;
                if (!(__ed && ttlEd && thEd && ziEd && bEd)) window.__pendingState = s;
            } catch { window.__pendingState = s; }
            setupAutoGrow();
            selectAfterReloadIfAny();
            try { ensureImportFilterSelections(s); } catch {}
        }

        // After CKEditor initializes, apply any pending prompt HTML/state from import
        (function applyWhenEditorReady(){
            let tries = 0; const max = 120; // ~12s total
            const t = setInterval(() => {
                try {
                    const ed = (typeof getEd === 'function') && getEd();

                    // If editor exists, flush any pending HTML once
                    if (ed && window.__pendingPromptHtml) {
                        ed.setData(window.__pendingPromptHtml || '');
                        try { saveAutosave && saveAutosave(); } catch {}
                        window.__pendingPromptHtml = '';
                    }

                    // If any field editors are not yet ready, keep pending state and retry
                    if (window.__pendingState) {
                        try { applyState(window.__pendingState); } catch {}
                        // applyState will clear/retain window.__pendingState depending on readiness
                    }

                    // Stop when editor is ready AND no pending state/html remains
                    if (ed && !window.__pendingPromptHtml && !window.__pendingState) {
                        clearInterval(t);
                        return;
                    }

                    if (++tries >= max) clearInterval(t);
                } catch { clearInterval(t); }
            }, 100);
        })();

        // Ensure the editor HTML contains a “Farbe:” paragraph with the given colors
        function ensureColorsInHtml(html, colors) {
            try {
                const arr = Array.isArray(colors) ? colors.filter(h => /^#[0-9A-F]{6}$/i.test(h)) : [];
                if (!arr.length) return html || '';
                const colorLine = `<p data-pc-colors="1"><strong>Farbe:</strong> ${arr.join(', ')}</p>`;
                if (!html) return colorLine;
                // 1) Prefer replacing the marked block
                let replaced = html.replace(/<p[^>]*data-pc-colors=("|')1\1[^>]*>[\s\S]*?<\/p>/i, colorLine);
                if (replaced !== html) return replaced;
                // 2) Fallback: replace any paragraph that starts with <strong>Farbe:</strong>
                replaced = html.replace(/<p[^>]*>\s*<strong>\s*Farbe:\s*<\/strong>[\s\S]*?<\/p>/i, colorLine);
                if (replaced !== html) return replaced;
                // 3) Otherwise append once at the end
                return html + colorLine;
            } catch { return html || ''; }
        }


        /* --------------------------------------------------
           JSON EXPORT (button + helper)
        -------------------------------------------------- */
        async function downloadPromptJson() {
            const data = collectState();
            const hash = await sha256(secretKey + JSON.stringify(data));
            const blob = new Blob([JSON.stringify({ data, hash }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            Object.assign(document.createElement('a'), { href: url, download: 'prompt-export.json' }).click();
            URL.revokeObjectURL(url);
        }
        document.getElementById('export-json').addEventListener('click', async () => {
            await downloadPromptJson();
            Swal.fire({ icon: 'success', title: 'Export abgeschlossen', timer: 2000, showConfirmButton: false });
        });

        /* --------------------------------------------------
           PROMPT-TYPE <select>  (confirm + optional JSON save)
        -------------------------------------------------- */
        /* ---------- Prompt-Typ tabs (with Thema/Ziele backup) ---------- */
        (function () {
            const tabs = document.querySelectorAll('#promptTypeTabs .nav-link');
            if (!tabs.length) return;

            tabs.forEach(tab => tab.addEventListener('click', async e => {
                e.preventDefault();
                if (tab.classList.contains('active')) return;

                const willLose = !!(
                    getEd()?.getData().trim() ||
                    document.querySelectorAll('.filter-checkbox input:checked').length ||
                    document.getElementById('thema').value.trim() ||
                    document.getElementById('ziele').value.trim()
                );

                let proceed = true;
                if (willLose) {
                    const res = await Swal.fire({
                        title: 'Prompt-Art Auswahl ändern?',
                        html: 'Beim Ändern der Prompt-Auswahl wird der aktuelle Prompt gelöscht.<br><br><b>Möchten Sie fortfahren?</b>',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Fortfahren',
                        cancelButtonText: 'Abbrechen',
                        showDenyButton: true,
                        denyButtonText: 'Als JSON herunterladen',
                        reverseButtons: true
                    });

                    if (res.isDenied) await downloadPromptJson();
                    proceed = res.isConfirmed || res.isDenied;   // only go on if user confirmed or saved JSON
                }

                if (!proceed) return;

                /* keep Thema & Ziele for the next page (same code you had before) */
                        /* keep Thema & Ziele for the next page */
        localStorage.setItem(keyOf('prompt_thema'), document.getElementById('thema').value.trim());
        localStorage.setItem(keyOf('prompt_ziele'), document.getElementById('ziele').value.trim());

        /* 🆕 weitere Eigenschaften merken */
        (function(){
          const ta = document.getElementById('beschreibung');
          const html = ta?.ckeditorInstance ? ta.ckeditorInstance.getData() : (ta?.value || '').trim();
          localStorage.setItem(keyOf('prompt_beschreibung_html'), html);
          // Keep legacy plain key for backward compatibility
          localStorage.setItem(keyOf('prompt_beschreibung'), (ta?.value || '').trim());
        })();
        localStorage.setItem(keyOf('prompt_schluesselbegriffe'),
                             document.getElementById('schluesselbegriffe').value.trim());
        localStorage.setItem(keyOf('prompt_title'),
                             document.getElementById('promptTitle').value.trim());
        localStorage.setItem(keyOf('prompt_akronym'),
                             document.getElementById('akronym').value.trim());


                /* redirect with new type using anchor's href */
                // Merken, ob der Prompt-Techniken‑Helper aktuell geöffnet ist
                try {
                    const wrap = document.getElementById('promptHelperWrap');
                    if (wrap && wrap.classList.contains('show')) {
                        localStorage.setItem('pa_open_helper', '1');
                    }
                } catch { }

                const href = tab.getAttribute('href') || tab.href;
                if (href) location.href = href;
            }));
        })();



        /* --------------------------------------------------
           RESTORE Thema / Ziele after redirect
        -------------------------------------------------- */
                (() => {
          const t  = localStorage.getItem(keyOf('prompt_thema'));
          const z  = localStorage.getItem(keyOf('prompt_ziele'));
          const bH = localStorage.getItem(keyOf('prompt_beschreibung_html'));     // 🆕 prefer HTML
          const b  = localStorage.getItem(keyOf('prompt_beschreibung'));          // legacy
          const k  = localStorage.getItem(keyOf('prompt_schluesselbegriffe'));    // 🆕
          const ttl= localStorage.getItem(keyOf('prompt_title'));                 // 🆕
          const a  = localStorage.getItem(keyOf('prompt_akronym'));               // 🆕

          if (t !== null) {
            const el = document.getElementById('thema');
            if (el?.ckeditorInstance) el.ckeditorInstance.setData(t); else if (el) el.value = t;
          }
          if (z !== null) {
            const el = document.getElementById('ziele');
            if (el?.ckeditorInstance) el.ckeditorInstance.setData(z); else if (el) el.value = z;
          }
          if (bH !== null || b !== null) {
            const el = document.getElementById('beschreibung');
            const val = (bH !== null ? bH : b);
            if (el?.ckeditorInstance) el.ckeditorInstance.setData(val);
            else if (el) el.value = val;
          }
          if (k  !== null) document.getElementById('schluesselbegriffe').value = k;
          if (ttl!== null) {
            const el = document.getElementById('promptTitle');
            if (el?.ckeditorInstance) el.ckeditorInstance.setData(ttl); else if (el) el.value = ttl;
          }
          if (a  !== null) document.getElementById('akronym').value          = a;

          /* aufräumen */
          ['prompt_thema','prompt_ziele','prompt_beschreibung','prompt_beschreibung_html',
           'prompt_schluesselbegriffe','prompt_title','prompt_akronym']
           .forEach(k => localStorage.removeItem(keyOf(k)));
        })();

        // Restore autosave snapshot if available (and no import is pending)
        restoreAutosaveIfAny();

        // After autosave restore, auto-select any newly generated filters persisted for this type
        selectAfterReloadIfAny();


        // Prevent browser from restoring previous scroll position and force top-of-page on load
        try { history.scrollRestoration = 'manual'; } catch {}
        function scrollToTopSafely() {
            try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch { window.scrollTo(0, 0); }
            // Fallbacks for different engines
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
        }
        // Run immediately and shortly after render to counter late layout shifts
        scrollToTopSafely();
        setTimeout(scrollToTopSafely, 50);
        setTimeout(scrollToTopSafely, 200);



        /* --------------------------------------------------
           IMPORT PAYLOAD (if we switched type automatically)
        -------------------------------------------------- */
        (() => {
            let raw = localStorage.getItem(keyOf('import_payload'));
            if (!raw) {
                const legacy = localStorage.getItem('import_payload');
                if (legacy) {
                    try { localStorage.setItem(keyOf('import_payload'), legacy); } catch {}
                    localStorage.removeItem('import_payload');
                    raw = legacy;
                }
            }
            if (!raw) return;
            try { 
                const obj = JSON.parse(raw);
                // Wipe autosave and any field-specific keys to avoid collisions
                try {
                    localStorage.removeItem(AUTOSAVE_KEY);
                    ['prompt_thema','prompt_ziele','prompt_beschreibung','prompt_beschreibung_html','prompt_schluesselbegriffe','prompt_title','prompt_akronym']
                      .forEach(k => { try { localStorage.removeItem(keyOf(k)); } catch {} });
                } catch {}
                applyState(obj.data); 
            } finally { localStorage.removeItem(keyOf('import_payload')); }
        })();

        /* --------------------------------------------------
        JSON IMPORT  (auto type-switch, now fills editor)
        -------------------------------------------------- */
        const fileInput = document.getElementById('import-json-file');
        document.getElementById('import-json-btn').addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async e => {
            const file = e.target.files[0]; if (!file) return;
            try {
                const txt = await file.text(), obj = JSON.parse(txt);
                if (!obj.data || !obj.hash) throw 'Formatfehler';
                if (await sha256(secretKey + JSON.stringify(obj.data)) !== obj.hash) throw 'Integritäts-Check fehlgeschlagen!';
                const jsonType = (obj.data.type || 'text').toLowerCase();

                const dirty = !!(getEd()?.getData().trim() ||
                    document.querySelectorAll('.filter-checkbox input:checked').length ||
                    document.getElementById('thema').value.trim() ||
                    document.getElementById('ziele').value.trim());

                if (jsonType !== CURRENT_TYPE) {
                    const ok = !dirty || await Swal.fire({
                        title: 'Anderen Prompt-Typ importieren?',
                        text: 'Der aktuelle Fortschritt geht verloren.',
                        icon: 'warning', showCancelButton: true,
                        confirmButtonText: 'Fortfahren', cancelButtonText: 'Abbrechen'
                    }).then(r => r.isConfirmed);
                    if (!ok) { fileInput.value = ''; return; }

                    localStorage.setItem(keyOf('import_payload'), txt);        // stash for next page
                    const url = new URL(location.href); url.searchParams.set('type', jsonType);
                    location.href = url.toString();
                    return;
                }

                /* same type */
                if (dirty) {
                    const ok = await Swal.fire({
                        title: 'Aktuellen Prompt überschreiben?',
                        text: 'Der bisherige Inhalt wird ersetzt.',
                        icon: 'warning', showCancelButton: true,
                        confirmButtonText: 'Überschreiben', cancelButtonText: 'Abbrechen'
                    }).then(r => r.isConfirmed);
                    if (!ok) { fileInput.value = ''; return; }
                }
                applyState(obj.data);
                Swal.fire({ icon: 'success', title: 'Import erfolgreich', timer: 2000, showConfirmButton: false });
            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'Import fehlgeschlagen', text: String(err) });
            } finally { fileInput.value = ''; }
        });

        /* --------------------------------------------------
           payload after redirect
        -------------------------------------------------- */
        (() => {
            let raw = localStorage.getItem(keyOf('import_payload'));
            if (!raw) {
                const legacy = localStorage.getItem('import_payload');
                if (legacy) {
                    try { localStorage.setItem(keyOf('import_payload'), legacy); } catch {}
                    localStorage.removeItem('import_payload');
                    raw = legacy;
                }
            }
            if (!raw) return;
            try { 
                const obj = JSON.parse(raw);
                // Wipe autosave and any field-specific keys to avoid collisions
                try {
                    localStorage.removeItem(AUTOSAVE_KEY);
                    ['prompt_thema','prompt_ziele','prompt_beschreibung','prompt_beschreibung_html','prompt_schluesselbegriffe','prompt_title','prompt_akronym']
                      .forEach(k => { try { localStorage.removeItem(keyOf(k)); } catch {} });
                } catch {}
                applyState(obj.data); 
            } finally { localStorage.removeItem(keyOf('import_payload')); }
        })();


        /* --------------------------------------------------
           SUMMARY BOX
        -------------------------------------------------- */
        function rebuildSummary() {
            summaryBox.innerHTML = '';
            // 1) Build sidebar map from ALL checked (including ai-suggested)
            const sidebarMap = {};
               document.querySelectorAll('.filter-checkbox input:checked').forEach(cb => {
        const panel = cb.closest('.filter-panel');
        // Skip mirrored bookmark panel to avoid duplicates (original checkbox is synced and will be included)
        if (panel && panel.dataset && panel.dataset.bookmarks === 'true') return;
        const box = cb.closest('.filter-checkbox');
        const cat = panel?.dataset?.category;
        const text = cb.dataset.title || box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
        const raw  = box?.dataset?.instruction || cb.value;
        const ins  = raw?.replace(/&#10;/g, '\n');
        // Normalize id so bookmark mirrors and originals collapse to the same entry
        const id   = String(cb.id || '').replace(/^bm_filter_/, '').replace(/^filter_/, '');
        if (!cat) return;
        (sidebarMap[cat] ??= []).push({ id, val: cb.value, text, ins });
    });
    rebuildSidebar(sidebarMap);

// 2) Build VISIBLE summary map excluding ai-selected and ai-suggested
    const map = {};
    document.querySelectorAll('.filter-checkbox input:checked').forEach(cb => {
        const panel = cb.closest('.filter-panel');
        const box = cb.closest('.filter-checkbox');
        if (panel && panel.dataset && panel.dataset.bookmarks === 'true') return; // skip mirrored bookmarks
        if (box && (box.classList.contains('ai-selected') || box.classList.contains('ai-suggested'))) return;
        const cat = panel.dataset.category;
        const text = cb.dataset.title || box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
        const raw  = box?.dataset?.instruction || cb.value;
        const ins  = raw?.replace(/&#10;/g, '\n');
        const id   = String(cb.id || '').replace(/^bm_filter_/, '').replace(/^filter_/, '');
        (map[cat] ??= []).push({ id, val: cb.value, text, ins });
    });
            // if (!Object.keys(map).length) { summaryBox.style.display = 'none'; return; }
            if (!Object.keys(map).length) {
                summaryBox.style.display = 'none';
                // Move clear button back to its original place and hide
                if (clearBtn && clearBtnAnchor && clearBtnHome && clearBtn.parentElement !== clearBtnHome) {
                    try { clearBtn.classList.add('d-none'); } catch {}
                    try { clearBtnHome.insertBefore(clearBtn, clearBtnAnchor.nextSibling); } catch {}
                } else if (clearBtn) {
                    try { clearBtn.classList.add('d-none'); } catch {}
                }
                return;
            }
            summaryBox.style.display = 'block';
            summaryBox.innerHTML = '<label class="form-label fw-semibold">Prompt-Kriterien:</label>';
            // Ensure the clear button lives inside the summary top-right if there are selections
            if (clearBtn) {
                try { clearBtn.classList.remove('d-none'); } catch {}
                if (clearBtn.parentElement !== summaryBox) {
                    try { summaryBox.appendChild(clearBtn); } catch {}
                }
            }
            Object.entries(map).forEach(([cid, items]) => {
                const grp = document.createElement('div');
                grp.className = 'filter-summary-group';
                grp.innerHTML = `<div class="filter-summary-group-title">${categoryMap[cid]}</div>`;
                items.forEach(({ id, val, text, ins }) => {
                    const _info = String(ins || '')
                      .replace(/&/g,'&amp;')
                      .replace(/</g,'&lt;')
                      .replace(/>/g,'&gt;')
                      .replace(/\"/g,'&quot;')
                      .replace(/'/g,'&#39;')
                      .replace(/\n/g,'<br/>');
                    grp.insertAdjacentHTML('beforeend', `
                        <div class="filter-summary-item mb-3">
                            <button class="btn btn-sm btn-outline-danger trash-btn" data-id="${id}" data-val="${val}"><i class="fa fa-trash"></i></button>
                                    <button class="btn btn-sm btn-outline-success plus-btn"

                data-id="${id}" data-val="${val}"
                data-title="${text}"
                data-instruction="${ins}">
                    <i class="fa fa-arrow-down"></i>
        </button>

                            <span class=" mt-3">${text}</span>
                            <span class="info-badge" data-info="${_info}">?</span>
                            <span class="use-badge" style="display:none">×0</span>
                        </div>`);
                });
                summaryBox.appendChild(grp);
            });
            updateUsedMarks();
        }
        rebuildSummary();

        // Build/refresh the KI accordion list from current AI marks
        function rebuildAiAccordion() {
            const acc = document.getElementById('ai-selected-accordion');
            if (!acc) return; // non-admins have no accordion
            const list = document.getElementById('ai-selected-list');
            const badge = document.getElementById('ai-selected-count');
            if (!list || !badge) return;

            const groups = new Map(); // name -> [{val,text,ins}]
            document.querySelectorAll('.filter-checkbox.ai-selected input:checked').forEach(cb => {
                const panel = cb.closest('.filter-panel');
                const name  = panel?.dataset?.name || '';
                const box   = cb.closest('.filter-checkbox');
                const text  = cb.dataset.title || box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
                const ins   = box?.dataset?.instruction || cb.value;
                const id    = String(cb.id || '').replace(/^filter_/, '');
                if (!groups.has(name)) groups.set(name, []);
                groups.get(name).push({ id, val: cb.value, text, ins });
            });

            const total = Array.from(groups.values()).reduce((s,a)=>s+a.length,0);
            badge.textContent = String(total);
            list.innerHTML = '';
            const wasHidden = acc.classList.contains('d-none');
            if (total > 0) {
                groups.forEach((items, name) => {
                    const section = document.createElement('div');
                    section.className = 'ai-group';
                    section.innerHTML = `<div class="ai-group-title"><i class="bi bi-stars me-1"></i>${name}</div>`;
                    items.forEach(({ id, val, text, ins }) => {
                        const _info = String(ins || '')
                          .replace(/&/g,'&amp;')
                          .replace(/</g,'&lt;')
                          .replace(/>/g,'&gt;')
                          .replace(/\"/g,'&quot;')
                          .replace(/'/g,'&#39;')
                          .replace(/\n/g,'<br/>');
                        section.insertAdjacentHTML('beforeend', `
                            <div class="filter-summary-item mb-3">
                                <button class="btn btn-sm btn-outline-danger trash-btn" data-id="${id}" data-val="${val}"><i class="fa fa-trash"></i></button>
                                <button class="btn btn-sm btn-outline-success plus-btn" data-id="${id}" data-val="${val}" data-title="${text}" data-instruction="${ins}">
                                    <i class="fa fa-level-down"></i>
                                </button>
                                <span>${text}</span>
                                <span class="info-badge" data-info="${_info}">?</span>
                                <span class="use-badge" style="display:none">×0</span>
                            </div>
                        `);
                    });
                    list.appendChild(section);
                });
                acc.classList.remove('d-none');
                // Open on first reveal; after that, respect user's toggle
                if (wasHidden) {
                    const body = document.getElementById('ai-acc-body');
                    const btn  = document.querySelector('#ai-acc-head .accordion-button');
                    if (body && !body.classList.contains('show')) body.classList.add('show');
                    if (btn) { btn.classList.remove('collapsed'); btn.setAttribute('aria-expanded','true'); }
                }
            } else {
                acc.classList.add('d-none');
                // Reset to collapsed state when hiding
                const body = document.getElementById('ai-acc-body');
                const btn  = document.querySelector('#ai-acc-head .accordion-button');
                if (body) body.classList.remove('show');
                if (btn) { btn.classList.add('collapsed'); btn.setAttribute('aria-expanded','false'); }
            }
        }

              document.getElementById('apply-basic').addEventListener('click', () => {
            ensureBaseTemplate();
            refreshSpecifications();                     // setzt den Text, Cursor springt nach vorn

            /* ── Cursor ans Dokumentende verschieben ── */
            const ed = getEd(); if (!ed) return;
            ed.model.change( writer => {
                const endPos = ed.model.createPositionAt( ed.model.document.getRoot(), 'end' );
                writer.setSelection( endPos );
            });
            ed.editing.view.focus();                     // Einfügemarke blinkt ganz hinten
        });


        document.addEventListener('change', e => {
            if (e.target.matches('.filter-checkbox input')) {
                // ensureBaseTemplate();
                rebuildSummary();
                updateUsedMarks();
                rebuildAiAccordion();
            }
        });

        document.getElementById('clear-filters').addEventListener('click', async () => {
            const confirmed = await Swal.fire({
                title: 'Filter zurücksetzen?',
                text: 'Alle ausgewählten Filter werden entfernt.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ja, zurücksetzen',
                cancelButtonText: 'Abbrechen',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then(r => r.isConfirmed);

            if (!confirmed) return;

            // Uncheck only user-selected filters (do NOT touch AI-selected or AI-suggested)
            document.querySelectorAll('.filter-checkbox input:checked').forEach(cb => {
                const box = cb.closest('.filter-checkbox');
                if (box && (box.classList.contains('ai-selected') || box.classList.contains('ai-suggested'))) return;
                cb.checked = false;
                const v = cb.value; if (v) { try { chosenCounts[v] = 0; } catch {} }
            });
            rebuildSummary();
            updateUsedMarks();
            try { saveAutosave(); } catch {}
        });

        // Dedicated reset for AI-selected filters
        document.addEventListener('click', async (ev) => {
            const aiSelBtn = ev.target.closest('#reset-ai-selected, #reset-ai-selected-2');
            if (aiSelBtn) {
                const ok = await Swal.fire({
                    title: 'KI‑Auswahl zurücksetzen?',
                    text: 'Alle von der KI gesetzten Filter werden entfernt.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ja, zurücksetzen',
                    cancelButtonText: 'Abbrechen',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6'
                }).then(r => r.isConfirmed);
                if (!ok) return;
                try {
                    document.querySelectorAll('.filter-checkbox.ai-selected').forEach(fc => {
                        const cb = fc.querySelector('input[type="checkbox"]');
                        if (cb) cb.checked = false;
                        fc.classList.remove('ai-selected');
                        fc.querySelector('.ai-tag')?.remove();
                    });
                    const acc = document.getElementById('ai-selected-accordion');
                    const list = document.getElementById('ai-selected-list');
                    const badge = document.getElementById('ai-selected-count');
                    if (list) list.innerHTML = '';
                    if (badge) badge.textContent = '0';
                    if (acc) acc.classList.add('d-none');
                } catch {}
                rebuildSummary();
                updateUsedMarks();
                try { saveAutosave(); } catch {}
                return;
            }
            const aiSuggBtn = ev.target.closest('#reset-ai-suggested, #reset-ai-suggested-2');
            if (aiSuggBtn) {
                const ok2 = await Swal.fire({
                    title: 'KI‑Vorschläge zurücksetzen?',
                    text: 'Alle Vorschläge aus der Deep Analyse werden entfernt.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ja, zurücksetzen',
                    cancelButtonText: 'Abbrechen',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6'
                }).then(r => r.isConfirmed);
                if (!ok2) return;
                try {
                    document.querySelectorAll('.filter-checkbox.ai-suggested').forEach(fc => {
                        fc.classList.remove('ai-suggested');
                        fc.querySelector('.sugg-tag')?.remove();
                    });
                    const acc2 = document.getElementById('ai-suggested-accordion');
                    const list2 = document.getElementById('ai-suggested-list');
                    const badge2 = document.getElementById('ai-suggested-count');
                    if (list2) list2.innerHTML = '';
                    if (badge2) badge2.textContent = '0';
                    if (acc2) acc2.classList.add('d-none');
                } catch {}
                rebuildSummary();
                updateUsedMarks();
                try { saveAutosave(); } catch {}
            }
        });

        document.querySelectorAll('.clear-category').forEach(btn => {
            btn.addEventListener('click', () => {
                // Uncheck and reset usage counters for this category only
                document.querySelectorAll(`.filter-panel[data-category="${btn.dataset.category}"] .filter-checkbox input`).forEach(cb => {
                    cb.checked = false;
                    const v = cb.value; if (v) { try { chosenCounts[v] = 0; } catch {} }
                });
                rebuildSummary();
                updateUsedMarks();
                // Remove AI marks within this panel and update accordion list
                try {
                  const panel = document.querySelector(`.filter-panel[data-category="${btn.dataset.category}"]`);
                  panel?.querySelectorAll('.filter-checkbox.ai-selected').forEach(fc => { fc.classList.remove('ai-selected'); fc.querySelector('.ai-tag')?.remove(); });
                  panel?.querySelectorAll('.filter-checkbox.ai-suggested').forEach(fc => { fc.classList.remove('ai-suggested'); fc.querySelector('.sugg-tag')?.remove(); });
                  // Rebuild accordion from currently marked elements
                  const acc = document.getElementById('ai-selected-accordion');
                  if (acc) {
                    const list = document.getElementById('ai-selected-list');
                    const badge = document.getElementById('ai-selected-count');
                    const groups = new Map();
                    document.querySelectorAll('.filter-checkbox.ai-selected input').forEach(cb => {
                      const p = cb.closest('.filter-panel');
                      const nm = p?.dataset?.name || '';
                      const t  = cb.closest('.filter-checkbox')?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
                      if (nm && t) { if (!groups.has(nm)) groups.set(nm, []); groups.get(nm).push(t); }
                    });
                    const total = Array.from(groups.values()).reduce((s,a)=>s+a.length,0);
                    if (badge) badge.textContent = String(total);
                    if (list) {
                      list.innerHTML = '';
                      groups.forEach((arr, name) => {
                        const uniq = Array.from(new Set(arr));
                        list.insertAdjacentHTML('beforeend', `<div class="ai-group"><div class="ai-group-title"><i class=\"bi bi-stars me-1\"></i>${name}</div><div class="ai-chips">${uniq.map(t => `<span class=\"ai-chip\">${t}</span>`).join(' ')}</div></div>`);
                    });
                  }
                  acc.classList.toggle('d-none', total === 0);
                }
              } catch (e) {
                console.error(e);
              } finally {
                rebuildAiSuggestedAccordion();
              }
            });
          });

        // Build/refresh the KI-Vorschläge accordion from current suggested marks
        function rebuildAiSuggestedAccordion() {
            const acc = document.getElementById('ai-suggested-accordion');
            if (!acc) return;
            const list = document.getElementById('ai-suggested-list');
            const badge = document.getElementById('ai-suggested-count');
            if (!list || !badge) return;

            const groups = new Map(); // label -> [{id,val,text,ins}]
            document.querySelectorAll('.filter-checkbox.ai-suggested input').forEach(cb => {
                const panel = cb.closest('.filter-panel');
                if (!panel) return;
                const cid   = panel.dataset?.category || '';
                const label = panel.dataset?.name || (typeof categoryMap !== 'undefined' ? (categoryMap[cid] || cid) : cid) || cid;
                const box   = cb.closest('.filter-checkbox');
                const text  = cb.dataset.title || box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
                const ins   = box?.dataset?.instruction || cb.value;
                const id    = String(cb.id || '').replace(/^filter_/, '');
                if (!text) return;
                if (!groups.has(label)) groups.set(label, []);
                groups.get(label).push({ id, val: cb.value, text, ins });
            });

            let total = 0;
            list.innerHTML = '';
            for (const [label, items] of groups.entries()){
                total += items.length;
                const section = document.createElement('div');
                section.className = 'ai-group';
                section.innerHTML = `<div class="ai-group-title"><i class="bi bi-lightbulb me-1"></i>${label}</div>`;
                items.forEach(({ id, val, text, ins }) => {
                    const _info = String(ins || '')
                      .replace(/&/g,'&amp;')
                      .replace(/</g,'&lt;')
                      .replace(/>/g,'&gt;')
                      .replace(/\"/g,'&quot;')
                      .replace(/'/g,'&#39;')
                      .replace(/\n/g,'<br/>');
                    section.insertAdjacentHTML('beforeend', `
                        <div class="filter-summary-item mb-3">
                            <button class="btn btn-sm btn-outline-danger trash-btn" data-id="${id}" data-val="${val}"><i class="fa fa-trash"></i></button>
                            <button class="btn btn-sm btn-outline-success plus-btn" data-id="${id}" data-val="${val}" data-title="${text}" data-instruction="${ins}">
                                <i class="fa fa-level-down"></i>
                            </button>
                            <span>${text}</span>
                            <span class="info-badge" data-info="${_info}">?</span>
                            <span class="use-badge" style="display:none">×0</span>
                        </div>
                    `);
                });
                list.appendChild(section);
            }
            badge.textContent = String(total);
            const wasHidden = acc.classList.contains('d-none');
            acc.classList.toggle('d-none', total === 0);
            if (total > 0 && wasHidden) {
                const body = document.getElementById('ais-acc-body');
                const btn  = document.querySelector('#ais-acc-head .accordion-button');
                if (body && !body.classList.contains('show')) body.classList.add('show');
                if (btn) { btn.classList.remove('collapsed'); btn.setAttribute('aria-expanded','true'); }
            }
        }

        // Prepare hub early
        (async()=>{ try { await ensureImportHub(); } catch(_){} })();

        // Deep Select: call API with deep flag and MARK suggestions (do not auto-check)
        (function(){
          const deepBtns = Array.from(document.querySelectorAll('.js-deep-select'));
          if (!deepBtns.length) return;

          const setBusy = (busy) => {
            deepBtns.forEach(btn => {
              btn.disabled = busy;
              btn.classList.toggle('is-busy', busy);
              const icon = btn.querySelector('i.bi-magic');
              if (icon) icon.classList.toggle('spin', busy);
            });
          };

          const runDeepSelect = async () => {
            const getTextById = (id) => {
              const el = document.getElementById(id);
              if (!el) return '';
              const ed = el.ckeditorInstance;
              const raw = ed ? ed.getData() : el.value;
              try { return new DOMParser().parseFromString(raw || '', 'text/html').body.textContent.trim(); } catch { return (raw || '').trim(); }
            };

            const body = {
              Titel: getTextById('promptTitle'),
              Thema: getTextById('thema'),
              Ziele: getTextById('ziele'),
              Beschreibung: getTextById('beschreibung'),
              'Schlüsselbegriffe': (document.getElementById('schluesselbegriffe')?.value || '')
                .split(',').map(s=>s.trim()).filter(Boolean)
            };
            const hasAny = [body.Titel, body.Thema, body.Ziele, body.Beschreibung].some(s => (s||'').length >= 3);
            if (!hasAny)
              return Swal.fire('Fehler','Bitte gib mindestens einen der folgenden Bereiche an: Titel, Thema, Ziele oder Beschreibung.','error');

            const modelId = getCurrentModel();
            const isGpt5 = (modelId || '').toLowerCase().startsWith('gpt-5');
            if (isGpt5) {
              const confirmed = await Swal.fire({
                title: 'GPT-5 Reasoning aktiv',
                html: '<div class="text-start">Der Deep-Select-Modus nutzt <strong>GPT-5</strong> für intensives Reasoning.<br/>Dies kann etwas länger dauern als bei anderen Modellen.<br/><br/>Bitte hab einen Moment Geduld, während die Ergebnisse berechnet werden.</div>',
                icon: 'info',
                confirmButtonText: 'Verstanden',
                customClass: { popup: 'glass-popup' }
              }).then(r => r.isConfirmed);
              if (!confirmed) return;
            }

            let progressTimer = null;
            try {
              const groupName = await getSelectedGroupName();
              if (groupName === undefined) return;

              setBusy(true);
              const overlay = document.getElementById('smart-loading');
              const stageTitle = document.getElementById('smart-stage-title');
              const stageHint  = document.getElementById('smart-stage-hint');
              overlay?.classList.remove('d-none');
              if (stageTitle) stageTitle.textContent = 'Deep Analyse';
              if (stageHint)  stageHint.textContent  = 'Vorschläge werden berechnet …';

              // No model selection in UI (managed in Manage Users)

              const opId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(36).slice(2));
              const progressUrl = '@Url.Content("~/api/PromptSmartSelection/progress/")' + opId;
              const poll = async () => {
                try {
                  const r = await fetch(progressUrl, { cache: 'no-store' });
                  if (!r.ok) return;
                  const p = await r.json();
                  const s = Number(p.stage);
                  const titles = new Map([[3,'Denken: Auswahl'],[6,'Denken: Bewertung'],[8,'Fertig']]);
                  if (stageTitle) stageTitle.textContent = titles.get(s) || 'Denken';
                } catch {}
              };
              await poll();
              progressTimer = setInterval(poll, 900);

              const targetType = CURRENT_TYPE;
              const req = { form: body, targetType, modelId, groupName };
              const res = await fetch('@Url.Content("~/api/PromptSmartSelection")', {
                method : 'POST',
                headers: { 'Content-Type':'application/json', 'X-Op-Id': opId, 'X-Deep-Select': '1' },
                body   : JSON.stringify(req)
              });

              if (!res.ok) throw new Error(await res.text());
              const data = await res.json();

              const cats = data?.categories || data?.Categories || [];
              const ids = [];
              for (const c of cats) {
                const items = c?.items || c?.Items || [];
                for (const it of items) ids.push(it?.itemId ?? it?.ItemId);
              }

              // Clear previous suggestion flags
              try {
                document.querySelectorAll('.filter-checkbox.ai-suggested').forEach(fc => {
                  fc.classList.remove('ai-suggested');
                  fc.querySelector('.sugg-tag')?.remove();
                });
              } catch {}

              let suggCount = 0;
              const firstId = ids[0];
              ids.forEach(id => {
                if (!id) return;
                const input = document.getElementById('filter_' + id);
                if (!input) return;
                const box = input.closest('.filter-checkbox');
                if (!box) return;
                // Do NOT check automatically; mark as KI‑Vorschlag only
                box.classList.add('ai-suggested');
                const lbl = box.querySelector('.filter-label');
                if (lbl && !lbl.querySelector('.sugg-tag')) {
                  const tag = document.createElement('span');
                  tag.className = 'sugg-tag';
                  tag.textContent = 'Vorschlag';
                  lbl.appendChild(tag);
                }
                suggCount++;
              });

              rebuildAiSuggestedAccordion();
              try { rebuildSummary(); } catch {}
              try { updateUsedMarks(); } catch {}
              try { setSmartAttention(); } catch {}
              try { saveAutosave(); } catch {}
              if (firstId) document.getElementById('filter_' + firstId)?.scrollIntoView({ behavior:'smooth', block:'center' });

              const overlay2 = document.getElementById('smart-loading');
              overlay2?.classList.add('d-none');
await Swal.fire({
  icon: 'success',
  title: `Deep Select<br><small style="font-size:0.7em; font-weight:400;">Datenbankbasierte Selektion</small>`,
  html: `<b>${suggCount}</b> Einträge gefunden.`
});            } catch (err) {
              const overlay2 = document.getElementById('smart-loading');
              overlay2?.classList.add('d-none');
              Swal.fire('Fehler', String(err), 'error');
            } finally {
              try { if (progressTimer) { clearInterval(progressTimer); progressTimer = null; } } catch {}
              setBusy(false);
            }
          };

          deepBtns.forEach(btn => btn.addEventListener('click', runDeepSelect));
        })();
        /* summary plus / trash buttons */
               summaryBox.addEventListener('click', e => {
            const plus  = e.target.closest('.plus-btn');
            const trash = e.target.closest('.trash-btn');

            /* –– Trash –– */
            if (trash) {
                const id  = trash.dataset.id;
                const val = trash.dataset.val;
                let inputs = [];
                if (id) {
                    const cb1 = document.getElementById('filter_' + id);
                    const cb2 = document.getElementById('bm_filter_' + id); // mirrored bookmark
                    if (cb1) { cb1.checked = false; inputs.push(cb1); }
                    if (cb2) { cb2.checked = false; inputs.push(cb2); }
                } else if (val) {
                    const selVal = CSS.escape(val);
                    inputs = Array.from(document.querySelectorAll(`.filter-checkbox input[value="${selVal}"]`));
                    inputs.forEach(cb => cb.checked = false);
                }
                // Remove ai-suggested mark and tag for these inputs as well
                try {
                    inputs.forEach(cb => {
                        const box = cb.closest('.filter-checkbox');
                        if (!box) return;
                        box.classList.remove('ai-suggested');
                        box.querySelector('.sugg-tag')?.remove();
                    });
                } catch {}
                // Also reset the usage counter for this single filter
                if (val) { try { chosenCounts[val] = 0; } catch {} }
                rebuildAiSuggestedAccordion();
                rebuildSummary();
                updateUsedMarks();
                try { saveAutosave(); } catch {}
                return;
            }
            if (!plus) return;

            /* –– Plus –– */
            const rawTitle = plus.dataset.title ||
                             plus.closest('.filter-summary-item')
                                 .querySelector('span')?.textContent || '';
            const title = oneLine(rawTitle);
            const instr = oneLine(plus.dataset.instruction ?? '');
            const toInsert = `(${title}): ${instr}`;

            const bTa = document.getElementById('beschreibung');
            const ed = bTa && bTa.ckeditorInstance;
            if (!ed) return;
            try { ed.execute('enter'); } catch {}
            ed.model.change(writer => {
                const html = `<p>${toInsert.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
                const insertionRange = ed.model.insertContent(
                    ed.data.toModel(ed.data.processor.toView(html)),
                    ed.model.document.selection.getFirstPosition()
                );
                writer.setSelection(insertionRange.end);
            });

            ed.editing.view.focus();
            incrementCount(plus.dataset.val || title);
            try { saveAutosave(); } catch {}
        });

        // AI accordion: mirror the same plus/trash behavior
        (function(){
          const acc = document.getElementById('ai-selected-accordion');
          if (!acc) return;
          acc.addEventListener('click', e => {
            const plus  = e.target.closest('.plus-btn');
            const trash = e.target.closest('.trash-btn');
            if (trash) {
              const id  = trash.dataset.id;
              const val = trash.dataset.val;
              let inputs = [];
              if (id) {
                const cb1 = document.getElementById('filter_' + id);
                const cb2 = document.getElementById('bm_filter_' + id);
                if (cb1) { cb1.checked = false; inputs.push(cb1); }
                if (cb2) { cb2.checked = false; inputs.push(cb2); }
              } else if (val) {
                const selVal = CSS.escape(val);
                inputs = Array.from(document.querySelectorAll(`.filter-checkbox input[value="${selVal}"]`));
                inputs.forEach(cb => cb.checked = false);
              }
              // Remove AI-selected mark and tag for these inputs as well
              try {
                inputs.forEach(cb => {
                  const box = cb.closest('.filter-checkbox');
                  if (!box) return;
                  box.classList.remove('ai-selected');
                  box.querySelector('.ai-tag')?.remove();
                });
              } catch {}
              if (val) { try { chosenCounts[val] = 0; } catch {} }
              rebuildSummary();
              updateUsedMarks();
              rebuildAiAccordion();
              try { saveAutosave(); } catch {}
              return;
            }
            if (!plus) return;
            const rawTitle = plus.dataset.title || plus.closest('.filter-summary-item')?.querySelector('span')?.textContent || '';
            const title = oneLine(rawTitle);
            const instr = oneLine(plus.dataset.instruction ?? '');
            const toInsert = `(${title}): ${instr}`;

            const bTa = document.getElementById('beschreibung');
            const ed = bTa && bTa.ckeditorInstance;
            if (!ed) return;
            try { ed.execute('enter'); } catch {}
            ed.model.change(writer => {
              const html = `<p>${toInsert.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
              const insertionRange = ed.model.insertContent(
                ed.data.toModel(ed.data.processor.toView(html)),
                ed.model.document.selection.getFirstPosition()
              );
              writer.setSelection(insertionRange.end);
            });
            ed.editing.view.focus();
            incrementCount(plus.dataset.val || title);
            try { saveAutosave(); } catch {}
          });
        })();

        // AI‑Vorschläge accordion: mirror plus/trash behavior
        (function(){
          const acc = document.getElementById('ai-suggested-accordion');
          if (!acc) return;
          acc.addEventListener('click', e => {
            const plus  = e.target.closest('.plus-btn');
            const trash = e.target.closest('.trash-btn');
            if (trash) {
              const id  = trash.dataset.id;
              const val = trash.dataset.val;
              let inputs = [];
              if (id) {
                const cb1 = document.getElementById('filter_' + id);
                const cb2 = document.getElementById('bm_filter_' + id);
                if (cb1) { cb1.checked = false; inputs.push(cb1); }
                if (cb2) { cb2.checked = false; inputs.push(cb2); }
              } else if (val) {
                const selVal = CSS.escape(val);
                inputs = Array.from(document.querySelectorAll(`.filter-checkbox input[value="${selVal}"]`));
                inputs.forEach(cb => cb.checked = false);
              }
              try {
                inputs.forEach(cb => {
                  const box = cb.closest('.filter-checkbox');
                  if (!box) return;
                  // Remove both types of AI marks if present
                  box.classList.remove('ai-suggested');
                  box.classList.remove('ai-selected');
                  box.querySelector('.sugg-tag')?.remove();
                  box.querySelector('.ai-tag')?.remove();
                });
              } catch {}
              if (val) { try { chosenCounts[val] = 0; } catch {} }
              rebuildAiSuggestedAccordion();
              rebuildSummary();
              updateUsedMarks();
              try { saveAutosave(); } catch {}
              return;
            }
            if (!plus) return;
            const rawTitle = plus.dataset.title || plus.closest('.filter-summary-item')?.querySelector('span')?.textContent || '';
            const title = oneLine(rawTitle);
            const instr = oneLine(plus.dataset.instruction ?? '');
            const toInsert = `(${title}): ${instr}`;

            const bTa = document.getElementById('beschreibung');
            const ed = bTa && bTa.ckeditorInstance;
            if (!ed) return;
            try { ed.execute('enter'); } catch {}
            ed.model.change(writer => {
              const html = `<p>${toInsert.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
              const insertionRange = ed.model.insertContent(
                ed.data.toModel(ed.data.processor.toView(html)),
                ed.model.document.selection.getFirstPosition()
              );
              writer.setSelection(insertionRange.end);
            });
            ed.editing.view.focus();
            incrementCount(plus.dataset.val || title);
            try { saveAutosave(); } catch {}
          });
        })();


                // put this near the top of your <script> block – we can reuse it everywhere
        function oneLine(htmlLikeString) {
          const decoded = htmlLikeString.replace(/&#10;/g, '\n');        // 1)   LF entity → real LF
          const text    = new DOMParser()                                // 2)   drop every tag / entity
                            .parseFromString(decoded, 'text/html')
                            .body.textContent || '';
          return text.replace(/\s+/g, ' ').trim();                       // 3)   collapse & trim
        }


        /* --------------------------------------------------
           COPY PROMPT
        -------------------------------------------------- */
        // document.getElementById('copy-prompt').addEventListener('click', () => {
        //     const ed = getEd(); if (!ed) return;
        //     const div = document.createElement('div'); div.innerHTML = ed.getData();
        //     div.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
        //     div.querySelectorAll('div,p').forEach(el => el.append('\n'));
        //     navigator.clipboard.writeText(div.textContent.trim()).then(() => new bootstrap.Toast('#copy-toast').show());
        // });



        /* --------------------------------------------------
            EXPORT as PDF
        -------------------------------------------------- */

        document.getElementById("export-pdf").addEventListener("click", async () => {
            const ed = getEd();
            if (!ed) return;

            const contentHTML = ed.getData().trim();
            if (!contentHTML) {
                Swal.fire({
                    icon: 'error',
                    title: 'Leerer Prompt',
                    text: 'Bitte gib zuerst einen Prompt ein, bevor du exportierst!',
                    confirmButtonColor: '#d33'
                });
                return;
            }


            const pdf = new jspdf.jsPDF("p", "mm", "a4");
            const margin = 15;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const maxWidth = pageWidth - 2 * margin;
            let yPos = margin;

            // Improved content parser
            const contentText = htmlToStructuredText(contentHTML);

            // Add header
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.setTextColor(0, 208, 132);
            pdf.text("Meine Prompt:", margin, yPos);
            yPos += 12;

            // Process content sections
            contentText.sections.forEach(section => {
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = margin;
                }

                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(12);
                pdf.setTextColor(40, 40, 40);

                // Split section title
                const titleLines = pdf.splitTextToSize(section.title, maxWidth);
                titleLines.forEach(line => {
                    pdf.text(line, margin, yPos);
                    yPos += 8;
                });

                pdf.setFont("helvetica");
                pdf.setFontSize(11);
                pdf.setTextColor(60, 60, 60);

                // Split content with proper wrapping
                const contentLines = pdf.splitTextToSize(section.content, maxWidth);
                contentLines.forEach(line => {
                    if (yPos > 280) {
                        pdf.addPage();
                        yPos = margin;
                    }
                    pdf.text(line, margin + (section.type === 'list' ? 5 : 0), yPos);
                    yPos += 7;
                });

                yPos += 10; // Section spacing
            });

            // Add footer
            const pageCount = pdf.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(100);
                pdf.text(`Seite ${i} von ${pageCount}`, pageWidth - margin, 290, { align: 'right' });
            }

            try {
                pdf.save("MeinPrompt.pdf");
                Swal.fire({
                    icon: 'success',
                    title: 'PDF erfolgreich exportiert',
                    text: 'Dein generierter Prompt wurde als PDF gespeichert!',
                    timer: 2500,
                    showConfirmButton: false
                });
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Fehler beim Export',
                    text: 'Beim Exportieren der PDF-Datei ist ein Fehler aufgetreten.',
                    confirmButtonColor: '#d33'
                });
            }

        });

        // Enhanced content parser
        function htmlToStructuredText(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            return {
                sections: Array.from(tempDiv.children).map(element => {
                    const text = element.textContent
                        .replace(/\s+/g, ' ')
                        .trim();

                    // numeric parameters
                    if (text.startsWith('Temperatur:') || text.startsWith('Max Zeichen:')) {
                        return { type: 'parameter', title: text, content: '' };
                    }

                    // header sections: Thema, Ziele, Beschreibung, Schlüsselbegriffe
                    if (
                        text.startsWith('Thema:') ||
                        text.startsWith('Ziele:') ||
                        text.startsWith('Beschreibung:') ||
                        text.startsWith('Schlüsselbegriffe:')
                    ) {
                        return { type: 'header', title: text, content: '' };
                    }

                    // everything else as list items
                    if (text) {
                        return {
                            type: 'list',
                            title: 'Anweisungen',
                            content: text.split(/, ?/).join('\n')
                        };
                    }

                    return { type: 'paragraph', title: '', content: text };
                })
            };
        }

        /* --------------------------------------------------
           Tokens Claculator
        -------------------------------------------------- */

        document.getElementById("calculate-tokens").addEventListener("click", () => {
            const ed = getEd();
            if (!ed) return;

            const contentHTML = ed.getData().trim();
            if (!contentHTML) {
                Swal.fire({
                    icon: 'error',
                    title: 'Kein Prompt gefunden',
                    text: 'Bitte gib zuerst einen Prompt ein.',
                    confirmButtonColor: '#d33'
                });
                return;
            }

            // Strip HTML to plain text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentHTML;
            const plainText = tempDiv.textContent || tempDiv.innerText || "";

            const charCount = plainText.length;
            const tokenCount = Math.ceil(charCount / 4); // Rough estimation: 1 token ≈ 4 chars

            Swal.fire({
                icon: 'info',
                title: 'Zeichen & Token',
                html: `
                    <p><strong>Zeichen (Characters):</strong> ${charCount}</p>
                    <p><strong>Tokens (geschätzt):</strong> ${tokenCount}</p>
                `,
                confirmButtonColor: '#3085d6'
            });
        });

               /* ----------  kompakteres Inline‑Model‑Panel  ------------------- */
        document.addEventListener('DOMContentLoaded', () => {
          /* ── Elemente ───────────────────────────────────────────────── */
          const container   = document.getElementById('inlineModelCards');
          const pagination  = document.getElementById('inlineModelPagination');
          const searchInput = document.getElementById('inlineModelSearch');
          const wrapper     = document.getElementById('inlineModelsContainer');
          const toggleBtn   = document.getElementById('show-inline-models');

          /* ── Layout‑Tweaks: 4 Spalten, kleinere Gaps ───────────────── */
          container.className = 'model-card-grid row row-cols-2 row-cols-sm-4 g-3';   // ❶
          const pageSize  = 8;                                                        // ❷  (4 × 2 Zeilen)

          /* ── State ──────────────────────────────────────────────────── */
          let allModels = [], filteredModels = [], currentPage = 1, isVisible = false;

          /* ── kleine, schmale Karte ─────────────────────────────────── */
         const cardHtml = m => `
        <div class="col">
          <div class="card h-100 shadow-sm border-success-subtle">
            <div class="card-body p-3 d-flex flex-column align-items-center gap-2">
              <!-- truncate & zentriert -->
              <h6 class="card-title mb-0 w-100 text-truncate text-center fw-semibold text-success"
                  title="${m.titel}">${m.titel}</h6>

              <!-- kompakter Button, zentriert durch align‑items‑center -->
              <a href="${m.redirectUrl}" target="_blank"
                 class="btn btn-sm btn-outline-success px-3 mt-auto">
                Öffnen <i class="bi bi-box-arrow-up-right ms-1"></i>
              </a>
            </div>
          </div>
        </div>`;



                /* ── Pagination ─────────────────────────────────────────────── */
          function renderPagination() {
            const totalPages = Math.ceil(filteredModels.length / pageSize);
            pagination.innerHTML = '';
            const add = (lbl, p, dis = false, act = false) =>
              pagination.insertAdjacentHTML('beforeend',
                `<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
                   <a class="page-link" href="#" data-page="${p}">${lbl}</a>
                 </li>`);

            add('«', currentPage-1, currentPage===1);
            for (let p = 1; p <= totalPages; p++) add(p, p, false, p===currentPage);
            add('»', currentPage+1, currentPage===totalPages);
          }

          /* ── Karten‑Render ──────────────────────────────────────────── */
          function renderModels() {
            const start = (currentPage-1)*pageSize;
            const slice = filteredModels.slice(start, start+pageSize);
            container.innerHTML = slice.length
              ? slice.map(cardHtml).join('')
              : `<p class="text-muted text-center">Keine Modelle gefunden.</p>`;
            renderPagination();
          }

          /* ── Event‑Binding ──────────────────────────────────────────── */
          pagination.addEventListener('click', e => {
            const l = e.target.closest('a[data-page]'); if (!l) return; e.preventDefault();
            const p = +l.dataset.page;
            if (p>0 && p<=Math.ceil(filteredModels.length/pageSize)) { currentPage = p; renderModels(); }
          });

          searchInput.addEventListener('input', () => {
            const term = searchInput.value.trim().toLowerCase();
            filteredModels = allModels.filter(m => m.titel.toLowerCase().includes(term));
            currentPage = 1; renderModels();
          });

          toggleBtn.addEventListener('click', async () => {
            isVisible = !isVisible;
            wrapper.style.display = isVisible ? 'block' : 'none';
            document.getElementById('models-button-text').textContent = isVisible ? 'Modelle ausblenden' : 'Modelle anzeigen';
            document.getElementById('models-icon').className = isVisible ? 'bi bi-eye-slash' : 'fa fa-cubes';

            if (isVisible && !allModels.length) {
              try {
                const res  = await fetch('@Url.Content("~/api/PromptModel")');
                if (!res.ok) throw new Error(`Fehler ${res.status}`);
                allModels = await res.json();
                filteredModels = allModels;
                renderModels();
              } catch (err) {
                console.error(err);
                container.innerHTML = `<p class="text-danger">${err.message}</p>`;
              }
            }
          });
        });


        document.querySelectorAll('.color-swatch').forEach(swatch => {
            if (swatch.value.toUpperCase() === '#FFFFFF') {
                swatch.style.border = '2px solid #ccc';
            }
        });

        document.querySelectorAll('.scroll-arrow').forEach(btn => {
            btn.addEventListener('click', () => {
                const toolbar = document.querySelector('.filter-toolbar');
                const direction = btn.classList.contains('left') ? -1 : 1;
                toolbar.scrollBy({ left: direction * 150, behavior: 'smooth' });
            });
        });

        //Als Vorlage Speichern

                  /* -----------------------------------------------------------
         *  Bibliotheks‑Speichern  (PromptTemplate – Admin‑Bereich)
         * -----------------------------------------------------------
         *  – prüft zuerst, ob das Akronym schon existiert
         *  – bei Kollision: „Überschreiben / Abbrechen“‑Dialog
         *  – sendet anschließend den Prompt an /Save   (Upsert‑Logik)
         * --------------------------------------------------------- */

              /* -----------------------------------------------------------
         *  Bibliotheks‑Speichern (PromptTemplate – Admin‑Area)
         * --------------------------------------------------------- */
        (() => {
          const btnSave = document.getElementById('save-to-library');
          if (!btnSave) return;                        // safety‑net

          /* ---- Helper: SHA‑256 ------------------------------------------------ */
          async function sha256(str) {
            const buf  = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
          }

          /* ---- Helper: Akronym‑Existenz prüfen -------------------------------- */
          const existsUrl = '@Url.Action("Exists", "PromptTemplateApi", new { area = "Api" })';

          async function akronymExists(akronym) {
            const res = await fetch(`${existsUrl}?akronym=${encodeURIComponent(akronym)}`,
                                    { credentials: 'same-origin' });
            if (res.status === 404) return false;          // route not found → treat as “free”
            const data = await res.json();                 // always { exists: bool, message? }
            return !!data.exists;
          }

          /* ---- Main handler --------------------------------------------------- */
          btnSave.addEventListener('click', async () => {
            const akronym = document.getElementById('akronym').value.trim();
            if (!akronym)
              return Swal.fire({ icon:'error', title:'Akronym fehlt', text:'Bitte ein Akronym angeben.' });

            /* 1) Existenz abfragen ------------------------------------------------ */
            let alreadyThere = false;
            try {
              alreadyThere = await akronymExists(akronym);
            } catch (err) {
              return Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
            }

            /* 2) Dialog: neu | überschreiben ------------------------------------ */
            const confirmed = await Swal.fire({
              title: alreadyThere
                     ? `Akronym „${akronym}“ existiert bereits.`
                     : 'In die Bibliothek speichern?',
              text:  alreadyThere
                     ? 'Möchtest du den bestehenden Prompt überschreiben?'
                     : 'Bist du sicher, dass du diesen Prompt speichern möchtest?',
              icon:  alreadyThere ? 'warning' : 'question',
              showCancelButton: true,
              confirmButtonText: alreadyThere ? 'Überschreiben' : 'Speichern',
              cancelButtonText: 'Abbrechen'
            }).then(r => r.isConfirmed);

            if (!confirmed) return;

            /* 3) Gruppenwahl ----------------------------------------------------- */
            let selectedGroups = [];
            try {
              const groupsUrl = '@Url.Action("AllowedGroups", "PromptTemplateApi", new { area = "Api" })';
              const grRes = await fetch(groupsUrl, { credentials: 'same-origin' });
              const grJson = await grRes.json();
              const groups = Array.isArray(grJson.groups) ? grJson.groups : [];

              // Build premium searchable multi-select dropdown for rooms (portal-based)
              const html = groups.length === 0
                ? '<div>Keine Räume verfügbar. Der Prompt wird ohne Raum veröffentlicht.</div>'
                : `<div class="room-select-container" id="pubRoomContainer">
                     <div class="room-select-box" id="pubRoomSelectBox">
                       <span class="room-select-placeholder">Räume auswählen…</span>
                       <span class="room-select-arrow"><i class="bi bi-chevron-down"></i></span>
                     </div>
                   </div>
                   <div class="room-select-info">${groups.length} Räume verfügbar</div>`;

              // Create portal dropdown in body
              const portalId = 'pubRoomDropdownPortal';
              let portal = document.getElementById(portalId);
              if (portal) portal.remove();
              portal = document.createElement('div');
              portal.id = portalId;
              portal.className = 'room-dropdown-portal';
              portal.innerHTML = `
                <input type="text" class="room-search-input" id="pubRoomSearch" placeholder="Räume durchsuchen…">
                <div class="room-list" id="pubRoomList">
                  ${groups.map(g => { const esc = g.replace(/"/g,'&quot;'); return `<div class="room-list-item" data-value="${esc}" data-search="${esc.toLowerCase()}">${esc}</div>`; }).join('')}
                </div>`;
              document.body.appendChild(portal);

              const go = await Swal.fire({
                title: 'In welchen Räume veröffentlichen?',
                html,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Weiter',
                cancelButtonText: 'Abbrechen',
                customClass: { popup: 'group-select-popup' },
                didOpen: () => {
                  const container = document.getElementById('pubRoomContainer');
                  const selectBox = document.getElementById('pubRoomSelectBox');
                  const arrow = selectBox.querySelector('.room-select-arrow');
                  const portal = document.getElementById(portalId);
                  const searchInput = document.getElementById('pubRoomSearch');
                  const list = document.getElementById('pubRoomList');
                  if (!container || !selectBox || !portal) return;

                  let selected = new Set();
                  let isOpen = false;

                  function positionPortal() {
                    const rect = selectBox.getBoundingClientRect();
                    portal.style.top = (rect.bottom + 4) + 'px';
                    portal.style.left = rect.left + 'px';
                    portal.style.width = rect.width + 'px';
                  }

                  function openDropdown() {
                    if (isOpen) return;
                    isOpen = true;
                    positionPortal();
                    portal.classList.add('open');
                    selectBox.classList.add('focused');
                    arrow.classList.add('open');
                    searchInput.focus();
                  }

                  function closeDropdown() {
                    if (!isOpen) return;
                    isOpen = false;
                    portal.classList.remove('open');
                    selectBox.classList.remove('focused');
                    arrow.classList.remove('open');
                  }

                  function renderTags() {
                    const placeholder = selectBox.querySelector('.room-select-placeholder');
                    selectBox.querySelectorAll('.room-tag').forEach(t => t.remove());
                    if (selected.size === 0) {
                      if (placeholder) placeholder.style.display = '';
                    } else {
                      if (placeholder) placeholder.style.display = 'none';
                      selected.forEach(val => {
                        const tag = document.createElement('span');
                        tag.className = 'room-tag';
                        tag.innerHTML = `<span>${val}</span><span class="room-tag-remove" data-val="${val}">&times;</span>`;
                        selectBox.insertBefore(tag, arrow);
                      });
                    }
                    list.querySelectorAll('.room-list-item').forEach(item => {
                      item.classList.toggle('selected', selected.has(item.dataset.value));
                    });
                  }

                  selectBox.addEventListener('click', (e) => {
                    if (e.target.closest('.room-tag-remove')) {
                      const val = e.target.closest('.room-tag-remove').dataset.val;
                      selected.delete(val);
                      renderTags();
                      e.stopPropagation();
                      return;
                    }
                    isOpen ? closeDropdown() : openDropdown();
                  });

                  searchInput.addEventListener('input', () => {
                    const term = searchInput.value.toLowerCase().trim();
                    list.querySelectorAll('.room-list-item').forEach(item => {
                      const matches = !term || item.dataset.search.includes(term);
                      item.classList.toggle('hidden', !matches);
                    });
                  });

                  list.addEventListener('click', (e) => {
                    const item = e.target.closest('.room-list-item');
                    if (!item) return;
                    const val = item.dataset.value;
                    if (selected.has(val)) selected.delete(val);
                    else selected.add(val);
                    renderTags();
                    closeDropdown();
                  });

                  // Close on outside click
                  document.addEventListener('click', function handler(e) {
                    if (!selectBox.contains(e.target) && !portal.contains(e.target)) {
                      closeDropdown();
                    }
                  });

                  container._getSelected = () => Array.from(selected);
                },
                willClose: () => {
                  const portal = document.getElementById(portalId);
                  if (portal) portal.remove();
                },
                preConfirm: () => {
                  if (groups.length === 0) return [];
                  const container = document.getElementById('pubRoomContainer');
                  const selected = container?._getSelected?.() || [];
                  if (selected.length === 0) {
                    Swal.showValidationMessage('Bitte mindestens einen Raum auswählen.');
                    return false;
                  }
                  return selected;
                }
              });
              if (!go.isConfirmed) return; // aborted
              selectedGroups = Array.isArray(go.value) ? go.value : [];
            } catch (e) {
              // if anything fails, continue without groups
              selectedGroups = [];
            }

            /* 4) Payload --------------------------------------------------------- */
            const st   = collectState();           // deine Helfer‑Funktion
            // embed colors into HTML
            st.promptHtml = ensureColorsInHtml(st.promptHtml, st.colors);
            const used = getUsedFilters(st);

            const payload = {
              Akronym:            akronym,
              Title:              document.getElementById('promptTitle').value.trim(),
              Beschreibung:       document.getElementById('beschreibung').value.trim(),
              Schluesselbegriffe: document.getElementById('schluesselbegriffe').value.trim(),
              Thema:              st.thema,
              Ziele:              st.ziele,
              PromptHtml:         st.promptHtml,
              PromptType:         st.type,
              FilterJson:         JSON.stringify(used),
              Groups:             selectedGroups,
              Temperatur:         st.temperatur,
              MaxZeichen:         st.maxZeichen
            };
            const body = { ...payload, MetaHash: await sha256(JSON.stringify(payload)) };

            /* 5) POST an /Publish ------------------------------------------------ */
            try {
              const saveUrl   = '@Url.Action("Publish", "PromptTemplateApi", new { area = "Api" })';
              const res     = await fetch(saveUrl, {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : JSON.stringify(body)
              });
              if (!res.ok) throw await res.text();

              Swal.fire({
                icon: alreadyThere ? 'success' : 'success',
                title: alreadyThere ? 'Überschrieben!' : 'Veröffentlicht!',
                timer: 1500,
                showConfirmButton: false
              });
            } catch (err) {
              Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
            }
          });
        })();


        document.addEventListener('click', e => {
            let target = e.target;
            if (target && target.nodeType !== 1) target = target.parentElement;
            const badge = target?.closest?.('.info-badge');
            if (!badge) return;
            e.preventDefault();
            if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
            else e.stopPropagation();
            const infoText = badge.dataset.info || '';
            Swal.fire({
                html: `<div style="text-align:left; width:100%; line-height:1.4;">${infoText}</div>`,
                showCloseButton: true,
                focusConfirm: false,
                customClass: { popup: 'glass-popup' }
            });
        });

        // Note: rely on native <label for="..."> toggling. The .info-badge handler above
        // prevents default only for badges, so normal label clicks continue to work.


        //Als Variation speichern
        // document.getElementById('save-variation').addEventListener('click', async () => {
        //     // 1) collect all current prompt state
        //     const state = collectState();

        //     // 2) ask user for the Akronym
        //     const { value: akronym } = await Swal.fire({
        //         title: 'Variation speichern',
        //         input: 'text',
        //         inputLabel: 'Bitte gib das Akronym des bestehenden Prompts ein',
        //         inputPlaceholder: 'z. B. SMM',
        //         showCancelButton: true
        //     });

        //     if (!akronym) {
        //         Swal.fire({ icon: 'error', title: 'Abbruch', text: 'Kein Akronym eingegeben.' });
        //         return;
        //     }

        //     // 3) POST to your new endpoint
        //     let res, json;
        //     try {
        //         res = await fetch('/Admin/PromptTemplate/AddVariation', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify({ Akronym: akronym.trim(), Data: state })
        //         });
        //         json = await res.json();
        //     } catch (e) {
        //         return Swal.fire({ icon: 'error', title: 'Netzwerkfehler', text: e.message });
        //     }

        //     if (!json.success) {
        //         return Swal.fire({ icon: 'error', title: 'Fehler', text: json.message });
        //     }

        //     Swal.fire({ icon: 'success', title: 'Gespeichert', text: json.message });
        // });

                // ── Als Variation speichern ───────────────────────────

                        /* ---- Prompt-Eigenschaften  ➜  Zurücksetzen ---- */
        document.getElementById('reset-basic')?.addEventListener('click', async () => {
          const go = await Swal.fire({
            title: 'Prompt‑Eigenschaften zurücksetzen?',
            text:  'Akronym, Titel, Thema, Ziele, Beschreibung und Schlüsselbegriffe werden geleert.',
            icon:  'warning',
            showCancelButton: true,
            confirmButtonText: 'Ja, zurücksetzen',
            cancelButtonText : 'Abbrechen'
          }).then(r => r.isConfirmed);
          if (!go) return;

          const ids = ['akronym','promptTitle','thema','ziele','beschreibung','schluesselbegriffe'];
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ed = el.ckeditorInstance;
            if (ed) { try { ed.setData(''); } catch {} }
            else { el.value = ''; }
          });

          // Spezifikations-Block im Editor aktualisieren
          try { if (typeof refreshSpecifications === 'function') refreshSpecifications(); } catch {}
          // Autosave auslösen
          try { saveAutosave(); } catch { try { saveAutosaveDebounced(); } catch {} }
        });


              /* ------------------------------------------------------------------
         *  2)  ➜  “Variation zur Bibliothek”   (Admin‑Bibliothek)
         * ----------------------------------------------------------------- */
        (() => {
          const btn = document.getElementById('save-variation');
          if (!btn) return;

          /* helper: Existenz in Bibliothek prüfen */
          const existsUrl = '@Url.Action("Exists", "PromptTemplateApi", new { area = "Api" })';
          const akronymExistsInLib = async akr => {
            const res = await fetch(`${existsUrl}?akronym=${encodeURIComponent(akr)}`,
                                    { credentials: 'same-origin' });
            return (await res.json()).exists;
          };

          btn.addEventListener('click', async () => {
            const akronym = document.getElementById('akronym').value.trim();
            if (!akronym)
              return Swal.fire('Akronym fehlt', 'Bitte zuerst ein Akronym angeben.', 'error');

            if (!(await akronymExistsInLib(akronym)))
              return Swal.fire('Nicht gefunden',
                               `Kein Bibliotheks‑Prompt mit Akronym “${akronym}” vorhanden.`,
                               'error');

            const go = await Swal.fire({
              title: `Variation zu “${akronym}” speichern?`,
              icon:  'question',
              showCancelButton: true,
              confirmButtonText: 'Speichern',
              cancelButtonText : 'Abbrechen'
            }).then(r => r.isConfirmed);
            if (!go) return;

            try {
              const res = await fetch('@Url.Action("AddVariation", "PromptTemplateApi", new { area = "Api" })', {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : (() => { const cs = collectState(); cs.promptHtml = ensureColorsInHtml(cs.promptHtml, cs.colors); mergeFilterJsonWithTechniques(cs); return JSON.stringify({ Akronym: akronym, Data: cs }); })()
              });
              if (!res.ok) throw await res.text();

              const json = await res.json();
              if (!json.success) throw json.message;

              Swal.fire({ icon:'success', title:'Variation gespeichert', timer:1500, showConfirmButton:false });
            } catch (err) {
              Swal.fire({ icon:'error', title:'Fehler', text:String(err) });
            }
          });
        })();

        //Prompt Generieren mit KI section

                /* --------------------------------------------------
           FILTER GENERIEREN  (→ GPT → JSON-Download)
        -------------------------------------------------- */
        // document.getElementById('generate-filters')
        //         .addEventListener('click', async () => {

        //   /* 1)  Formulardaten einsammeln */
        //   const body = {
        //     Titel:             document.getElementById('promptTitle').value.trim(),
        //     Thema:             document.getElementById('thema').value.trim(),
        //     Ziele:             document.getElementById('ziele').value.trim(),
        //     Beschreibung:      document.getElementById('beschreibung').value.trim(),
        //     Schlüsselbegriffe: document.getElementById('schluesselbegriffe')
        //                           .value.split(',').map(s => s.trim()).filter(Boolean)
        //   };

        //   /* minimale Validierung */
        //   if (!body.Titel || !body.Thema)
        //     return Swal.fire('Fehler', 'Titel und Thema dürfen nicht leer sein.', 'error');

        //   /* 2)  Request an dein API-Ende */
        //   try {
        //     const res = await fetch('/promptcoach/api/PromptFilters/generate', {
        //       method : 'POST',
        //       headers: { 'Content-Type':'application/json' },
        //       body   : JSON.stringify(body)
        //     });
        //     if (!res.ok) throw await res.text();

        //     /* 3)  Blob → Download */
        //     const blob = await res.blob();
        //     const url  = URL.createObjectURL(blob);
        //     Object.assign(document.createElement('a'), {
        //       href: url,
        //       download: (body.Titel || 'prompt-filters') + '.json'
        //     }).click();
        //     URL.revokeObjectURL(url);

        //     Swal.fire({ icon:'success',
        //                 title:'JSON gespeichert',
        //                 text :'Die Filter wurden erzeugt und heruntergeladen.',
        //                 timer:1800,
        //                 showConfirmButton:false });

        //     /* → hier könntest du das JSON auch
        //          direkt als JavaScript-Objekt einlesen,
        //          um es gleich in Schritt 2 in die DB zu schreiben. */

        //   } catch (err) {
        //     Swal.fire('Fehler', String(err), 'error');
        //   }
        // });

                // ===== Loading UI for "Filter generieren"
              // ===== Loading UI for "Filter generieren"
        const genBtn  = document.getElementById('generate-filters');
        const loadBox = document.getElementById('ai-loading');
        const wordEl  = document.getElementById('ai-typing-word');
        const dotsEl  = document.getElementById('ai-typing-dots');
        // CURRENT_TYPE is declared earlier in this file
        const IS_ADMIN = @((User.IsInRole("Admin") || User.IsInRole("SuperAdmin")).ToString().ToLower());
        const FEATURE_GENERATION_ENABLED = @(((bool)(ViewBag.FeatureGenerationEnabled ?? true)).ToString().ToLower());
        const FEATURE_GENERATION_DISABLED_MSG = '@(ViewBag.FeatureGenerationDisabledReason ?? "Die KI‑Generierung wurde vom Admin deaktiviert.")';
        const FEATURE_SMART_ENABLED = @(((bool)(ViewBag.FeatureSmartEnabled ?? true)).ToString().ToLower());
        const FEATURE_SMART_DISABLED_MSG = '@(ViewBag.FeatureSmartDisabledReason ?? "Smart Selection wurde vom Admin deaktiviert.")';
        const FEATURE_TECHNIQUE_ENABLED = @(((bool)(ViewBag.FeatureTechniqueEnabled ?? true)).ToString().ToLower());
        const FEATURE_TECHNIQUE_DISABLED_MSG = '@(ViewBag.FeatureTechniqueDisabledReason ?? "Prompt‑Techniken wurden vom Admin deaktiviert.")';
        const FILTER_CATEGORY_INDEX = '@Url.Action("Index","FilterCategory", new { area = "User" })';
        const ADMIN_FILTER_CATEGORY_INDEX = '@Url.Action("Index","FilterCategory", new { area = "Admin" })';

        // Run these ONCE in order, then stick to "Denken"
        const THINK_ONCE = ["Analysieren", "Strukturieren", "Bewerten", "Kombinieren", "Verfeinern"];
        let _wordTimer = null, _dotsTimer = null, _idx = -1;

        function startLoadingUI(){
          if(!genBtn || !loadBox) return;
          genBtn.classList.add('is-loading'); genBtn.disabled = true;
          loadBox.classList.remove('d-none');
          try { document.querySelector('.filter-toolbar-wrapper')?.classList.add('is-loading'); } catch {}

          // dots: slower
          clearInterval(_dotsTimer);
          let d = 0;
          _dotsTimer = setInterval(()=>{
            d = (d + 1) % 4;
            dotsEl.textContent = ".".repeat(d);
          }, 500); // slower dots

          // words: step through once, then pin to "Denken"
          clearInterval(_wordTimer);
          _idx = -1;
          wordEl.textContent = THINK_ONCE[0]; // start immediately with first
          _idx = 0;

          _wordTimer = setInterval(()=>{
            _idx++;
            if (_idx < THINK_ONCE.length) {
              wordEl.textContent = THINK_ONCE[_idx];
            } else {
              wordEl.textContent = "Denken";
              clearInterval(_wordTimer); // stop cycling; keep dots animating
            }
          }, 1800); // ← slower word cadence
        }

        function stopLoadingUI(){
          if(!genBtn || !loadBox) return;
          genBtn.classList.remove('is-loading'); genBtn.disabled = false;
          loadBox.classList.add('d-none');
          try { document.querySelector('.filter-toolbar-wrapper')?.classList.remove('is-loading'); } catch {}
          clearInterval(_wordTimer);
          clearInterval(_dotsTimer);

          _wordTimer = _dotsTimer = null;
          // reset text to first state for next run
          wordEl.textContent = "Denken";
          dotsEl.textContent = "…";
        }

        // Ask options (title mode) before starting Filter Generation
        async function askGenerationOptions(){
          return await Swal.fire({
            title: 'Filter generieren',
            html: `
              <div class="text-start">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="genTitleMode" id="genTitle_ai" value="ai" checked>
                  <label class="form-check-label" for="genTitle_ai">Titel von KI vorschlagen</label>
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="radio" name="genTitleMode" id="genTitle_manual" value="manual">
                  <label class="form-check-label" for="genTitle_manual">Titel manuell festlegen</label>
                </div>
                <input id="genTitle_input" class="form-control mt-2" placeholder="Kategorie-Titel" disabled>
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Generieren',
            cancelButtonText : 'Abbrechen',
            didOpen: () => {
              const ai  = document.getElementById('genTitle_ai');
              const man = document.getElementById('genTitle_manual');
              const inp = document.getElementById('genTitle_input');
              const apply = () => {
                const useAi = ai?.checked;
                inp.disabled = !!useAi;
                inp.placeholder = useAi ? 'Kategorie-Titel wird von der KI gesetzt' : 'Kategorie-Titel';
                if (!useAi) setTimeout(()=> inp.focus(), 0);
              };
              ai?.addEventListener('change', apply);
              man?.addEventListener('change', apply);
              apply();
            },
            preConfirm: () => {
              const mode  = (document.querySelector('input[name="genTitleMode"]:checked')?.value || 'ai');
              const title = (document.getElementById('genTitle_input')?.value || '').trim();
              if (mode === 'manual' && !title) {
                Swal.showValidationMessage('Bitte einen Titel eingeben.');
                return false;
              }
              return { mode, title };
            }
          });
        }

        // (disabled) separate binding; integrated into main generation flow below
        if (false && genBtn) {
          genBtn.addEventListener('click', async () => {
            /* integrated elsewhere */
          });
        }
        
        // reflect feature toggle in UI on load
               if (genBtn && !FEATURE_GENERATION_ENABLED && !IS_ADMIN) {
          genBtn.disabled = true;
          genBtn.title = FEATURE_GENERATION_DISABLED_MSG;
        }
        // Prompt Technique button (Editor)
        const genTechBtn = document.getElementById('generate-techniques');
        if (genTechBtn && !FEATURE_TECHNIQUE_ENABLED) {
          genTechBtn.disabled = true;
          genTechBtn.title = FEATURE_TECHNIQUE_DISABLED_MSG;
        }
        const smartBtnNodes = Array.from(document.querySelectorAll('.js-smart-select'));
        if (smartBtnNodes.length && !FEATURE_SMART_ENABLED && !IS_ADMIN) {
          smartBtnNodes.forEach(b => b.classList.add('d-none'));
        }

        function setSmartAttention(){
          const anyChecked = !!document.querySelector('.filter-checkbox input:checked');
          document.querySelectorAll('.js-smart-select').forEach(b => b.classList.toggle('attention', !anyChecked));
          const hint = document.getElementById('dock-hint');
          if (hint) hint.classList.toggle('d-none', anyChecked);
        }

        // Smart Selection: call API to select existing items by IDs and auto-check them
        (function(){
          const smartBtns = Array.from(document.querySelectorAll('.js-smart-select'));
          if (!smartBtns.length) return;

          const setBusy = (busy) => {
            smartBtns.forEach(btn => {
              btn.disabled = busy;
              btn.classList.toggle('is-busy', busy);
              const icon = btn.querySelector('i.bi-magic');
              if (icon) icon.classList.toggle('spin', busy);
            });
          };

          const runSmartSelection = async () => {
            if (!FEATURE_SMART_ENABLED && !IS_ADMIN) {
              return Swal.fire('Deaktiviert', FEATURE_SMART_DISABLED_MSG, 'info');
            }

            const body = {
              Titel: document.getElementById('promptTitle').value.trim(),
              Thema: document.getElementById('thema').value.trim(),
              Ziele: document.getElementById('ziele').value.trim(),
              Beschreibung: document.getElementById('beschreibung').value.trim(),
              'Schlüsselbegriffe': document.getElementById('schluesselbegriffe')
                .value.split(',').map(s=>s.trim()).filter(Boolean)
            };
            if (!body.Titel || !body.Thema)
              return Swal.fire('Fehler','Titel und Thema dürfen nicht leer sein.','error');

            // progress state for Smart Selection
            let progressTimer = null;
            try {
              const groupName = await getSelectedGroupName();
              if (groupName === undefined) return;

              setBusy(true);
              // Use local overlay for Smart Selection (inside .type-card)
              const overlay = document.getElementById('smart-loading');
              const stageTitle = document.getElementById('smart-stage-title');
              const stageHint  = document.getElementById('smart-stage-hint');
              overlay?.classList.remove('d-none');

              // Keep local overlay with magic-wand.gif; do not swap global artwork
              // Start backend-driven progress polling
              try { clearInterval(_wordTimer); } catch {}
              // reflect local progress text if available

              // Generate an operation id and begin polling the backend for progress
              const opId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(36).slice(2));
              const stageMap = new Map([
                [0, ['Start', 'Initialisiere …']],
                [1, ['Lexikon laden', '']],
                [2, ['Lexikon getrimmt', '']],
                [3, ['Denken: Auswahl', 'Analyse läuft …']],
                [4, ['Auswahl erhalten', '']],
                [5, ['IDs validieren', '']],
                [6, ['Denken: Bewertung', 'Bewertung läuft …']],
                [7, ['Bewertung erhalten', '']],
                [8, ['Fertig', '']]
              ]);
              const progressUrl = '@Url.Content("~/api/PromptSmartSelection/progress/")' + opId;
              const poll = async () => {
                try {
                  const r = await fetch(progressUrl, { cache: 'no-store' });
                  if (!r.ok) return; // 404 until first report is fine
                  const p = await r.json();
                  const s = Number(p.stage);
                  const pair = stageMap.get(s) || ['Denken', ''];
                  // Only use our local stageMap text (never surface server-provided text)
                  const title = pair[0];
                  const hintText = pair[1] || '';
                  if (stageTitle) stageTitle.textContent = title;
                  if (stageHint) stageHint.textContent = hintText;
                } catch {}
              };
              await poll();
              progressTimer = setInterval(poll, 900);

              const targetType = CURRENT_TYPE; // server parses case-insensitively
              const req = { form: body, targetType, groupName };
              const res = await fetch('@Url.Content("~/api/PromptSmartSelection")', {
                method : 'POST',
                headers: { 'Content-Type':'application/json', 'X-Op-Id': opId },
                body   : JSON.stringify(req)
              });
              if (!res.ok) throw new Error(await res.text());
              const data = await res.json();

              const cats = data?.categories || data?.Categories || [];
              const ids = new Set();
              for (const c of cats) {
                const items = c?.items || c?.Items || [];
                for (const it of items) ids.add(it?.itemId ?? it?.ItemId);
              }

              // Clear previous AI flags
              try {
                document.querySelectorAll('.filter-checkbox.ai-selected').forEach(fc => {
                  fc.classList.remove('ai-selected');
                  fc.querySelector('.ai-tag')?.remove();
                });
              } catch {}

              let selectedCount = 0;
              const firstId = ids.values().next().value;
              const aiGroups = new Map(); // category name -> [titles]
              ids.forEach(id => {
                if (!id) return;
                const cb = document.getElementById('filter_' + id);
                if (!cb) return;
                if (!cb.checked) {
                  cb.checked = true;
                  cb.dispatchEvent(new Event('change', { bubbles: true }));
                  selectedCount++;
                }
                // Mark visual
                const box = cb.closest('.filter-checkbox');
                if (box) {
                  box.classList.add('ai-selected');
                  const lbl = box.querySelector('.filter-label');
                  if (lbl && !lbl.querySelector('.ai-tag')) {
                    const tag = document.createElement('span');
                    tag.className = 'ai-tag';
                    tag.textContent = 'KI';
                    lbl.appendChild(tag);
                  }
                }
                // Group for accordion
                const panel = cb.closest('.filter-panel');
                const catName = panel?.dataset?.name || '';
                const title = box?.querySelector('.filter-label')?.textContent?.trim() || cb.value;
                if (catName && title) {
                  if (!aiGroups.has(catName)) aiGroups.set(catName, []);
                  aiGroups.get(catName).push(title);
                }
              });

              // Build the KI accordion from current AI marks
              rebuildAiAccordion();

              if (firstId) {
                const el = document.getElementById('filter_' + firstId);
                el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }

              try { rebuildSummary(); } catch {}
              try { updateUsedMarks(); } catch {}
              try { updateBurgerVisibility(); } catch {}
              try { setSmartAttention(); } catch {}
              try { saveAutosave(); } catch {}

              // stop local overlay for Smart Selection
              const overlay2 = document.getElementById('smart-loading');
              overlay2?.classList.add('d-none');
              const cov = (data?.coverageScore ?? data?.CoverageScore ?? 0);
              await Swal.fire({
                icon:'success',
                title:'Smart Selection angewandt',
                html:`<div>Es wurden <b>${selectedCount}</b> Filter automatisch ausgewählt.</div>
                      <div>Abdeckung: <b>${Math.round(cov*100)}%</b></div>`
              });
            } catch (err) {
              const overlay2 = document.getElementById('smart-loading');
              overlay2?.classList.add('d-none');
              Swal.fire('Fehler', String(err), 'error');
            }
            finally {
              // Stop progress polling
              try {
                if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
              } catch {}
              setBusy(false);
            }
          };

          smartBtns.forEach(btn => btn.addEventListener('click', runSmartSelection));
          // Initialize attention state
          setSmartAttention();
        })();

        // Wire both the dock button and the toolbar chip (if present)
        const genButtons = [
          ...Array.from(document.querySelectorAll('.js-generate-filters')),
          ...[document.getElementById('generate-filters')].filter(Boolean)
        ];
        function storeFormSnapshot(){
          try {
            const getVal = (id) => {
              const el = document.getElementById(id);
              if (!el) return '';
              const ed = el.ckeditorInstance;
              return ed ? ed.getData() : (el.value || '');
            };
            const html = getVal('beschreibung');
            const text = (() => { try { return new DOMParser().parseFromString(html, 'text/html').body.textContent || ''; } catch { return html; } })();
            localStorage.setItem(keyOf('prompt_title'), getVal('promptTitle'));
            localStorage.setItem(keyOf('prompt_thema'), getVal('thema'));
            localStorage.setItem(keyOf('prompt_ziele'), getVal('ziele'));
            localStorage.setItem(keyOf('prompt_beschreibung_html'), html);
            localStorage.setItem(keyOf('prompt_beschreibung'), text);
            const sb = document.getElementById('schluesselbegriffe'); if (sb) localStorage.setItem(keyOf('prompt_schluesselbegriffe'), sb.value || '');
            const ak = document.getElementById('akronym'); if (ak) localStorage.setItem(keyOf('prompt_akronym'), ak.value || '');
          } catch {}
        }
        genButtons.forEach(el => el.addEventListener('click', async () => {
          // feature disabled guard
                   if (!FEATURE_GENERATION_ENABLED && !IS_ADMIN) {
          return Swal.fire('Deaktiviert', FEATURE_GENERATION_DISABLED_MSG, 'info');
        }

            const body = {
              Titel: document.getElementById('promptTitle').value.trim(),
              Thema: document.getElementById('thema').value.trim(),
              Ziele: document.getElementById('ziele').value.trim(),
              Beschreibung: document.getElementById('beschreibung').value.trim(),
              'Schlüsselbegriffe': document.getElementById('schluesselbegriffe')
                .value.split(',').map(s=>s.trim()).filter(Boolean)
            };
            if (!body.Titel || !body.Thema)
              return Swal.fire('Fehler','Titel und Thema dürfen nicht leer sein.','error');

            try {
              let targetType = CURRENT_TYPE;
              let genOpts    = null; // { mode, title }
              if (!IS_ADMIN) {
                if (CURRENT_TYPE !== 'eigenfilter') {
                  const promptUrl = '@Url.Action("PromptAssistent","Home", new { area = "User" })';
                  const go = await Swal.fire({
                    title: 'Nur im Eigenfilter verfügbar',
                    text: 'Möchtest du zum Eigenfilter wechseln, um Filter zu generieren?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Zu Eigenfilter',
                    cancelButtonText: 'Hier bleiben'
                  }).then(r=>r.isConfirmed);
                  if (!go) return;
                  // Persist current form so nothing is lost on navigation
                  storeFormSnapshot();
                  window.location.href = `${promptUrl}?type=Eigenfilter`;
                  return;
                }

                targetType = 'Eigenfilter';
                // Ask for title options (AI/manual) for non-admin flow
                const res = await askGenerationOptions();
                if (!res?.isConfirmed) return;
                genOpts = res.value; // {mode,title}
                try { localStorage.setItem(keyOf('gen_opts'), JSON.stringify(genOpts)); } catch {}
                document.dispatchEvent(new CustomEvent('pa:filter-generate:options', { detail: genOpts }));
              } else {
                // Combined popup: target type + title mode
                const defaultType = (CURRENT_TYPE === 'eigenfilter')
                  ? 'Eigenfilter'
                  : ((CURRENT_TYPE && CURRENT_TYPE.length)
                      ? (CURRENT_TYPE.charAt(0).toUpperCase() + CURRENT_TYPE.slice(1))
                      : 'Text');

                const { value: cfg, isConfirmed } = await Swal.fire({
                  title: 'Filter generieren',
                  html: `
                    <div class="text-start">
                      <label class="form-label">Für welchen Prompt‑Typ generieren?</label>
                      <select id="genTargetType" class="form-select mb-2">
                        <option>Eigenfilter</option>
                        <option>Text</option>
                        <option>Bild</option>
                        <option>Video</option>
                        <option>Sound</option>
                        <option>Bildung</option>
                        <option>Beruf</option>
                      </select>
                      <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="genTitleMode2" id="genTitle2_ai" value="ai" checked>
                        <label class="form-check-label" for="genTitle2_ai">Titel von KI vorschlagen</label>
                      </div>
                      <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="genTitleMode2" id="genTitle2_manual" value="manual">
                        <label class="form-check-label" for="genTitle2_manual">Titel manuell festlegen</label>
                      </div>
                      <input id="genTitle2_input" class="form-control mt-2" placeholder="Kategorie-Titel" disabled>
                    </div>
                  `,
                  focusConfirm: false,
                  showCancelButton: true,
                  confirmButtonText: 'Generieren',
                  cancelButtonText : 'Abbrechen',
                  didOpen: () => {
                    const sel = document.getElementById('genTargetType');
                    if (sel) sel.value = defaultType;
                    const ai  = document.getElementById('genTitle2_ai');
                    const man = document.getElementById('genTitle2_manual');
                    const inp = document.getElementById('genTitle2_input');
                    const apply = () => {
                      const useAi = ai?.checked;
                      inp.disabled = !!useAi;
                      inp.placeholder = useAi ? 'Kategorie-Titel wird von der KI gesetzt' : 'Kategorie-Titel';
                      if (!useAi) setTimeout(()=> inp.focus(), 0);
                    };
                    ai?.addEventListener('change', apply);
                    man?.addEventListener('change', apply);
                    apply();
                  },
                  preConfirm: () => {
                    const targetType = (document.getElementById('genTargetType')?.value || 'Text');
                    const mode  = (document.querySelector('input[name="genTitleMode2"]:checked')?.value || 'ai');
                    const title = (document.getElementById('genTitle2_input')?.value || '').trim();
                    if (mode === 'manual' && !title) {
                      Swal.showValidationMessage('Bitte einen Titel eingeben.');
                      return false;
                    }
                    return { targetType, mode, title };
                  }
                });
                if (!isConfirmed) return;
                targetType = cfg.targetType;
                genOpts    = { mode: cfg.mode, title: cfg.title };
                try { localStorage.setItem(keyOf('gen_opts'), JSON.stringify(genOpts)); } catch {}
                document.dispatchEvent(new CustomEvent('pa:filter-generate:options', { detail: genOpts }));
              }

              // Ask for model selection for Filter generieren (optional)
              // If user doesn't pick a model, proceed with empty string to allow backend resolver to choose defaults.
              const modelId = await pickModelDropdown();
              // Guard: some vision/multimodal models are not supported for this text-only flow
              const isVisionLike = /(^|[-_.])vl(|[-_.])|internvl/i.test(modelId);
              if (isVisionLike) {
                await Swal.fire('Nicht unterstützt', 'Dieses Modell ist multimodal/vision und für die textbasierte Filter-Generierung nicht geeignet. Bitte wähle ein textbasiertes Chat‑Modell.', 'info');
                return;
              }

              const groupName = await getSelectedGroupName();
              if (groupName === undefined) return;

              startLoadingUI();

              const req = {
                form: body,
                targetType,
                CategoryTitleMode: (genOpts?.mode || 'ai'),
                CategoryTitle    : (genOpts?.title || ''),
                ModelId: modelId,
                GroupName: groupName
              };

              const res = await fetch('@Url.Content("~/api/PromptFilterAi")', {
                method : 'POST',
                headers: { 'Content-Type':'application/json' },
                body   : JSON.stringify(req)
              });
              if (!res.ok) throw new Error(await res.text());
              const payload = await res.json();

              const cats = payload?.data ?? [];
              const itemsOf = (c) => (c.filterItems ?? c.FilterItems ?? c.items ?? c.Items ?? []);
              const itemCount = cats.reduce((n,c)=> n + itemsOf(c).length, 0);

              stopLoadingUI();

              // When user is already on the target type, no need to navigate across types
              const sameType = (String(targetType).toLowerCase() === CURRENT_TYPE);

              if (sameType) {
                // Persist newly generated filter values to auto-select after reload (user-scoped)
                const selectKey = keyOf(`select_after_reload_${CURRENT_TYPE}`);
                try {
                  const items = (cats || [])
                    .flatMap(c => itemsOf(c))
                    .map(it => ({
                      t: (it?.title ?? it?.Title ?? it?.value ?? it?.Value ?? '').toString().trim(),
                      i: (it?.instruction ?? it?.Instruction ?? it?.ins ?? it?.Ins ?? '').toString()
                    }))
                    .filter(x => x.t || x.i);
                  localStorage.setItem(selectKey, JSON.stringify(items));
                } catch {}

                // Persist generated category name to focus its tab after reload
                try {
                  const catKey = keyOf(`focus_category_${CURRENT_TYPE}`);
                  const cName = ((cats?.[0]?.name) ?? (cats?.[0]?.Name) ?? '').toString().trim();
                  if (cName) localStorage.setItem(catKey, cName);
                } catch {}

                await Swal.fire({
                  icon:'success',
                  title:'Filter gespeichert',
                  html:`Es wurden <b>${cats.length}</b> Kategorien mit <b>${itemCount}</b> Filtern in deinen <i>${targetType}</i> übernommen.`,
                  confirmButtonText: `${targetType} Filter anzeigen`,
                  showCancelButton: false
                });

                // Ensure current inputs are saved, then soft-reload same page
                try { saveAutosave(); } catch {}
                try { storeFormSnapshot(); } catch {}
                try {
                  // Open helper and focus generated tab + first item after reload
                  localStorage.setItem('pa_open_helper','1');
                  const genCat = (cats && cats[0]) || null;
                  const catName = (genCat?.name ?? genCat?.Name ?? '').toString().trim();
                  if (catName) localStorage.setItem('pa_scroll_tab_name', catName);
                  const firstItem = genCat ? (itemsOf(genCat)[0] || null) : null;
                  const itemTitle = (firstItem?.title ?? firstItem?.Title ?? firstItem?.value ?? firstItem?.Value ?? '').toString().trim();
                  if (itemTitle) localStorage.setItem('pa_scroll_item_title', itemTitle);
                } catch {}
                location.reload();
              } else {
                const go2 = await Swal.fire({
                  icon:'success',
                  title:'Filter gespeichert',
                  html:`Es wurden <b>${cats.length}</b> Kategorien mit <b>${itemCount}</b> Filtern in deinen <i>${targetType}</i> übernommen.`,
                  showCancelButton:true,
                  confirmButtonText:`Zu ${targetType}`,
                  cancelButtonText:'Hier bleiben'
                }).then(r=>r.isConfirmed);

                if (go2) {
                  const promptUrl = '@Url.Action("PromptAssistent","Home", new { area = "User" })';
                  try {
                    // Persist current form so nothing is lost on navigation
                    storeFormSnapshot();
                    localStorage.setItem('pa_open_helper','1');
                    const genCat = (cats && cats[0]) || null;
                    const catName = (genCat?.name ?? genCat?.Name ?? '').toString().trim();
                    if (catName) localStorage.setItem('pa_scroll_tab_name', catName);
                    const firstItem = genCat ? (itemsOf(genCat)[0] || null) : null;
                    const itemTitle = (firstItem?.title ?? firstItem?.Title ?? firstItem?.value ?? firstItem?.Value ?? '').toString().trim();
                    if (itemTitle) localStorage.setItem('pa_scroll_item_title', itemTitle);
                  } catch {}
                  window.location.href = `${promptUrl}?type=${encodeURIComponent(targetType)}`;
                }
              }
            } catch (err) {
              stopLoadingUI();
              Swal.fire('Fehler', String(err), 'error');
            }
        }));

        //save to my Prompts

        restoreAutosaveIfAny();

        // (removed) legacy kwAccordion initializer using 'show' class

        // Floating Prompt Helper panel (pin/unpin + draggable) and chip sync
        (function(){
          const wrap = document.getElementById('promptHelperWrap');
          const header = wrap?.querySelector('.helper-header');
          const btn  = document.getElementById('toggle-helper-float');
          const chip = document.getElementById('helper-chip');
          if (!wrap || !btn || typeof keyOf !== 'function') return;
          const key = keyOf('helper_float');
          const posKey = keyOf('helper_float_pos');

          function applySavedPos(){
            try {
              const raw = sessionStorage.getItem(posKey);
              if (!raw) return;
              const p = JSON.parse(raw);
              if (p && typeof p.left === 'number' && typeof p.top === 'number') {
                wrap.style.left = p.left + 'px';
                wrap.style.top  = p.top  + 'px';
                wrap.style.right = '';
                wrap.style.bottom = '';
              }
            } catch {}
          }

          function enterFloating(){
            wrap.classList.add('show','is-floating');
            btn.setAttribute('aria-pressed','true');
            applySavedPos();
            if (chip) chip.setAttribute('aria-expanded','true');
          }

          try { if (sessionStorage.getItem(key) === '1') enterFloating(); } catch {}

          btn.addEventListener('click', () => {
            const on = wrap.classList.toggle('is-floating');
            if (on) {
              wrap.classList.add('show');
              try { sessionStorage.setItem(key, '1'); } catch {}
              applySavedPos();
              if (chip) chip.setAttribute('aria-expanded','true');
            } else {
              try { sessionStorage.setItem(key, '0'); } catch {}
              // reset inline pos when docking back
              wrap.style.left = '';
              wrap.style.top = '';
              wrap.style.right = '';
              wrap.style.bottom = '';
              if (chip) {
                const isOpen = wrap.classList.contains('show');
                chip.setAttribute('aria-expanded', isOpen ? 'true':'false');
              }
            }
            btn.setAttribute('aria-pressed', on ? 'true':'false');
          });

          // Sync chip with Bootstrap collapse events
          try {
            wrap.addEventListener('shown.bs.collapse', () => { if (chip) chip.setAttribute('aria-expanded','true'); });
            wrap.addEventListener('hidden.bs.collapse', () => {
              if (chip) chip.setAttribute('aria-expanded','false');
              // If hidden while floating, unfloat to avoid overlay confusion
              if (wrap.classList.contains('is-floating')) {
                wrap.classList.remove('is-floating');
                btn.setAttribute('aria-pressed','false');
                try { sessionStorage.setItem(key, '0'); } catch {}
              }
            });
          } catch {}

          if (header) {
            let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;

            const start = (ev) => {
              if (!wrap.classList.contains('is-floating')) return;
              // ignore interactive controls
              if (ev.target.closest('button, a, .btn, .dropdown, .form-control')) return;
              dragging = true;
              const pt = ('touches' in ev) ? ev.touches[0] : ev;
              startX = pt.clientX; startY = pt.clientY;
              const rect = wrap.getBoundingClientRect();
              wrap.style.right = ''; wrap.style.bottom = '';
              startLeft = parseFloat(wrap.style.left) || rect.left;
              startTop  = parseFloat(wrap.style.top)  || rect.top;
              document.addEventListener('mousemove', move);
              document.addEventListener('mouseup', end);
              document.addEventListener('touchmove', move, { passive:false });
              document.addEventListener('touchend', end);
              ev.preventDefault();
            };

            const move = (ev) => {
              if (!dragging) return;
              const pt = ('touches' in ev) ? ev.touches[0] : ev;
              const dx = pt.clientX - startX;
              const dy = pt.clientY - startY;
              const vw = window.innerWidth; const vh = window.innerHeight;
              const r = wrap.getBoundingClientRect();
              let left = startLeft + dx;
              let top  = startTop  + dy;
              left = Math.min(Math.max(8, left), vw - r.width - 8);
              top  = Math.min(Math.max(8, top),  vh - r.height - 8);
              wrap.style.left = left + 'px';
              wrap.style.top  = top  + 'px';
              if ('touches' in ev) ev.preventDefault();
            };

            const end = () => {
              if (!dragging) return;
              dragging = false;
              document.removeEventListener('mousemove', move);
              document.removeEventListener('mouseup', end);
              document.removeEventListener('touchmove', move);
              document.removeEventListener('touchend', end);
              try {
                const left = parseFloat(wrap.style.left) || 0;
                const top  = parseFloat(wrap.style.top)  || 0;
                sessionStorage.setItem(posKey, JSON.stringify({ left, top }));
              } catch {}
            };

            header.addEventListener('mousedown', start);
            header.addEventListener('touchstart', start, { passive:false });
          }
        })();
</script>

}
