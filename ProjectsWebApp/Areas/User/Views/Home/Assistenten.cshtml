@model IEnumerable<ProjectsWebApp.Models.Assistant>
@using System.Security.Claims
@{
    ViewData["Title"] = "KI-Assistenten";
}

<style>
    :root {
        --accent: #3acc59;
        --accent2: #00b36c;
        --accentRing: #80d9b0;
    }

    .asst-hero {
        border: 1px solid #eef1f4;
        border-radius: 16px;
        background: linear-gradient(135deg,#f8fffb,#f2fbf6);
        padding: 1.25rem 1.25rem;
        box-shadow: 0 12px 28px rgba(16,24,40,.06);
        margin-bottom: 1rem;
    }

    .asst-hero h1 {
        font-size: 1.6rem;
        letter-spacing: .2px;
        margin: 0;
    }

    .asst-hero p {
        margin: 0;
        color: #6b7280;
    }

    .btn-accent {
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        color: #fff;
        border: 0;
        border-radius: .75rem;
        padding: .55rem 1rem;
        font-weight: 700;
        letter-spacing: .2px;
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        box-shadow: 0 10px 24px rgba(58,204,89,.35), inset 0 0 0 1px rgba(255,255,255,.15);
    }

    .btn-accent:hover {
        filter: brightness(1.04);
        color: #fff;
        box-shadow: 0 14px 28px rgba(58,204,89,.45);
    }

    .asst-grid .asst-card {
        border: 1px solid #eef1f4;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 12px 28px rgba(16,24,40,.06);
        transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .asst-grid .asst-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(16,24,40,.12);
        border-color: #dff4e7;
    }

    .asst-card .card-body {
        padding: 0.85rem 1rem 0.65rem;
    }

    .asst-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 0 0 3px #fff, 0 0 0 5px rgba(58,204,89,.15);
    }

    .asst-share-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: linear-gradient(135deg,#ecfdf3,#d1fae5);
        color: #16a34a;
        box-shadow: 0 0 0 2px rgba(128,217,176,.5);
        font-size: .9rem;
    }

    .asst-name {
        font-size: 1.05rem;
        font-weight: 700;
        margin: 0;
    }

    .asst-desc {
        color: black;
        font-size: .95rem;
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .asst-desc * {
        margin: 0 !important;
    }

    .asst-meta {
        color: #6b7280;
        font-size: .95rem;
    }

    .asst-meta .meta-line {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .asst-meta .meta-key {
        font-weight: 600;
        color: #111827;
        margin-right: .25rem;
    }

    .card-body-fixed {
        display: flex;
        flex-direction: column;
    }

    .desc-clamp {
        --lines: 3;
        line-height: 1.35rem;
        min-height: calc(var(--lines) * 1.35rem);
        max-height: calc(var(--lines) * 1.35rem);
        display: -webkit-box;
        -webkit-line-clamp: var(--lines);
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .asst-item {
        display: flex;
    }

    .asst-item .asst-card {
        flex: 1 1 auto;
    }

    .asst-actions .btn {
        border-radius: .65rem;
    }

    .btn-outline-soft {
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
    }

    .btn-outline-soft:hover {
        background: #f8fafc;
        border-color: #dbe1ea;
        color: #111827;
    }

    .btn-danger-soft {
        background: #fff5f5;
        color: #991d30;
        border: 1px solid #f3c5c5;
    }

    .btn-danger-soft:hover {
        background: #ffe9e9;
        color: #7f1527;
        border-color: #ecaaaa;
    }

    .asst-footer {
        margin-top: auto;
        padding: .55rem .75rem .65rem;
        border-top: 1px solid #f1f5f9;
        min-height: 2.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .5rem;
    }

    .asst-footer-left {
        display: flex;
        align-items: center;
        gap: .5rem;
        min-width: 0;
    }

    .asst-share-groups-btn {
        border-radius: .65rem;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        color: #111827;
        font-weight: 500;
        padding: .35rem .8rem;
    }

        .asst-share-groups-btn i {
            margin-right: .25rem;
        }

        .asst-share-groups-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #111827;
        }

    .asst-toolbar {
        border: 1px solid #eef1f4;
        border-radius: 14px;
        background: #fff;
        padding: .6rem;
        margin: .5rem 0 1rem;
        box-shadow: 0 10px 24px rgba(16,24,40,.06);
    }

    .asst-toolbar .form-control,
    .asst-toolbar .form-select {
        border-color: #e5e7eb;
    }

    .asst-toolbar .form-control:focus,
    .asst-toolbar .form-select:focus {
        box-shadow: 0 0 0 .25rem rgba(58,204,89,.15);
        border-color: #80d9b0;
    }

    .asst-count {
        color: #6b7280;
        font-weight: 600;
        margin-right: 13px;
    }

    /* Smart search UI */
    .smart-search {
        position: relative;
        display: block;
    }

    .smart-input {
        height: 44px;
        padding-left: 2.25rem;
        padding-right: 7.25rem;
        border: 2px solid var(--accent);
        border-radius: 12px;
    }

    .smart-input:focus {
        outline: 0;
        border-color: var(--accent);
        box-shadow: 0 0 0 .2rem rgba(58,204,89,.15);
    }

    .smart-icon {
        position: absolute;
        left: .65rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        color: #6b7280;
        pointer-events: none;
    }

    .btn-clear {
        position: absolute;
        right: 6rem;
        top: 50%;
        transform: translateY(-50%);
        padding: 0 .25rem;
        line-height: 1;
        border: 0;
        background: transparent;
        color: #2563eb;
        text-decoration: none;
        opacity: 0;
        pointer-events: none;
    }

    .btn-clear:hover {
        text-decoration: underline;
    }

    .btn-smart-submit {
        position: absolute;
        right: .4rem;
        top: 50%;
        transform: translateY(-50%);
        border: 1px solid var(--accent);
        background: #fff;
        color: #0f172a;
        padding: .3rem .7rem;
        border-radius: .5rem;
        font-weight: 600;
        box-shadow: 0 1px 0 rgba(16,24,40,.04);
        opacity: 0;
        pointer-events: none;
    }

    .btn-smart-submit:hover {
        background: #f8fffb;
        border-color: var(--accent2);
    }

    .smart-search.has-value .btn-clear,
    .smart-search.has-value .btn-smart-submit {
        opacity: 1;
        pointer-events: auto;
    }

    /* --- SORT / GROUP / MINE CONTAINER ------------------------------------ */

    /* Desktop default: all three in one row, auto width */
    .sort-filter-shell {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: flex-start;
        gap: .6rem;
        border-radius: 16px;
        padding: .6rem .85rem;
        background: white;
        /* border: 1px solid #d7f0e4; */
        /* box-shadow: 0 12px 28px rgba(16,24,40,.07); */
        width:92%;
    }

    .sort-filter-shell > * {
        flex: 0 0 auto;
        min-width: 0;
    }

    .sort-filter-shell form {
        margin: 0;
    }

    /* override inline style from Razor (min-width / max-width) */
    .sort-filter-shell .select-wrapper {
        position: relative;
        min-width: 0 !important;
        max-width: none !important;
    }

    .sort-filter-shell .select-wrapper i {
        position: absolute;
        left: 0.9rem;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        pointer-events: none;
        font-size: 1.1rem;
    }

    .sort-filter-shell .sort-select {
        border-radius: 999px;
        padding-left: 2.4rem;
        padding-right: 1.25rem;
        height: 44px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
        font-weight: 600;
        color: #0f172a;
        width: auto;          /* pill-sized on desktop */
        max-width: 100%;
        background: #fff;
    }

    .sort-filter-shell .sort-select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 0.2rem rgba(58, 204, 89, 0.15);
    }

    .toggle-pill {
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        padding: 0.45rem 1rem;
        font-weight: 600;
        color: #0f172a;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        box-shadow: 0 1px 0 rgba(15,23,42,0.04);
        transition: all 0.18s ease;
        white-space: nowrap;
        flex: 0 0 auto;
    }

    .toggle-pill:hover {
        border-color: #cbd5f5;
        color: #111827;
    }

    .toggle-pill.active {
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 24px rgba(58, 204, 89, 0.32),
                    inset 0 0 0 1px rgba(255,255,255,0.18);
    }

    .toggle-pill.active:hover {
        filter: brightness(1.05);
    }

    .pill-finalized {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        border-radius: 999px;
        padding: .2rem .55rem;
        font-weight: 700;
        font-size: .78rem;
        color: #065f46;
        background: linear-gradient(135deg,#e7fbe9,#d3f7db);
        border: 1px solid #b7ecc3;
        box-shadow: 0 1px 0 rgba(15,23,42,.04);
        white-space: nowrap;
    }
    .pill-finalized i { color: #10b981; }

    /* Alphabet pills */
    .alpha-nav {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: .4rem;
        margin-top: .25rem;
    }

    .alpha-nav .pill {
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        border-radius: 999px;
        padding: .25rem .5rem;
        line-height: 1;
        font-weight: 600;
        font-size: .9rem;
        min-height: auto;
    }

    .alpha-nav .pill.active {
        border-color: var(--accent);
        color: #0f172a;
        box-shadow: 0 0 0 .16rem rgba(58,204,89,.12);
    }

    /* Single-letter alphabet buttons - perfect circles */
    .alpha-nav .pill[data-alpha]:not([data-alpha="all"]):not([data-alpha="0-9"]) {
        width: 32px;
        height: 32px;
        min-height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 1 / 1;
    }

    /* --- RESPONSIVE DESIGN FOR IPADS AND TABLETS --- */

    /* For iPad Pro (1024px) and similar large tablets in landscape */
    @@media (max-width: 1199.98px) and (min-width: 992px) {
        .asst-grid .asst-card .card-body {
            padding: 0.75rem 0.85rem 0.55rem;
        }
        
        .asst-name {
            font-size: 1rem;
        }
        
        .asst-desc {
            font-size: .9rem;
        }
        
        .asst-footer {
            padding: .5rem .65rem .55rem;
        }

        .sort-filter-shell {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .6rem;
            padding: .7rem 1rem;
            width:125%;
        }

        .sort-filter-shell > * {
            min-width: 0;
        }

        .sort-filter-shell .select-wrapper,
        .sort-filter-shell form {
            width: 100%;
        }

        .sort-filter-shell .sort-select {
            width: 100%;
        }

         .toggle-pill {
            justify-self: start;
            padding: .38rem .65rem;
            font-size: .88rem;
            min-width: 0;
        }

        .toggle-pill i {
            font-size: 1rem;
        }
    }

    /* For standard iPad (768px) and similar tablets in portrait */
    @@media (max-width: 991.98px) and (min-width: 768px) {
        .asst-hero {
            padding: 1rem 1rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .asst-hero h1 {
            font-size: 1.5rem;
        }
        
        .asst-toolbar .row {
            flex-direction: column;
            gap: 1rem;
        }
        
        .asst-toolbar .col-md-6,
        .asst-toolbar .col-md-4,
        .asst-toolbar .col-md-2 {
            width: 100%;
        }
        
        .sort-filter-shell {
            display: grid;
            grid-template-columns: 1fr;
            gap: .5rem;
            padding: .55rem .75rem;
        }

        .sort-filter-shell > * {
            min-width: 0;
        }

        .sort-filter-shell .sort-select {
            width: 100%;
        }

        .toggle-pill {
            width: 100%;
            justify-content: center;
            padding: .4rem .65rem;
            font-size: .9rem;
        }

        .asst-grid {
            gap: .75rem;
        }
        
        .asst-card .card-body {
            padding: 0.75rem 0.85rem 0.55rem;
        }
        
        .asst-name {
            font-size: 1rem;
        }
        
        .asst-desc {
            font-size: .9rem;
        }
        
        .asst-avatar {
            width: 44px;
            height: 44px;
        }
        
        .alpha-nav {
            gap: .3rem;
        }

        .alpha-nav .pill {
            font-size: .85rem;
            padding: .2rem .4rem;
        }

        .alpha-nav .pill[data-alpha]:not([data-alpha="all"]):not([data-alpha="0-9"]) {
            width: 30px;
            height: 30px;
            min-height: 30px;
        }
    }

    /* For smaller tablets and large phones */
    @@media (max-width: 767.98px) {
        .sort-filter-shell {
            flex-direction: column;
            align-items: stretch;
        }

        .sort-filter-shell > * {
            flex: 0 0 auto;
            width: 100%;
        }

        .sort-filter-shell .sort-select,
        .toggle-pill {
            width: 100%;
        }
        
        .alpha-nav {
            gap: .25rem;
        }

        .alpha-nav .pill {
            font-size: .8rem;
            padding: .15rem .35rem;
        }

        .alpha-nav .pill[data-alpha]:not([data-alpha="all"]):not([data-alpha="0-9"]) {
            width: 28px;
            height: 28px;
            min-height: 28px;
        }

        .smart-input {
            padding-right: 6rem;
        }
        
        .btn-clear {
            right: 5rem;
        }
    }

    /* For very small screens */
    @@media (max-width: 575.98px) {
        .asst-hero {
            padding: .85rem;
        }
        
        .asst-hero h1 {
            font-size: 1.4rem;
        }
        
        .btn-accent {
            padding: .5rem .85rem;
            font-size: .9rem;
        }
        
        .asst-toolbar {
            padding: .5rem;
        }
        
        .smart-input {
            height: 42px;
            padding-left: 2rem;
            padding-right: 5.5rem;
        }
        
        .btn-smart-submit {
            padding: .25rem .6rem;
            font-size: .9rem;
        }
        
        .btn-clear {
            right: 4.5rem;
        }

        .alpha-nav {
            gap: .2rem;
        }

        .alpha-nav .pill {
            font-size: .75rem;
            padding: .1rem .3rem;
        }

        .alpha-nav .pill[data-alpha]:not([data-alpha="all"]):not([data-alpha="0-9"]) {
            width: 24px;
            height: 24px;
            min-height: 24px;
        }
    }

    /* Scrollable groups list inside the modal */
    #assistantGroupsList {
        max-height: 320px;
        overflow-y: auto;
        padding-right: .25rem; /* keep content away from scrollbar */
    }

    /* Premium Room Selection Dropdown */
    .room-select-container { position: relative; width: 100%; }
    .room-select-box {
        min-height: 50px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 10px;
        background: #fff; cursor: pointer; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .room-select-box:hover { border-color: #d1d5db; }
    .room-select-box.focused { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58,204,89,0.15); }

    .room-tag {
        display: inline-flex; align-items: center; gap: 4px; background: var(--accent); color: #fff;
        padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; max-width: 200px;
    }
    .room-tag span:first-child { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .room-tag-remove {
        cursor: pointer; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; background: rgba(255,255,255,0.3); font-size: 14px; line-height: 1; flex-shrink: 0;
    }
    .room-tag-remove:hover { background: rgba(255,255,255,0.5); }

    .room-select-placeholder { color: #9ca3af; font-size: 0.95rem; }
    .room-select-arrow { margin-left: auto; color: #6b7280; transition: transform 0.2s; flex-shrink: 0; }
    .room-select-arrow.open { transform: rotate(180deg); }

    .room-dropdown {
        position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff;
        border: 2px solid var(--accent); border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1050; display: none;
    }
    .room-dropdown.open { display: block; }

    /* Portal dropdown - renders outside modal */
    .room-dropdown-portal {
        position: fixed; background: #fff; border: 2px solid #3acc59; border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 999999; display: none;
    }
    .room-dropdown-portal.open { display: block; }
    .room-list-item.hidden { display: none !important; }

    .room-search-input {
        width: 100%; padding: 12px 14px; border: none; border-bottom: 1px solid #e5e7eb;
        font-size: 0.95rem; outline: none; box-sizing: border-box; border-radius: 8px 8px 0 0;
    }
    .room-search-input::placeholder { color: #9ca3af; }

    .room-list { max-height: 200px; overflow-y: auto; }
    .room-list-item {
        padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        transition: background 0.15s; font-size: 0.95rem; color: #374151;
    }
    .room-list-item:hover { background: #f3f4f6; }
    .room-list-item.selected { background: #f0fdf4; color: #166534; font-weight: 600; }
    .room-list-item.selected::before { content: '\2713'; color: var(--accent); font-weight: 700; }

    .room-list-empty { padding: 16px 14px; text-align: center; color: #9ca3af; font-size: 0.9rem; }

    /* Premium Filter Dropdown (single-select) */
    .filter-select-container { position: relative; width: 100%; min-width: 300px; max-width: 380px; }
    .filter-select-box {
        height: 46px; padding: 0 18px; border: 1px solid #e5e7eb; border-radius: 999px;
        background: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px;
        transition: border-color 0.2s, box-shadow 0.2s; font-weight: 600; color: #0f172a;
        box-shadow: 0 1px 0 rgba(15,23,42,0.04); font-size: 0.95rem;
    }
    .filter-select-box:hover { border-color: #d1d5db; }
    .filter-select-box.focused { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(58,204,89,0.15); }
    .filter-select-box .filter-icon { color: #64748b; font-size: 1.2rem; flex-shrink: 0; }
    .filter-select-box .filter-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .filter-select-box .filter-arrow { color: #6b7280; transition: transform 0.2s; flex-shrink: 0; }
    .filter-select-box .filter-arrow.open { transform: rotate(180deg); }

    .filter-dropdown-portal {
        position: fixed; background: #fff; border: 2px solid var(--accent); border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 999999; display: none; min-width: 300px;
    }
    .filter-dropdown-portal.open { display: block; }

    .filter-search-input {
        width: 100%; padding: 12px 14px; border: none; border-bottom: 1px solid #e5e7eb;
        font-size: 0.95rem; outline: none; box-sizing: border-box; border-radius: 10px 10px 0 0;
    }
    .filter-search-input::placeholder { color: #9ca3af; }

    .filter-list { max-height: 280px; overflow-y: auto; }
    .filter-list-item {
        padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        transition: background 0.15s; font-size: 0.95rem; color: #374151;
    }
    .filter-list-item:hover { background: #f3f4f6; }
    .filter-list-item.selected { background: linear-gradient(135deg,#ecfdf3,#d1fae5); color: #166534; font-weight: 600; }
    .filter-list-item.selected::before { content: '\2713'; color: var(--accent); font-weight: 700; }
    .filter-list-item.hidden { display: none !important; }
    .filter-list-empty { padding: 16px 14px; text-align: center; color: #9ca3af; font-size: 0.9rem; }

    /* Responsive adjustments for filter dropdown */
    @@media (max-width: 991.98px) {
        .filter-select-container { min-width: 0; width: 100%; }
        .filter-select-box { width: 100%; }
    }

    /* Page content spacing */
    .asst-page-content {
        margin-bottom: 4rem;
    }
</style>

<div class="asst-page-content">

<div class="asst-hero d-flex align-items-center justify-content-between">
    <div>
        <h1>KI-Assistenten</h1>
        <p>Deine gespeicherten Assistenten. Starte die Unterhaltung.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <a asp-area="User" asp-controller="Home" asp-action="PromptAssistent" class="btn btn-accent">
            <i class="bi bi-plus-circle"></i><span>Assistent</span>
        </a>
    </div>
</div>

<div class="modal fade" id="assistantGroupsModal" tabindex="-1" aria-labelledby="assistantGroupsModalLabel" aria-hidden="true" data-bs-focus="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assistantGroupsModalLabel">In welchen Räume veröffentlichen?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="assistantGroupsForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="agAssistantId" />
                    <div class="mb-3">
                        <strong id="agAssistantName"></strong>
                    </div>

                    <!-- Hidden inputs for form submission -->
                    <div id="agHiddenInputs"></div>

                    <!-- Premium Dropdown (portal will be created in body) -->
                    <div class="room-select-container" id="agRoomSelectContainer">
                        <div class="room-select-box" id="agRoomSelectBox">
                            <span class="room-select-placeholder">Räume auswählen...</span>
                            <span class="room-select-arrow"><i class="bi bi-chevron-down"></i></span>
                        </div>
                    </div>
                    <!-- Store all groups data for JS -->
                    <script type="application/json" id="agAllGroupsData">@Html.Raw(Json.Serialize(ViewBag.AllGroups ?? new List<string>()))</script>
                    <div class="form-text text-muted mt-2">
                        <i class="bi bi-info-circle me-1"></i>Wählen Sie die Räume aus, in denen der Assistent veröffentlicht werden soll.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" form="assistantGroupsForm" class="btn btn-dark">Speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="asst-toolbar">
    <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6 col-lg-6">
            <!-- Smart search field -->
            <div class="smart-search">
                <i class="bi bi-search smart-icon" aria-hidden="true"></i>
                <input id="asstSearch" type="text" class="form-control smart-input" placeholder="Assistenten suchen… (Name, Beschreibung)" autocomplete="off" />
                <button type="button" class="btn btn-link btn-clear" title="Eingabe löschen" aria-label="Eingabe löschen">
                    <i class="bi bi-x"></i>
                </button>
                <button type="button" id="btnUserSearch" class="btn btn-smart-submit">Suchen</button>
            </div>
        </div>
        <div class="col-12 col-md-4 col-lg-4">
            <div class="sort-filter-shell">
                @{
                    var filterGroups = ViewBag.AllGroups as IEnumerable<string> ?? new List<string>();
                    var selectedGroup = ViewBag.SelectedGroup as string;
                    var isAdmin = User.IsInRole("Admin") || User.IsInRole("SuperAdmin");
                    var displayText = string.IsNullOrEmpty(selectedGroup) ? "Alle Räume" : selectedGroup;
                }
                <!-- Premium Filter Dropdown -->
                <div class="filter-select-container" id="filterSelectContainer">
                    <div class="filter-select-box" id="filterSelectBox" title="Nach Räume filtern">
                        <i class="bi bi-people filter-icon"></i>
                        <span class="filter-text" id="filterSelectedText">@displayText</span>
                        <span class="filter-arrow"><i class="bi bi-chevron-down"></i></span>
                    </div>
                </div>
                <!-- Store filter data for JS -->
                <script type="application/json" id="filterGroupsData">@Html.Raw(Json.Serialize(new {
                    groups = filterGroups,
                    selected = selectedGroup ?? "",
                    isAdmin = isAdmin,
                    actionUrl = Url.Action("Assistenten", "Home", new { area = "User" })
                }))</script>
                <button type="button" id="mineToggle" class="toggle-pill" aria-pressed="false">
                    <i class="bi bi-person"></i>
                    <span>Meine Assistenten</span>
                </button>
            </div>
        </div>
        <div class="col-12 col-md-2 col-lg-2 text-md-end">
            <span class="asst-count d-inline-flex align-items-center justify-content-end w-100">Gesamt: <span id="asstCount">0</span></span>
        </div>
    </div>
</div>

<div id="alphaNav" class="alpha-nav mb-4">
    <button type="button" class="pill active" data-alpha="all">Alle</button>
    <button type="button" class="pill" data-alpha="0-9">0–9</button>
    <button type="button" class="pill" data-alpha="A">A</button>
    <button type="button" class="pill" data-alpha="B">B</button>
    <button type="button" class="pill" data-alpha="C">C</button>
    <button type="button" class="pill" data-alpha="D">D</button>
    <button type="button" class="pill" data-alpha="E">E</button>
    <button type="button" class="pill" data-alpha="F">F</button>
    <button type="button" class="pill" data-alpha="G">G</button>
    <button type="button" class="pill" data-alpha="H">H</button>
    <button type="button" class="pill" data-alpha="I">I</button>
    <button type="button" class="pill" data-alpha="J">J</button>
    <button type="button" class="pill" data-alpha="K">K</button>
    <button type="button" class="pill" data-alpha="L">L</button>
    <button type="button" class="pill" data-alpha="M">M</button>
    <button type="button" class="pill" data-alpha="N">N</button>
    <button type="button" class="pill" data-alpha="O">O</button>
    <button type="button" class="pill" data-alpha="P">P</button>
    <button type="button" class="pill" data-alpha="Q">Q</button>
    <button type="button" class="pill" data-alpha="R">R</button>
    <button type="button" class="pill" data-alpha="S">S</button>
    <button type="button" class="pill" data-alpha="T">T</button>
    <button type="button" class="pill" data-alpha="U">U</button>
    <button type="button" class="pill" data-alpha="V">V</button>
    <button type="button" class="pill" data-alpha="W">W</button>
    <button type="button" class="pill" data-alpha="X">X</button>
    <button type="button" class="pill" data-alpha="Y">Y</button>
    <button type="button" class="pill" data-alpha="Z">Z</button>
</div>

@{
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var sharedIds = ViewBag.SharedAssistantIds as HashSet<int> ?? new HashSet<int>();
    bool canMultiGroupPublish = (ViewBag.CanPublishToMultipleGroups as bool?) ?? false;
    bool isAdminUser = User.IsInRole("Admin") || User.IsInRole("SuperAdmin");
    bool isDozentUser = User.IsInRole("Dozent");
}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3 asst-grid" id="asstGrid" data-current="@currentUserId">
    @foreach (var a in Model)
    {
        <div class="col asst-item" data-id="@a.Id" data-name="@a.Name" data-desc="@a.Description" data-owner="@a.CreatedByUserId">
            <div class="asst-card card h-100">
                <div class="card-body d-flex flex-column card-body-fixed">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                            @{
                                var av = a.AvatarUrl;
                                if (!string.IsNullOrWhiteSpace(av))
                                {
                                    if (av.StartsWith("~/")) { av = Url.Content(av); }
                                    else if (av.StartsWith("/") && !av.StartsWith("//")) { av = Url.Content("~" + av); }
                                }
                            }
                            <img src="@av" alt="@a.Name" class="asst-avatar me-2" />
                            <div>
                                <p class="asst-name">@a.Name</p>
                            </div>
                        </div>
                        @if (sharedIds.Contains(a.Id))
                        {
                            <span class="asst-share-indicator" title="Assistent ist extern freigegeben">
                                <i class="bi bi-share-fill"></i>
                            </span>
                        }
                    </div>
                    <div class="asst-desc desc-clamp" title="@a.Description">@Html.Raw(a.Description)</div>
                </div>
                <div class="asst-footer">
                    <div class="asst-footer-left">
                        <span class="asst-badges"><span class="pill-finalized d-none"><i class="bi bi-check-circle-fill"></i><span>Abgegeben</span></span></span>
                        @if (canMultiGroupPublish && (isAdminUser || (isDozentUser && string.Equals(a.CreatedByUserId, currentUserId, StringComparison.Ordinal))))
                        {
                            <button type="button"
                                    class="btn btn-sm asst-share-groups-btn"
                                    data-id="@a.Id"
                                    data-name="@a.Name">
                                <i class="bi bi-people-fill"></i>
                                <span>Räume</span>
                            </button>
                        }
                    </div>
                    <a asp-area="User" asp-controller="Home" asp-action="AssistantChat" asp-route-id="@a.Id" class="btn btn-accent btn-sm">
                        <i class="bi bi-chat-dots"></i><span>Starten</span>
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<div id="asstEmpty" class="text-center text-muted py-5" style="display:none">
    <div class="mb-2"><i class="bi bi-robot" style="font-size:2rem;color:#9ca3af"></i></div>
    <div>Keine Assistenten gefunden. Suchbegriff anpassen oder neuen Assistent erstellen.</div>
    <div class="mt-3">
        <a asp-area="User" asp-controller="Home" asp-action="PromptAssistent" class="btn btn-accent btn-sm">
            <i class="bi bi-plus-circle"></i> Neuen Assistent erstellen
        </a>
    </div>
</div>

<script>
    (function(){
      const grid  = document.getElementById('asstGrid');
      const items = () => Array.from(grid?.querySelectorAll('.asst-item') || []);
      const inp   = document.getElementById('asstSearch');
      const sort  = document.getElementById('asstSort');
      const mineBtn = document.getElementById('mineToggle');
      const sortIcon = document.getElementById('sortIcon');
      const cnt   = document.getElementById('asstCount');
      const empty = document.getElementById('asstEmpty');
      const alphaNav = document.getElementById('alphaNav');
      let alpha = 'all';
      let mineOnly = false;
      const currentUserId = grid?.getAttribute('data-current') || '';

      // smart search controls
      const smartWrap = document.querySelector('.smart-search');
      const btnClear  = smartWrap?.querySelector('.btn-clear');
      const btnSubmit = document.getElementById('btnUserSearch');

      function syncSortIcon(){
        if (!sortIcon || !sort) return;
        const asc = (sort.value || 'name-asc') === 'name-asc';
        sortIcon.className = asc ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-down-alt';
      }

      function updateCount(){
        const visible = items().filter(it => it.style.display !== 'none').length;
        if (cnt) cnt.textContent = String(visible);
        if (empty) empty.style.display = visible ? 'none' : '';
      }

      function applyFilter(){
        const q = (inp?.value || '').trim().toLowerCase();
        items().forEach(it => {
          const name = (it.dataset.name || '').toLowerCase();
          const desc = (it.dataset.desc || '').toLowerCase();
          const first = (it.dataset.name || '').trim().charAt(0).toUpperCase();
          const passAlpha = (alpha === 'all') ? true : (alpha === '0-9' ? /[0-9]/.test(first) : first === alpha);
          const owner = it.dataset.owner || '';
          const passMine = !mineOnly || (owner && owner === currentUserId);
          const show = passAlpha && passMine && (!q || name.includes(q) || desc.includes(q));
          it.style.display = show ? '' : 'none';
        });
        updateCount();
      }

      function applySort(){
        if (!grid) return;
        const mode = sort?.value || 'name-asc';
        const arr = items();
        arr.sort((a,b)=>{
          const an=(a.dataset.name||'').toLowerCase();
          const bn=(b.dataset.name||'').toLowerCase();
          if (mode==='name-desc') return an<bn?1:an>bn?-1:0;
          return an>bn?1:an<bn?-1:0;
        });
        arr.forEach(el => grid.appendChild(el));
        syncSortIcon();
      }

      function refreshFinalizedBadges(){
        const me = currentUserId;
        items().forEach(it => {
          const id = it.getAttribute('data-id');
          const owner = it.dataset.owner || '';
          const badge = it.querySelector('.pill-finalized');
          if (!badge || !id) return;
          let show = false;
          if (owner && owner === me){
            try { show = localStorage.getItem('assistant:finalized:' + id) === '1'; } catch { show = false; }
          }
          badge.classList.toggle('d-none', !show);
        });
      }

      // show/hide × and Suchen depending on value
      function syncSmartUI(){
        const has = (inp?.value || '').trim().length > 0;
        smartWrap?.classList.toggle('has-value', has);
      }

      // events
      inp?.addEventListener('input', function(){
        syncSmartUI();
        // live filter while typing
        applyFilter();
        // if user cleared the field, show all immediately
        if ((inp.value || '').trim().length === 0) {
          applySort();
          applyFilter();
        }
      });

      sort?.addEventListener('change', function(){
        applySort();
        applyFilter();
      });

      mineBtn?.addEventListener('click', function(){
        mineOnly = !mineOnly;
        this.classList.toggle('active', mineOnly);
        this.setAttribute('aria-pressed', mineOnly ? 'true' : 'false');
        const icon = this.querySelector('i');
        if (icon) {
          icon.className = mineOnly ? 'bi bi-person-check-fill' : 'bi bi-person';
        }
        applySort();
        applyFilter();
        refreshFinalizedBadges();
      });

      // Suchen button just triggers filter (no form submit here)
      btnSubmit?.addEventListener('click', function(e){
        e.preventDefault();
        applySort();
        applyFilter();
      });

      // Clear button: empty, focus, and show all
      btnClear?.addEventListener('click', function(e){
        e.preventDefault();
        inp.value = '';
        inp.focus();
        syncSmartUI();
        applySort();
        applyFilter();
      });

      // ESC clears too
      inp?.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          inp.value = '';
          syncSmartUI();
          applySort();
          applyFilter();
        }
      });

      // initial
      applySort();
      applyFilter();
      syncSmartUI();
      syncSortIcon();
      refreshFinalizedBadges();

      // alphabet filter events
      alphaNav?.addEventListener('click', function(e){
        const btn = e.target.closest('.pill');
        if (!btn) return;
        alpha = btn.getAttribute('data-alpha') || 'all';
        alphaNav.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p === btn));
        applySort();
        applyFilter();
        refreshFinalizedBadges();
      });
    })();
</script>

<!-- Premium Filter Dropdown Script -->
<script>
    (function () {
        const container = document.getElementById('filterSelectContainer');
        const selectBox = document.getElementById('filterSelectBox');
        const selectedText = document.getElementById('filterSelectedText');
        if (!container || !selectBox) return;

        const arrow = selectBox.querySelector('.filter-arrow');
        const portalId = 'filterDropdownPortal';
        let isOpen = false;

        // Load data from JSON
        let filterData = { groups: [], selected: '', isAdmin: false, actionUrl: '' };
        try {
            const jsonEl = document.getElementById('filterGroupsData');
            if (jsonEl) filterData = JSON.parse(jsonEl.textContent) || filterData;
        } catch (e) { }

        function getPortalElements() {
            return {
                portal: document.getElementById(portalId),
                searchInput: document.querySelector('#' + portalId + ' .filter-search-input'),
                list: document.querySelector('#' + portalId + ' .filter-list')
            };
        }

        function positionPortal() {
            const { portal } = getPortalElements();
            if (!portal || !selectBox) return;
            const rect = selectBox.getBoundingClientRect();
            portal.style.top = (rect.bottom + 4) + 'px';
            portal.style.left = rect.left + 'px';
            portal.style.width = Math.max(rect.width, 220) + 'px';
        }

        function filterList(query) {
            const { list } = getPortalElements();
            if (!list) return;
            const term = (query || '').toLowerCase().trim();
            list.querySelectorAll('.filter-list-item').forEach(item => {
                const text = (item.dataset.search || '').toLowerCase();
                item.classList.toggle('hidden', term && !text.includes(term));
            });
        }

        function createPortal() {
            let portal = document.getElementById(portalId);
            if (portal) portal.remove();

            portal = document.createElement('div');
            portal.id = portalId;
            portal.className = 'filter-dropdown-portal';

            // Build list HTML - include "Alle Räume" option for admins
            let listHtml = '';
            if (filterData.isAdmin) {
                const isSelected = !filterData.selected || filterData.selected === '';
                listHtml += `<div class="filter-list-item ${isSelected ? 'selected' : ''}" data-value="" data-search="alle räume">Alle Räume</div>`;
            }

            listHtml += (filterData.groups || [])
                .filter(g => g && g.trim())
                .map(g => {
                    const norm = g.trim();
                    const esc = norm.replace(/"/g, '&quot;');
                    const isSelected = filterData.selected === norm;
                    return `<div class="filter-list-item ${isSelected ? 'selected' : ''}" data-value="${esc}" data-search="${norm.toLowerCase()}">${norm}</div>`;
                }).join('');

            if (!listHtml) {
                listHtml = '<div class="filter-list-empty">Keine Räume verfügbar.</div>';
            }

            portal.innerHTML = `
                <input type="text" class="filter-search-input" placeholder="Räume durchsuchen…" autocomplete="off">
                <div class="filter-list">${listHtml}</div>`;

            document.body.appendChild(portal);

            // Attach event listeners
            const searchInput = portal.querySelector('.filter-search-input');
            const list = portal.querySelector('.filter-list');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterList(e.target.value);
                });
                searchInput.addEventListener('click', (e) => e.stopPropagation());
                searchInput.addEventListener('mousedown', (e) => e.stopPropagation());
                searchInput.addEventListener('keydown', (e) => e.stopPropagation());
            }

            if (list) {
                list.addEventListener('click', (e) => {
                    const item = e.target.closest('.filter-list-item');
                    if (!item) return;
                    e.stopPropagation();
                    const val = item.dataset.value;
                    // Navigate to the filtered page
                    const url = new URL(filterData.actionUrl, window.location.origin);
                    if (val) {
                        url.searchParams.set('group', val);
                    }
                    window.location.href = url.toString();
                });
            }

            portal.addEventListener('click', (e) => e.stopPropagation());

            return portal;
        }

        function openDropdown() {
            if (isOpen) return;
            createPortal();
            const { portal, searchInput } = getPortalElements();
            if (!portal) return;
            isOpen = true;
            positionPortal();
            portal.classList.add('open');
            selectBox.classList.add('focused');
            if (arrow) arrow.classList.add('open');
            if (searchInput) {
                searchInput.value = '';
                requestAnimationFrame(() => searchInput.focus());
            }
            filterList('');
        }

        function closeDropdown() {
            const { portal } = getPortalElements();
            if (!isOpen) return;
            isOpen = false;
            if (portal) portal.classList.remove('open');
            selectBox.classList.remove('focused');
            if (arrow) arrow.classList.remove('open');
        }

        // Event: Click on select box
        selectBox.addEventListener('click', () => {
            isOpen ? closeDropdown() : openDropdown();
        });

        // Event: Click outside to close
        document.addEventListener('click', (e) => {
            if (!isOpen) return;
            const { portal } = getPortalElements();
            if (selectBox.contains(e.target)) return;
            if (portal && portal.contains(e.target)) return;
            closeDropdown();
        });

        // Reposition on scroll/resize
        window.addEventListener('scroll', () => { if (isOpen) positionPortal(); }, true);
        window.addEventListener('resize', () => { if (isOpen) positionPortal(); });
    })();
</script>

<script>
    (function () {
        const modalEl = document.getElementById('assistantGroupsModal');
        if (!modalEl) return;

        let modalInstance = null;
        function getModal() {
            try {
                if (!modalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    // Disable focus trap so portal dropdown can receive keyboard input
                    modalInstance = new bootstrap.Modal(modalEl, { focus: false });
                }
            } catch { }
            return modalInstance;
        }

        const form = document.getElementById('assistantGroupsForm');
        const idInput = document.getElementById('agAssistantId');
        const nameEl = document.getElementById('agAssistantName');
        const container = document.getElementById('agRoomSelectContainer');
        const selectBox = document.getElementById('agRoomSelectBox');
        const hiddenInputsContainer = document.getElementById('agHiddenInputs');
        const arrow = selectBox ? selectBox.querySelector('.room-select-arrow') : null;

        // Load all groups from JSON data
        let allGroupsData = [];
        try {
            const jsonEl = document.getElementById('agAllGroupsData');
            if (jsonEl) allGroupsData = JSON.parse(jsonEl.textContent) || [];
        } catch(e) { allGroupsData = []; }

        // State
        let selected = new Set();
        let allowedGroups = [];
        let isOpen = false;
        const portalId = 'agRoomDropdownPortal';

        const getUrl = '@Url.Action("GetAssistantGroups", "Home", new { area = "User" })';
        const postUrl = '@Url.Action("UpdateAssistantGroups", "Home", new { area = "User" })';

        // Helper functions that work with current portal
        function getPortalElements() {
            return {
                portal: document.getElementById(portalId),
                searchInput: document.getElementById('agRoomSearch'),
                list: document.getElementById('agRoomList')
            };
        }

        function positionPortal() {
            const { portal } = getPortalElements();
            if (!portal || !selectBox) return;
            const rect = selectBox.getBoundingClientRect();
            portal.style.top = (rect.bottom + 4) + 'px';
            portal.style.left = rect.left + 'px';
            portal.style.width = rect.width + 'px';
        }

        function filterList(query) {
            const { list } = getPortalElements();
            if (!list) return;
            const term = (query || '').toLowerCase().trim();
            list.querySelectorAll('.room-list-item').forEach(item => {
                const searchText = item.dataset.search || '';
                const isAllowed = allowedGroups.length === 0 || allowedGroups.includes(item.dataset.value);
                const matchesQuery = !term || searchText.includes(term);
                item.classList.toggle('hidden', !(isAllowed && matchesQuery));
            });
        }

        function updateListSelection() {
            const { list } = getPortalElements();
            if (!list) return;
            list.querySelectorAll('.room-list-item').forEach(item => {
                item.classList.toggle('selected', selected.has(item.dataset.value));
            });
        }

        function renderTags() {
            const placeholder = selectBox.querySelector('.room-select-placeholder');
            selectBox.querySelectorAll('.room-tag').forEach(t => t.remove());

            if (selected.size === 0) {
                if (placeholder) placeholder.style.display = '';
            } else {
                if (placeholder) placeholder.style.display = 'none';
                selected.forEach(val => {
                    const tag = document.createElement('span');
                    tag.className = 'room-tag';
                    tag.innerHTML = `<span>${val}</span><span class="room-tag-remove" data-val="${val}">&times;</span>`;
                    selectBox.insertBefore(tag, arrow);
                });
            }

            // Update hidden inputs
            hiddenInputsContainer.innerHTML = '';
            selected.forEach(val => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'groups';
                input.value = val;
                hiddenInputsContainer.appendChild(input);
            });

            updateListSelection();
        }

        function openDropdown() {
            const { portal, searchInput } = getPortalElements();
            if (isOpen || !portal) return;
            isOpen = true;
            positionPortal();
            portal.classList.add('open');
            selectBox.classList.add('focused');
            if (arrow) arrow.classList.add('open');
            if (searchInput) {
                searchInput.value = '';
                // Use multiple attempts to ensure focus works with Bootstrap modal
                requestAnimationFrame(() => {
                    searchInput.focus();
                    searchInput.click();
                });
            }
            filterList('');
            updateListSelection();
        }

        function closeDropdown() {
            const { portal } = getPortalElements();
            if (!isOpen) return;
            isOpen = false;
            if (portal) portal.classList.remove('open');
            selectBox.classList.remove('focused');
            if (arrow) arrow.classList.remove('open');
        }

        function createPortal() {
            let portal = document.getElementById(portalId);
            if (portal) portal.remove();

            portal = document.createElement('div');
            portal.id = portalId;
            portal.className = 'room-dropdown-portal';

            // Build list HTML
            const listHtml = allGroupsData
                .filter(g => g && g.trim())
                .map(g => {
                    const norm = g.trim();
                    const esc = norm.replace(/"/g, '&quot;');
                    return `<div class="room-list-item" data-value="${esc}" data-search="${norm.toLowerCase()}">${norm}</div>`;
                }).join('') || '<div class="room-list-empty">Keine Räume verfügbar.</div>';

            portal.innerHTML = `
                <input type="text" class="room-search-input" id="agRoomSearch" placeholder="Räume durchsuchen…" tabindex="0" autocomplete="off">
                <div class="room-list" id="agRoomList">${listHtml}</div>`;

            document.body.appendChild(portal);

            // Attach event listeners to portal elements
            const searchInput = document.getElementById('agRoomSearch');
            const list = document.getElementById('agRoomList');

            // Search input - filter on typing
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterList(e.target.value);
                });

                // Prevent all events from bubbling to modal
                searchInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                searchInput.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                searchInput.addEventListener('keydown', (e) => {
                    e.stopPropagation();
                });
                searchInput.addEventListener('keyup', (e) => {
                    e.stopPropagation();
                });

                // Force focus on the input
                searchInput.addEventListener('focus', () => {
                    searchInput.setAttribute('tabindex', '1');
                });
            }

            // Click on list item
            if (list) {
                list.addEventListener('click', (e) => {
                    const item = e.target.closest('.room-list-item');
                    if (!item) return;
                    e.stopPropagation();
                    const val = item.dataset.value;
                    if (selected.has(val)) selected.delete(val);
                    else selected.add(val);
                    renderTags();
                });
            }

            // Prevent portal clicks from bubbling
            portal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            return portal;
        }

        // Single event listener on selectBox (attached once)
        if (selectBox) {
            selectBox.addEventListener('click', (e) => {
                if (e.target.closest('.room-tag-remove')) {
                    const val = e.target.closest('.room-tag-remove').dataset.val;
                    selected.delete(val);
                    renderTags();
                    e.stopPropagation();
                    return;
                }
                isOpen ? closeDropdown() : openDropdown();
            });
        }

        // Close on outside click (global handler)
        document.addEventListener('click', (e) => {
            if (!isOpen) return;
            const { portal } = getPortalElements();
            if (selectBox && selectBox.contains(e.target)) return;
            if (portal && portal.contains(e.target)) return;
            closeDropdown();
        });

        function cleanupPortal() {
            const portal = document.getElementById(portalId);
            if (portal) portal.remove();
            isOpen = false;
            if (selectBox) selectBox.classList.remove('focused');
            if (arrow) arrow.classList.remove('open');
        }

        // Button click handlers
        const buttons = document.querySelectorAll('.asst-share-groups-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const asstId = btn.getAttribute('data-id');
                const asstName = btn.getAttribute('data-name') || '';
                if (!asstId) return;

                if (idInput) idInput.value = asstId;
                if (nameEl) nameEl.textContent = asstName;

                // Reset state
                selected = new Set();
                allowedGroups = [];
                isOpen = false;

                // Clean old portal
                cleanupPortal();

                // Reset tags
                const placeholder = selectBox.querySelector('.room-select-placeholder');
                selectBox.querySelectorAll('.room-tag').forEach(t => t.remove());
                if (placeholder) placeholder.style.display = '';
                hiddenInputsContainer.innerHTML = '';

                // Create portal
                createPortal();

                // Fetch assigned groups
                fetch(getUrl + '?id=' + encodeURIComponent(asstId), { credentials: 'same-origin' })
                    .then(resp => resp.ok ? resp.json() : null)
                    .then(data => {
                        if (data && data.ok) {
                            allowedGroups = data.allowedGroups || [];
                            (data.assignedGroups || []).forEach(g => selected.add(g));
                            renderTags();
                        }
                    })
                    .catch(() => {});

                const m = getModal();
                if (m) m.show();
            });
        });

        // Form submit
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                closeDropdown();

                const fd = new FormData(form);
                fetch(postUrl, { method: 'POST', body: fd, credentials: 'same-origin' })
                    .then(resp => { if (resp.ok) window.location.reload(); })
                    .catch(() => {});
            });
        }

        // Modal hidden - cleanup
        modalEl.addEventListener('hidden.bs.modal', () => {
            selected = new Set();
            allowedGroups = [];
            cleanupPortal();

            // Reset tags
            const placeholder = selectBox.querySelector('.room-select-placeholder');
            selectBox.querySelectorAll('.room-tag').forEach(t => t.remove());
            if (placeholder) placeholder.style.display = '';
            hiddenInputsContainer.innerHTML = '';
        });

        // Prevent modal from stealing focus from portal
        modalEl.addEventListener('focusin', (e) => {
            const { portal } = getPortalElements();
            if (portal && portal.classList.contains('open')) {
                const searchInput = document.getElementById('agRoomSearch');
                if (searchInput && document.activeElement !== searchInput) {
                    // If portal is open and focus went to modal, refocus search
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });
    })();
</script>

</div> <!-- /.asst-page-content -->