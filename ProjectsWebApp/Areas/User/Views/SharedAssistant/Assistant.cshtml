@model ProjectsWebApp.Models.Assistant
@{
    ViewData["Title"] = Model.Name;

    string? avatarSrc = Model.AvatarUrl;
    if (!string.IsNullOrWhiteSpace(avatarSrc))
    {
        if (avatarSrc.StartsWith("~/")) { avatarSrc = Url.Content(avatarSrc); }
        else if (avatarSrc.StartsWith("/") && !avatarSrc.StartsWith("//")) { avatarSrc = Url.Content("~" + avatarSrc); }
    }
}

<style>
    :root {
        --accent: #3acc59;
        --card: #ffffff;
        --border: #e8ecf3;
        --bg: #f8fafc;
        --text: #111827;
        --muted: #667085;
        --avatar: 32px;
        --gap: .6rem;
        --pad-x: .8rem;
    }

    .chat-shell {
        position: relative;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 14px 34px rgba(16,24,40,.08);
        overflow: hidden;
    }

    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        gap: .6rem;
        background: linear-gradient(180deg,#fff,#f8fafc);
        border-bottom: 1px solid var(--border);
        flex-wrap: nowrap;
    }

    .chat-header .left {
        display: flex;
        align-items: center;
        gap: .6rem;
        flex: 1 1 auto;
        min-width: 0;
    }

    .chat-header .right {
        display: flex;
        align-items: center;
        gap: .5rem;
        flex: 0 0 auto;
    }

    .btn-back {
        margin-left: 2px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border);
        background: #878686;
        color: #fff;
        border-radius: 999px;
        box-shadow: 0 2px 6px rgba(16,24,40,.06);
        flex: 0 0 auto;
    }

    .hdr-sep {
        width: 1px;
        height: 24px;
        align-self: center;
        background: linear-gradient(to bottom,transparent,var(--border),transparent);
        margin: 0 10px;
        border-radius: 1px;
        flex: 0 0 auto;
    }

    .chat-header .chat-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        border: 0;
        box-shadow: 0 0 0 2px #fff,0 0 0 3px var(--border);
        flex: 0 0 auto;
    }

    .chat-header .titles {
        display: flex;
        flex-direction: column;
        gap: .15rem;
        flex: 1 1 auto;
        min-width: 0;
        line-height: 1.15;
    }

    .chat-header .titles .name {
        font-weight: 700;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .muted {
        color: var(--muted);
    }

    .status-pill {
        background: var(--accent);
        color: #fff;
        border-radius: 999px;
        padding: .3rem .65rem;
        font-weight: 600;
        font-size: .82rem;
    }

    .sys-prompt-box {
        margin: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        overflow: hidden;
    }

    .sys-prompt-box > summary.sys-title {
        list-style: none;
        cursor: pointer;
        user-select: none;
        padding: 10px 12px;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
        color: var(--text);
        background: linear-gradient(180deg,#fff,#f8fafc);
        border-bottom: 1px solid var(--border);
    }

    .sys-prompt-box > summary::-webkit-details-marker { display:none; }

    .sys-prompt-box .chevron { transition: transform .18s ease; }
    .sys-prompt-box[open] .chevron { transform: rotate(0); }
    .sys-prompt-box:not([open]) .chevron { transform: rotate(180deg); }

    .sys-prompt-box .sys-lines {
        padding: 12px 14px 14px;
        color: #1f2937;
        font-size: .94rem;
    }

    #sysPromptLines { white-space: pre-wrap; }

    .section-title {
        display: flex;
        align-items: center;
        gap: .25rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0 0 .25rem 0;
    }

    .kv-row {
        display: flex;
        flex-direction: column;
        gap: .15rem;
        margin-bottom: .6rem;
    }

    .kv-label {
        min-width: 160px;
        color: #64748b;
        font-weight: 600;
    }

    .kv-value { color: #0f172a; }

    .para {
        margin: .15rem 0 .35rem;
        white-space: pre-wrap;
        line-height: 1.4;
    }

    .chat-body {
        height: 65vh;
        overflow: auto;
        padding: 14px 16px;
        background: var(--bg);
    }

    .msg-row {
        display: grid;
        grid-template-columns: var(--avatar) minmax(0,1fr);
        align-items: start;
        gap: var(--gap);
        margin-bottom: 12px;
    }

    .msg-row.me { grid-template-columns: minmax(0,1fr); }

    .msg-avatar {
        grid-column: 1;
        grid-row: 1;
        width: var(--avatar);
        height: var(--avatar);
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border);
    }

    .bubble {
        grid-column: 1 / -1;
        width: 100%;
        padding: .6rem var(--pad-x);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 6px 16px rgba(16,24,40,.05);
        font-size: .96rem;
        line-height: 1.5;
        background: #ffffff;
        color: #111;
    }

    .bubble.assistant {
        padding-left: calc(var(--pad-x) + var(--avatar) + var(--gap));
    }

    .bubble.me {
        background: #e8f7ee;
        border-color: #c1efcf;
        color: #083f1c;
    }

    .msg-row.assistant-thinking .bubble.assistant {
        position: relative;
        background: linear-gradient(135deg, #ffffff 0%, #f5fbff 45%, #eef9f2 100%);
        border-color: rgba(58, 204, 89, 0.28);
        box-shadow: 0 14px 26px rgba(58, 204, 89, 0.16);
        overflow: hidden;
    }

    @@keyframes bubbleShimmer {
        0% { transform: translateX(-140%); opacity: .2; }
        50% { transform: translateX(0%); opacity: .7; }
        100% { transform: translateX(140%); opacity: 0; }
    }

    .thinking-indicator {
        display: flex;
        align-items: center;
        gap: .75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #14532d;
    }

    .thinking-dots { display:flex; gap:.35rem; }

    .thinking-dot {
        width: .55rem;
        height: .55rem;
        border-radius: 999px;
        background: linear-gradient(135deg, #3acc59 0%, #119f45 100%);
        animation: dotPulse 1.2s ease-in-out infinite;
        opacity: .8;
    }

    .thinking-dot:nth-child(2) { animation-delay: .18s; }
    .thinking-dot:nth-child(3) { animation-delay: .36s; }

    @@keyframes dotPulse {
        0%,70%,100% { transform: scale(0.55); opacity:.35; }
        40% { transform: scale(1); opacity:1; }
    }

    .thinking-text {
        font-size: .8rem;
        letter-spacing: .2em;
        color: #1d4d28;
    }

    .chat-inputbar {
        display: flex;
        gap: .5rem;
        padding: 10px 16px;
        border-top: 1px solid var(--border);
        background: linear-gradient(180deg,#ffffff,#f8fafc);
        position: sticky;
        bottom: 0;
    }

    .chat-input { border-radius: 12px; }

    .btn-accent {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: .5rem .9rem;
        font-weight: 700;
    }

    .scroll-bottom-btn {
        position: absolute;
        right: 18px;
        bottom: 84px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #111827;
        color: #fff;
        display: none;
        align-items: center;
        justify-content: center;
        border: 0;
        box-shadow: 0 10px 24px rgba(16,24,40,.2);
    }

    .scroll-bottom-btn.show { display:flex; }

    .chat-shell.compact .chat-header {
        padding: 8px 12px;
        gap: .5rem;
    }

    .chat-shell.compact .sys-prompt-box {
        margin: 8px 12px;
    }

    .chat-shell.compact .chat-body {
        padding: 10px 12px;
    }
</style>

<div class="chat-shell compact mt-3">
    <div class="chat-header">
        <div class="left">
            <a href="~/" class="btn-back" title="Zurück" aria-label="Zurück">
                <i class="bi bi-arrow-left"></i>
            </a>

            <span class="hdr-sep" aria-hidden="true"></span>

            <img src="@avatarSrc" alt="@Model.Name" class="chat-avatar" />

            <div class="titles">
                <div class="name">
                    @Model.Name
                    <span class="muted">&nbsp;&middot;&nbsp;ID @Model.Id</span>
                </div>
            </div>
        </div>

        <div class="right">
            <span class="status-pill">KI-Assistent</span>
        </div>
    </div>

    <details id="goalsBox" class="sys-prompt-box" open>
        <summary class="sys-title">
            <span>Ziele &amp; Beschreibung</span>
            <span class="d-flex align-items-center gap-2">
                <i class="bi bi-chevron-up chevron" aria-hidden="true"></i>
            </span>
        </summary>
        <div id="goalsReadonly" class="sys-lines">
            @{
                var _g = Model.Goals ?? string.Empty;
                _g = System.Text.RegularExpressions.Regex.Replace(_g, "<\\s*br\\s*/?\\s*>", "\n", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                _g = System.Text.RegularExpressions.Regex.Replace(_g, "</(p|li|div|h[1-6])>", "\n", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                _g = System.Text.RegularExpressions.Regex.Replace(_g, "<.*?>", string.Empty, System.Text.RegularExpressions.RegexOptions.Singleline);
                _g = _g.Trim();
                var _d = Model.Description ?? string.Empty;
                _d = System.Text.RegularExpressions.Regex.Replace(_d, "<\\s*br\\s*/?\\s*>", "\n", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                _d = System.Text.RegularExpressions.Regex.Replace(_d, "</(p|li|div|h[1-6])>", "\n", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                _d = System.Text.RegularExpressions.Regex.Replace(_d, "<.*?>", string.Empty, System.Text.RegularExpressions.RegexOptions.Singleline);
                _d = _d.Trim();
            }
            @if (!string.IsNullOrWhiteSpace(_g))
            {
                <div class="section-title"><span>Ziele</span></div>
                <p class="para">@_g</p>
            }
            @if (!string.IsNullOrWhiteSpace(_d))
            {
                <div class="section-title mt-4"><span>Beschreibung</span></div>
                <p class="para mb-0">@_d</p>
            }
            @if (string.IsNullOrWhiteSpace(_g) && string.IsNullOrWhiteSpace(_d))
            {
                <div class="muted">Keine Angaben.</div>
            }
        </div>
    </details>

    @* System-Prompt is intentionally hidden for shared assistants *@

    <details id="ownerBox" class="sys-prompt-box">
        <summary class="sys-title">
            <span>Assistent-Owner &amp; Lizenz</span>
            <span class="d-flex align-items-center gap-2">
                <i class="bi bi-chevron-up chevron" aria-hidden="true"></i>
            </span>
        </summary>
        <div id="ownerReadonly" class="sys-lines">
            <div class="kv-row">
                <div class="kv-label">Assistent-ID</div>
                <div class="kv-value">@Model.Id</div>
            </div>
            <div class="kv-row">
                <div class="kv-label">Assistent-Name</div>
                <div class="kv-value">@Model.Name</div>
            </div>
            <div class="kv-row">
                <div class="kv-label">Assistent-Owner</div>
                <div class="kv-value">@(string.IsNullOrWhiteSpace(Model.AuthorName) ? "–" : Model.AuthorName)</div>
            </div>
            <div class="kv-row mb-0">
                <div class="kv-label">Lizenz</div>
                <div class="kv-value">@(string.IsNullOrWhiteSpace(Model.Licenses) ? "–" : Model.Licenses)</div>
            </div>
        </div>
    </details>

    <div id="chatBox" class="chat-body"></div>

    <form id="chatForm" class="chat-inputbar" onsubmit="return false;">
        <input id="chatInput" class="form-control chat-input" placeholder="Nachricht schreiben…" autocomplete="off" />
        <button id="sendBtn" class="btn btn-accent" type="button"><i class="bi bi-send"></i></button>
    </form>

    <button id="scrollBtn" class="scroll-bottom-btn" type="button"><i class="bi bi-arrow-down"></i></button>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chat = document.getElementById('chatBox');
        const input = document.getElementById('chatInput');
        const send = document.getElementById('sendBtn');
        const scrollBtn = document.getElementById('scrollBtn');
        const apiUrl = '@Url.Action("Reply", "SharedAssistant", new { area = "User", id = ViewBag.PublicId })';
        const assistantAvatar = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(avatarSrc ?? ""));
        const messages = [];

        function cleanHtml(html) {
            try {
                let s = String(html || '');
                s = s.replace(/<\s*br\s*\/?\s*>/gi, '\n')
                    .replace(/<\/(p|li|div|h[1-6])>/gi, '\n')
                    .replace(/<\s*li\s*>/gi, '• ');
                return new DOMParser().parseFromString(s, 'text/html').body.textContent || '';
            } catch {
                return String(html || '');
            }
        }

        const renderMarkdown = (text) => {
            const safe = cleanHtml(text || '');
            let html = safe
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1<\/strong>')
                .replace(/\*(.+?)\*/g, '<em>$1<\/em>')
                .replace(/`([^`]+)`/g, '<code>$1<\/code>');
            html = html.replace(/\n/g, '<br>');
            return html;
        };

        // System-Prompt is not rendered or exposed on shared assistant links

        function appendUser(text) {
            if (!chat) return;
            const row = document.createElement('div');
            row.className = 'msg-row me';
            const bubble = document.createElement('div');
            bubble.className = 'bubble me';
            bubble.textContent = text;
            row.appendChild(bubble);
            chat.appendChild(row);
            if (scrollBtn) scrollBtn.classList.add('show');
            chat.scrollTop = chat.scrollHeight;
        }

        function createAssistantThinkingRow() {
            if (!chat) return null;
            const row = document.createElement('div');
            row.className = 'msg-row assistant-thinking';
            if (assistantAvatar) {
                const img = document.createElement('img');
                img.src = assistantAvatar;
                img.alt = '';
                img.className = 'msg-avatar';
                row.appendChild(img);
            }
            const bubble = document.createElement('div');
            bubble.className = 'bubble assistant';
            bubble.innerHTML = '\n          <div class="thinking-indicator">\n            <div class="thinking-dots">\n              <span class="thinking-dot"></span>\n              <span class="thinking-dot"></span>\n              <span class="thinking-dot"></span>\n            </div>\n            <span class="thinking-text">DENKT</span>\n          </div>';
            row.appendChild(bubble);
            chat.appendChild(row);
            if (scrollBtn) scrollBtn.classList.add('show');
            chat.scrollTop = chat.scrollHeight;
            return { row, bubble };
        }

        function simulateStreaming(row, targetEl, fullText) {
            if (!targetEl) return;
            const tokens = fullText.split(/(\s+)/g);
            let idx = 0;
            let assembled = '';
            targetEl.textContent = '';
            const step = () => {
                if (idx >= tokens.length) {
                    targetEl.innerHTML = renderMarkdown(fullText);
                    if (row) row.classList.remove('assistant-thinking');
                    return;
                }
                assembled += tokens[idx++] || '';
                targetEl.textContent = assembled;
                const last = tokens[idx - 1] || '';
                const delay = Math.min(60, Math.max(8, last.replace(/\s+/g, '').length * 10));
                setTimeout(step, delay);
            };
            step();
        }

        async function sendCurrent() {
            if (!input || !chat) return;
            const text = (input.value || '').trim();
            if (!text) return;
            appendUser(text);
            messages.push({ role: 'user', content: text });
            input.value = '';
            const thinking = createAssistantThinkingRow();
            try {
                const resp = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });
                let data = null;
                if (!resp.ok) {
                    try { data = await resp.json(); } catch { }
                    const msg = (data && data.error) ? String(data.error) : 'Fehler beim Erzeugen der Antwort.';
                    if (thinking && thinking.bubble) {
                        thinking.bubble.innerHTML = '<span class="text-danger small"></span>';
                        const span = thinking.bubble.querySelector('span');
                        if (span) span.textContent = msg;
                    }
                    return;
                }
                data = await resp.json().catch(() => null);
                const reply = (data && data.reply) ? String(data.reply) : '';
                if (reply) {
                    messages.push({ role: 'assistant', content: reply });
                    if (thinking && thinking.bubble) {
                        simulateStreaming(thinking.row, thinking.bubble, reply);
                    }
                }
            } catch (e) {
                if (thinking && thinking.bubble) {
                    thinking.bubble.innerHTML = '<span class="text-danger small">Fehler beim Abrufen der Antwort.</span>';
                }
            }
        }

        if (send) {
            send.addEventListener('click', function (ev) {
                ev.preventDefault();
                sendCurrent();
            });
        }
        if (input) {
            input.addEventListener('keydown', function (ev) {
                if (ev.key === 'Enter' && !ev.shiftKey) {
                    ev.preventDefault();
                    sendCurrent();
                }
            });
        }

        if (scrollBtn && chat) {
            scrollBtn.addEventListener('click', function () {
                chat.scrollTop = chat.scrollHeight;
            });
        }
    });
</script>
}
